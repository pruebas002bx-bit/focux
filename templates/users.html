<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Usuarios • Focux</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800;900&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary-orange: #f97316;
      --primary-orange-dark: #ea580c;
      --bg-light: #f4f5f7;
      --panel-bg: #ffffff;
      --text-dark: #1f2937;
      --text-muted: #6b7280;
      --border-light: #e5e7eb;
      --ok: #16a34a;
      --warn: #d97706;
      --danger: #dc2626;

      --radius-lg: 12px;
      --radius-xl: 16px;
      --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      --transition: 200ms cubic-bezier(.4,0,.2,1);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100%; overflow: hidden; }

    body {
      font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color: var(--text-dark);
      background-color: var(--bg-light);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    main {
      padding: 28px;
      height: 100vh;
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      gap: 16px;
      flex-shrink: 0;
    }
    .header h2 { font-size: 1.8rem; font-weight: 800; letter-spacing: -0.02em; }
    .header .pill {
      display: inline-block;
      margin-top: 4px;
      padding: 4px 10px;
      background-color: #f3f4f6;
      color: var(--text-muted);
      font-size: 0.75rem;
      font-weight: 500;
      border-radius: 999px;
    }

    .toolbar {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .filter-input, .select {
      padding: 10px 16px 10px 40px;
      border-radius: var(--radius-lg);
      border: 1px solid var(--border-light);
      font-size: 0.9rem;
      min-width: 220px;
      transition: all var(--transition);
      background-repeat: no-repeat;
      background-position: 14px center;
      background-color: #fff;
    }
    .filter-input {
      min-width: 320px;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%239ca3af' viewBox='0 0 16 16'%3E%3Cpath d='M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z'/%3E%3C/svg%3E");
    }
    .select {
      padding-left: 40px;
      appearance: none;
      background-image:
        url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%239ca3af' viewBox='0 0 16 16'%3E%3Cpath d='M3 6l5 5 5-5H3z'/%3E%3C/svg%3E"),
        none;
      background-position: calc(100% - 12px) center, 14px center;
      background-size: 16px, 16px;
    }
    .filter-input:focus, .select:focus {
      outline: none;
      border-color: var(--primary-orange);
      box-shadow: 0 0 0 3px rgba(249, 115, 22, .2);
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 10px 14px;
      border-radius: var(--radius-lg);
      border: 1px solid var(--border-light);
      background: var(--panel-bg);
      color: var(--text-muted);
      font-weight: 600;
      cursor: pointer;
      transition: all var(--transition);
      box-shadow: var(--shadow-sm);
    }
    .btn.icon { padding: 10px; }
    .btn:hover { transform: translateY(-1px); color: var(--text-dark); border-color: #d1d5db; }
    .btn.primary { background: var(--primary-orange); color: white; border-color: var(--primary-orange); }
    .btn.primary:hover { background: var(--primary-orange-dark); border-color: var(--primary-orange-dark); }
    .btn.ghost { background-color: transparent; box-shadow: none; border-color: transparent; }

    /* BULK ACTIONS BAR */
    .bulk-actions-bar {
      background: linear-gradient(135deg, #f97316, #ea580c);
      color: white;
      padding: 16px 24px;
      margin-top: -12px;
      margin-bottom: 12px;
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-sm);
      transition: all var(--transition);
      animation: slideDown 0.3s ease-out;
    }

    .bulk-actions-bar.hidden { display: none; }
    .bulk-actions-content {
      display: flex; justify-content: space-between; align-items: center;
      gap: 16px; flex-wrap: wrap;
    }
    .bulk-actions-info { font-weight: 600; font-size: 0.95rem; }
    .bulk-actions-controls { display: flex; align-items: center; gap: 12px; flex-wrap: wrap; }
    .bulk-date-input {
      padding: 8px 12px; border-radius: 8px; border: 1px solid rgba(255, 255, 255, 0.3);
      background: rgba(255, 255, 255, 0.1); color: white; font-size: 0.9rem;
      backdrop-filter: blur(4px); transition: all var(--transition);
    }
    .bulk-date-input:focus { outline: none; background: rgba(255, 255, 255, 0.2); border-color: rgba(255, 255, 255, 0.5); }
    .bulk-date-input::placeholder { color: rgba(255, 255, 255, 0.7); }

    @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

    .table-container-wrapper {
      background: var(--panel-bg); border: 1px solid var(--border-light);
      border-radius: var(--radius-xl); box-shadow: var(--shadow-sm);
      flex-grow: 1; min-height: 0; overflow-y: auto;
    }

    table { width: 100%; border-collapse: collapse; table-layout: fixed; }
    thead th {
      text-align: left; font-size: 0.75rem; letter-spacing: .05em; text-transform: uppercase;
      color: var(--text-muted); background-color: #f9fafb; padding: 12px 16px;
      position: sticky; top: 0; z-index: 1;
    }
    tbody td {
      padding: 14px 16px; border-top: 1px solid var(--border-light); font-size: 0.9rem;
      vertical-align: middle;
    }
    
    .col-checkbox { width: 50px; text-align: center; }
    .col-db { width: 160px; }
    .col-user { width: 240px; }
    .col-email { width: 240px; }
    .col-boards { width: 100px; }
    .col-cards { width: 100px; }
    .col-shared { width: 120px; }
    .col-expires { width: 180px; }
    .col-actions { width: 220px; text-align: right; }

    tbody td {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    td.col-actions {
        overflow: visible;
    }

    tbody tr:has(.user-checkbox:checked) { background-color: #fff7ed; }
    tbody tr:has(.user-checkbox:checked) td:first-of-type { border-left: 3px solid var(--primary-orange); }
    
    .user-name { font-weight: 600; }
    .user-meta { font-size: 0.8rem; color: var(--text-muted); }

    .expiry-input {
      padding: 8px 10px; border-radius: 8px; border: 1px solid var(--border-light);
      font-size: 0.9rem; width: 100%; max-width: 180px;
    }

    .user-checkbox, #checkbox-all {
      cursor: pointer; transform: scale(1.1); transition: transform 0.2s ease;
      width: 16px; height: 16px; accent-color: var(--primary-orange);
    }

    .dropdown { position: relative; display: inline-block; }
    .dropdown-toggle { min-width: 110px; }
    .dropdown-menu {
      position: absolute; right: 0; top: calc(100% + 6px);
      background: #fff; border: 1px solid var(--border-light); border-radius: 10px;
      box-shadow: var(--shadow-lg); padding: 6px; display: none; min-width: 180px; z-index: 10;
    }
    .dropdown.open .dropdown-menu { display: block; }
    
    .dropdown-menu.show-up {
        top: auto;
        bottom: calc(100% + 6px);
    }

    .dropdown-item {
      display: flex; align-items: center; gap: 8px; width: 100%; border: 0;
      background: transparent; cursor: pointer; padding: 10px 12px;
      border-radius: 8px; font-weight: 600; color: var(--text-dark); text-align: left;
    }
    .dropdown-item:hover { background: #f3f4f6; }
    .dropdown-item.danger { color: var(--danger); }
    .dropdown-item.danger:hover { background-color: #fee2e2; }
    .dropdown-divider { height: 1px; background-color: var(--border-light); margin: 4px 0; }

    .modal {
      position: fixed; inset: 0; display: flex; align-items: center; justify-content: center;
      background: rgba(15, 23, 42, .6); backdrop-filter: blur(4px); z-index: 999;
      opacity: 0; visibility: hidden; transition: all var(--transition);
    }
    .modal.show { opacity: 1; visibility: visible; }
    .modal-card {
      width: min(920px, 94vw); max-height: 86vh; background: var(--panel-bg);
      border-radius: var(--radius-xl); box-shadow: var(--shadow-lg);
      display: flex; flex-direction: column; transform: scale(0.95); transition: all var(--transition);
    }
    .modal.show .modal-card { transform: scale(1); }
    .modal-head {
      display: flex; justify-content: space-between; align-items: center;
      padding: 16px 24px; border-bottom: 1px solid var(--border-light); flex-shrink: 0;
    }
    .modal-head strong { font-size: 1.25rem; font-weight: 700; }
    .modal-body { padding: 24px; overflow-y: auto; flex-grow: 1; }

    .toast {
      position: fixed; right: 24px; bottom: 24px; z-index: 1000;
      background: var(--text-dark); color: #fff; padding: 12px 18px;
      border-radius: var(--radius-lg); box-shadow: var(--shadow-lg);
      opacity: 0; transform: translateY(10px); visibility: hidden;
      transition: all var(--transition); font-weight: 600;
    }
    .toast.show { opacity: 1; transform: translateY(0); visibility: visible; }
    .w-nowrap { white-space: nowrap; }
    .ta-center { text-align: center; }

    @media (max-width: 768px) {
      .bulk-actions-content { flex-direction: column; align-items: stretch; }
      .bulk-actions-controls { justify-content: center; }
      .bulk-date-input { flex-grow: 1; }
      .header { flex-direction: column; align-items: stretch; }
      .toolbar { flex-direction: column; align-items: stretch; }
      .filter-input, .select { min-width: auto; }
    }
  </style>
</head>
<body>
  <main>
    <div class="header">
      <div>
        <h2>Gestión de Usuarios</h2>
        <div class="pill">Administra el acceso, tableros y tarjetas</div>
      </div>
      <div class="toolbar">
        <input id="filter-user" placeholder="Buscar por correo o nombre..." class="filter-input"/>
        <select id="filter-db" class="select" title="Filtrar por base de datos">
          <option value="all">Todas las bases</option>
        </select>
        <select id="filter-status" class="select" title="Estado de expiración">
          <option value="all">Todos</option>
          <option value="expired">Vencidos</option>
          <option value="active">Vigentes</option>
        </select>
        <select id="order-by" class="select" title="Ordenar por">
          <option value="default">Orden predeterminado</option>
          <option value="boards_desc">Más tableros</option>
          <option value="cards_desc">Más tarjetas</option>
          <option value="shared_desc">Más compartidos</option>
        </select>
        <button class="btn icon" id="btn-refresh-users" title="Actualizar">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"/><path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"/></svg>
        </button>
      </div>
    </div>

    <div id="bulk-actions-bar" class="bulk-actions-bar hidden">
      <div class="bulk-actions-content">
        <div class="bulk-actions-info">
          <span id="selected-count">0</span> usuario(s) seleccionado(s)
        </div>
        <div class="bulk-actions-controls">
          <label for="bulk-expiry-date" style="font-weight: 500;">Establecer expiración:</label>
          <input type="date" id="bulk-expiry-date" class="bulk-date-input">
          <button id="btn-bulk-set-expiry" class="btn primary">Aplicar Fecha</button>
          <div style="border-left: 1px solid rgba(255,255,255,0.3); height: 24px; margin: 0 8px;"></div>
          <button id="btn-bulk-clear-expiry" class="btn" style="background:rgba(255,255,255,0.9); color:var(--danger);">Quitar Expiración</button>
          <button id="btn-clear-selection" class="btn ghost" style="margin-left:auto; color:white;">Limpiar selección</button>
        </div>
      </div>
    </div>

    <div class="table-container-wrapper">
      <table>
        <thead>
          <tr>
            <th class="col-checkbox"><input type="checkbox" id="checkbox-all" title="Seleccionar todos"></th>
            <th class="col-db">Base de datos</th>
            <th class="col-user">Usuario</th>
            <th class="col-email">Email</th>
            <th class="col-boards ta-center">Tableros</th>
            <th class="col-cards ta-center">Tarjetas</th>
            <th class="col-shared ta-center">Compartidos</th>
            <th class="col-expires">Expira</th>
            <th class="col-actions">Acciones</th>
          </tr>
        </thead>
        <tbody id="tbl-users"></tbody>
      </table>
    </div>
  </main>

  <div class="modal" id="modal">
    <div class="modal-card">
      <div class="modal-head">
        <strong id="modal-title">Detalles</strong>
        <button class="btn" id="modal-close">Cerrar</button>
      </div>
      <div class="modal-body" id="modal-body"></div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    const API_BASE_URL = 'https://focux-app.onrender.com';
    let CACHE = { users: [], boards: [], databases: [] };
    const DBMAP = { displayNameByFilename: new Map() };

    async function fetchJSON(path, {method='GET', body=null} = {}) {
      const opts = { method, headers: { 'ngrok-skip-browser-warning':'true' }, mode:'cors' };
      if (body) { opts.headers['Content-Type'] = 'application/json'; opts.body = JSON.stringify(body); }
      const res = await fetch(`${API_BASE_URL}${path}`, opts);
      if(!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText}`);
      return res.json();
    }

    function toast(msg){
      const t = document.getElementById('toast');
      t.textContent = msg; t.classList.add('show');
      setTimeout(()=> t.classList.remove('show'), 3200);
    }

    function buildDbMaps(){
      DBMAP.displayNameByFilename.clear();
      CACHE.databases.forEach(db => {
        const filename = String(db.filename || '').trim();
        if (filename) DBMAP.displayNameByFilename.set(filename.toLowerCase(), db.display_name || filename);
      });
    }

    function getDisplayForFilename(filename){
      if (!filename) return '—';
      return DBMAP.displayNameByFilename.get(String(filename).toLowerCase()) || filename;
    }

    function parseYMD(s) {
      if (!s) return null;
      const d = new Date(s);
      return isNaN(d.getTime()) ? null : new Date(d.getUTCFullYear(), d.getUTCMonth(), d.getUTCDate());
    }

    function formatYMD(d) {
      if (!(d instanceof Date) || isNaN(d)) return '';
      return d.toISOString().split('T')[0];
    }

    function addMonths(date, months) {
      const d = new Date(date);
      d.setMonth(d.getMonth() + months);
      return d;
    }
    
    function formatRelativeTime(dateString) {
      if (!dateString) return 'Nunca';
      const date = new Date(dateString);
      const diffMins = Math.floor((new Date() - date) / 60000);
      if (diffMins < 1) return 'Ahora mismo';
      if (diffMins < 60) return `${diffMins}m`;
      if (diffMins < 1440) return `${Math.floor(diffMins / 60)}h`;
       if (diffMins < 10080) return `${Math.floor(diffMins / 1440)}d`;
      return date.toLocaleDateString('es-CO');
    }

    function isExpired(u) {
      const d = parseYMD(u.access_expires_on);
      if (!d) return false;
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      return d.getTime() < today.getTime();
    }

    async function loadData(){
      try {
        const [dash, dbres] = await Promise.all([
          fetchJSON('/admin/dashboard'),
          fetchJSON('/admin/available-databases')
        ]);
        if(!dash.success) throw new Error(dash.message || 'Respuesta no exitosa');

        CACHE.users = dash.stats.detailed_users || [];
        CACHE.boards = dash.stats.detailed_boards || [];
        CACHE.databases = dbres.databases || [];

        buildDbMaps();
        populateDBFilter();
      } catch(e) {
        console.error("Error al cargar datos:", e);
        toast('❌ No se pudo cargar los datos del servidor');
      }
    }

    function renderBoardsTable(items){
      if (!items.length) return '<div class="pill" style="margin:20px;">Este usuario no tiene tableros.</div>';
      let html = '<table><thead><tr><th>Nombre</th><th class="ta-center">Tarjetas</th><th class="ta-center">Compartidos</th><th>Última Modificación</th></tr></thead><tbody>';
      items.forEach(b => {
        const ud = b.updated_date ? new Date(b.updated_date).toLocaleString('es-CO', { dateStyle: 'short', timeStyle: 'short' }) : '—';
        html += `<tr>
                    <td>${b.name||'—'}</td>
                    <td class="ta-center">${b.cards_count||0}</td>
                    <td class="ta-center">${b.shared_count||0}</td>
                    <td>${ud}</td>
                </tr>`;
      });
      return `${html}</tbody></table>`;
    }

    function showModal(title, html){
      document.getElementById('modal-title').textContent = title || 'Detalles';
      document.getElementById('modal-body').innerHTML = html || '';
      document.getElementById('modal').classList.add('show');
    }
    
    function closeAllDropdowns(){
      document.querySelectorAll('.dropdown.open').forEach(d => d.classList.remove('open'));
    }

    async function setExpiry(email, dateOrNull) {
        const dateString = dateOrNull ? formatYMD(dateOrNull) : '';
        try {
            const res = await fetchJSON('/admin/user/set-expiry', { 
                method: 'POST', 
                body: { email, expiry_date: dateString } 
            });
            if (!res.success) throw new Error(res.message || 'Error del servidor');
            return true;
        } catch (e) {
            console.error(e);
            toast(`❌ No se pudo guardar la expiración para ${email}`);
            return false;
        }
    }

    function populateDBFilter(){
      const sel = document.getElementById('filter-db');
      const prev = sel.value || 'all';
      const known = CACHE.databases.sort((a,b) => (a.display_name || a.filename).localeCompare(b.display_name || b.filename, 'es'));
      sel.innerHTML = '<option value="all">Todas las bases</option>' + 
        known.map(d => `<option value="${d.filename}">${d.display_name}</option>`).join('');
      sel.value = prev;
    }
    
    function paintUsers(){
      const T = document.getElementById('tbl-users');
      T.innerHTML = '';

      const term = document.getElementById('filter-user').value.toLowerCase();
      const status = document.getElementById('filter-status').value;
      const orderBy = document.getElementById('order-by').value;
      const dbFilter = document.getElementById('filter-db').value;

      let enriched = CACHE.users.map(u => ({
        u,
        boards_count: u.boards_count || 0,
        cards_count: (CACHE.boards.filter(b => b.owner_email === u.email).reduce((sum, b) => sum + (b.cards_count || 0), 0)),
        shared_count: (CACHE.boards.filter(b => b.owner_email === u.email).reduce((sum, b) => sum + (b.shared_count || 0), 0)),
        db_display: getDisplayForFilename(u.source_db),
      }));

      let list = enriched
        .filter(x => !term || x.u.name.toLowerCase().includes(term) || x.u.email.toLowerCase().includes(term))
        .filter(x => status === 'all' || (status === 'expired' && isExpired(x.u)) || (status === 'active' && !isExpired(x.u)))
        .filter(x => dbFilter === 'all' || (x.u.source_db || '').toLowerCase() === dbFilter.toLowerCase());

      if (orderBy === 'boards_desc') list.sort((a,b) => b.boards_count - a.boards_count);
      else if (orderBy === 'cards_desc') list.sort((a,b) => b.cards_count - a.cards_count);
      else if (orderBy === 'shared_desc') list.sort((a,b) => b.shared_count - a.shared_count);

      if(list.length === 0) {
        T.innerHTML = `<tr><td colspan="9" style="text-align:center; padding: 40px; color: var(--text-muted);">No se encontraron usuarios con los filtros aplicados.</td></tr>`;
        return;
      }

      list.forEach(({u, cards_count, shared_count, db_display}) => {
        const tr = document.createElement('tr');
        const expDate = parseYMD(u.access_expires_on);
        const expStr = expDate ? formatYMD(expDate) : '';
        tr.dataset.managerId = u.source_db || '';
        
        tr.innerHTML = `
          <td class="col-checkbox"><input type="checkbox" class="user-checkbox" data-email="${u.email}"></td>
          <td class="col-db w-nowrap" title="${u.source_db || ''}">${db_display}</td>
          <td class="col-user">
            <div class="user-name">${u.name||'—'}</div>
            <div class="user-meta">Último acceso: ${u.last_login ? formatRelativeTime(u.last_login) : 'Nunca'}</div>
          </td>
          <td class="col-email">${u.email}</td>
          <td class="col-boards ta-center">${u.boards_count||0}</td>
          <td class="col-cards ta-center">${cards_count}</td>
          <td class="col-shared ta-center">${shared_count}</td>
          <td class="col-expires"><input type="date" value="${expStr}" data-email="${u.email}" class="expiry-input"/></td>
          <td class="col-actions">
            <div style="display:flex; gap:8px; justify-content:flex-end; flex-wrap: nowrap;">
              <button class="btn btn-view-boards" data-email="${u.email}">Ver</button>
              <div class="dropdown" data-email="${u.email}">
                <button class="btn dropdown-toggle">
                  <span>Acciones</span>
                  <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" fill="currentColor" viewBox="0 0 16 16" style="margin-left:4px;">
                    <path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z"/>
                  </svg>
                </button>
                <div class="dropdown-menu">
                  <button class="dropdown-item" data-action="save-expiry">💾 Guardar fecha</button>
                  <button class="dropdown-item" data-action="clear-expiry">🚫 Quitar expiración</button>
                  <div class="dropdown-divider"></div>
                  <button class="dropdown-item" data-action="add-expiry" data-months="1">➕ 1 Mes</button>
                  <button class="dropdown-item" data-action="add-expiry" data-months="3">➕ 3 Meses</button>
                  <button class="dropdown-item" data-action="add-expiry" data-months="12">➕ 1 Año</button>
                  <div class="dropdown-divider"></div>
                  <button class="dropdown-item danger" data-action="delete-user">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16" style="margin-right:4px;"><path d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z"/></svg>
                    Eliminar Usuario
                  </button>
                </div>
              </div>
            </div>
          </td>
        `;
        T.appendChild(tr);
      });
    }

    async function handleUserAction(email, action, months = 0) {
        // --- INICIO DE CORRECCIÓN ---
        // Se busca la fila (tr) específica del usuario sobre el que se está actuando.
        const rowElement = document.querySelector(`.user-checkbox[data-email="${email}"]`)?.closest('tr');
        if (!rowElement) {
            toast('❌ Error crítico: No se pudo encontrar la fila del usuario en la interfaz.');
            return;
        }
        const input = rowElement.querySelector(`.expiry-input`);
        // --- FIN DE CORRECCIÓN ---
        let newDate;

        if (action === 'save-expiry') {
            newDate = parseYMD(input.value);
            if (!input.value) { 
                if (confirm("El campo está vacío. ¿Quieres quitar la expiración?")) { newDate = null; } else { return; }
            } else if (!newDate) {
                toast('❌ Fecha inválida.'); return;
            }
            const success = await setExpiry(email, newDate);
            if (success) { toast('✅ Expiración actualizada.'); await loadData(); paintUsers(); }

        } else if (action === 'clear-expiry') {
            newDate = null;
            const success = await setExpiry(email, newDate);
            if (success) { toast('✅ Expiración actualizada.'); await loadData(); paintUsers(); }

        } else if (action === 'add-expiry') {
            const baseDate = parseYMD(input.value) || new Date();
            newDate = addMonths(baseDate, months);
            const success = await setExpiry(email, newDate);
            if (success) { toast('✅ Expiración actualizada.'); await loadData(); paintUsers(); }

        } else if (action === 'delete-user') {
            // Se obtiene el managerId directamente del atributo 'data-manager-id' de la fila correcta.
            const managerId = rowElement.dataset.managerId;
            if (!managerId) {
                toast('❌ No se pudo encontrar el Manager ID del usuario.');
                return;
            }

            const confirmation = prompt(`ACCIÓN DESTRUCTIVA:\nPara eliminar permanentemente al usuario '${email}' y todos sus datos, escribe su email completo a continuación:`);
            
            if (confirmation !== email) {
                toast('La confirmación no coincide. Eliminación cancelada.');
                return;
            }

            try {
                const res = await fetchJSON('/admin/user/delete', { 
                    method: 'DELETE', 
                    body: { email, manager_id: managerId } 
                });
                toast(`✅ ${res.message}`);
                await loadData();
                paintUsers();
            } catch(e) {
                toast(`❌ Error al eliminar: ${e.message}`);
            }
        }
    }
    
    async function handleBulkExpiryAction(isClearing = false) {
        const selectedEmails = Array.from(document.querySelectorAll('.user-checkbox:checked')).map(cb => cb.dataset.email);
        if (selectedEmails.length === 0) return toast('❌ Selecciona al menos un usuario.');
        
        const bulkDateInput = document.getElementById('bulk-expiry-date');
        const dateValue = isClearing ? '' : bulkDateInput.value;
        const confirmMessage = isClearing 
            ? `¿Estás seguro de que quieres quitar la expiración para ${selectedEmails.length} usuario(s)?`
            : `¿Aplicar la fecha ${dateValue} a ${selectedEmails.length} usuario(s)?`;

        if (!dateValue && !isClearing) return toast('❌ Selecciona una fecha para aplicar.');
        if (!confirm(confirmMessage)) return;

        let successCount = 0;
        for (const email of selectedEmails) {
            const success = await setExpiry(email, isClearing ? null : parseYMD(dateValue));
            if (success) successCount++;
        }
        
        toast(`✅ Operación completada para ${successCount} de ${selectedEmails.length} usuarios.`);
        document.getElementById('checkbox-all').checked = false;
        document.querySelectorAll('.user-checkbox:checked').forEach(cb => { cb.checked = false; });
        document.getElementById('bulk-actions-bar').classList.add('hidden');
        await loadData();
        paintUsers();
    }
    
    // ===== Eventos =====
    document.addEventListener('DOMContentLoaded', async () => {
      document.querySelectorAll('#filter-user, #filter-status, #order-by, #filter-db').forEach(el => {
        el.addEventListener('input', paintUsers);
      });
      document.getElementById('btn-refresh-users').addEventListener('click', async () => { await loadData(); paintUsers(); });
      document.getElementById('modal-close').addEventListener('click', () => document.getElementById('modal').classList.remove('show'));
      document.getElementById('modal').addEventListener('click', (e) => { if(e.target.id === 'modal') e.currentTarget.classList.remove('show'); });
      document.addEventListener('click', (e) => { if (!e.target.closest('.dropdown')) closeAllDropdowns(); });
      
      document.getElementById('tbl-users').addEventListener('click', (e) => {
          const target = e.target;
          
          const viewBtn = target.closest('.btn-view-boards');
          if (viewBtn) {
              const email = viewBtn.dataset.email;
              const userBoards = CACHE.boards.filter(b => b.owner_email === email);
              showModal(`Tableros de ${email}`, renderBoardsTable(userBoards));
              return;
          }
          const dropdownToggle = target.closest('.dropdown-toggle');
          if (dropdownToggle) {
              e.stopPropagation();
              const dd = dropdownToggle.closest('.dropdown');
              const menu = dd.querySelector('.dropdown-menu');
              if (!menu) return;
              
              const isOpen = dd.classList.contains('open');
              closeAllDropdowns();
              
              if(!isOpen) {
                  const rect = dropdownToggle.getBoundingClientRect();
                  const spaceBelow = window.innerHeight - rect.bottom;
                  const menuHeight = menu.offsetHeight > 0 ? menu.offsetHeight : 220;
                  
                  if (spaceBelow < menuHeight && rect.top > menuHeight) {
                      menu.classList.add('show-up');
                  } else {
                      menu.classList.remove('show-up');
                  }
                  dd.classList.add('open');
              }
              return;
          }
          const dropdownItem = target.closest('.dropdown-item');
          if (dropdownItem) {
              e.stopPropagation();
              const action = dropdownItem.dataset.action;
              const months = parseInt(dropdownItem.dataset.months || '0', 10);
              const email = dropdownItem.closest('.dropdown').dataset.email;
              handleUserAction(email, action, months);
              closeAllDropdowns();
              return;
          }
      });
      
      const updateBulkActionsBar = () => {
        const selectedCount = document.querySelectorAll('.user-checkbox:checked').length;
        document.getElementById('bulk-actions-bar').classList.toggle('hidden', selectedCount === 0);
        document.getElementById('selected-count').textContent = selectedCount;
      };

      document.getElementById('checkbox-all').addEventListener('change', (e) => {
        document.querySelectorAll('.user-checkbox').forEach(cb => { cb.checked = e.target.checked; });
        updateBulkActionsBar();
      });
      document.getElementById('tbl-users').addEventListener('change', (e) => {
          if (e.target.classList.contains('user-checkbox')) updateBulkActionsBar();
      });
      document.getElementById('btn-clear-selection').addEventListener('click', () => {
          document.getElementById('checkbox-all').checked = false;
          document.querySelectorAll('.user-checkbox:checked').forEach(cb => { cb.checked = false; });
          updateBulkActionsBar();
      });
      document.getElementById('btn-bulk-set-expiry').addEventListener('click', () => handleBulkExpiryAction(false));
      document.getElementById('btn-bulk-clear-expiry').addEventListener('click', () => handleBulkExpiryAction(true));

      await loadData();
      paintUsers();
    });
  </script>
</body>
</html>