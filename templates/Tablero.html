<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">

    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">


    <title>Focux - Claridad en Acción</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">


    <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    <link rel="stylesheet" type="text/css" href="https://unpkg.com/trix@2.0.0/dist/trix.css">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>

<style>
        html, body {
            height: 100%;
            overflow: hidden;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f5f7;
        }
        .focux-title { font-family: 'Cormorant Garamond', serif; }


        .kanban-card {
            cursor: pointer;
            overflow: visible; /* Cambiado de 'hidden' a 'visible' */
        }



        .kanban-card.dragging-card {
            opacity: 0.6;
            transform: rotate(2deg);
        }
        .kanban-column.dragging-column {
            opacity: 0.5;
            transform: scale(1.02);
        }
        .kanban-column-content::-webkit-scrollbar, #chatbot-messages::-webkit-scrollbar { width: 8px; }
        .kanban-column-content::-webkit-scrollbar-track, #chatbot-messages::-webkit-scrollbar-track { background: transparent; }
        .kanban-column-content::-webkit-scrollbar-thumb, #chatbot-messages::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .kanban-column-content::-webkit-scrollbar-thumb:hover, #chatbot-messages::-webkit-scrollbar-thumb:hover { background: #a0aec0; }
        
        .modal-overlay { transition: opacity 0.3s ease-in-out; }
                
        .tag-select-btn[aria-checked="true"] {
            background-color: #dc2626;
            color: white;
            border-color: #dc2626;
        }

        .card-actions-menu {
            z-index: 99;
        }
        
        .tag-color-dot {
            width: 8px;
            height: 8px;
            border-radius: 9999px;
            margin-right: 8px;
            flex-shrink: 0;
        }
        
        #kanban-board-container,
        #calendar-container {
            position: absolute;
            inset: 0;
            display: none;
            flex-direction: column;
        }


        #kanban-board-container.active,
        #calendar-container.active {
            display: flex;
        }

        #eisenhower-container.active {
            display: flex;
        }

        /* AGREGAR ESTA LÍNEA */
        #notes-container.active {
            display: block;
        }


        #kanban-board-container.active,
        #calendar-container.active {
            display: flex;
        }


        .card-sequence {
            position: absolute;
            top: -8px;
            left: -8px;
            background: linear-gradient(135deg, var(--primary-orange) 0%, var(--primary-orange-dark) 100%);
            color: white;
            font-size: 0.7rem;
            font-weight: 700;
            padding: 4px 8px;
            border-radius: 50px;
            box-shadow: var(--shadow-sm);
            z-index: 10;
        }

        .card-preview {
            position: relative; /* <-- MODIFICAR ESTA LÍNEA para permitir positioning absoluto */
            background: var(--panel-bg);
            padding: 1rem;
            border-radius: var(--radius-md);
            margin-bottom: 0.75rem;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-light);
            transition: all var(--transition-fast);
        }


        input[type="file"]::file-selector-button {
            background-color: #dc2626;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        input[type="file"]::file-selector-button:hover {
            background-color: #b91c1c;
        }

        #kanban-board-container::-webkit-scrollbar {
          height: 12px; /* Aumentado a 12px para mayor notoriedad */
        }
        #kanban-board-container::-webkit-scrollbar-thumb {
          background-color: #f97316; /* Color naranja de Tailwind (orange-500) */
          border-radius: 8px;
          border: 3px solid #f3f4f6; /* Borde gris claro para mayor contraste */
        }
        #kanban-board-container::-webkit-scrollbar-track {
          background-color: #f3f4f6; /* Fondo de la pista en gris claro */
          border-radius: 8px;
        }

        #kanban-board-container {
            overflow-x: auto;
            overflow-y: hidden;
            height: 125%; /* 100% / 0.8 para compensar la escala */
            width: 125%; /* 100% / 0.8 para compensar la escala */
            background-size: cover;
            background-position: center;
            position: relative;
            z-index: 0;
            box-sizing: border-box;

            /* --- INICIO DE LA CORRECCIÓN --- */
            /* Escala todo el contenedor al 80% de su tamaño */
            transform: scale(0.8);
            /* Fija el punto de transformación en la esquina superior izquierda */
            transform-origin: top left;
            /* --- FIN DE LA CORRECCIÓN --- */
        }



        .stat-card {
            background-color: white;
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.05), 0 2px 4px -2px rgb(0 0 0 / 0.05);
            border: 1px solid #e5e7eb;
            text-align: center;
            transition: all 0.2s ease-in-out;
        }
        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        .stat-title {
            font-size: 0.875rem; /* 14px */
            font-weight: 600;
            color: #4b5563; /* gray-600 */
            margin-bottom: 0.5rem;
        }
        .stat-value {
            font-size: 2.25rem; /* 36px */
            font-weight: 800;
            line-height: 1.1;
        }
        .stat-description {
            font-size: 0.75rem; /* 12px */
            color: #6b7280; /* gray-500 */
            margin-top: 0.25rem;
        }

        /* Estilos para gráficas SVG */
        .chart-bar {
            transition: all 0.2s ease-in-out;
            cursor: pointer;
        }
        .chart-bar:hover {
            opacity: 0.8;
        }
        .chart-tooltip {
            position: absolute;
            background-color: rgba(17, 24, 39, 0.9); /* gray-900/90 */
            color: white;
            padding: 0.5rem 0.75rem;
            border-radius: 0.375rem; /* rounded-md */
            font-size: 0.75rem; /* 12px */
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            white-space: nowrap;
            z-index: 10;
        }

        .progress-ring-text {
            font-size: 1.8rem;
            font-weight: 800;
            dominant-baseline: middle;
            text-anchor: middle;
        }

        /* Lista de tareas próximas */
        .upcoming-task-item {
            padding: 0.5rem;
            border-left-width: 4px;
            border-radius: 0.25rem;
            background-color: #f9fafb; /* gray-50 */
        }
        .upcoming-task-item .title {
            font-weight: 600;
            color: #1f2937; /* gray-800 */
        }
        .upcoming-task-item .details {
            font-size: 0.75rem;
            color: #6b7280; /* gray-500 */
        }




        #kanban-board {
            display: grid;
            grid-auto-flow: column;
            grid-auto-columns: 340px;
            gap: 1.5rem;
            padding: 1.0rem;
            width: max-content;
            height: calc(100% - 2rem);
            margin-top: 0.5rem;
            box-sizing: border-box;

            /* --- INICIO DE LA CORRECCIÓN CLAVE --- */
            /* Esta línea es la más importante. Le ordena al grid que su
               única fila de columnas debe ocupar todo el espacio vertical
               disponible (1fr) y no más, evitando que crezca. */
            grid-template-rows: minmax(0, 1fr);
            /* --- FIN DE LA CORRECCIÓN CLAVE --- */
        }

        .kanban-column {
            display: flex;
            flex-direction: column;
            /* Establece la altura de la columna para que ocupe el 100% de su contenedor padre (#kanban-board), que tiene una altura fija. */
            height: 100%;
            max-height: 100%;
        }


        .kanban-column-content {
            /* El contenido crece para llenar el espacio entre el header y el footer. */
            flex-grow: 1;
            /* El scroll vertical se activará aquí, creando el efecto de "máscara". */
            overflow-y: auto;
            /* Permite que el contenedor se encoja y muestre el scroll. */
            min-height: 0;
        }
                        
        .kanban-column-content::-webkit-scrollbar {
            width: 8px;
        }

        .kanban-column-content::-webkit-scrollbar-track {
            background: rgba(229, 231, 235, 0.3);
            border-radius: 10px;
        }

        .kanban-column-content::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }

        .kanban-column-content::-webkit-scrollbar-thumb:hover {
            background: #a0aec0;
        }






        .trix-content {
            min-height: 120px;
        }
        trix-toolbar .trix-button-group {
            border-top-color: #d1d5db;
            border-bottom-color: #d1d5db;
        }
        .trix-preview h1, .trix-preview p, .trix-preview div, .trix-preview ul, .trix-preview ol, .trix-preview li {
            margin: 0 !important;
            padding: 0 !important;
            font-size: inherit !important;
            line-height: inherit !important;
        }
        .trix-preview ul, .trix-preview ol {
            padding-left: 1rem !important;
        }
        
        /* CALENDAR STYLES */
        #calendar-container {
            padding: 1.5rem;
        }
        #calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 1rem;
            flex-shrink: 0;
        }


        /* ADD THESE STYLES FOR THE NOTES FEATURE */
        #notes-grid {
            align-content: start;
        }


        #notes-grid {
            align-content: start;
        }


        #documents-container.active {
            /* REEMPLAZAR 'display: block;' por 'display: flex;' */
            display: flex;
            /* ELIMINAR 'position: absolute;' */
            flex-direction: column;
            padding: 1.5rem; /* Añadir padding al contenedor principal */
            overflow-y: auto; /* Permitir scroll en el contenedor principal */
        }


        .document-card {
            background-color: #fff;
            border-radius: 3px 8px 8px 3px; /* Esquinas redondeadas como un libro */
            box-shadow: 0 5px 15px rgba(0,0,0,0.1), 0 2px 5px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            transition: all 0.3s ease-in-out;
            position: relative;
            transform-style: preserve-3d; /* Habilita el efecto 3D */
            aspect-ratio: 2 / 3; /* Proporción más alta, como un libro */
        }

        .document-card::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            width: 20px; /* Ancho del lomo */
            height: 100%;
            /* Corrección: Lomo negro con un sutil gradiente para simular volumen */
            background: linear-gradient(to right, 
                #1a1a1a 0%, 
                #3c3c3c 20%, 
                #4d4d4d 40%,
                #3c3c3c 60%,
                #1a1a1a 100%
            );
            transform: translateX(-100%) rotateY(-20deg);
            transform-origin: right;
            border-radius: 3px 0 0 3px;
        }

        .document-card:hover {
            transform: rotateY(-10deg) scale(1.05); /* Efecto 3D al pasar el mouse */
            box-shadow: 0 12px 28px rgba(0,0,0,0.15), 0 5px 10px rgba(0,0,0,0.1);
        }
        
        .document-card .action-overlay {
            position: absolute;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.55);
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            z-index: 20;
        }

        /* Mostrar la capa al hacer hover en la tarjeta (requiere la clase 'group') */
        .document-card:hover .action-overlay {
            opacity: 1;
        }

        /* Estilo base para los botones de acción */
        .document-card .action-overlay .change-cover-btn,
        .document-card .action-overlay .delete-doc-btn {
            padding: 0.75rem; /* 12px */
            background-color: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(5px);
            border-radius: 9999px; /* Círculo perfecto */
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }

        /* Efecto de escala al pasar el mouse sobre los botones */
        .document-card .action-overlay button:hover {
            transform: scale(1.1);
            background-color: #ffffff;
        }

        /* Color específico para el ícono del botón de eliminar */
        .document-card .action-overlay .delete-doc-btn {
            color: #dc2626; /* red-600 */
        }

        /* Cambio de color al pasar el mouse sobre el botón de eliminar */
        .document-card .action-overlay .delete-doc-btn:hover {
            background-color: #dc2626;
            color: #ffffff;
        }

        /* Tamaño de los íconos SVG dentro de los botones */
        .document-card .action-overlay svg {
            width: 1.25rem; /* 20px */
            height: 1.25rem; /* 20px */
        }
        
        .doc-thumbnail {
            width: 100%;
            height: 100%; /* La imagen ocupa toda la tarjeta */
            object-fit: cover;
            border-radius: 3px 8px 8px 3px; /* Coincide con la tarjeta */
            background-color: #f3f4f6;
            position: absolute;
            top: 0;
            left: 0;
            z-index: -1; /* Detrás del contenido */
        }
        
        .doc-info {
            padding: 1rem;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: space-between; /* Espacia el título y los metadatos */
            background: linear-gradient(to top, rgba(0,0,0,0.8) 0%, rgba(0,0,0,0.4) 40%, transparent 70%); /* Sombra para legibilidad */
            border-radius: 3px 8px 8px 3px;
        }

        .doc-title {
            font-weight: 700;
            color: #ffffff; /* Texto blanco para contraste */
            font-size: 1.1rem; /* Título más grande */
            line-height: 1.3;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.7);
            display: -webkit-box;
            -webkit-line-clamp: 3; /* Permite más líneas para el título */
            -webkit-box-orient: vertical;  
            overflow: hidden;
            margin-top: auto; /* Empuja el título hacia abajo */
        }

        .doc-meta {
            margin-top: 0.75rem; /* Espacio entre título y metadatos */
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.75rem;
            color: #e5e7eb; /* Color de texto más claro */
        }

        .doc-meta-item {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            background-color: rgba(255, 255, 255, 0.15); /* Fondo semitransparente */
            backdrop-filter: blur(2px);
            padding: 4px 10px;
            border-radius: 9999px;
            font-weight: 500;
        }

        
        #pdf-drop-zone.drag-over {
            border-color: #f97316;
            background-color: #fff7ed;
        }


        .note-card {
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            border-left: 5px solid;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            transition: all 0.3s ease-in-out;
            position: relative;
            overflow: hidden;
            cursor: pointer;
            min-height: 200px;
        }

        /* Colores específicos para notas */
        .note-card.note-yellow {
            background: linear-gradient(135deg, #fffbeb, #fef3c7);
            border-left-color: #f59e0b;
            box-shadow: 0 8px 25px rgba(245, 158, 11, 0.15);
        }

        .note-card.note-blue {
            background: linear-gradient(135deg, #eff6ff, #dbeafe);
            border-left-color: #3b82f6;
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.15);
        }

        .note-card.note-green {
            background: linear-gradient(135deg, #f0fdf4, #dcfce7);
            border-left-color: #22c55e;
            box-shadow: 0 8px 25px rgba(34, 197, 94, 0.15);
        }

        .note-card.note-pink {
            background: linear-gradient(135deg, #fdf2f8, #fce7f3);
            border-left-color: #ec4899;
            box-shadow: 0 8px 25px rgba(236, 72, 153, 0.15);
        }

        .note-card.note-purple {
            background: linear-gradient(135deg, #f5f3ff, #ede9fe);
            border-left-color: #8b5cf6;
            box-shadow: 0 8px 25px rgba(139, 92, 246, 0.15);
        }

        .note-card.note-gray {
            background: linear-gradient(135deg, #f9fafb, #f3f4f6);
            border-left-color: #6b7280;
            box-shadow: 0 8px 25px rgba(107, 114, 128, 0.15);
        }

        .note-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.25);
        }

        .note-preview {
            flex-grow: 1;
            margin-bottom: 16px;
            display: flex;
            flex-direction: column;
        }

        .note-content-preview {
            font-family: 'Inter', sans-serif;
            color: #4b5563;
            font-size: 1rem;
            line-height: 1.6;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }

        .note-preview-image {
            margin-bottom: 12px;
            flex-shrink: 0;
        }

        .note-preview-image img {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s ease;
        }

        .note-preview-image img:hover {
            transform: scale(1.02);
        }

        .note-preview-text {
            flex-grow: 1;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 4;
            -webkit-box-orient: vertical;
            margin-bottom: 8px;
        }

        .note-image-counter {
            background: rgba(249, 115, 22, 0.1);
            color: #ea580c;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            margin-top: auto;
            align-self: flex-start;
        }


 

        .participant-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 6px;
            border-radius: 6px;
            transition: background-color 0.2s;
        }
        .participant-item:hover {
            background-color: #f9fafb;
        }
        .hand-raised-icon {
            opacity: 0;
            transform: scale(0.5);
            transition: all 0.3s ease;
        }
        .participant-item.hand-raised .hand-raised-icon {
            opacity: 1;
            transform: scale(1);
            animation: wave-hand 2s infinite;
        }
        @keyframes wave-hand {
            0% { transform: rotate(0deg); }
            10% { transform: rotate(14deg); }
            20% { transform: rotate(-8deg); }
            30% { transform: rotate(14deg); }
            40% { transform: rotate(-4deg); }
            50% { transform: rotate(10deg); }
            60% { transform: rotate(0deg); }
            100% { transform: rotate(0deg); }
        }

        .note-image-only {
            color: #9ca3af;
            font-size: 0.875rem;
            font-style: italic;
            text-align: center;
            padding: 20px 0;
            background: rgba(249, 115, 22, 0.05);
            border-radius: 8px;
            margin: 10px 0;
        }




        #sticker-modal-container {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            padding: 1rem;
            transition: opacity 0.3s ease-in-out;
        }

        /* Oculta el modal cuando tiene la clase .hidden */
        #sticker-modal-container.hidden {
            display: none;
        }

        /* 2. El Contenido del Modal (la "ventana" blanca) */
        #sticker-modal-content {
            background-color: #f9fafb; /* Un blanco un poco más suave */
            border-radius: 1.5rem; /* Bordes más redondeados */
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.4);
            display: flex;
            flex-direction: column;
            max-width: 600px;
            width: 100%;
            max-height: 85vh; /* Altura máxima para que no ocupe toda la pantalla */
            border: 1px solid rgba(255, 255, 255, 0.1);
            transform: scale(1);
            opacity: 1;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }

        /* Efecto de entrada/salida para el contenido */
        #sticker-modal-container.hidden #sticker-modal-content {
            transform: scale(0.95);
            opacity: 0;
        }


        .dashboard-stat-card {
            background-color: white;
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            border: 1px solid #e5e7eb;
            text-align: center;
        }
        .progress-ring-bg {
            fill: transparent;
            stroke: #e5e7eb;
            stroke-width: 10;
        }
        .progress-ring-fg {
            fill: transparent;
            stroke-width: 10;
            stroke-linecap: round;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
            transition: stroke-dashoffset 0.5s ease-in-out;
        }


        /* 3. La Cuadrícula para los Stickers */
        #sticker-modal-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
            gap: 1rem;
            padding: 1.5rem;
            align-content: start;
            overflow-y: auto; /* Permite scroll si hay muchos stickers */
        }

        /* 4. Título de cada categoría de stickers */
        .sticker-category-title {
            grid-column: 1 / -1; /* Ocupa toda la fila */
            font-size: 0.8rem;
            font-weight: 700;
            color: #f97316; /* Naranja Focux */
            text-transform: uppercase;
            letter-spacing: 0.05em;
            padding-bottom: 0.5rem;
            margin-top: 1rem;
            border-bottom: 2px solid #fed7aa; /* Naranja claro */
        }
        .sticker-category-title:first-child {
            margin-top: 0;
        }

        /* 5. Estilo para cada sticker individual */
        .sticker-item {
            cursor: pointer;
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            padding: 8px;
            border-radius: 12px;
            background-color: rgba(249, 115, 22, 0.05);
            border: 1px solid transparent;
        }

        /* 6. Efecto al pasar el mouse sobre un sticker */
        .sticker-item:hover {
            transform: scale(1.15) rotate(3deg);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.12);
            border-color: #fed7aa;
            background-color: #fff;
        }

        /* 7. Scrollbar personalizado (opcional pero mejora la apariencia) */
        #sticker-modal-grid::-webkit-scrollbar { width: 8px; }
        #sticker-modal-grid::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 10px; }
        #sticker-modal-grid::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        #sticker-modal-grid::-webkit-scrollbar-thumb:hover { background: #94a3b8; }







        .note-empty-state {
            color: #9ca3af;
            font-size: 0.875rem;
            font-style: italic;
            text-align: center;
            padding: 40px 20px;
            background: rgba(156, 163, 175, 0.1);
            border-radius: 8px;
            border: 2px dashed #d1d5db;
        }

        .note-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 12px;
            margin-top: 12px;
            border-top: 1px solid rgba(249, 115, 22, 0.2);
            flex-shrink: 0;
        }

        .note-timestamp {
            font-size: 0.75rem;
            color: #9ca3af;
            font-weight: 500;
        }


 

        .note-actions {
            display: flex;
            gap: 8px;
            align-items: center;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .note-card:hover .note-actions {
            opacity: 1;
        }

        #ai-assistant-filter {
            width: 100%;
            padding: 10px 12px;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            font-size: 0.9rem;
            transition: all 0.2s;
            flex-grow: 1; /* Permite que el filtro ocupe el espacio restante */
        }
        #ai-assistant-filter:focus {
            outline: none;
            border-color: #f97316;
            box-shadow: 0 0 0 2px rgba(249, 115, 22, 0.2);
        }
        #group-chat-btn {
            flex-shrink: 0;
            padding: 10px 12px;
            font-size: 0.9rem;
            font-weight: 600;
            color: white;
            background-color: #f97316;
            border-radius: 8px;
            transition: background-color 0.2s;
        }
        #group-chat-btn:hover {
            background-color: #ea580c;
        }

        .note-edit-btn,
        .note-delete-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 6px;
            border-radius: 6px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .note-edit-btn {
            color: #f97316;
        }


        /* --- INICIO: REEMPLAZA EL BLOQUE DE ESTILOS DEL CALENDARIO CON ESTE --- */

        .calendar-event {
            font-size: 0.8rem;
            padding: 2px 8px; /* Reducir padding vertical */
            border-radius: 4px; /* Un redondeo base sutil */
            margin-bottom: 4px;
            cursor: pointer;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis; /* El texto se cortará con '...' si es muy largo */
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(220, 38, 38, 0.2);
            color: #b91c1c; /* Texto más oscuro para contraste */
            font-weight: 600;
            transition: all 0.2s ease;
            height: 24px; /* Altura fija para alinear barras */
            line-height: 20px; /* Alineación vertical del texto */
        }

        .calendar-event:hover {
            background-color: rgba(220, 38, 38, 0.2);
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        /* Estilo para los segmentos de la barra de eventos */
        .calendar-event.bar-segment {
            border-radius: 0;
            border-left-width: 0;
            border-right-width: 0;
        }

        /* Estilo para el inicio de la barra */
        .calendar-event.bar-start {
            border-top-left-radius: 8px;
            border-bottom-left-radius: 8px;
            border-left-width: 4px; /* Borde inicial distintivo */
            border-color: #dc2626;
        }

        /* Estilo para el final de la barra */
        .calendar-event.bar-end {
            border-top-right-radius: 8px;
            border-bottom-right-radius: 8px;
            border-right-width: 1px;
            border-color: rgba(220, 38, 38, 0.2);
        }

        .gantt-header-days .gantt-cell {
            background-color: #f9fafb;
            font-weight: 600;
            color: #4b5563;
            text-align: center;
            border-bottom: 1px solid #e5e7eb;
            border-left: 1px solid #e5e7eb;
            white-space: nowrap;
        }

        .gantt-chart {
            display: grid;
            font-size: 12px;
            width: max-content;
            min-width: 100%;
            border-collapse: collapse;
        }


        /* 1. MODIFICAR: El contenedor principal ya no tendrá el scroll ni el padding. */
        #gantt-container.active {
            display: flex;
            flex-direction: column;
            overflow: hidden; /* El scroll ya no se gestiona aquí */
            padding: 0 !important; /* Anula las clases de padding del HTML */
        }

        /* 2. AÑADIR: Se aplica el padding al título para mantener el diseño. */
        #gantt-container > .flex-shrink-0 {
            padding: 1.5rem;
        }

        /* 3. AÑADIR: El nuevo contenedor de scroll será el wrapper del gráfico. */
        #gantt-chart-wrapper {
            overflow: auto; /* <-- El scroll se mueve a este elemento */
            padding: 0 1.5rem 1.5rem 1.5rem; /* Padding para el contenido del gráfico */
            flex-grow: 1;
        }

        /* 4. MODIFICAR: La cabecera ahora se pegará al borde superior de su nuevo contenedor de scroll. */
        .gantt-header-days {
            position: sticky;
            top: 0;
            z-index: 30;
        }

        .gantt-header-days, .gantt-task-row {
            display: grid;
            grid-template-columns: 280px auto; /* Aumentado a 280px para más espacio */
        }

        .gantt-header-days .gantt-cell.gantt-task-header {
            position: sticky;
            left: 0;
            z-index: 40; /* El más alto para la esquina */
            background-color: #ffffff;
            border-right: 1px solid #e5e7eb;
            border-bottom: 1px solid #e5e7eb;
        }

        .gantt-timeline {
            display: grid;
            background-color: #f9fafb;
            border-bottom: 1px solid #e5e7eb;
        }

        .gantt-day-header-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-right: 1px solid #e5e7eb;
            padding: 6px 0;
            font-size: 11px;
            color: #4b5563;
        }
        .gantt-day-header-item.is-weekend {
            background-color: #f3f4f6;
        }
        .gantt-day-header-item span:first-child {
            font-weight: 600;
        }

        /* --- Filas de Tareas y Subtareas --- */
        .gantt-task-row {
            border-bottom: 1px solid #f3f4f6;
        }

        .gantt-task-name, .gantt-subtask-name {
            position: sticky;
            left: 0;
            z-index: 20;
            padding: 10px 12px;
            border-right: 1px solid #e5e7eb;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: flex;
            align-items: center;
        }

        /* Efecto "Zebra" para mejorar legibilidad */
        .gantt-task-row:nth-child(odd) .gantt-task-name,
        .gantt-task-row:nth-child(odd) .gantt-subtask-name,
        .gantt-task-row:nth-child(odd) .gantt-bars-container {
            background-color: #f9fafb;
        }
        .gantt-task-row:nth-child(even) .gantt-task-name,
        .gantt-task-row:nth-child(even) .gantt-subtask-name,
        .gantt-task-row:nth-child(even) .gantt-bars-container {
            background-color: #ffffff;
        }
        .gantt-task-name:hover {
            background-color: #fef2f2 !important;
        }
        
        .gantt-task-name {
            font-weight: 600;
            color: #1f2937;
            cursor: pointer;
        }
        .gantt-subtask-name {
            padding-left: 32px; /* Mayor indentación */
            color: #4b5563;
            font-size: 11px;
        }
        .gantt-subtask-name .subtask-icon {
            width: 8px;
            height: 8px;
            margin-right: 10px;
            border-radius: 2px;
            opacity: 0.8;
        }

        /* --- Contenedor de las Barras (Línea de Tiempo) --- */
        .gantt-bars-container {
            position: relative;
            display: grid;
        }
        /* Se ocultan las líneas verticales generadas por JS para usar un fondo más limpio */
        .gantt-bars-container .gantt-day-line {
            display: none; 
        }
        .gantt-bars-container .gantt-day-line.is-weekend {
            background-color: #f9fafb;
            display: block; /* Mantenemos solo el sombreado de fin de semana */
            border: none;
        }

        /* --- Barras de Tareas y Subtareas --- */
        .gantt-task-bar, .gantt-subtask-bar {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .gantt-task-bar:hover, .gantt-subtask-bar:hover {
            filter: brightness(1.1);
            transform: translateY(-50%) scaleY(1.05);
            box-shadow: 0 3px 6px rgba(0,0,0,0.15);
        }

        .gantt-task-bar {
            height: 24px;
            background: linear-gradient(to right, #fb923c, #f97316); /* Gradiente Naranja */
            border: 1px solid rgba(0,0,0,0.1);
        }
        .gantt-subtask-bar {
            height: 12px;
            background-color: #fbbf24; /* Amarillo/Naranja más claro */
        }

        .gantt-task-bar.completed {
            background: linear-gradient(to right, #4ade80, #22c55e); /* Gradiente Verde */
        }
        .gantt-subtask-bar.completed {
            background-color: #86efac; /* Verde claro */
        }

        .gantt-bar-label {
            padding: 0 8px;
            white-space: nowrap;
            color: white;
            font-weight: 500;
            font-size: 11px;
            text-shadow: 0 1px 1px rgba(0,0,0,0.3);
        }


        .gantt-task-row:last-child {
            border-bottom: none;
        }

        .gantt-task-bar:hover {
            opacity: 0.8;
            transform: translateY(-50%) scale(1.05);
        }

        .gantt-bar-label {
            padding: 0 8px;
            white-space: nowrap;
            color: white;
            font-weight: 500;
            font-size: 11px;
        }
        /* --- END: BLOCK TO ADD --- */

        .note-edit-btn:hover {
            background-color: rgba(249, 115, 22, 0.1);
            color: #ea580c;
        }

        .note-delete-btn {
            color: #ef4444;
        }

        .note-delete-btn:hover {
            background-color: #fee2e2;
            color: #dc2626;
        }

        /* Estilos para el editor Trix en el modal */
        .note-trix-editor {
            min-height: 300px;
        }

        .note-trix-editor trix-toolbar {
            background: #f9fafb;
            border-bottom: 1px solid #e5e7eb;
            padding: 12px;
        }

        .note-trix-editor trix-toolbar .trix-button-group {
            margin-bottom: 0;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            overflow: hidden;
        }

        .note-trix-editor trix-toolbar .trix-button {
            background: white;
            border: none;
            color: #374151;
            padding: 8px 12px;
            transition: all 0.2s;
        }

        .note-trix-editor trix-toolbar .trix-button:hover {
            background: #f3f4f6;
        }

        .note-trix-editor trix-toolbar .trix-button.trix-active {
            background: #f97316;
            color: white;
        }

        .note-trix-editor trix-editor {
            padding: 20px;
            min-height: 280px;
            font-family: 'Inter', sans-serif;
            line-height: 1.6;
        }

        /* Estilos para imágenes en el editor de notas */
        .note-trix-editor trix-editor img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin: 10px 0;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .note-trix-editor trix-editor img:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        #calendar-grid {
            flex-grow: 1;
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            grid-template-rows: auto repeat(6, 1fr);
            gap: 4px;
            min-height: 0;
        }

        .calendar-day-name {
            text-align: center;
            font-weight: 600;
            font-size: 0.875rem;
            color: #4b5563;
            padding-bottom: 0.5rem;
        }

        .calendar-day {
            background-color: white;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 0.5rem;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .calendar-day.other-month {
            background-color: #f9fafb;
            color: #9ca3af;
        }
        .day-number {
            font-weight: 500;
            margin-bottom: 0.25rem;
            flex-shrink: 0;
        }

        #eisenhower-container {
            position: absolute;
            inset: 0;
            display: none;
            flex-direction: column;
        }

        #eisenhower-container.active {
            display: flex;
        }


        .view-dropdown {
            position: relative;
            display: inline-block;
        }

        .view-dropdown-button {
            min-width: 140px;
        }

        .view-dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background-color: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            z-index: 50;
            margin-top: 4px;
        }

        .view-dropdown-item {
            transition: background-color 0.2s ease;
        }

        .view-dropdown-item.active {
            background-color: #fee2e2;
            color: #dc2626;
            font-weight: 600;
        }


        /* Estilos mejorados para la Matriz de Eisenhower - Estilo Kanban */
        .eisenhower-quadrant {
            background-color: rgba(255, 255, 255, 0.85);
            transition: all 0.2s ease;
        }

        .eisenhower-quadrant:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .eisenhower-header {
            transition: all 0.2s ease;
        }

        .eisenhower-content::-webkit-scrollbar {
            width: 8px;
        }

        .eisenhower-content::-webkit-scrollbar-track {
            background: transparent;
        }

        .eisenhower-content::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 10px;
        }

        .eisenhower-content::-webkit-scrollbar-thumb:hover {
            background: #a0aec0;
        }

        .eisenhower-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .eisenhower-card:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border-color: #f97316;
        }

        .eisenhower-card .font-semibold {
            color: #1f2937;
            font-size: 14px;
            font-weight: 600;
            line-height: 1.4;
            margin-bottom: 8px;
        }

        .eisenhower-card .flex {
            margin-top: 6px;
        }


        .dashboard-card {
            background-color: white;
            border-radius: 1rem; /* 16px */
            padding: 1.5rem; /* 24px */
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.05), 0 2px 4px -2px rgb(0 0 0 / 0.05);
            border: 1px solid #e5e7eb; /* gray-200 */
            display: flex;
            flex-direction: column;
            transition: all 0.2s ease-in-out;
        }
        .dashboard-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        .dashboard-card-title {
            font-size: 1rem; /* 16px */
            font-weight: 700;
            color: #1f2937; /* gray-800 */
            margin-bottom: 1rem; /* 16px */
            flex-shrink: 0;
        }

        /* Estilo para las tarjetas de KPIs (indicadores principales) */
        .dashboard-kpi-card {
            background-color: white;
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.05), 0 2px 4px -2px rgb(0 0 0 / 0.05);
            border: 1px solid #e5e7eb;
            text-align: left;
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
            transition: all 0.2s ease-in-out;
        }
        .dashboard-kpi-card:hover {
            transform: translateY(-4px);
            border-color: #f97316; /* orange-500 */
            box-shadow: 0 10px 15px -3px rgb(249 115 22 / 0.1), 0 4px 6px -4px rgb(249 115 22 / 0.1);
        }
        .kpi-icon {
            width: 3rem; /* 48px */
            height: 3rem; /* 48px */
            border-radius: 0.75rem; /* 12px */
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 0.75rem;
        }
        .kpi-icon svg {
            width: 1.75rem;
            height: 1.75rem;
        }
        .kpi-title {
            font-size: 0.875rem; /* 14px */
            font-weight: 600;
            color: #4b5563; /* gray-600 */
        }
        .kpi-value {
            font-size: 2.25rem; /* 36px */
            font-weight: 800;
            line-height: 1.1;
            color: #111827; /* gray-900 */
        }
        .kpi-description {
            font-size: 0.75rem; /* 12px */
            color: #6b7280; /* gray-500 */
        }

        /* Estilo para las listas dentro de las tarjetas */
        .dashboard-list {
            overflow-y: auto;
            flex-grow: 1;
            padding-right: 0.5rem; /* Espacio para el scrollbar */
        }

        /* Scrollbar personalizado para las listas */
        .dashboard-list::-webkit-scrollbar { width: 6px; }
        .dashboard-list::-webkit-scrollbar-track { background: transparent; }
        .dashboard-list::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .dashboard-list::-webkit-scrollbar-thumb:hover { background: #a0aec0; }


        .emoji-category-btn {
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 18px;
            min-width: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .emoji-category-btn:hover {
            background: #f3f4f6;
            border-color: #d1d5db;
        }

        .emoji-category-btn.active {
            background: #3b82f6;
            border-color: #3b82f6;
            color: white;
        }

        .emoji-item {
            padding: 8px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 44px;
        }

        .emoji-item:hover {
            background: #f3f4f6;
            transform: scale(1.1);
        }

        .eisenhower-card .flex span {
            font-size: 11px;
            font-weight: 500;
            padding: 2px 8px;
            border-radius: 9999px;
        }


        @keyframes pulse-red {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.7;
            }
        }

        /* 1. Las pestañas del chat (selector) siempre deben estar visibles. */
        #chat-mode-selector {
            display: flex;
        }

        /* 2. Por defecto, todas las VISTAS de contenido del chat están ocultas. */
        .chat-view {
            display: none;
        }

        /* 3. La vista que tenga la clase '.active' (controlada por JS) será la que se muestre. */
        .chat-view.active {
            display: flex;
        }

        /* 4. En tableros que NO son compartidos, se oculta ÚNICAMENTE la pestaña de "Chat Grupal". */
        #chat-box.is-solo-board #chat-mode-board {
            display: none;
        }
        .eisenhower-badge {
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.8; }
        }

        .eisenhower-description {
            backdrop-filter: blur(2px);
        }

        /* Drag and drop feedback para Eisenhower */
        .eisenhower-quadrant.bg-gray-200\/50 {
            background-color: rgba(229, 231, 235, 0.5);
            transform: scale(1.02);
        }

        @media (max-width: 768px) {
            html, body {
                height: auto;
                overflow: auto;
            }
            main {
                flex-grow: 1;
                overflow-y: auto;
                padding-top: 72px; /* Ajuste manual para dar espacio al encabezado */
                position: relative;
            }


            #kanban-board-container,
            #calendar-container {
                position: absolute;
                inset: 0;
                display: none;
                flex-direction: column;
            }

            #eisenhower-container {
                position: absolute;
                inset: 0;
                display: none;
                flex-direction: column;
            }

            #kanban-board-container.active,
            #calendar-container.active {
                display: flex;
            }

            #eisenhower-container.active {
                display: flex;
            }

            /* Modificación clave para apilar columnas verticalmente */
            #kanban-board {
                display: block;
                padding: 1.5rem;
                width: 100%;
                height: auto;
                margin-bottom: 4rem;
                overflow-x: hidden;
                overflow-y: auto;
            }

            .kanban-column {
                /* Volvemos al método flexbox para la estructura interna, que es
                   ideal para mantener el pie de página fijo abajo. */
                display: flex;
                flex-direction: column;

                /* Ahora que el padre tiene una altura de fila definida,
                   el height: 100% funcionará correctamente. */
                height: 100%;
                max-height: 100%;
                min-height: 0; /* Asegura la compatibilidad del overflow. */
            }

            /* Estilos responsive de la Matriz de Eisenhower */
            #eisenhower-container .grid {
                grid-template-rows: repeat(4, minmax(200px, 1fr));
                grid-template-columns: 1fr;
                gap: 16px;
            }
            
            .eisenhower-quadrant {
                min-height: 200px;
            }
            
            .eisenhower-header h3 {
                font-size: 14px;
            }
            
            .eisenhower-badge {
                font-size: 10px;
                padding: 1px 6px;
            }

            #calendar-grid {
                grid-template-rows: auto repeat(6, minmax(100px, auto));
            }
            .calendar-event {
                font-size: 0.75rem;
                padding: 2px 4px;
            }
            #mr-focus-container {
                bottom: 10px;
                right: 10px;
            }
            .board-selector {
                margin-left: 0;
                margin-top: 8px;
            }
        }

        .calendar-day.today .day-number {
            background-color: #dc2626;
            color: white;
            border-radius: 9999px;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .calendar-events {
            flex-grow: 1;
            overflow-y: auto;
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .calendar-events::-webkit-scrollbar {
             display: none;
        }

        .calendar-day.has-events {
            background-color: white;
            box-shadow: inset 0 0 0 0.5px #dc2626;
            backdrop-filter: saturate(150%) blur(2px);
            border-color: #dc2626;
            transition: background-color 0.3s ease;
        }

        .calendar-event {
            font-size: 0.8rem;
            padding: 6px 10px;
            border-radius: 8px;
            margin-bottom: 4px;
            cursor: pointer;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            background: rgba(239, 68, 68, 0.1);
            border-left: 4px solid #dc2626;
            color: #fffff;
            font-weight: 500;
            transition: background-color 0.2s ease, transform 0.2s ease;
        }




        .assigned-avatar {
            width: 28px;
            height: 28px;
            /* --- CAMBIO PRINCIPAL: De círculo a cuadrado redondeado --- */
            border-radius: 6px; /* en lugar de 9999px */
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
            border: 2px solid rgba(255, 255, 255, 0.8);
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.2);
            text-transform: uppercase;
            transition: all 0.2s ease-in-out;
            position: relative;
        }

        .assigned-avatar:hover {
            transform: scale(1.15) translateY(-2px);
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.25);
            z-index: 10;
        }

        .assignee-selector-item {
            display: flex;
            align-items: center;
            width: 100%;
            padding: 8px;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            margin-bottom: 8px; /* Espacio entre items */
        }
        .assignee-selector-item:hover {
            background-color: #f9fafb;
            border-color: #d1d5db;
        }
        .assignee-selector-item.selected {
            background-color: #fff7ed;
            border-color: #f97316;
            box-shadow: 0 0 0 1px #f97316;
        }
        .assigned-avatar-large { /* Para el modal selector */
            width: 32px;
            height: 32px;
            font-size: 14px;
            border-radius: 8px;
        }
        .assignee-selector-item .check-icon {
            opacity: 0;
            transform: scale(0.5);
            transition: all 0.2s ease-in-out;
        }
        .assignee-selector-item.selected .check-icon {
            opacity: 1;
            transform: scale(1);
        }




        .assignee-item {
            cursor: pointer;
            transition: all 0.2s ease;
            padding: 4px;
            border: 2px solid transparent;
            /* --- CAMBIO PRINCIPAL: Ajustar el contenedor del selector --- */
            border-radius: 8px; /* en lugar de 50% */
        }

        .assignee-item.selected {
            border-color: #f97316;
            background-color: #fff7ed;
        }


        .calendar-event:hover {
            background-color: rgba(220, 38, 38, 0.1);
            transform: scale(1.02);
        }

        /* View Switcher Styles */
        .view-switcher {
            display: inline-flex;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            overflow: hidden;
        }
        .view-switcher button {
            padding: 0.5rem 1rem;
            background-color: #ffffff;
            color: #374151;
            font-size: 0.875rem;
            font-weight: 500;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s;
        }
        .view-switcher button.active {
            background-color: #f97316; /* Cambiado de #dc2626 */
            color: #ffffff;
        }

        .view-switcher button:not(:last-child) {
            border-right: 1px solid #d1d5db;
        }

        /* Board Selector Styles */
        .board-selector {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            margin-left: 16px;
        }

        .board-dropdown {
            position: relative;
        }


        /* --- ESTILOS DEL LOADER DE FOCUX (REEMPLAZAR ANTERIORES) --- */
        #loader-view {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            background-color: #FFFFFF;
            z-index: 9999;
        }

        .focux-loader {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 5px; /* Espacio entre las barras */
            height: 80px;
        }

        .focux-loader .bar {
            width: 18px;
            height: 45px;
            border-radius: 3px;
            background: linear-gradient(45deg, #0057B7, #4DA8DA);
            animation: focux-loading-animation 0.8s infinite ease-in-out;
        }

        .focux-loader .bar:nth-child(2) {
            background: linear-gradient(45deg, #4DA8DA, #0057B7);
            animation-delay: 0.16s;
        }

        .focux-loader .bar:nth-child(3) {
            background: linear-gradient(45deg, #FFC148, #FFA500);
            animation-delay: 0.32s;
        }

        .focus-text {
            text-align: center;
            margin-top: 30px;
            font-family: 'Arial', sans-serif;
            font-size: 28px;
            font-weight: bold;
            color: #0057B7;
            letter-spacing: 3px;
            text-transform: uppercase;
        }

        @keyframes focux-loading-animation {
            0%, 80%, 100% {
                opacity: .75;
                box-shadow: 0 0 transparent;
                height: 45px;
                transform: scaleY(1);
            }
            40% {
                opacity: 1;
                box-shadow: 0 -10px rgba(0, 0, 0, 0.1);
                height: 55px;
                transform: scaleY(1.25);
            }
        }

        .loader {
            position: relative;
            width: 120px;
            height: 80px;
        }
        
        .jimu-primary-loading:before,
        .jimu-primary-loading:after {
            position: absolute;
            top: 0;
            content: '';
        }

        .jimu-primary-loading:before {
            left: -25px;
            background: linear-gradient(45deg, #4DA8DA, #0057B7);
        }

        .jimu-primary-loading:after {
            left: 25px;
            background: linear-gradient(45deg, #FFC148, #FFA500);
            -webkit-animation-delay: 0.32s !important;
            animation-delay: 0.32s !important;
        }

        .jimu-primary-loading:before,
        .jimu-primary-loading:after,
        .jimu-primary-loading {
            -webkit-animation: loading-keys-app-loading 0.8s infinite ease-in-out;
            animation: loading-keys-app-loading 0.8s infinite ease-in-out;
            width: 18px;
            height: 45px;
            border-radius: 3px;
        }

        .jimu-primary-loading {
            background: linear-gradient(45deg, #0057B7, #4DA8DA);
            text-indent: -9999em;
            margin: auto;
            position: absolute;
            right: calc(50% - 9px);
            top: calc(50% - 22.5px);
            -webkit-animation-delay: 0.16s !important;
            animation-delay: 0.16s !important;
        }

        @-webkit-keyframes loading-keys-app-loading {
            0%, 80%, 100% {
                opacity: .75;
                box-shadow: 0 0 transparent;
                height: 45px;
                transform: scaleY(1);
            }
            40% {
                opacity: 1;
                box-shadow: 0 -10px rgba(0, 0, 0, 0.1);
                height: 55px;
                transform: scaleY(1.25);
            }
        }


        .template-card {
            background-color: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 16px;
            display: flex;
            flex-direction: column;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .template-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 25px -5px rgba(249, 115, 22, 0.2), 0 8px 10px -6px rgba(249, 115, 22, 0.2);
            border-color: #f97316; /* Naranja Focux */
        }
        .template-card img {
            width: 100%;
            height: 150px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 16px;
            border: 1px solid #e5e7eb;
        }
        .template-card h3 {
            font-size: 1.1rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 8px;
        }
        .template-card .columns-desc {
            font-size: 0.8rem;
            font-weight: 600;
            color: #4b5563;
            background-color: #f3f4f6;
            padding: 6px 10px;
            border-radius: 6px;
            margin-bottom: 12px;
            text-align: center;
        }
        .template-card .desc-block {
            font-size: 0.8rem;
            color: #6b7280;
            line-height: 1.5;
            margin-top: auto; /* Empuja este bloque al final */
        }
        .template-card .desc-block strong {
            color: #374151;
            display: block;
            margin-top: 10px;
        }

        @keyframes loading-keys-app-loading {
            0%, 80%, 100% {
                opacity: .75;
                box-shadow: 0 0 transparent;
                height: 45px;
                transform: scaleY(1);
            }
            40% {
                opacity: 1;
                box-shadow: 0 -10px rgba(0, 0, 0, 0.1);
                height: 55px;
                transform: scaleY(1.25);
            }
        }

        .focus-text {
            text-align: center;
            margin-top: 30px;
            font-family: 'Arial', sans-serif;
            font-size: 28px;
            font-weight: bold;
            color: #0057B7;
            letter-spacing: 3px;
            text-transform: uppercase;
        }


        .board-dropdown-button {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px;
            background-color: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            color: #334155;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 180px;
        }




        .board-dropdown-button:hover {
            background-color: #f1f5f9;
            border-color: #cbd5e1;
        }


        .board-category-tag:hover {
            transform: scale(1.05);
            opacity: 0.9;
        }
        .board-category-personal {
            background-color: #dbeafe; /* blue-200 */
            color: #1e40af; /* blue-800 */
            border-color: #93c5fd; /* blue-300 */
        }
        .board-category-laboral {
            background-color: #dcfce7; /* green-200 */
            color: #166534; /* green-800 */
            border-color: #86efac; /* green-300 */
        }


        #ai-assistant-trigger {
            display: none !important;
        }

        /* <-- AÑADE ESTE BLOQUE NUEVO --> */
        .board-category-institucional {
            background-color: #f3e8ff; /* purple-100 */
            color: #581c87; /* purple-900 */
            border-color: #d8b4fe; /* purple-300 */
        }

        .board-dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background-color: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            z-index: 50;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 4px;
        }

        #board-filter-input {
            padding: 8px 12px;
            width: calc(100% - 16px);
            margin: 8px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            font-size: 14px;
            outline: none;
        }
        #board-filter-input:focus {
            border-color: #f97316;
            box-shadow: 0 0 0 1px #f97316;
        }
        .board-section-header {
            padding: 8px 16px 4px;
            font-size: 11px;
            font-weight: 600;
            color: #94a3b8;
            text-transform: uppercase;
            border-top: 1px solid #f1f5f9;
        }

        .board-name-text {
            font-weight: 500;
            color: #334155; /* slate-700 */
        }

        .indicator-content {
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .board-meta-container {
            display: flex;
            align-items: center; /* Alinea verticalmente la etiqueta y el contador */
            gap: 8px; /* Espacio entre las etiquetas */
            margin-top: 6px;
        }

        .board-category-tag {
            font-size: 10px;
            font-weight: 600;
            padding: 2px 8px;
            border-radius: 9999px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid transparent;
            /* Se eliminó align-self y margin-top de aquí para un control centralizado */
        }

        .board-category-shared {
            background-color: #f1f5f9; /* slate-100 */
            color: #475569; /* slate-600 */
            border-color: #e2e8f0; /* slate-200 */
            cursor: default; /* No es clickeable */
        }
        .board-category-shared:hover {
            transform: none; /* No tiene efecto hover */
            opacity: 1;
        }

        .board-dropdown-item {
            display: flex;
            align-items: flex-start; /* Alinear al tope para nombres largos */
            justify-content: space-between;
            padding: 12px 16px;
            font-size: 14px;
            color: #334155;
            cursor: pointer;
            transition: background-color 0.2s ease;
            border-bottom: 1px solid #f1f5f9;
        }

        .board-dropdown-item:last-child {
            border-bottom: none;
        }

        .board-dropdown-item:hover {
            background-color: #f8fafc;
        }

        .board-dropdown-item.active {
            background-color: #fee2e2;
            color: #dc2626;
            font-weight: 600;
        }

        .create-board-item {
            background-color: #fefefe;
            border-top: 1px solid #e2e8f0;
            color: #dc2626;
            font-weight: 600;
        }

        .create-board-item:hover {
            background-color: #fee2e2;
        }

        .delete-board-btn {
            color: #ef4444;
            opacity: 0;
            transition: opacity 0.2s ease;
            padding: 4px;
            border-radius: 4px;
        }


        .focux-message-content {
            font-size: 0.875rem;
            line-height: 1.5;
        }

        .focux-message-content h1,
        .focux-message-content h2,
        .focux-message-content h3 {
            margin-top: 8px;
            margin-bottom: 4px;
        }

        .focux-message-content p {
            margin: 4px 0;
        }

        .focux-message-content strong {
            font-weight: 700;
            color: #1f2937;
        }

        .focux-message-content em {
            font-style: italic;
            color: #4b5563;
        }


        #mr-focus-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 30;
            display: flex;
            align-items: flex-end;
            flex-direction: row;
            gap: 15px;
        }

        #mr-focus-tip {
            background-color: #f3f4f6;
            color: #1f2937;
            padding: 12px 18px;
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
            /* --- INICIO DE LA MODIFICACIÓN --- */
            max-width: 320px; /* Ancho máximo aumentado a 320px */
            /* --- FIN DE LA MODIFICACIÓN --- */
            font-size: 1rem;
            opacity: 0;
            transform: translateX(10px);
            transition: opacity 0.3s ease-out, transform 0.3s ease-out;
            position: relative;
            border: 1px solid #e5e7eb;
            line-height: 1.4;
        }

        #mr-focus-tip::after {
            content: '';
            position: absolute;
            bottom: 20px;
            left: 100%;
            width: 0;
            height: 0;
            border-top: 10px solid transparent;
            border-bottom: 10px solid transparent;
            border-left: 10px solid #f3f4f6;
        }
        
        #mr-focus-tip.show {
            opacity: 1;
            transform: translateX(0);
        }

        #mr-focus-avatar {
            width: 80px;
            height: 100px;
            border-radius: 0%;
            background-color: transparent;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.2s ease-in-out;
            flex-shrink: 0;
        }

        #mr-focus-avatar:hover {
            transform: scale(1.05);
        }

        #mr-focus-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        /* --- INICIO DE LA MODIFICACIÓN --- */
        #mr-focus-tip {
            max-width: 320px; /* Ancho máximo aumentado a 320px */
            word-wrap: break-word;
        }

        #mr-focus-tip img {
            max-height: 100px; /* Altura máxima de la imagen reducida a 100px */
            width: 100%;
            object-fit: cover;
        }

        /* TimeBoxing Styles */
        .TimeBoxing-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(251, 146, 60, 0.95);
            z-index: 9999;
            display: none;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }

        .TimeBoxing-modal {
            background: white;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);
            text-align: center;
            max-width: 500px;
            margin: 0 20px;
        }

        .timer-container {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 10000;
            background: rgba(220, 38, 38, 0.95); /* Cambiado a rojo */
            padding: 15px 25px;
            border-radius: 15px;
            color: white;
            font-weight: bold;
            font-size: 18px;
            box-shadow: 0 8px 25px rgba(220, 38, 38, 0.4); /* Sombra roja */
            border: 2px solid #dc2626; /* Borde rojo */
            max-width: 400px;
            text-align: center;
        }

        /* Estilos para imágenes en el editor de notas */
        .note-trix-editor trix-editor img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin: 10px 0;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .note-trix-editor trix-editor img:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        /* Indicador visual para drag and drop */
        .note-trix-editor trix-editor.drag-over {
            background-color: rgba(249, 115, 22, 0.05);
            border-color: #f97316;
        }

        /* Estilos para la zona de drop */
        .note-trix-editor trix-editor::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            border: 2px dashed transparent;
            border-radius: 8px;
            pointer-events: none;
            transition: border-color 0.2s ease;
        }

        .note-trix-editor trix-editor.drag-over::before {
            border-color: #f97316;
        }


        .assignee-item {
            cursor: pointer;
            transition: all 0.2s ease;
            padding: 4px;
            border: 2px solid transparent;
            border-radius: 50%;
        }

        .assignee-item.selected {
            border-color: #f97316;
            background-color: #fff7ed;
        }

        #timer-text {
            text-align: center;
            font-family: 'Inter', monospace;
            font-size: 16px;
            font-weight: 700;
            line-height: 1.4;
        }

        .chat-mode-btn {
            background-color: #e5e7eb; /* gris claro */
            color: #4b5563; /* gris oscuro */
            transition: all 0.2s ease-in-out;
        }
        .chat-mode-btn.active {
            background-color: #f97316; /* naranja */
            color: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        /* Por defecto, todas las vistas de chat están ocultas. */
        .chat-view {
            display: none;
        }
        /* La vista con la clase .active se mostrará. */
        .chat-view.active {
            display: flex;
        }

        /* En tableros que NO son compartidos (solo), OCULTAMOS únicamente el botón de "Chat Grupal". */
        #chat-box.is-solo-board #chat-mode-board {
            display: none;
        }


        .conversation-list-item {
            display: flex;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid #f3f4f6; /* slate-100 */
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .conversation-list-item:hover {
            background-color: #f9fafb; /* slate-50 */
        }
        .conversation-list-item .chat-avatar {
            width: 40px;
            height: 40px;
            margin-right: 12px;
        }


        /* Quitar completamente el loader animado */
        .loader {
            display: none;
        }

        /* ESTILOS PARA EL CHAT DE IA */
        #ai-chat-messages::-webkit-scrollbar { width: 6px; }
        #ai-chat-messages::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .ai-chat-message { max-width: 85%; display: flex; gap: 10px; }
        .ai-chat-bubble { padding: 10px 16px; border-radius: 20px; line-height: 1.5; }
        .from-user { align-self: flex-end; flex-direction: row-reverse; }
        .from-user .ai-chat-bubble { background-color: #f97316; color: white; border-bottom-right-radius: 5px; }
        .from-ai { align-self: flex-start; }
        .from-ai .ai-chat-bubble { background-color: #ffffff; color: #1f2937; border: 1px solid #e5e7eb; border-bottom-left-radius: 5px; }

        .from-ai .ai-avatar { width: 32px; height: 32px; border-radius: 50%; flex-shrink: 0; }
        
        .typing-indicator span { height: 8px; width: 8px; background-color: #9ca3af; border-radius: 50%; display: inline-block; animation: wave 1.4s infinite ease-in-out both; }
        .typing-indicator span:nth-of-type(1) { animation-delay: -0.32s; }
        .typing-indicator span:nth-of-type(2) { animation-delay: -0.16s; }

        @keyframes wave { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1.0); } }

        .scheduled-TimeBoxing-card {
            position: relative;
            overflow: visible;
            transition: all 0.3s ease;
        }

        .scheduled-TimeBoxing-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(249, 115, 22, 0.25) !important;
        }

        .scheduled-TimeBoxing-card::before {
            content: '';
            position: absolute;
            top: -1px;
            left: -1px;
            right: -1px;
            bottom: -1px;
            background: linear-gradient(45deg, #f97316, #fb923c, #f97316, #fb923c);
            border-radius: 0.5rem;
            z-index: -1;
            background-size: 400% 400%;
            animation: gradientShift 3s ease infinite;
        }

        @keyframes borderGlow {
            0% { opacity: 0.5; }
            100% { opacity: 0.8; }
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .loader::before,
        .loader::after {
            content: "12 00 23 40 31 45 60 17 45 32 29 42 50 08 14 07 46 11 03 55";
            font-size: 30px;
            font-family: monospace;
            font-weight: bold;
            line-height: 1em;
            height: 1em;
            width: 2ch;
            color: #0000;
            text-shadow: 0 0 0 #000;
            overflow: hidden;
            margin: 5px 10px;
            animation: l3 1s steps(20) infinite;
        }

        .loader::before {
            animation-duration: 1.5s;
        }

        @keyframes l3 {
            100% {
                text-shadow: 0 -20em 0 #000
            }
        }

        .screen-flash {
            animation: flash 0.5s ease-in-out 3;
        }

        @keyframes flash {
            0%, 100% { background-color: transparent; }
            50% { background-color: rgba(251, 146, 60, 0.8); }
        }

        .TimeBoxing-section {
            border-top: 1px solid #e5e7eb;
            padding-top: 1rem;
            margin-top: 1rem;
        }

        .TimeBoxing-card {
            border: 2px solid #f97316 !important;
            background: linear-gradient(135deg, #fff7ed, #fed7aa) !important;
        }

        .TimeBoxing-badge {
            background: #f97316;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: bold;
            display: inline-block;
            margin-bottom: 8px;
        }


        .board-dropdown-item:hover .delete-board-btn {
            opacity: 1;
        }

        .delete-board-btn:hover {
            background-color: #fee2e2;
        }

        /* Loading spinner */
        .loading-spinner {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #dc2626;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Auto-save indicator */
        .auto-save-indicator {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .chat-mode-btn {
            flex: 1;
            padding: 6px 12px;
            font-size: 13px;
            font-weight: 600;
            border-radius: 6px;
            background-color: #e5e7eb;
            color: #4b5563;
            transition: all 0.2s ease-in-out;
        }
        .chat-mode-btn.active {
            background-color: #f97316;
            color: white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .chat-view {
            display: none;
            flex-grow: 1;
            min-height: 0;
            flex-direction: column;
        }


        /* Estilos para el input y botón de enviar */
        .chat-input-field {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.2s;
        }
        .chat-input-field:focus {
            outline: none;
            border-color: #f97316;
            box-shadow: 0 0 0 1px #f97316;
        }
        .chat-send-btn {
            padding: 8px;
            background-color: #f97316;
            color: white;
            border-radius: 8px;
            transition: background-color 0.2s;
        }
        .chat-send-btn:hover {
            background-color: #ea580c;
        }

        /* Mejoras a la lista de usuarios y conversaciones */
        .user-directory-item, .conversation-list-item {
            display: flex;
            align-items: center;
            padding: 12px;
            border-bottom: 1px solid #f3f4f6;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .user-directory-item:hover, .conversation-list-item:hover {
            background-color: #f9fafb;
        }

        /* Cabecera de la conversación general */
        #conversation-header {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background-color: #f9fafb;
            border-bottom: 1px solid #e5e7eb;
        }
        #back-to-directory-btn {
            padding: 6px;
            border-radius: 9999px;
            transition: background-color 0.2s;
        }
        #back-to-directory-btn:hover {
            background-color: #e5e7eb;
        }  

        .auto-save-indicator.saving {
            background-color: #fef3c7;
            color: #d97706;
        }

        .auto-save-indicator.saved {
            background-color: #dbeafe;
            color: #2563eb;
        }

        .auto-save-indicator.error {
            background-color: #fee2e2;
            color: #dc2626;
        }

        .chat-message-wrapper {
            display: flex;
            margin-bottom: 2px;
            max-width: 85%;
            align-items: flex-end;
        }
        .chat-message-wrapper.from-me {
            align-self: flex-end;
            flex-direction: row-reverse;
        }
        .chat-message-wrapper.from-others {
            align-self: flex-start;
        }
        .chat-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
            font-weight: 600;
            text-transform: uppercase;
            color: white;
            margin: 0 8px;
            flex-shrink: 0;
            opacity: 1;
            transition: opacity 0.3s;
        }
        .chat-message-wrapper.grouped .chat-avatar {
            opacity: 0;
        }
        .chat-content {
            display: flex;
            flex-direction: column;
        }
        .chat-sender-name {
            font-size: 11px;
            font-weight: 600;
            margin-bottom: 4px;
            color: #4b5563;
        }
        .from-me .chat-sender-name {
            text-align: right;
            margin-right: 12px;
        }
        .from-others .chat-sender-name {
            margin-left: 12px;
        }
        .chat-bubble {
            padding: 10px 16px;
            border-radius: 20px;
            line-height: 1.5;
            position: relative;
        }
        .from-me .chat-bubble {
            background-color: #f97316;
            color: white;
            border-bottom-right-radius: 5px;
        }
        .from-others .chat-bubble {
            background-color: #e5e7eb;
            color: #1f2937;
            border-bottom-left-radius: 5px;
        }
        .chat-message-wrapper.grouped .chat-sender-name {
            display: none;
        }

        .progress-bar-container {
            width: 100%;
            height: 8px; /* Altura de la barra de fondo */
            background-color: #e5e7eb; /* gris-200 */
            border-radius: 9999px;
            margin-top: 0.75rem; /* 12px */
            overflow: hidden; /* Asegura que la barra interior no se salga */
        }

        .progress-bar {
            height: 100%;
            background-color: #f97316; /* Naranja Focux (orange-500) */
            border-radius: 9999px;
            width: 0%; /* Inicia en 0 para la animación */
            transition: width 0.8s ease-out; /* Animación suave */
        }

        .chat-timestamp {
            font-size: 10px;
            color: #9ca3af;
            text-align: center;
            margin-top: 2px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        #column-pager {
            display: none !important;
        }
        .chat-message-wrapper:hover .chat-timestamp {
            opacity: 1;
        }
        .chat-date-separator {
            text-align: center;
            margin: 16px 0 8px;
            font-size: 11px;
            font-weight: 600;
            color: #6b7280;
            position: relative;
        }
        .chat-date-separator::before, .chat-date-separator::after {
            content: '';
            position: absolute;
            top: 50%;
            width: 40%;
            height: 1px;
            background-color: #d1d5db;
        }
        .chat-date-separator::before { left: 0; }
        .chat-date-separator::after { right: 0; }

        #chat-typing-indicator {
            height: 24px;
            padding: 0 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: opacity 0.3s;
        }

        #pomodoro-timer-widget.pomodoro-work #pomodoro-status {
            background-color: #fef2f2; /* Rojo claro (red-50) */
            color: #991b1b; /* Rojo oscuro (red-800) */
        }
        #pomodoro-timer-widget.pomodoro-short-break #pomodoro-status {
            background-color: #eff6ff; /* Azul claro (blue-50) */
            color: #1e40af; /* Azul oscuro (blue-800) */
        }
        #pomodoro-timer-widget.pomodoro-long-break #pomodoro-status {
            background-color: #f0fdf4; /* Verde claro (green-50) */
            color: #14532d; /* Verde oscuro (green-900) */
        }


        .typing-dot {
            width: 6px;
            height: 6px;
            background-color: #9ca3af;
            border-radius: 50%;
            animation: wave 1.4s infinite ease-in-out both;
        }
        .typing-dot:nth-of-type(1) { animation-delay: -0.32s; }
        .typing-dot:nth-of-type(2) { animation-delay: -0.16s; }
        @keyframes wave { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1.0); } }


        #chat-messages::-webkit-scrollbar { width: 8px; }
        #chat-messages::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }

        #chat-messages {
            scroll-behavior: smooth; /* Desplazamiento suave */
            display: flex;
            flex-direction: column;
            gap: 4px; /* Espacio vertical entre mensajes */
        }
        #chat-messages::-webkit-scrollbar { width: 8px; }
        #chat-messages::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }

        /* Contenedor de un mensaje individual (avatar + burbuja) */
        .chat-message-wrapper {
            display: flex;
            max-width: 85%;
            align-items: flex-end; /* Alinea el avatar con la base de la burbuja */
            gap: 10px; /* Espacio entre el avatar y el contenido */
        }

        /* Alineación para mensajes propios (derecha) */
        .chat-message-wrapper.from-me {
            align-self: flex-end;
            flex-direction: row-reverse; /* Invierte el orden (contenido, luego avatar) */
        }

        /* Alineación para mensajes de otros (izquierda) */
        .chat-message-wrapper.from-others {
            align-self: flex-start;
        }

        /* Avatar del usuario */
        .chat-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            color: white;
            flex-shrink: 0;
            border: 2px solid white; /* Borde sutil para resaltar */
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); /* Sombra suave */
            transition: opacity 0.3s ease;
        }

        /* Contenido del mensaje (nombre + burbuja) */
        .chat-content {
            display: flex;
            flex-direction: column;
        }

        /* Nombre del remitente */
        .chat-sender-name {
            font-size: 12px; /* Ligeramente más grande */
            font-weight: 600;
            margin-bottom: 5px;
            color: #6b7280; /* Un gris más suave (slate-500) */
        }
        .from-me .chat-sender-name {
            text-align: right;
            margin-right: 12px;
        }
        .from-others .chat-sender-name {
            margin-left: 12px;
        }

        /* Burbuja del mensaje */
        .chat-bubble {
            padding: 12px 18px; /* Un poco más de padding */
            border-radius: 22px; /* Bordes más redondeados */
            line-height: 1.5;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.08); /* Sombra sutil para profundidad */
            transition: all 0.2s ease;
        }

        /* Estilo para la burbuja propia */
        .from-me .chat-bubble {
            background-color: #f97316; /* Naranja Focux (orange-500) */
            color: white;
            border-bottom-right-radius: 8px; /* Cola de la burbuja */
        }

        /* Estilo para la burbuja de otros */
        .from-others .chat-bubble {
            background-color: #ffffff; /* Blanco limpio */
            color: #1f2937; /* Texto oscuro (slate-800) */
            border: 1px solid #e5e7eb; /* Borde sutil (slate-200) */
            border-bottom-left-radius: 8px; /* Cola de la burbuja */
        }

        /* Lógica para agrupar mensajes del mismo remitente */
        .chat-message-wrapper.grouped {
            margin-top: 2px; /* Espacio reducido para mensajes seguidos */
        }
        .chat-message-wrapper.grouped .chat-avatar {
            opacity: 0; /* Oculta el avatar para que no se repita */
            height: 0; /* Colapsa el espacio del avatar */
            width: 36px;
            margin: 0 10px;
            border: none;
            box-shadow: none;
        }
        .chat-message-wrapper.grouped .chat-sender-name {
            display: none; /* Oculta el nombre en mensajes seguidos */
        }

        /* Indicador de "Escribiendo..." */
        #chat-typing-indicator {
            height: 24px;
            padding: 0 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: opacity 0.3s;
        }
        .typing-dot {
            width: 6px;
            height: 6px;
            background-color: #9ca3af;
            border-radius: 50%;
            animation: wave 1.4s infinite ease-in-out both;
        }
        .typing-dot:nth-of-type(1) { animation-delay: -0.32s; }
        .typing-dot:nth-of-type(2) { animation-delay: -0.16s; }
        @keyframes wave { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1.0); } }

        @media (max-width: 640px) {

            /* ======================================== */
            /* == 1. HEADER Y BOTONES (CORRECCIÓN DEFINITIVA) == */
            /* ======================================== */
            #main-header {
                position: fixed; top: 0; left: 0; right: 0; z-index: 60;
                display: flex; align-items: center;
                padding: calc(env(safe-area-inset-top) + 8px) 12px 8px;
                background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(6px);
                border-bottom: 1px solid #e5e7eb;
            }
            #main-header #desktop-header-content { display: none; }
            
            /* Se asegura que los contenedores padres ocupen el 100% del ancho */
            #main-header #mobile-top-tools,
            .mobile-top-line,
            #mobile-selectors-wrapper {
                display: flex;
                width: 100%;
                align-items: center;
                gap: 8px;
            }

            /* MÉTODO ROBUSTO: Anulamos forzosamente las clases de ancho incorrectas del HTML */
            #mobile-board-selector-slot,
            #mobile-view-and-status-slot {
                width: 50% !important; /* Se fuerza a cada slot a ocupar la mitad del espacio */
            }
            
            /* El botón debe llenar el 100% de su slot (que ahora sí mide 50%) */
            #mobile-board-selector-slot .board-dropdown-button,
            #mobile-view-and-status-slot .board-dropdown-button {
                width: 100%;
                height: 38px;
                padding: 0 10px;
                margin: 0; /* Se elimina el margen para evitar centrado incorrecto */
                box-sizing: border-box;
                display: flex;
                align-items: center;
                justify-content: space-between;
                background-color: #ffffff;
                border: 1px solid #d1d5db;
                border-radius: 8px;
                box-shadow: 0 1px 2px 0 rgb(0 0 0 / 0.05);
                font-size: 14px;
                font-weight: 500;
                color: #374151;
                overflow: hidden;
                text-overflow: ellipsis;
                white-space: nowrap;
            }

            #auto-save-indicator span { display: none; }
            #auto-save-indicator { padding: 4px; }
            #mobile-search-slot { display: block; }

            /* ==================================================== */
            /* == 2. MENÚS DESPLEGABLES                          == */
            /* ==================================================== */
            .view-dropdown-menu .view-dropdown-item {
                text-transform: uppercase;
                font-size: 13px;
                letter-spacing: 0.05em;
            }
            #mobile-board-selector-slot .board-dropdown-menu {
                width: 180px;
                left: 0;
                right: auto;
            }
            #mobile-view-and-status-slot .board-dropdown-menu {
                width: 240px;
                right: 0;
                left: auto;
            }

            /* =============================================== */
            /* == 3. ESTILOS GENERALES                      == */
            /* =============================================== */
            body {
                padding-top: calc(var(--topbar-h, 70px) + 8px);
                padding-bottom: calc(var(--bottombar-h, 64px) + 12px);
            }
            #kanban-board {
                display: flex; gap: 0; overflow-x: auto; scroll-snap-type: x mandatory;
                height: calc(100vh - var(--topbar-h, 70px) - var(--bottombar-h, 64px));
                scrollbar-width: none; -ms-overflow-style: none;
            }
            #kanban-board::-webkit-scrollbar { display: none; }
            .kanban-column {
                flex: 0 0 100vw; max-width: 100vw; min-width: 100vw;
                border: none; border-radius: 0; scroll-snap-align: start;
                padding: 0 12px; height: 100%; display: flex; flex-direction: column;
            }
            .kanban-column-content { overflow-y: auto; flex: 1 1 auto; min-height: 0; }
            
            .mobile-only { display: flex; }
            #mobile-bottom-bar {
                position: fixed; bottom: 0; left: 0; right: 0; z-index: 65;
                align-items: center; justify-content: space-around; gap: 8px;
                padding: 10px max(12px, env(safe-area-inset-left)) calc(10px + env(safe-area-inset-bottom));
                background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(6px); border-top: 1px solid #e5e7eb;
            }
            #mobile-bottom-bar > * { flex: 1 1 auto; min-width: 0; position: relative; }

            #mobile-bottom-bar .board-dropdown-menu,
            #mobile-bottom-bar #notifications-dropdown,
            #mobile-bottom-bar #tag-filter-dropdown {
                bottom: calc(100% + 8px);
                top: auto;
            }

            #mobile-bottom-bar #tag-filter-container .board-dropdown-menu,
            #mobile-bottom-bar #tag-filter-dropdown {
                left: 0; right: auto; transform: none;
            }
            #mobile-bottom-bar #notifications-container .board-dropdown-menu,
            #mobile-bottom-bar #notifications-dropdown {
                right: 0; left: auto; transform: none;
            }
            
            #mr-focus-container {
                bottom: calc(var(--bottombar-h, 64px) + 10px);
                right: 10px;
            }
            #column-pager {
                position: fixed; top: 50%; left: 0; right: 0; transform: translateY(-50%);
                z-index: 70; pointer-events: none; display: flex;
                justify-content: space-between; padding: 0 8px;
            }
            #column-pager .pager-btn {
                pointer-events: auto; width: 44px; height: 44px; border-radius: 9999px;
                background-color: #f97316; color: white; border: 1px solid #ea580c;
                box-shadow: 0 6px 20px rgba(234, 88, 12, 0.25); font-size: 22px;
                display: flex; align-items: center; justify-content: center;
            }
        }



    </style>
</head>
<body class="h-screen flex flex-col bg-gray-100">

    <header id="main-header" class="bg-white/90 backdrop-blur-sm shadow-sm p-3 flex items-center justify-between flex-shrink-0 z-20 border-b border-gray-200 gap-4">

        <!-- Estructura para móvil -->
        <div id="mobile-top-tools" class="hidden w-full">
            <div class="mobile-top-line">
                <div id="mobile-selectors-wrapper" class="flex w-full min-w-0 gap-2">
                    <div id="mobile-board-selector-slot" class="w-1/2"></div>
                    <div id="mobile-view-and-status-slot" class="w-1/2 flex items-center justify-end"></div>
                </div>
            </div>
        </div>

        <div id="desktop-header-content" class="flex items-center justify-between w-full gap-4">
            
            <div class="flex items-center gap-4 flex-shrink-0">
                <img id="institution-logo-img" 
                     src="https://i.postimg.cc/Qt6r571n/Adobe-Express-file.png" 
                     alt="Logo de la Institución" 
                     class="h-12 w-auto">
            </div>

            <div class="flex items-center gap-6 flex-grow min-w-0 justify-center">
                <div class="auto-save-indicator saved" id="auto-save-indicator">
                    <div class="w-2 h-2 bg-current rounded-full"></div>
                    <span>Guardado</span>
                </div>
                <div class="flex items-center gap-2">
                    <span class="text-sm font-semibold text-gray-600">Vistas:</span>
                    <div id="view-switcher" class="board-selector">
                        <div class="board-dropdown">
                            <button class="board-dropdown-button" id="view-selector-btn">
                                <span id="current-view-name">Tablero</span>
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </button>
                            <div class="board-dropdown-menu hidden" id="view-dropdown-menu">
                                <button id="board-view-btn" class="view-dropdown-item w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded-t-lg active">
                                    <div class="flex items-center gap-2">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 14a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zm10 0a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path></svg>
                                        Tablero
                                    </div>
                                </button>
                                <button id="calendar-view-btn" class="view-dropdown-item w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                    <div class="flex items-center gap-2">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                                        Calendario
                                    </div>
                                </button>
                                <button id="notes-view-btn" class="view-dropdown-item w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                    <div class="flex items-center gap-2">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path></svg>
                                        Notas
                                    </div>
                                </button>

                                <button id="eisenhower-view-btn" class="view-dropdown-item w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded-b-lg">
                                    <div class="flex items-center gap-2">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17V7m0 10a2 2 0 01-2 2H5a2 2 0 01-2-2V7a2 2 0 012-2h2a2 2 0 012 2m0 10a2 2 0 002 2h2a2 2 0 002-2V7a2 2 0 00-2-2h-2a2 2 0 00-2 2m0 10V7m0 10h2m-2 0h-2"></path></svg>
                                        Eisenhower
                                    </div>
                                </button>

                                <button id="gantt-view-btn" class="view-dropdown-item w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                    <div class="flex items-center gap-2">
                                        <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                            <path fill-rule="evenodd" d="M2 5a1 1 0 011-1h14a1 1 0 011 1v10a1 1 0 01-1 1H3a1 1 0 01-1-1V5zm2 2h12v1H4V7zm0 3h8v1H4v-1zm0 3h5v1H4v-1z" clip-rule="evenodd" />
                                        </svg>
                                        Diagrama de Gantt
                                    </div>
                                </button>


                                <button id="documents-view-btn" class="view-dropdown-item w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                                                                    <div class="flex items-center gap-2">
                                                                        <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                                                            <path fill-rule="evenodd" d="M4 4a2 2 0 00-2 2v8a2 2 0 002 2h12a2 2 0 002-2V8a2 2 0 00-2-2h-5L9 4H4zm2 6a1 1 0 00-1 1v1a1 1 0 102 0v-1a1 1 0 00-1-1z" clip-rule="evenodd" />
                                                                        </svg>
                                                                        Documentos
                                                                    </div>
                                                                </button>

                            </div>
                        </div>
                    </div>
                </div>

                <div class="flex items-center gap-2">
                    <span class="text-sm font-semibold text-gray-600">Tableros:</span>
                    <div id="board-selector" class="board-selector">
                        <div class="board-dropdown">
                            <button class="board-dropdown-button" id="board-selector-btn">
                                <span id="current-board-name">Cargando...</span>
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                </svg>
                            </button>
                            <div class="board-dropdown-menu hidden" id="board-dropdown-menu"></div>
                        </div>
                    </div>
                </div>

                <div class="flex-grow max-w-md min-w-[180px]">
                    <div class="relative">
                        <span class="absolute inset-y-0 left-0 flex items-center pl-3"><svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg></span>
                        <input type="search" id="search-input" placeholder="Buscar tarjetas..." class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-orange-600 focus:border-red-500">
                    </div>
                </div>
            </div>

            <div id="main-header-actions" class="flex items-center gap-3 flex-shrink-0">
                <div id="tag-filter-container" class="relative">
                    <button id="tag-filter-btn" class="flex items-center gap-2 px-3 py-2 bg-white border border-gray-300 text-gray-700 rounded-lg shadow-sm hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-orange-600 transition-colors text-sm font-medium">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg>
                        <span class="hidden sm:inline">Filtros</span>
                    </button>
                    <div id="tag-filter-dropdown" class="hidden absolute right-0 mt-2 w-56 bg-white rounded-md shadow-lg z-30 border border-gray-200"></div>
                </div>
                <button id="board-options-btn" class="flex items-center gap-2 px-3 py-2 bg-white border border-gray-300 text-gray-700 rounded-lg shadow-sm hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-orange-600 transition-colors text-sm font-medium">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M5 4a1 1 0 00-2 0v7.268a2 2 0 000 3.464V16a1 1 0 102 0v-1.268a2 2 0 000-3.464V4zM11 4a1 1 0 10-2 0v1.268a2 2 0 000 3.464V16a1 1 0 102 0V8.732a2 2 0 000-3.464V4zM16 3a1 1 0 011 1v7.268a2 2 0 010 3.464V16a1 1 0 11-2 0v-1.268a2 2 0 010-3.464V4a1 1 0 011-1z" /></svg>
                    <span class="hidden sm:inline">Opciones</span>
                </button>
                
                <div id="notifications-container" class="relative">
                    <button id="notifications-btn" class="flex items-center gap-2 px-3 py-2 bg-white border border-gray-300 text-gray-700 rounded-lg shadow-sm hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-orange-600 transition-colors text-sm font-medium">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
                        </svg>
                        <span class="hidden sm:inline">Alertas</span>
                    </button>
                    <span id="notifications-badge" class="absolute top-0 right-0 inline-flex items-center justify-center px-2 py-1 text-xs font-bold leading-none text-red-100 bg-red-600 rounded-full transform translate-x-1/2 -translate-y-1/2 hidden">0</span>
                    <div id="notifications-dropdown" class="hidden absolute right-0 mt-2 w-80 bg-white rounded-md shadow-lg z-30 border border-gray-200">
                        <div class="p-3 flex justify-between items-center border-b">
                            <h4 class="font-semibold">Notificaciones</h4>
                            <button id="clear-notifications-btn" class="text-xs text-blue-600 hover:underline">Limpiar todo</button>
                        </div>
                        <ul id="notifications-list" class="max-h-80 overflow-y-auto">
                        </ul>
                    </div>
                </div>

                <div id="pomodoro-container" class="relative">
                    <button id="pomodoro-btn" class="flex items-center gap-2 px-3 py-2 bg-white border border-gray-300 text-gray-700 rounded-lg shadow-sm hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-orange-600 transition-colors text-sm font-medium" title="Iniciar Pomodoro">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd" />
                        </svg>
                        <span class="hidden sm:inline">Pomodoro</span>
                    </button>
                </div>
                
                <div class="h-6 w-px bg-gray-300"></div>
                <button id="add-column-header-btn" class="flex items-center gap-2 px-4 py-2 bg-orange-600 text-white text-sm font-semibold rounded-lg shadow-sm hover:bg-orange-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6m0 0v6m0-6h6m-6 0H6" /></svg>
                    <span class="hidden sm:inline">Crear Columna</span>
                </button>
                <div class="h-6 w-px bg-gray-300"></div>
                
                <div class="relative">
                    <button id="profile-menu-btn" class="flex items-center gap-2 px-3 py-2 bg-white border border-gray-300 text-gray-700 rounded-lg shadow-sm hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-orange-600 transition-colors text-sm font-medium">
                        <img src="https://i.ibb.co/0y2M4c0j/image-removebg-preview.png" alt="Perfil" class="h-6 w-6 rounded-full object-cover">
                        <span class="hidden sm:inline font-semibold">Perfil</span>
                    </button>

                    <div id="profile-menu-dropdown" class="hidden absolute right-0 mt-2 w-64 bg-white rounded-lg shadow-xl z-30 border border-gray-200 py-2">
                        <div class="px-4 py-3 border-b border-gray-100">
                            <p class="text-sm text-gray-500">Sesión iniciada como</p>
                            <p class="font-semibold text-gray-800 truncate" id="user-name">Usuario Focux</p>
                        </div>
                        <div class="py-1">
                            <button id="dashboard-btn" class="w-full text-left flex items-center gap-3 px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path d="M2 11a1 1 0 011-1h2a1 1 0 011 1v5a1 1 0 01-1 1H3a1 1 0 01-1-1v-5zM8 7a1 1 0 011-1h2a1 1 0 011 1v9a1 1 0 01-1 1H9a1 1 0 01-1-1V7zM14 4a1 1 0 011-1h2a1 1 0 011 1v12a1 1 0 01-1 1h-2a1 1 0 01-1-1V4z" />
                                </svg>
                                <span>Dashboard</span>
                            </button>
                            <button id="change-password-btn" class="w-full text-left flex items-center gap-3 px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M10 1a4.5 4.5 0 00-4.5 4.5V9H5a2 2 0 00-2 2v6a2 2 0 002 2h10a2 2 0 002-2v-6a2 2 0 00-2-2h-.5V5.5A4.5 4.5 0 0010 1zm3 8V5.5a3 3 0 10-6 0V9h6z" clip-rule="evenodd" />
                                </svg>
                                <span>Cambiar Contraseña</span>
                            </button>
                        </div>
                        <div class="border-t border-gray-100">
                             <button id="logout-btn" class="w-full text-left flex items-center gap-3 px-4 py-2 text-sm text-red-600 hover:bg-red-50 transition-colors mt-1">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>
                                <span>Cerrar Sesión</span>
                            </button>
                        </div>
                    </div>



                </div>
            </div>
        </div>
    </header>






    <div id="add-document-modal" class="hidden fixed inset-0 z-[52] flex items-center justify-center p-4">
        <div id="add-document-overlay" class="absolute inset-0 backdrop-blur-sm bg-black bg-opacity-60"></div>
        
        <div class="bg-white rounded-2xl shadow-2xl z-10 w-full max-w-4xl transform transition-all scale-95 opacity-0 flex flex-col max-h-[90vh]">
            
            <div class="flex-shrink-0 flex items-center justify-between p-4 px-6 border-b">
                <h3 class="text-lg font-semibold text-gray-900 flex items-center gap-3">
                    <svg class="w-6 h-6 text-orange-600" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M6 2a2 2 0 00-2 2v12a2 2 0 002 2h8a2 2 0 002-2V7.414A2 2 0 0015.414 6L12 2.586A2 2 0 0010.586 2H6zm5 6a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V8z" clip-rule="evenodd" />
                    </svg>
                    Agregar Nuevo Documento
                </h3>
                <button type="button" id="add-document-close-btn" class="p-2 rounded-full text-gray-400 hover:bg-gray-200">&times;</button>
            </div>

            <form id="add-document-form" class="flex-grow overflow-y-auto">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 p-6">
                    
                    <div class="space-y-6">
                        <div>
                            <label for="doc-title" class="block text-sm font-medium text-gray-700 mb-1">Título del Documento <span class="text-red-500">*</span></label>
                            <input type="text" id="doc-title" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-orange-500 focus:border-orange-500" placeholder="Ej: Reporte Anual de Ventas">
                        </div>
                        
                        <div>
                            <label for="doc-version" class="block text-sm font-medium text-gray-700 mb-1">Versión</label>
                            <input type="text" id="doc-version" value="1.0" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-orange-500 focus:border-orange-500">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Archivo PDF <span class="text-red-500">*</span></label>
                            <div id="pdf-drop-zone" class="mt-1 flex flex-col items-center justify-center p-6 border-2 border-gray-300 border-dashed rounded-lg text-center transition-colors">
                                <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48"><path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" /></svg>
                                <p id="pdf-file-name" class="mt-2 text-sm text-gray-600 font-semibold">Arrastra y suelta tu PDF aquí</p>
                                <p class="text-xs text-gray-500">o</p>
                                <label for="pdf-file-input" class="relative cursor-pointer font-medium text-orange-600 hover:text-orange-500">
                                    <span>selecciona un archivo</span>
                                    <input id="pdf-file-input" name="pdf_file" type="file" class="sr-only" accept=".pdf">
                                </label>
                                <p class="text-xs text-gray-500 mt-1">Tamaño máximo: 10MB</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-gray-50 p-6 rounded-lg border border-gray-200 space-y-6 mt-6 md:mt-0">
                        <h4 class="text-base font-semibold text-gray-800 border-b pb-2">Opciones Adicionales</h4>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Portada del Documento</label>
                            <div id="new-doc-cover-preview" class="w-full h-40 bg-white rounded-md flex items-center justify-center border border-dashed text-xs text-gray-500 transition-colors mb-3">
                                Vista previa de la portada
                            </div>
                            <input type="hidden" id="new-doc-thumbnail-url">
                            <input type="hidden" id="new-doc-cover-color-class">
                            <div class="grid grid-cols-2 gap-3">
                                <button type="button" id="new-doc-cover-pc-btn" class="w-full text-center px-4 py-2 bg-white border border-gray-300 text-gray-700 rounded-md hover:bg-gray-100 text-sm font-medium">Subir del PC</button>
                                <button type="button" id="new-doc-cover-pexels-btn" class="w-full text-center px-4 py-2 bg-gray-800 text-white rounded-md hover:bg-black text-sm font-medium">Buscar en Pexels</button>
                            </div>
                            <input type="file" id="new-doc-cover-file-input" class="hidden" accept="image/*">
                            <p class="text-xs text-center text-gray-500 my-3">o elige un color sólido</p>
                            <div id="new-doc-cover-colors" class="grid grid-cols-8 gap-2"></div>
                        </div>
                        
                        <div>
                            <label for="new-doc-password" class="block text-sm font-medium text-gray-700 mb-1">Proteger con Contraseña</label>
                            <input type="password" id="new-doc-password" placeholder="Opcional" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-orange-500 focus:border-orange-500">
                        </div>
                    </div>
                </div>

                <div class="flex-shrink-0 flex justify-end space-x-3 p-4 bg-gray-50 border-t rounded-b-2xl">
                    <button type="button" id="add-document-cancel-btn" class="px-4 py-2 bg-white border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50 text-sm font-medium">Cancelar</button>
                    <button type="submit" id="add-document-submit-btn" class="px-4 py-2 bg-orange-600 text-white rounded-md hover:bg-orange-700 text-sm font-medium flex items-center gap-2">
                        <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M5.5 13a3.5 3.5 0 01-.369-6.98 4.5 4.5 0 118.738 0A3.5 3.5 0 0114.5 13H5.5z" /><path d="M9 13.5a1 1 0 011 1v1.5a1 1 0 11-2 0V14.5a1 1 0 011-1z" /></svg>
                        Crear Documento
                    </button>
                </div>
            </form>
        </div>
    </div>









    <div id="change-password-modal" class="hidden fixed inset-0 z-[52] flex items-center justify-center p-4">
        <div id="change-password-overlay" class="absolute inset-0 backdrop-blur-sm bg-black bg-opacity-60"></div>
        <div class="bg-white rounded-lg p-6 z-10 w-full max-w-md transform transition-all scale-95 opacity-0">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-900 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-orange-600" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 1a4.5 4.5 0 00-4.5 4.5V9H5a2 2 0 00-2 2v6a2 2 0 002 2h10a2 2 0 002-2v-6a2 2 0 00-2-2h-.5V5.5A4.5 4.5 0 0010 1zm3 8V5.5a3 3 0 10-6 0V9h6z" clip-rule="evenodd" />
                    </svg>
                    Cambiar Contraseña
                </h3>
                <button type="button" id="change-password-close-btn" class="p-1 rounded-full text-gray-400 hover:bg-gray-200">&times;</button>
            </div>
            <form id="change-password-form" class="space-y-4">
                <div>
                    <label for="current-password" class="block text-sm font-medium text-gray-700 mb-1">Contraseña Actual</label>
                    <input type="password" id="current-password" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-orange-600 focus:border-red-500">
                </div>
                <div>
                    <label for="new-password" class="block text-sm font-medium text-gray-700 mb-1">Nueva Contraseña</label>
                    <input type="password" id="new-password" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-orange-600 focus:border-red-500">
                </div>
                <div>
                    <label for="confirm-new-password" class="block text-sm font-medium text-gray-700 mb-1">Confirmar Nueva Contraseña</label>
                    <input type="password" id="confirm-new-password" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-orange-600 focus:border-red-500">
                </div>
                <p id="change-password-status" class="text-xs text-center font-medium h-4"></p>
                <div class="flex justify-end space-x-3 pt-2">
                    <button type="button" id="change-password-cancel-btn" class="px-4 py-2 bg-white border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50 text-sm font-medium">Cancelar</button>
                    <button type="submit" class="px-4 py-2 bg-orange-600 text-white rounded-md hover:bg-orange-700 text-sm font-medium">Guardar Cambios</button>
                </div>
            </form>
        </div>
    </div>


    <div id="dashboard-modal" class="hidden fixed inset-0 z-[52] flex items-center justify-center p-4 sm:p-6 lg:p-8">
        <div id="dashboard-overlay" class="absolute inset-0 backdrop-blur-sm bg-black bg-opacity-60"></div>
        
        <div class="bg-gray-50 rounded-2xl shadow-2xl z-10 w-full max-w-7xl h-[95vh] flex flex-col transform transition-all scale-95 opacity-0">
            
            <div class="flex-shrink-0 flex items-center justify-between p-4 px-6 border-b bg-white rounded-t-2xl">
                <h3 class="text-xl font-bold text-gray-800 flex items-center gap-3">
                    <svg class="w-6 h-6 text-orange-600" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M2 11a1 1 0 011-1h2a1 1 0 011 1v5a1 1 0 01-1 1H3a1 1 0 01-1-1v-5zM8 7a1 1 0 011-1h2a1 1 0 011 1v9a1 1 0 01-1 1H9a1 1 0 01-1-1V7zM14 4a1 1 0 011-1h2a1 1 0 011 1v12a1 1 0 01-1 1h-2a1 1 0 01-1-1V4z" /></svg>
                    <span>Panorama de Productividad</span>
                </h3>
                <button type="button" id="dashboard-close-btn" class="p-2 rounded-full text-gray-500 hover:bg-gray-200 hover:text-gray-700 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>

            <div id="dashboard-content" class="flex-grow p-6 lg:p-8 overflow-y-auto">
                <div id="dashboard-loader" class="flex flex-col items-center justify-center h-full text-center">
                    <svg class="animate-spin h-10 w-10 text-orange-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                    <p class="mt-4 text-gray-600 font-semibold text-lg">Analizando tu productividad...</p>
                    <p class="text-sm text-gray-500">Estamos compilando tus datos para darte la mejor perspectiva.</p>
                </div>

                <div id="dashboard-grid" class="hidden grid grid-cols-12 gap-6">
                    
                    <div class="col-span-12 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">

                        <div class="dashboard-kpi-card">
                            <div class="kpi-icon bg-blue-100 text-blue-600">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M2 10a8 8 0 1116 0 8 8 0 01-16 0z" /><path d="M12.293 6.293a1 1 0 011.414 0l.001.001 2 2a1 1 0 01-1.414 1.414L13 8.414V13a1 1 0 11-2 0V8.414l-1.293 1.293a1 1 0 01-1.414-1.414l2-2z" /></svg>
                            </div>
                            <h4 class="kpi-title">Tareas Totales</h4>
                            <p id="total-cards-stat" class="kpi-value">0</p>
                            <p class="kpi-description">En todos los tableros</p>
                        </div>


                         <div class="dashboard-kpi-card">
                            <div class="kpi-icon bg-green-100 text-green-600">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>
                            </div>
                            <h4 class="kpi-title">Tareas Completadas</h4>
                            <p id="completed-cards-stat" class="kpi-value">0</p>
                            <p class="kpi-description">¡Buen trabajo!</p>
                        </div>
                        <div class="dashboard-kpi-card">
                             <div class="kpi-icon bg-red-100 text-red-600">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                            </div>
                            <h4 class="kpi-title">Tareas Vencidas</h4>
                            <p id="overdue-cards-stat" class="kpi-value">0</p>
                            <p class="kpi-description">Requieren tu atención</p>
                        </div>

                        <div class="dashboard-kpi-card">
                                <div class="kpi-icon bg-orange-100 text-orange-600">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" /></svg>
                                </div>
                                <h4 class="kpi-title">Rendimiento General</h4>
                                <p id="performance-value" class="kpi-value">0%</p>
                                <div class="progress-bar-container">
                                    <div id="performance-bar" class="progress-bar"></div>
                                </div>
                            </div>
                        </div>

                    <div class="col-span-12 grid grid-cols-12 gap-6">
                        <div class="col-span-12 lg:col-span-8">
                            <div class="dashboard-card h-[380px]">
                                 <h3 class="dashboard-card-title">Carga de Trabajo (Tareas Activas por Columna)</h3>
                                 <div id="workload-chart-container" class="w-full h-full pt-4"></div>
                            </div>
                        </div>

                        <div class="col-span-12 lg:col-span-4">
                            <div class="dashboard-card h-[380px]">
                                <h3 class="dashboard-card-title">Próximos Vencimientos (7 días)</h3>
                                <ul id="upcoming-tasks-list" class="space-y-3 dashboard-list">
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div class="col-span-12">
                        <div class="dashboard-card">
                            <h3 class="dashboard-card-title flex items-center gap-2">
                                <svg class="w-5 h-5 text-red-500" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                                Tareas Vencidas que Requieren tu Atención
                            </h3>
                            <ul id="overdue-tasks-list" class="dashboard-list max-h-[240px] space-y-3">
                                </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- All existing modals and content from Tablero_2.html -->
    <div id="board-options-modal" class="hidden fixed inset-0 z-[51]">
        <div id="board-options-overlay" class="modal-overlay fixed inset-0 bg-black bg-opacity-60 opacity-0"></div>


        <div id="board-options-content" class="bg-white h-full w-96 max-w-full absolute top-0 right-0 shadow-2xl flex flex-col transform transition-transform duration-300 ease-in-out translate-x-full">

            <div class="flex-shrink-0 flex items-center justify-between p-4 border-b border-gray-200">
                <h3 class="text-lg font-semibold text-gray-900">Opciones de Tablero</h3>
                <button type="button" id="board-options-close-btn" class="p-1 rounded-full text-gray-400 hover:bg-gray-200 hover:text-gray-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>

            <div class="flex-grow p-6 space-y-6 overflow-y-auto">
                
                <div class="space-y-4 pb-4 border-b">
                    <h4 class="text-base font-semibold text-gray-800">Opciones de Colaboración</h4>
                    <div class="p-4 rounded-lg bg-gray-50 border border-gray-200">
                        <button type="button" id="open-share-modal-btn" class="w-full flex items-center justify-center gap-2 px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 text-sm font-medium">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z" /></svg>
                            Gestionar Acceso / Compartir
                        </button>
                    </div>
                </div>

                <div class="space-y-4">
                    <h4 class="text-base font-semibold text-gray-800">Fondo del Tablero</h4>
                    <div>
                        <p class="text-sm font-medium text-gray-700 mb-2">Fondo con Imagen</p>
                        <div class="flex gap-2">
                             <button type="button" id="upload-bg-btn" class="flex-1 text-center px-4 py-2 bg-white border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50 text-sm font-medium">Subir del PC</button>
                             <button type="button" id="pexels-bg-btn" class="flex-1 text-center px-4 py-2 bg-gray-800 text-white rounded-md hover:bg-black text-sm font-medium">Buscar en Pexels</button>
                        </div>
                        <input type="file" id="board-bg-input" class="hidden" accept="image/*">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Fondo Sólido</label>
                        <div id="board-bg-color-swatches" class="grid grid-cols-8 gap-2"></div>
                    </div>
                </div>

                <div class="space-y-4 pt-4 border-t">
                    <h4 class="text-base font-semibold text-gray-800">Opciones Generales</h4>
                    <div class="p-4 rounded-lg bg-gray-50 border border-gray-200">
                        <label for="telegram-connect-checkbox" class="flex items-center justify-between cursor-pointer">
                            <div class="flex items-center gap-4">
                                <div class="bg-blue-100 p-2 rounded-full">
                                   <svg class="h-6 w-6 text-blue-500" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.78 18.65l.28-4.23l7.68-6.92c.34-.31-.07-.46-.52-.19L7.74 13.3L3.64 12c-.88-.25-.89-.86.2-1.3l15.97-6.16c.73-.28 1.45.18 1.25.91L21 18.22c-.28.91-1.02 1.06-1.74.56l-4.2-3.15l-4.32 4.16c-.39.39-1.04.1-1.25-.36z"/></svg>
                                </div>
                                <div>
                                    <p class="font-semibold text-gray-800">Conectar con Telegram</p>
                                    <p class="text-xs text-gray-500">Recibe recordatorios y alertas.</p>
                                </div>
                            </div>
                            <div class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="telegram-connect-checkbox" name="telegramConnect" class="sr-only peer">
                                <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-focus:ring-2 peer-focus:ring-blue-300 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                            </div>
                        </label>
                        <div id="telegram-config-container" class="hidden mt-4 pt-4 border-t border-gray-200">
                             <p class="text-xs text-gray-600 mb-3">Ingresa tu <strong>Chat ID</strong> de Telegram. Puedes obtenerlo del bot <a href="https://t.me/userinfobot" target="_blank" class="text-blue-600 hover:underline font-medium">@userinfobot</a>.</p>
                            <div class="flex items-center gap-2">
                                <input type="text" id="telegram-chat-id" placeholder="Tu Chat ID" class="flex-grow px-3 py-1.5 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 text-sm">
                                <button type="button" id="connect-telegram-btn" class="px-4 py-1.5 bg-blue-500 text-white rounded-md hover:bg-blue-600 text-sm font-medium">Conectar</button>
                            </div>
                            <p id="telegram-status" class="text-xs text-gray-500 mt-2">Estado: <span class="font-medium text-red-600">No conectado</span>.</p>
                        </div>
                    </div>
                </div>

                <div class="space-y-4 pt-4 border-t">
                     <h4 class="text-base font-semibold text-gray-800">Efectos Visuales</h4>
                     <div>
                        <label for="blur-slider" class="block text-sm font-medium text-gray-700 mb-1">Desenfoque de Fondo</label>
                        <input type="range" id="blur-slider" min="0" max="20" step="1" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-orange-600">
                     </div>
                     <div>
                        <label for="opacity-slider" class="block text-sm font-medium text-gray-700 mb-1">Opacidad de Superposición</label>
                        <input type="range" id="opacity-slider" min="0" max="80" step="5" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-orange-600">
                     </div>
                     <div>
                        <label for="column-opacity-slider" class="block text-sm font-medium text-gray-700 mb-1">Transparencia de Columnas</label>
                        <input type="range" id="column-opacity-slider" min="20" max="100" step="5" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-orange-600">
                     </div>
                </div>
                
                <div class="space-y-3 pt-4 border-t">
                    <h4 class="text-base font-semibold text-gray-800">Asistente Mr. Focux</h4>
                    <div class="space-y-2">
                        <label for="mr-focux-interval-select" class="block text-sm font-medium text-gray-700">Frecuencia de mensajes</label>
                        <select id="mr-focux-interval-select" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-orange-600 focus:border-red-500 text-sm">
                            <option value="0">Desactivado</option>
                            <option value="5">Cada 5 minutos</option>
                            <option value="10">Cada 10 minutos</option>
                            <option value="20">Cada 20 minutos</option>
                            <option value="30">Cada 30 minutos</option>
                        </select>
                    </div>
                </div>

                <div class="space-y-3 pt-4 border-t">
                    <h4 class="text-base font-semibold text-gray-800">Color del Cuerpo de las Columnas</h4>
                    <div id="column-color-swatches" class="grid grid-cols-8 gap-2"></div>
                </div>

                <div class="space-y-3 pt-4 border-t">
                    <h4 class="text-base font-semibold text-gray-800">Color de Etiquetas</h4>
                    <div class="space-y-2 rounded-lg bg-gray-50 border border-gray-200 p-3">
                        <label class="flex items-center gap-3 cursor-pointer">
                            <input type="radio" name="tag-color-style" value="default" class="h-4 w-4 text-orange-600 focus:ring-orange-500 mt-1">
                            <div>
                                <span class="text-sm font-medium text-gray-800">Por Defecto</span>
                                <p class="text-xs text-gray-500">Usa colores predefinidos (Urgente, Importante, etc.).</p>
                            </div>
                        </label>
                        <label class="flex items-center gap-3 cursor-pointer">
                            <input type="radio" name="tag-color-style" value="pastel" class="h-4 w-4 text-orange-600 focus:ring-orange-500 mt-1">
                            <div>
                                <span class="text-sm font-medium text-gray-800">Color Pastel Uniforme</span>
                                <p class="text-xs text-gray-500">Asigna el mismo color pastel a todas las etiquetas.</p>
                            </div>
                        </label>
                        <div id="pastel-tag-color-selector" class="hidden pt-3 mt-2 border-t border-gray-200">
                            <div id="pastel-tag-color-swatches" class="grid grid-cols-8 gap-2"></div>
                        </div>
                    </div>
                </div>
                
                <div class="pt-6 border-t mt-2">
                    <button type="button" id="reset-board-options-btn" class="w-full text-center px-4 py-2 bg-gray-100 border border-gray-300 text-gray-700 rounded-md hover:bg-gray-200 text-sm font-medium">
                        Restaurar Opciones por Defecto
                    </button>
                </div>
            </div>
        </div>


    </div>

    <div id="confirm-delete-modal" class="hidden fixed inset-0 z-[51] flex items-center justify-center">
      <div id="confirm-delete-overlay" class="absolute inset-0 backdrop-blur-sm bg-orange-600 bg-opacity-50"></div>
      <div class="bg-white rounded-lg p-6 z-10 w-80">
        <p id="confirm-delete-message" class="text-gray-800 mb-4">¿Está seguro que desea eliminar?</p>
        <div class="flex justify-end space-x-2">
          <button id="confirm-delete-cancel" type="button" class="px-4 py-2 bg-white border border-gray-300 rounded-md hover:bg-gray-50">Cancelar</button>
          <button id="confirm-delete-ok"    type="button" class="px-4 py-2 bg-orange-600   text-white rounded-md hover:bg-orange-700">Eliminar</button>
        </div>
      </div>
    </div>

    <div id="trial-welcome-modal" class="hidden fixed inset-0 z-[53] flex items-center justify-center p-4">
        <div class="absolute inset-0 backdrop-blur-md bg-black bg-opacity-50"></div>
        
        <div class="bg-gradient-to-br from-white/90 to-gray-50/80 backdrop-blur-lg rounded-2xl p-10 z-10 w-full max-w-2xl flex items-center gap-8 transform transition-all scale-95 opacity-0 shadow-2xl border border-white/20">
            
            <div class="flex-shrink-0 flex items-center justify-center w-48 h-48 rounded-full bg-gradient-to-br from-orange-50 to-blue-50 p-4 shadow-inner">
                <img src="https://i.ibb.co/zHjzywnp/image-removebg-preview-2025-08-09-T234457-820.png" alt="Reloj Focux" class="w-40 h-40">
            </div>

            <div class="w-px h-40 bg-gray-200"></div>

            <div class="flex-grow flex flex-col">
                <h3 id="trial-welcome-title" class="text-3xl font-bold text-gray-800 mb-4">
                    <span class="bg-gradient-to-r from-orange-500 to-blue-600 bg-clip-text text-transparent"></span>
                </h3>
                <p id="trial-welcome-message" class="text-gray-700 mb-4 leading-relaxed text-base"></p>
                <p id="trial-welcome-subtitle" class="text-sm text-gray-500 font-medium mt-auto"></p>
                <div class="text-right mt-8">
                    <button id="trial-welcome-ok-btn" type="button" class="px-8 py-3 bg-gradient-to-r from-orange-500 to-red-500 text-white rounded-lg hover:from-orange-600 hover:to-red-600 text-base font-semibold shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 transition-all">
                        Entendido
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="pomodoro-modal" class="hidden fixed inset-0 z-[52] flex items-center justify-center p-4">
        <div id="pomodoro-overlay" class="absolute inset-0 backdrop-blur-sm bg-black bg-opacity-60"></div>
        <div class="bg-white rounded-lg p-6 z-10 w-full max-w-sm transform transition-all scale-95 opacity-0">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-900 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-orange-600" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd" /></svg>
                    Configurar Pomodoro
                </h3>
                <button type="button" id="pomodoro-close-btn" class="p-1 rounded-full text-gray-400 hover:bg-gray-200">&times;</button>
            </div>

            <div class="text-xs text-gray-500 bg-gray-50 p-3 rounded-md mb-6 border border-gray-200">
                La <strong>Técnica Pomodoro</strong> te ayuda a enfocarte dividiendo el trabajo en intervalos (pomodoros), separados por descansos cortos. Tras varios intervalos, tomas un descanso más largo.
            </div>
            <form id="pomodoro-form" class="space-y-4">
                <div>
                    <label for="pomodoro-task-name" class="block text-sm font-medium text-gray-700 mb-1">Nombre de la Tarea (Opcional)</label>
                    <input type="text" id="pomodoro-task-name" placeholder="Ej: Preparar informe mensual" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-orange-600 focus:border-red-500">
                </div>
                <div>
                    <label for="pomodoro-work-duration" class="block text-sm font-medium text-gray-700 mb-1">Tiempo de trabajo (minutos)</label>
                    <input type="number" id="pomodoro-work-duration" value="25" min="1" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-orange-600 focus:border-red-500">
                </div>
                <div>
                    <label for="pomodoro-short-break" class="block text-sm font-medium text-gray-700 mb-1">Descanso corto (minutos)</label>
                    <input type="number" id="pomodoro-short-break" value="5" min="1" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-orange-600 focus:border-red-500">
                </div>
                <div>
                    <label for="pomodoro-long-break" class="block text-sm font-medium text-gray-700 mb-1">Descanso largo (minutos)</label>
                    <input type="number" id="pomodoro-long-break" value="15" min="1" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-orange-600 focus:border-red-500">
                </div>
                <div>
                    <label for="pomodoro-intervals" class="block text-sm font-medium text-gray-700 mb-1">Intervalos para descanso largo</label>
                    <input type="number" id="pomodoro-intervals" value="4" min="1" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-orange-600 focus:border-red-500">
                </div>
                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" id="pomodoro-cancel-btn" class="px-4 py-2 bg-white border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50 text-sm font-medium">Cancelar</button>
                    <button type="submit" class="px-4 py-2 bg-orange-600 text-white rounded-md hover:bg-orange-700 text-sm font-medium">Iniciar Temporizador</button>
                </div>
            </form>
        </div>
    </div>

        <!-- Logout Confirmation Modal -->
    <div id="logout-modal" class="hidden fixed inset-0 z-[51] flex items-center justify-center">
      <div id="logout-overlay" class="absolute inset-0 backdrop-blur-sm bg-orange-600 bg-opacity-50"></div>
      <div class="bg-white rounded-lg p-6 z-10 w-80">
        <div class="flex items-center justify-center mb-4">
          <div class="bg-orange-100 rounded-full p-3">
            <svg class="w-6 h-6 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
            </svg>
          </div>
        </div>
        <h3 class="text-lg font-semibold text-gray-900 text-center mb-2">Cerrar Sesión</h3>
        <p class="text-gray-600 text-center mb-6">¿Estás seguro de que quieres cerrar sesión? Se guardarán automáticamente tus cambios.</p>
        <div class="flex justify-end space-x-3">
          <button id="logout-cancel" type="button" class="px-4 py-2 bg-white border border-gray-300 rounded-md hover:bg-gray-50 text-sm font-medium">Cancelar</button>
          <button id="logout-confirm" type="button" class="px-4 py-2 bg-orange-600 text-white rounded-md hover:bg-orange-700 text-sm font-medium">Cerrar Sesión</button>
        </div>
      </div>
    </div>

    <div id="upgrade-plan-modal" class="hidden fixed inset-0 z-[52] flex items-center justify-center">
        <div id="upgrade-plan-overlay" class="absolute inset-0 backdrop-blur-sm bg-black bg-opacity-50"></div>
        <div class="bg-white rounded-lg p-8 z-10 w-full max-w-4xl max-h-[90vh] overflow-y-auto transform transition-all scale-95 opacity-0">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-2xl font-bold text-gray-900">Mejorar tu Plan</h3>
                <button type="button" id="upgrade-plan-close-btn" class="p-1 rounded-full text-gray-400 hover:bg-gray-200 hover:text-gray-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>

            <p class="text-gray-600 text-center mb-8">Compara los planes y sigue los pasos para activar el que elijas.</p>
            
            <div class="grid md:grid-cols-3 gap-6">
                
                <div class="kanban-column rounded-xl border-4 border-gray-300 shadow-lg flex flex-col p-6">
                    <div class="column-header flex-shrink-0 flex items-center justify-between pb-4 border-b border-gray-200 mb-4">
                        <h4 class="text-xl font-bold text-gray-800">Plan Básico</h4>
                        <span class="text-sm font-semibold text-white px-3 py-1 rounded-full bg-orange-600">Actual</span>
                    </div>
                    <ul class="space-y-4 text-gray-600 flex-grow">
                        <li class="flex items-start gap-2"><svg class="w-6 h-6 text-green-500 mt-0.5 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg><p><strong>Capacidad para 2 Tableros</strong></p></li>
                        <li class="flex items-start gap-2 text-gray-400 line-through"><svg class="w-6 h-6 text-red-500 mt-0.5 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg><p>Acceso a Matriz de Eisenhower</p></li>
                        <li class="flex items-start gap-2 text-gray-400 line-through"><svg class="w-6 h-6 text-red-500 mt-0.5 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg><p>Checklist en tarjetas</p></li>
                        <li class="flex items-start gap-2 text-gray-400 line-through"><svg class="w-6 h-6 text-red-500 mt-0.5 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg><p>Función TimeBoxing</p></li>
                        <li class="flex items-start gap-2 text-gray-400 line-through"><svg class="w-6 h-6 text-red-500 mt-0.5 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg><p>Automatización (Tareas de Hoy/Vencidas)</p></li>
                        <li class="flex items-start gap-2 text-gray-400 line-through"><svg class="w-6 h-6 text-red-500 mt-0.5 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg><p>Conexión con Telegram</p></li>
                    </ul>
                    <div class="mt-6 text-center"><p class="text-4xl font-bold text-gray-900 mb-2">Gratis</p></div>
                </div>

                <div class="kanban-column rounded-xl border-4 border-gray-200 hover:border-blue-400 transition-all shadow-lg flex flex-col p-6">
                    <div class="column-header flex-shrink-0 flex items-center justify-between pb-4 border-b border-gray-200 mb-4">
                        <h4 class="text-xl font-bold text-gray-800">Plan Estándar</h4>
                    </div>
                    <ul class="space-y-4 text-gray-600 flex-grow">
                        <li class="flex items-start gap-2"><svg class="w-6 h-6 text-green-500 mt-0.5 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg><p><strong>Capacidad para 5 Tableros</strong></p></li>
                        <li class="flex items-start gap-2"><svg class="w-6 h-6 text-green-500 mt-0.5 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg><p>Acceso a Matriz de Eisenhower</p></li>
                        <li class="flex items-start gap-2 text-gray-400 line-through"><svg class="w-6 h-6 text-red-500 mt-0.5 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg><p>Checklist en tarjetas</p></li>
                        <li class="flex items-start gap-2"><svg class="w-6 h-6 text-green-500 mt-0.5 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg><p>Función TimeBoxing</p></li>
                        <li class="flex items-start gap-2 text-gray-400 line-through"><svg class="w-6 h-6 text-red-500 mt-0.5 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg><p>Automatización (Tareas de Hoy/Vencidas)</p></li>
                        <li class="flex items-start gap-2 text-gray-400 line-through"><svg class="w-6 h-6 text-red-500 mt-0.5 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg><p>Conexión con Telegram</p></li>
                    </ul>
                    <div class="mt-6 text-center">
                        <p class="text-4xl font-bold text-gray-900 mb-2">4.99 USD</p>
                        <p class="text-sm text-gray-500">o $19.999 COP</p>
                    </div>
                </div>

                <div class="kanban-column rounded-xl border-4 border-orange-500 shadow-xl flex flex-col p-6">
                    <div class="column-header flex-shrink-0 flex items-center justify-between pb-4 border-b border-gray-200 mb-4">
                        <h4 class="text-xl font-bold text-gray-800">Plan Profesional</h4>
                    </div>
                    <ul class="space-y-4 text-gray-600 flex-grow">
                        <li class="flex items-start gap-2"><svg class="w-6 h-6 text-green-500 mt-0.5 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg><p><strong>Capacidad para 10 Tableros</strong></p></li>
                        <li class="flex items-start gap-2"><svg class="w-6 h-6 text-green-500 mt-0.5 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg><p>Acceso a Matriz de Eisenhower</p></li>
                        <li class="flex items-start gap-2"><svg class="w-6 h-6 text-green-500 mt-0.5 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg><p>Checklist en tarjetas</p></li>
                        <li class="flex items-start gap-2"><svg class="w-6 h-6 text-green-500 mt-0.5 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg><p>Función TimeBoxing</p></li>
                        <li class="flex items-start gap-2"><svg class="w-6 h-6 text-green-500 mt-0.5 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg><p>Automatización (Tareas de Hoy/Vencidas)</p></li>
                        <li class="flex items-start gap-2"><svg class="w-6 h-6 text-green-500 mt-0.5 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg><p>Conexión con Telegram</p></li>
                    </ul>
                    <div class="mt-6 text-center">
                        <p class="text-4xl font-bold text-gray-900 mb-2">9.99 USD</p>
                        <p class="text-sm text-gray-500">o $39.999 COP</p>
                    </div>
                </div>
            </div>

            <div class="mt-12 pt-8 border-t border-gray-200">
                <h4 class="text-lg font-bold text-gray-800 mb-6 text-center">Proceso de Mejora de Plan</h4>
                <div class="grid md:grid-cols-3 gap-8 items-start">
                    <div class="flex flex-col items-center text-center">
                        <div class="flex items-center justify-center w-12 h-12 rounded-full bg-orange-100 text-orange-600 font-bold text-xl mb-4">1</div>
                        <h5 class="text-md font-semibold text-gray-800 mb-2">Realiza tu Pago</h5>
                        <p class="text-sm text-gray-600 mb-4">Elige el plan y completa la transferencia. Aquí tienes los datos:</p>
                        <div class="w-full text-left space-y-4">
                            <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                                <h6 class="text-xs font-bold text-gray-500 uppercase mb-1">Internacional (PayPal)</h6>
                                <p class="text-sm font-semibold text-blue-600 break-words">damiancastro.b97@gmail.com</p>
                            </div>
                            <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                                <h6 class="text-xs font-bold text-gray-500 uppercase mb-1">Nacional (Nequi)</h6>
                                <p class="text-sm font-semibold text-orange-600">3132217205</p>
                                <p class="text-xs text-gray-500">Titular: Damian Castro</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="hidden md:flex flex-col items-center justify-center h-full">
                        <div class="w-full border-t-2 border-dashed border-gray-300 relative">
                            <div class="absolute inset-y-0 -left-6 flex items-center">
                                 <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3" /></svg>
                            </div>
                            <div class="absolute inset-y-0 -right-6 flex items-center">
                                 <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-gray-300" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3" /></svg>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex flex-col items-center text-center">
                        <div class="flex items-center justify-center w-12 h-12 rounded-full bg-orange-100 text-orange-600 font-bold text-xl mb-4">2</div>
                        <h5 class="text-md font-semibold text-gray-800 mb-2">Envía el Comprobante</h5>
                        <p class="text-sm text-gray-600 mb-4">Envía un pantallazo de tu pago a nuestro WhatsApp para verificarlo. Incluye tu correo de Focux.</p>
                        <a href="https://wa.link/02bu3a" target="_blank" class="w-full px-4 py-3 bg-green-500 text-white rounded-lg font-bold hover:bg-green-600 transition-colors flex items-center justify-center gap-3">
                            <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12.04 2.1c-5.46 0-9.91 4.45-9.91 9.91c0 1.75.46 3.44 1.34 4.93l-.84 3.09l3.17-.83c1.47.8 3.14 1.22 4.88 1.22c5.46 0 9.91-4.45 9.91-9.91c0-5.46-4.45-9.91-9.91-9.91zm.04 15.68c-1.5 0-2.9-.4-4.14-1.12l-.29-.17l-3.03.79l.81-2.95l-.19-.3c-.8-.85-1.29-1.95-1.29-3.14c0-4.18 3.4-7.58 7.58-7.58c2.02 0 3.9.79 5.34 2.23c1.44 1.44 2.23 3.32 2.23 5.34c0 4.18-3.4 7.58-7.58 7.58zm3.62-5.71c-.2-.1-.45-.16-.71-.16c-.27 0-.5.06-.7.16c-.19.1-.39.24-.58.41c-.19.17-.37.38-.54.63c-.16.24-.3.51-.43.82c-.12.31-.22.64-.29 1.01l-.1 1.01c-.04.42-.2.53-.45.54c-.26.01-.52-.08-.75-.19c-.23-.1-.45-.25-.66-.43c-.63-.53-1.07-1.1-1.32-1.72c-.25-.62-.38-1.28-.38-1.99c0-1.16.48-2.15 1.4-2.97c.92-.82 2.11-1.23 3.58-1.23c.31 0 .61.03.9.09c.28.06.56.14.81.25c.26.11.49.25.7.41c.21.16.4.35.58.58c.2.22.37.47.51.76c.14.29.25.61.34.95c.08.34.13.69.13 1.05c0 .54-.15 1.08-.43 1.6z"/></svg>
                            Enviar comprobante
                        </a>
                    </div>
                </div>
            </div>

        </div>
    </div>



    <!-- Create Board Modal -->
    <div id="create-board-modal" class="hidden fixed inset-0 z-[52] flex items-center justify-center">
        <div id="create-board-overlay" class="absolute inset-0 backdrop-blur-sm bg-black bg-opacity-50"></div>
        <div class="bg-white rounded-lg p-6 z-10 w-96 max-w-[90vw]">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-900">Crear Nuevo Tablero</h3>
                <button type="button" id="create-board-close-btn" class="p-1 rounded-full text-gray-400 hover:bg-gray-200 hover:text-gray-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <form id="create-board-form">
                <div class="mb-4">
                    <label for="new-board-name" class="block text-sm font-medium text-gray-700 mb-2">Nombre del Tablero</label>
                    <input type="text" id="new-board-name" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-orange-600 focus:border-red-500" placeholder="Ej. Proyecto Marketing, Tareas Personales...">
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" id="create-board-cancel-btn" class="px-4 py-2 bg-white border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50 text-sm font-medium">Cancelar</button>
                    <button type="submit" class="px-4 py-2 bg-orange-600 text-white rounded-md hover:bg-orange-700 text-sm font-medium">Crear Tablero</button>
                </div>
            </form>
        </div>
    </div>


    <div id="template-selector-modal" class="hidden fixed inset-0 z-[53] flex items-center justify-center p-4">
        <div id="template-selector-overlay" class="absolute inset-0 backdrop-blur-sm bg-black bg-opacity-60"></div>
        <div class="bg-white rounded-lg z-10 w-full max-w-5xl max-h-[90vh] flex flex-col transform transition-all scale-95 opacity-0">
            <div class="flex-shrink-0 flex items-center justify-between p-4 border-b">
                <div>
                    <h3 class="text-xl font-bold text-gray-800">Elige una Plantilla para tu Tablero</h3>
                    <p class="text-sm text-gray-500">Comienza con una estructura probada o elige la original para personalizarla.</p>
                </div>
                <button type="button" id="template-selector-close-btn" class="p-1 rounded-full text-gray-400 hover:bg-gray-200">&times;</button>
            </div>
            <div id="template-selector-grid" class="flex-grow p-6 overflow-y-auto grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                </div>
        </div>
    </div>

    <div id="ai-suggestions-modal" class="hidden fixed inset-0 z-[52] flex items-center justify-center p-4">
        <div id="ai-suggestions-overlay" class="absolute inset-0 bg-black/60 backdrop-blur-sm"></div>
        <div class="bg-white rounded-2xl shadow-xl w-full max-w-2xl max-h-[80vh] flex flex-col transform transition-all scale-95 opacity-0">
            <div class="flex-shrink-0 flex items-center justify-between p-4 border-b">
                <h3 class="text-lg font-semibold text-gray-800 flex items-center gap-2">
                    <svg class="w-6 h-6 text-blue-600" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M17.218 2.232a1.25 1.25 0 00-1.768 0l-8.5 8.5a1.25 1.25 0 000 1.768l2.53 2.53a1.25 1.25 0 001.768 0l8.5-8.5a1.25 1.25 0 000-1.768l-2.53-2.53z" /><path d="M9.213 4.062a1.25 1.25 0 00-1.768 0l-6.25 6.25a1.25 1.25 0 000 1.768l2.53 2.53a1.25 1.25 0 001.768 0l6.25-6.25a1.25 1.25 0 000-1.768L9.213 4.062z" /></svg>
                    Sugerencias de Redacción
                </h3>
                <button id="ai-suggestions-close-btn" class="p-1 rounded-full text-gray-400 hover:bg-gray-200">&times;</button>
            </div>
            <div id="suggestions-list-container" class="flex-grow p-4 overflow-y-auto">
                </div>
            <div class="flex-shrink-0 p-3 border-t bg-gray-50 rounded-b-2xl flex justify-end">
                <button id="regenerate-suggestions-btn" class="flex items-center gap-2 px-4 py-2 bg-orange-600 text-white text-sm font-semibold rounded-lg shadow-sm hover:bg-orange-700 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 110 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd" />
                    </svg>
                    Generar otras 3 opciones
                </button>
            </div>
        </div>
    </div>









    <main class="flex-grow min-h-0 relative">
        <div id="kanban-board-container" class="active">
            <div id="board-overlay" class="absolute inset-0 bg-black" style="opacity: 0;"></div>
            <div id="kanban-board" class="relative z-10">
                </div>
        </div>

        <div id="calendar-container" class="hidden">
            <header id="calendar-header">
                <h2 id="calendar-month-year" class="text-xl font-bold text-orange-600 text-center uppercase w-full"></h2>
                <div class="flex items-center gap-2">
                    <button id="prev-month-btn" class="p-2 rounded-full hover:bg-gray-200">
                        <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                    </button>
                    <button id="next-month-btn" class="p-2 rounded-full hover:bg-gray-200">
                        <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                    </button>
                </div>
            </header>
            <div id="calendar-grid"></div>
        </div>

        <div id="notes-container" class="hidden absolute inset-0 p-6 overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-orange-600">Mis Notas</h2>
                <button id="add-note-btn" class="px-4 py-2 bg-orange-600 text-white text-sm font-semibold rounded-lg shadow-sm hover:bg-orange-700 transition-colors flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6m0 0v6m0-6h6m-6 0H6" /></svg>
                    Nueva Nota
                </button>
            </div>
            <div id="notes-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                </div>
        </div>


        <div id="eisenhower-container" class="hidden absolute inset-0 flex flex-col p-6 overflow-hidden">
            <div class="text-center mb-6">
                <h2 class="text-2xl font-bold text-orange-600 mb-2">Matriz de Eisenhower</h2>
                <p class="text-gray-600 text-sm">Organiza y prioriza tus tareas. Para que una tarea aparezca aquí, debe estar etiquetada con al menos una etiqueta de Urgencia (Urgente / No Urgente) y una de Importancia (Importante / No Importante).</p>
            </div>
            
            <div class="grid grid-cols-2 grid-rows-2 h-full w-full gap-4">
                <div id="eisenhower-do" data-quadrant="do" class="eisenhower-quadrant rounded-xl border border-gray-200/50 shadow-sm flex flex-col">
                    <div class="eisenhower-header flex-shrink-0 flex items-center justify-between p-3 rounded-t-xl border-t-4 border-orange-400 bg-white/60 backdrop-blur-sm">
                        <div class="flex items-center gap-2">
                            <div class="w-2 h-2 bg-orange-500 rounded-full"></div>
                            <h3 class="text-base font-semibold text-gray-800">Urgente e Importante</h3>
                        </div>
                        <span class="eisenhower-badge text-xs font-bold bg-orange-500 text-white px-2 py-1 rounded-full">HACER</span>
                    </div>
                    <div class="eisenhower-content p-3 bg-transparent flex-grow overflow-y-auto">
                        <div class="eisenhower-description bg-orange-50 border border-orange-200 rounded-lg p-2 mb-3">
                            <p class="text-xs text-orange-700 font-medium">🔥 Tareas críticas que requieren atención inmediata</p>
                        </div>
                        <div class="eisenhower-tasks space-y-2"></div>
                    </div>
                </div>

                <div id="eisenhower-plan" data-quadrant="plan" class="eisenhower-quadrant rounded-xl border border-gray-200/50 shadow-sm flex flex-col">
                    <div class="eisenhower-header flex-shrink-0 flex items-center justify-between p-3 rounded-t-xl border-t-4 border-blue-400 bg-white/60 backdrop-blur-sm">
                        <div class="flex items-center gap-2">
                            <div class="w-2 h-2 bg-blue-500 rounded-full"></div>
                            <h3 class="text-base font-semibold text-gray-800">Importante, No Urgente</h3>
                        </div>
                        <span class="eisenhower-badge text-xs font-bold bg-blue-500 text-white px-2 py-1 rounded-full">PLANEAR</span>
                    </div>
                    <div class="eisenhower-content p-3 bg-transparent flex-grow overflow-y-auto">
                        <div class="eisenhower-description bg-blue-50 border border-blue-200 rounded-lg p-2 mb-3">
                            <p class="text-xs text-blue-700 font-medium">📅 Ideal para programar en tu calendario</p>
                        </div>
                        <div class="eisenhower-tasks space-y-2"></div>
                    </div>
                </div>

                <div id="eisenhower-delegate" data-quadrant="delegate" class="eisenhower-quadrant rounded-xl border border-gray-200/50 shadow-sm flex flex-col">
                    <div class="eisenhower-header flex-shrink-0 flex items-center justify-between p-3 rounded-t-xl border-t-4 border-cyan-400 bg-white/60 backdrop-blur-sm">
                        <div class="flex items-center gap-2">
                            <div class="w-2 h-2 bg-cyan-500 rounded-full"></div>
                            <h3 class="text-base font-semibold text-gray-800">Urgente, No Importante</h3>
                        </div>
                        <span class="eisenhower-badge text-xs font-bold bg-cyan-500 text-white px-2 py-1 rounded-full">DELEGAR</span>
                    </div>
                    <div class="eisenhower-content p-3 bg-transparent flex-grow overflow-y-auto">
                        <div class="eisenhower-description bg-cyan-50 border border-cyan-200 rounded-lg p-2 mb-3">
                            <p class="text-xs text-cyan-700 font-medium">👥 Tareas que otros pueden hacer por ti</p>
                        </div>
                        <div class="eisenhower-tasks space-y-2"></div>
                    </div>
                </div>

                <div id="eisenhower-eliminate" data-quadrant="eliminate" class="eisenhower-quadrant rounded-xl border border-gray-200/50 shadow-sm flex flex-col">
                    <div class="eisenhower-header flex-shrink-0 flex items-center justify-between p-3 rounded-t-xl border-t-4 border-gray-400 bg-white/60 backdrop-blur-sm">
                        <div class="flex items-center gap-2">
                            <div class="w-2 h-2 bg-gray-500 rounded-full"></div>
                            <h3 class="text-base font-semibold text-gray-800">No Urgente, No Importante</h3>
                        </div>
                        <span class="eisenhower-badge text-xs font-bold bg-gray-500 text-white px-2 py-1 rounded-full">ELIMINAR</span>
                    </div>
                    <div class="eisenhower-content p-3 bg-transparent flex-grow overflow-y-auto">
                        <div class="eisenhower-description bg-gray-50 border border-gray-200 rounded-lg p-2 mb-3">
                            <p class="text-xs text-gray-700 font-medium">🗑️ Evita o elimina estas tareas por completo</p>
                        </div>
                        <div class="eisenhower-tasks space-y-2"></div>
                    </div>
                </div>
            </div>
        </div>



        <div id="gantt-container" class="hidden absolute inset-0 flex flex-col p-4 sm:p-6 bg-gray-50 overflow-auto">
            
            <div class="flex-shrink-0 text-center mb-6">
                <h2 class="text-2xl font-bold text-orange-600 mb-2">Diagrama de Gantt</h2>
                <p class="text-gray-600 text-sm max-w-3xl mx-auto">Visualiza la línea de tiempo de tus tareas y subtareas. Solo las tarjetas con fecha de inicio aparecerán aquí.</p>
                <div id="gantt-actions" class="mt-4 flex items-center justify-center gap-3">
                    <button id="export-gantt-pdf-btn" class="flex items-center gap-2 px-4 py-2 bg-red-600 text-white text-sm font-semibold rounded-lg shadow-sm hover:bg-red-700 transition-colors">
                        <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 2a2 2 0 00-2 2v12a2 2 0 002 2h12a2 2 0 002-2V4a2 2 0 00-2-2H4zm0 2h12v3H4V4zm0 5h12v2H4V9zm0 4h6v2H4v-2z" clip-rule="evenodd" /></svg>
                        Exportar a PDF
                    </button>
                </div>
            </div>
            <div id="gantt-chart-wrapper" class="flex-grow w-full h-full">
                </div>
        </div>



        <div id="collaborative-chat-container" class="hidden fixed bottom-0 left-1/2 -translate-x-1/2 w-full max-w-lg z-30">
            <div id="chat-box" class="bg-white/95 backdrop-blur-md rounded-t-lg shadow-2xl border border-gray-200 flex flex-col transition-all duration-300 h-12">

                <div id="chat-header" class="flex items-center justify-between p-3 cursor-pointer border-b border-gray-200 flex-shrink-0">
                    <h3 class="text-sm font-bold text-gray-800 flex items-center gap-2">
                        <span>Chat</span>
                        <span id="chat-total-unread-badge" class="hidden h-5 min-w-[20px] items-center justify-center rounded-full bg-red-600 px-1.5 text-xs font-bold text-white">0</span>
                    </h3>
                    <svg id="chat-toggle-icon" class="w-4 h-4 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                    </svg>
                </div>


                <div class="flex-grow min-h-0 flex flex-col">
                    <div id="chat-mode-selector" class="flex-shrink-0 p-2 border-b border-gray-200 bg-gray-50 flex gap-2">
                        <button id="chat-mode-board" class="chat-mode-btn">Chat Grupal</button>
                        <button id="chat-mode-general" class="chat-mode-btn">Chats Personales</button>
                        <button id="chat-mode-ai" class="chat-mode-btn">Asistentes</button>
                    </div>

                    <div id="board-chat-view" class="chat-view">
                        <div id="chat-messages" class="flex-grow p-4 overflow-y-auto flex flex-col gap-2"></div>
                        <div class="flex-shrink-0 p-2 border-t flex items-center justify-between">
                            <div id="chat-typing-indicator" class="text-xs text-gray-500 italic h-4"></div>
                            <button id="open-active-users" class="px-3 py-1 bg-orange-100 text-orange-700 rounded-md text-xs font-semibold hover:bg-orange-200 transition-colors">
                                Ver Participantes
                            </button>
                        </div>
                        <div class="flex-shrink-0 p-3 border-t">
                            <form id="board-chat-form" class="flex items-center gap-2">
                                <input type="text" id="board-chat-input" placeholder="Escribe en el chat del tablero..." class="chat-input-field" autocomplete="off">
                                <button type="submit" class="chat-send-btn">
                                    <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>
                                </button>
                            </form>
                        </div>
                    </div>

                    <div id="general-chat-view" class="chat-view">
                      <div id="user-directory-container" class="flex flex-col h-full w-full">
                          </div>
                      <div id="conversation-view-container" class="hidden flex-col h-full w-full">
                          </div>
                    </div>
                    
                    <div id="ai-chat-view" class="chat-view">
                        </div>
                </div>


                </div>
            </div>
        </div>




        <div id="ai-chat-modal" class="hidden fixed inset-0 z-[51]">
            <div id="ai-chat-overlay" class="modal-overlay fixed inset-0 bg-black bg-opacity-60 opacity-0"></div>
            <div id="ai-chat-content" class="bg-white h-full w-96 max-w-full absolute top-0 right-0 shadow-2xl flex flex-col transform transition-transform duration-300 ease-in-out translate-x-full">
                
                <div class="flex-shrink-0 flex flex-col p-4 border-b border-gray-200">
                    <div class="flex items-center justify-center p-2 bg-orange-500 rounded-md">
                        <h3 id="ai-chat-title" class="text-lg font-semibold text-white text-center"></h3>
                    </div>
                    <div class="p-4 bg-gray-50 flex items-center justify-center gap-4 flex-shrink-0">
                        <button id="ai-chat-prev-btn" class="flex-shrink-0 p-2 text-gray-600 hover:bg-gray-200 rounded-full transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" />
                            </svg>
                        </button>
                        <img id="ai-chat-avatar" src="" alt="Avatar" class="w-40 h-40 rounded-lg border-2 border-white shadow-md flex-shrink-0">
                        <button id="ai-chat-next-btn" class="flex-shrink-0 p-2 text-gray-600 hover:bg-gray-200 rounded-full transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" />
                            </svg>
                        </button>
                    </div>
                    <p class="text-xs text-center text-gray-600 mt-2">Asistente de IA</p>
                </div>

                <div id="ai-chat-messages" class="flex-grow p-4 overflow-y-auto space-y-4">
                </div>
                
                <div class="flex-shrink-0 p-4 border-t border-gray-200">
                    <form id="ai-chat-form" class="flex items-center gap-2">
                        <input type="text" id="ai-chat-input" placeholder="Pregúntale algo al asistente..." class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm text-sm focus:ring-orange-600 focus:border-red-500" autocomplete="off">
                        <button type="submit" class="p-2 bg-orange-600 text-white rounded-md hover:bg-orange-700 flex-shrink-0">
                            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                            </svg>
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <div id="note-editor-modal" class="hidden fixed inset-0 z-50">
            <div id="note-editor-overlay" class="modal-overlay fixed inset-0 bg-black bg-opacity-60 opacity-0"></div>
            <div id="note-editor-content" class="bg-white h-full w-[600px] max-w-full absolute top-0 right-0 shadow-2xl flex flex-col transform transition-transform duration-300 ease-in-out translate-x-full">
                <form id="note-editor-form" class="flex flex-col h-full">
                    <div class="flex-shrink-0 flex items-center justify-between p-4 border-b border-gray-200">
                        <h3 id="note-modal-title" class="text-lg font-semibold text-gray-900">Editar Nota</h3>
                        <button type="button" id="note-editor-close-btn" class="p-1 rounded-full text-gray-400 hover:bg-gray-200 hover:text-gray-600">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>

                    <div class="flex-grow p-6 space-y-6 overflow-y-auto">
                        <input type="hidden" name="note_id">
                        



                        <div>
                            <label for="note-content-input" class="block text-sm font-medium text-gray-700 mb-2">Contenido de la nota</label>
                            
                            <div class="flex items-center gap-2 mb-2">
                                <button type="button" id="ai-improve-note" class="flex-1 text-xs font-medium flex items-center justify-center gap-1.5 px-3 py-1.5 bg-blue-50 text-blue-700 rounded-md hover:bg-blue-100 border border-blue-200">
                                    <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M17.218 2.232a1.25 1.25 0 00-1.768 0l-8.5 8.5a1.25 1.25 0 000 1.768l2.53 2.53a1.25 1.25 0 001.768 0l8.5-8.5a1.25 1.25 0 000-1.768l-2.53-2.53z" /><path d="M9.213 4.062a1.25 1.25 0 00-1.768 0l-6.25 6.25a1.25 1.25 0 000 1.768l2.53 2.53a1.25 1.25 0 001.768 0l6.25-6.25a1.25 1.25 0 000-1.768L9.213 4.062z" /></svg>
                                    Mejorar Redacción
                                </button>
                                <button type="button" id="ai-fix-note-spell" class="flex-1 text-xs font-medium flex items-center justify-center gap-1.5 px-3 py-1.5 bg-green-50 text-green-700 rounded-md hover:bg-green-100 border border-green-200">
                                    <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.704 4.153a.75.75 0 01.143 1.052l-8 10.5a.75.75 0 01-1.127.075l-4.5-4.5a.75.75 0 011.06-1.06l3.894 3.893 7.48-9.817a.75.75 0 011.052-.143z" clip-rule="evenodd" /></svg>
                                    Corregir Ortografía
                                </button>
                            </div>
                            <input id="note-content-input" type="hidden" name="content">
                            <trix-editor input="note-content-input" class="note-trix-editor ..."></trix-editor>
                        </div>





                        <!-- Opciones de imagen -->
                        <div class="space-y-4 pt-4 border-t">
                            <h4 class="text-base font-semibold text-gray-800">Opciones de Imagen</h4>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Color de la nota</label>
                                <div id="note-color-swatches" class="grid grid-cols-6 gap-2"></div>
                            </div>

                            <div class="grid grid-cols-2 gap-4">
                                <button type="button" id="insert-image-pc-btn" class="flex items-center justify-center gap-2 px-4 py-3 bg-white border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50 text-sm font-medium">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                                    </svg>
                                    Subir Imagen
                                </button>
                                
                                <button type="button" id="insert-image-pexels-btn" class="flex items-center justify-center gap-2 px-4 py-3 bg-gray-800 text-white rounded-md hover:bg-black text-sm font-medium">
                                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                                        <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path>
                                    </svg>
                                    Buscar en Pexels
                                </button>
                            </div>
                            
                            <input type="file" id="note-image-input" class="hidden" accept="image/*">
                            
                        </div>

                        <!-- Opciones de formato -->
                        <div class="space-y-4 pt-4 border-t">
                            <h4 class="text-base font-semibold text-gray-800">Atajos de Formato</h4>
                            <div class="grid grid-cols-2 gap-2 text-sm text-gray-600">
                                <div class="flex items-center gap-2">
                                    <kbd class="px-2 py-1 bg-gray-100 rounded text-xs">Ctrl+B</kbd>
                                    <span>Negrita</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <kbd class="px-2 py-1 bg-gray-100 rounded text-xs">Ctrl+I</kbd>
                                    <span>Cursiva</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <kbd class="px-2 py-1 bg-gray-100 rounded text-xs">Ctrl+U</kbd>
                                    <span>Subrayado</span>
                                </div>
                                <div class="flex items-center gap-2">
                                    <kbd class="px-2 py-1 bg-gray-100 rounded text-xs">Ctrl+K</kbd>
                                    <span>Enlace</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="flex-shrink-0 flex justify-between items-center p-4 border-t border-gray-200 bg-gray-50">
                        <button type="button" id="delete-note-btn" class="px-4 py-2 bg-white border border-gray-300 text-red-600 rounded-md hover:bg-red-50 text-sm font-medium">
                            Eliminar Nota
                        </button>
                        <div class="flex space-x-3">
                            <button type="button" id="note-editor-cancel-btn" class="px-4 py-2 bg-white border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50 text-sm font-medium">
                                Cancelar
                            </button>
                            <button type="submit" class="px-4 py-2 bg-orange-600 text-white rounded-md hover:bg-orange-700 text-sm font-medium">
                                Guardar Nota
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>



        <div id="meeting-invite-modal" class="hidden fixed inset-0 z-[52] flex items-center justify-center">
            <div id="meeting-invite-overlay" class="absolute inset-0 backdrop-blur-sm bg-black bg-opacity-50"></div>
            <div class="bg-white rounded-lg p-6 z-10 w-96 max-w-[90vw]">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">Iniciar Reunión de Voz</h3>
                <div class="mb-4">
                    <label class="flex items-center space-x-2">
                        <input type="checkbox" id="meeting-select-all-users" class="h-4 w-4 rounded border-gray-300 text-orange-600">
                        <span class="text-sm font-medium text-gray-700">Seleccionar todos</span>
                    </label>
                </div>
                <div id="meeting-user-list" class="space-y-2 max-h-60 overflow-y-auto border-t border-b py-2 mb-4">
                    </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" id="meeting-invite-cancel-btn" class="px-4 py-2 bg-white border border-gray-300 rounded-md hover:bg-gray-50 text-sm font-medium">Cancelar</button>
                    <button type="button" id="meeting-invite-call-btn" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 text-sm font-medium">Llamar</button>
                </div>
            </div>
        </div>
        
    </main>
    

    <div id="info-modal" class="hidden fixed inset-0 z-[53] flex items-center justify-center p-4">
            <div id="info-modal-overlay" class="absolute inset-0 backdrop-blur-sm bg-black bg-opacity-60"></div>
            <div class="bg-white rounded-lg p-6 z-10 w-96 max-w-[90vw] transform transition-all scale-95 opacity-0">
                <h3 id="info-modal-title" class="text-lg font-semibold text-gray-900 mb-2"></h3>
                <p id="info-modal-message" class="text-gray-600 mb-6"></p>
                <div class="flex justify-end">
                    <button type="button" id="info-modal-ok-btn" class="px-6 py-2 bg-orange-600 text-white rounded-md hover:bg-orange-700 text-sm font-medium">Aceptar</button>
                </div>
            </div>
        </div>

        <div id="view-card-modal" class="hidden fixed inset-0 z-40">
            <div id="view-card-overlay" class="modal-overlay fixed inset-0 bg-black bg-opacity-60 opacity-0"></div>
            <div id="view-card-content" class="bg-white h-full w-96 max-w-full absolute top-0 right-0 shadow-2xl flex flex-col transform transition-transform duration-300 ease-in-out translate-x-full">
                <div class="flex-shrink-0 flex items-center justify-between p-4 border-b border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-900 flex items-center gap-2">
                        <svg class="w-5 h-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>
                        Detalles de la Tarjeta (Solo Vista)
                    </h3>
                    <button type="button" id="view-card-close-btn" class="p-1 rounded-full text-gray-400 hover:bg-gray-200 hover:text-gray-600">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                    </button>
                </div>

                <div class="flex-grow p-6 space-y-6 overflow-y-auto">
                    <div id="view-card-title-container" class="pb-4 border-b"></div>
                    
                    <div id="view-card-attachment-container"></div>
                    
                    <div id="view-card-description-container"></div>
                    
                    <div class="grid grid-cols-2 gap-4 pt-4 border-t">
                        <div id="view-card-due-date-container"></div>
                        <div id="view-card-assignees-container"></div>
                    </div>

                    <div id="view-card-tags-container" class="pt-4 border-t"></div>
                    
                    <div id="view-card-checklist-container" class="pt-4 border-t"></div>
                    
                    <div id="view-card-comments-container" class="pt-4 border-t"></div>
                </div>
            </div>
        </div>


    <div id="move-to-column-modal" class="hidden fixed inset-0 z-[52] flex items-center justify-center">
        <div id="move-to-column-overlay" class="absolute inset-0 backdrop-blur-sm bg-black bg-opacity-50"></div>
        <div class="bg-white rounded-lg p-6 z-10 w-96 max-w-[90vw]">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Mover Tarjeta a...</h3>
            <form id="move-to-column-form">
                <input type="hidden" id="move-card-id-column" name="cardId">
                <div class="mb-4">
                    <label for="move-to-column-select" class="block text-sm font-medium text-gray-700 mb-2">Seleccionar Columna de Destino</label>
                    <select id="move-to-column-select" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-orange-600 focus:border-red-500">
                        </select>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" id="move-to-column-cancel-btn" class="px-4 py-2 bg-white border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50 text-sm font-medium">Cancelar</button>
                    <button type="submit" class="px-4 py-2 bg-orange-600 text-white rounded-md hover:bg-orange-700 text-sm font-medium">Mover Tarjeta</button>
                </div>
            </form>
        </div>
    </div>

    <div id="move-to-board-modal" class="hidden fixed inset-0 z-[52] flex items-center justify-center">
        <div id="move-to-board-overlay" class="absolute inset-0 backdrop-blur-sm bg-black bg-opacity-50"></div>
        <div class="bg-white rounded-lg p-6 z-10 w-96 max-w-[90vw]">
            <h3 class="text-lg font-semibold text-gray-900 mb-4">Mover Tarjeta a otro Tablero</h3>
            <form id="move-to-board-form">
                <input type="hidden" id="move-card-id-board" name="cardId">
                <div class="mb-4">
                    <label for="move-to-board-select" class="block text-sm font-medium text-gray-700 mb-2">1. Seleccionar Tablero de Destino</label>
                    <select id="move-to-board-select" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-orange-600 focus:border-red-500">
                        </select>
                </div>
                <div class="mb-4">
                    <label for="move-to-board-column-select" class="block text-sm font-medium text-gray-700 mb-2">2. Seleccionar Columna de Destino</label>
                    <select id="move-to-board-column-select" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-orange-600 focus:border-red-500" disabled>
                        <option value="">-- Seleccione un tablero primero --</option>
                    </select>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" id="move-to-board-cancel-btn" class="px-4 py-2 bg-white border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50 text-sm font-medium">Cancelar</button>
                    <button type="submit" id="move-to-board-submit-btn" class="px-4 py-2 bg-orange-600 text-white rounded-md hover:bg-orange-700 text-sm font-medium" disabled>Mover Tarjeta</button>
                </div>
            </form>
        </div>
    </div>

    <div id="collaborator-indicator" class="hidden fixed bottom-4 left-4 z-50">
        <div class="flex items-center gap-2 bg-white/90 backdrop-blur-md text-slate-700 font-semibold text-sm px-4 py-2 rounded-full shadow-lg border border-slate-200">
            <div class="relative flex h-3 w-3">
                <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                <span class="relative inline-flex rounded-full h-3 w-3 bg-green-500"></span>
            </div>
            <span id="collaborator-count-text"></span>
        </div>
    </div>

    <div id="move-success-modal" class="hidden fixed inset-0 z-[53] flex items-center justify-center">
      <div id="move-success-overlay" class="absolute inset-0 backdrop-blur-sm bg-black bg-opacity-50"></div>
      <div class="bg-white rounded-lg p-8 z-10 w-96 max-w-[90vw] text-center transform transition-all scale-95 opacity-0">
        <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100 mb-4">
          <svg class="h-6 w-6 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
          </svg>
        </div>
        <h3 class="text-lg font-semibold text-gray-900 mb-2">¡Éxito!</h3>
        <p class="text-gray-600 mb-6">La tarjeta ha sido movida al otro tablero correctamente.</p>
        <button id="move-success-ok-btn" type="button" class="px-6 py-2 bg-orange-600 text-white rounded-md hover:bg-orange-700 text-sm font-medium">Entendido</button>
      </div>
    </div>

    <div id="edit-board-name-modal" class="hidden fixed inset-0 z-[52] flex items-center justify-center">
        <div id="edit-board-name-overlay" class="absolute inset-0 backdrop-blur-sm bg-black bg-opacity-50"></div>
        <div class="bg-white rounded-lg p-6 z-10 w-96 max-w-[90vw] transform transition-all scale-95 opacity-0">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-900">Editar Nombre del Tablero</h3>
                <button type="button" id="edit-board-name-close-btn" class="p-1 rounded-full text-gray-400 hover:bg-gray-200 hover:text-gray-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <form id="edit-board-name-form">
                <div class="mb-4">
                    <label for="new-board-name-input" class="block text-sm font-medium text-gray-700 mb-2">Nuevo Nombre</label>
                    <input type="text" id="new-board-name-input" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-orange-600 focus:border-red-500">
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" id="edit-board-name-cancel-btn" class="px-4 py-2 bg-white border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50 text-sm font-medium">Cancelar</button>
                    <button type="submit" class="px-4 py-2 bg-orange-600 text-white rounded-md hover:bg-orange-700 text-sm font-medium">Guardar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="trial-welcome-modal" class="hidden fixed inset-0 z-[53] flex items-center justify-center">
        <div class="absolute inset-0 backdrop-blur-sm bg-black bg-opacity-60"></div>
        <div class="bg-white rounded-lg p-8 z-10 w-96 max-w-[90vw] text-center transform transition-all scale-95 opacity-0">
            <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-blue-100 mb-4">
                <svg class="h-6 w-6 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
            </div>
            <h3 class="text-lg font-semibold text-gray-900 mb-2">Bienvenido a tu Período de Prueba</h3>
            <p id="trial-welcome-message" class="text-gray-600 mb-6">...</p>
            <button id="trial-welcome-ok-btn" type="button" class="px-6 py-2 bg-orange-600 text-white rounded-md hover:bg-orange-700 text-sm font-medium">Entendido</button>
        </div>
    </div>


    <div id="collaborator-indicator" class="hidden fixed bottom-4 left-4 z-50">
        <div class="flex items-center gap-2 bg-white/90 backdrop-blur-md text-slate-700 font-semibold text-sm px-4 py-2 rounded-full shadow-lg border border-slate-200">
            <div class="relative flex h-3 w-3">
                <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                <span class="relative inline-flex rounded-full h-3 w-3 bg-green-500"></span>
            </div>
            <span id="collaborator-count-text"></span>
        </div>
    </div>



    <div id="day-view-modal" class="hidden fixed inset-0 z-[52] flex items-center justify-center p-4">
        <div id="day-view-overlay" class="absolute inset-0 backdrop-blur-sm bg-black bg-opacity-50"></div>
        <div class="bg-white rounded-lg shadow-xl z-10 w-full max-w-4xl h-[80vh] flex flex-col">
            <div class="flex-shrink-0 flex items-center justify-between p-4 border-b">
                <h3 id="day-view-title" class="text-lg font-semibold text-gray-800"></h3>
                <button type="button" id="day-view-close-btn" class="p-1 rounded-full text-gray-400 hover:bg-gray-200">
                    <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <div class="flex-grow flex flex-col min-h-0">
                <div id="day-view-all-day-section" class="flex-shrink-0 p-3 border-b">
                    <h4 class="text-xs font-bold text-gray-500 uppercase mb-2">Todo el día</h4>
                    <div id="day-view-all-day-tasks" class="flex flex-wrap gap-2"></div>
                </div>
                <div id="day-view-hourly-container" class="flex-grow overflow-y-auto relative">
                    </div>
            </div>
        </div>
    </div>



    <div id="column-editor-modal" class="hidden fixed inset-0 z-50">
        <div id="column-editor-overlay" class="modal-overlay fixed inset-0 bg-black bg-opacity-60 opacity-0"></div>
        <div id="column-editor-content" class="bg-white h-full w-96 max-w-full absolute top-0 right-0 shadow-2xl flex flex-col transform transition-transform duration-300 ease-in-out translate-x-full">
            <form id="column-editor-form" class="flex flex-col h-full">
                <div class="flex-shrink-0 flex items-center justify-between p-4 border-b border-gray-200">
                    <h3 id="column-modal-title" class="text-lg font-semibold text-gray-900">Editar Columna</h3>
                    <button type="button" id="column-editor-close-btn" class="p-1 rounded-full text-gray-400 hover:bg-gray-200 hover:text-gray-600">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                    </button>
                </div>
                <div class="flex-grow p-6 space-y-6 overflow-y-auto">
                    <input type="hidden" name="column_id">
                    <div>
                        <label for="column-name-input" class="block text-sm font-medium text-gray-700 mb-1">Nombre de la columna</label>
                        <input type="text" id="column-name-input" name="column_name" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-orange-600 focus:border-red-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Color de encabezado</label>
                        <div id="color-swatches-container" class="grid grid-cols-8 gap-2"></div>
                    </div>

                    <div class="border-t pt-5">
                        <h4 class="text-base font-semibold text-gray-800 mb-4">Programación de Columna</h4>
                        <div class="space-y-4">
                            <div class="p-4 rounded-lg bg-gray-50 border border-gray-200">
                            <label for="attracts-tag-select" class="font-semibold text-gray-800">Atraer por Etiqueta</label>
                            <select id="attracts-tag-select" name="attractsTag" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-orange-600 focus:border-red-500">
                            </select>
                            </div>
                            
                            <label for="attracts-today-checkbox" class="flex items-center justify-between p-4 rounded-lg bg-gray-50 border border-gray-200 cursor-pointer hover:bg-red-50 hover:border-red-300 transition-all">
                                <div class="flex items-center gap-4">
                                    <div class="bg-red-100 p-2 rounded-full">
                                        <svg class="h-6 w-6 text-orange-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                                    </div>
                                    <div>
                                        <p class="font-semibold text-gray-800">Tareas para Hoy</p>
                                        <p class="text-xs text-gray-500">Mueve tarjetas con vencimiento hoy.</p>
                                    </div>
                                </div>
                                <div class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="attracts-today-checkbox" name="attractsToday" class="sr-only peer">
                                    <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-focus:ring-2 peer-focus:ring-red-300 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-orange-600"></div>
                                </div>
                            </label>

                            <label for="attracts-overdue-checkbox" class="flex items-center justify-between p-4 rounded-lg bg-gray-50 border border-gray-200 cursor-pointer hover:bg-red-50 hover:border-red-300 transition-all">
                                 <div class="flex items-center gap-4">
                                    <div class="bg-red-100 p-2 rounded-full">
                                        <svg class="h-6 w-6 text-orange-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                    </div>
                                    <div>
                                        <p class="font-semibold text-gray-800">Tareas Vencidas</p>
                                        <p class="text-xs text-gray-500">Mueve tarjetas cuya fecha ya pasó.</p>
                                    </div>
                                </div>
                                <div class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="attracts-overdue-checkbox" name="attractsOverdue" class="sr-only peer">
                                    <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-focus:ring-2 peer-focus:ring-red-300 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-orange-600"></div>
                                </div>
                            </label>
                        </div>
                        <div id="programming-change-notice" class="hidden mt-4 p-3 text-center text-sm text-orange-700 bg-red-100 rounded-lg">
                            <p>Para aplicar los cambios, guarda la configuración y actualiza la página.</p>
                        </div>
                    </div>
                </div>

                <div class="flex-shrink-0 flex justify-between items-center p-4 border-t border-gray-200 bg-gray-50">
                    <button type="button" id="delete-column-btn" class="px-4 py-2 bg-white border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50 text-sm font-medium">Eliminar</button>
                    <div class="flex space-x-3">
                        <button type="button" id="column-editor-cancel-btn" class="px-4 py-2 bg-white border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50 text-sm font-medium">Cancelar</button>
                        <button type="submit" class="px-4 py-2 bg-orange-600 text-white rounded-md hover:bg-orange-600 text-sm font-medium">Guardar Cambios</button>
                    </div>
                </div>

            </form>
        </div>
    </div>

    <div id="add-card-modal" class="hidden fixed inset-0 z-40">
        <div id="add-card-overlay" class="modal-overlay fixed inset-0 bg-black bg-opacity-60 opacity-0"></div>
        <div id="add-card-content" class="bg-white h-full w-96 max-w-full absolute top-0 right-0 shadow-2xl flex flex-col transform transition-transform duration-300 ease-in-out translate-x-full">
             <form id="add-card-form" class="flex flex-col h-full">
                <div class="flex-shrink-0 flex items-center justify-between p-4 border-b border-gray-200">
                    <h3 id="modal-title" class="text-lg font-semibold text-gray-900">Crear Tarjeta</h3>
                    <button type="button" id="add-card-close-btn" class="p-1 rounded-full text-gray-400 hover:bg-gray-200 hover:text-gray-600">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                    </button>
                </div>

                <div class="flex-grow p-6 space-y-6 overflow-y-auto">
                    <input type="hidden" name="card_id">

                    <div>
                        <button type="button" id="complete-task-btn" class="mb-3 px-3 py-2 text-sm font-medium text-white bg-blue-600 rounded-md hover:bg-blue-700">
                            Completar Tarea
                        </button>
                        <input type="text" name="title" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-orange-600 focus:border-red-500" placeholder="Título de la tarjeta">
                    </div>


                    <div>
                        <label for="card-description-input" class="block text-sm font-medium text-gray-700 mb-1">Descripción</label>
                        
                        <div class="flex items-center gap-2 mb-2">
                            <button type="button" id="ai-improve-card-desc" class="flex-1 text-xs font-medium flex items-center justify-center gap-1.5 px-3 py-1.5 bg-blue-50 text-blue-700 rounded-md hover:bg-blue-100 border border-blue-200">
                                <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M17.218 2.232a1.25 1.25 0 00-1.768 0l-8.5 8.5a1.25 1.25 0 000 1.768l2.53 2.53a1.25 1.25 0 001.768 0l8.5-8.5a1.25 1.25 0 000-1.768l-2.53-2.53z" /><path d="M9.213 4.062a1.25 1.25 0 00-1.768 0l-6.25 6.25a1.25 1.25 0 000 1.768l2.53 2.53a1.25 1.25 0 001.768 0l6.25-6.25a1.25 1.25 0 000-1.768L9.213 4.062z" /></svg>
                                Mejorar Redacción
                            </button>
                            <button type="button" id="ai-fix-card-spell" class="flex-1 text-xs font-medium flex items-center justify-center gap-1.5 px-3 py-1.5 bg-green-50 text-green-700 rounded-md hover:bg-green-100 border border-green-200">
                                <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.704 4.153a.75.75 0 01.143 1.052l-8 10.5a.75.75 0 01-1.127.075l-4.5-4.5a.75.75 0 011.06-1.06l3.894 3.893 7.48-9.817a.75.75 0 011.052-.143z" clip-rule="evenodd" /></svg>
                                Corregir Ortografía
                            </button>
                        </div>
                        <input id="card-description-input" type="hidden" name="description">
                        <trix-editor input="card-description-input" class="trix-content"></trix-editor>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Color de la tarjeta</label>
                        <div id="card-color-swatches-container" class="grid grid-cols-8 gap-2"></div>
                    </div>

                    <div class="grid grid-cols-1 gap-4">
                        <div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label for="card-start-date" class="block text-sm font-medium text-gray-700 mb-1">Fecha Inicio</label>
                                    <input type="date" id="card-start-date" name="startDate" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-orange-600 focus:border-red-500">
                                </div>
                                <div>
                                    <label for="card-end-date" class="block text-sm font-medium text-gray-700 mb-1">Fecha Final</label>
                                    <input type="date" id="card-end-date" name="endDate" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-orange-600 focus:border-red-500">
                                </div>
                            </div>

                            <div class="flex items-center justify-between mt-3">
                                <label for="card-all-day" class="flex items-center gap-2 text-sm text-gray-600 cursor-pointer">
                                    <input type="checkbox" id="card-all-day" name="allDay" class="h-4 w-4 rounded border-gray-300 text-orange-600 focus:ring-orange-500">
                                    Todo el día
                                </label>
                            </div>

                            <div id="card-time-inputs" class="hidden grid grid-cols-2 gap-4 mt-3">
                                <div>
                                    <label for="card-start-time" class="block text-xs font-medium text-gray-500 mb-1">Hora Inicio</label>
                                    <input type="time" id="card-start-time" name="startTime" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm text-sm focus:ring-orange-600 focus:border-red-500">
                                </div>
                                <div>
                                    <label for="card-end-time" class="block text-xs font-medium text-gray-500 mb-1">Hora Final</label>
                                    <input type="time" id="card-end-time" name="endTime" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm text-sm focus:ring-orange-600 focus:border-red-500">
                                </div>
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Adjuntar Imagen</label>
                            <div class="flex gap-2">
                                 <button type="button" id="upload-from-pc-btn" class="flex-1 text-center px-4 py-2 bg-white border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50 text-sm font-medium">Subir del PC</button>
                                 <button type="button" id="open-pexels-btn" class="flex-1 text-center px-4 py-2 bg-gray-800 text-white rounded-md hover:bg-black text-sm font-medium">Buscar en Pexels</button>
                            </div>
                            <input type="file" id="card-attachment" name="attachment" class="hidden" accept="image/*">
                        </div>
                    </div>

                    <div id="attachment-preview-container" class="hidden">
                        <p class="text-sm font-medium text-gray-700 mb-2">Vista Previa:</p>
                        <div id="attachment-preview" class="relative w-full h-48 border rounded-lg overflow-hidden bg-gray-100"></div>
                    </div>

                    <div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Urgencia</label>
                                <div id="urgency-tags-container" class="flex flex-col gap-2">
                                    </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Importancia</label>
                                <div id="importance-tags-container" class="flex flex-col gap-2">
                                    </div>
                            </div>
                        </div>
                        <label class="block text-sm font-medium text-gray-700 mt-4 mb-2">Otras Etiquetas</label>
                        <input type="text" name="custom_tags" placeholder="Etiquetas personalizadas (separadas por coma)" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-orange-600 focus:border-red-500 text-sm">
                    </div>

                    <div id="assignment-section" class="pt-4 border-t">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Asignar a:</label>
                        <div id="card-assignment-container" class="flex flex-wrap items-center gap-3">
                            </div>
                    </div>
                    <hr>
                    <div class="space-y-3">
                        <h4 class="text-md font-semibold text-gray-800">Checklist</h4>
                        <div class="w-full bg-gray-200 rounded-full h-2">
                            <div id="checklist-progress-bar" class="bg-orange-600 h-2 rounded-full" style="width: 0%"></div>
                        </div>
                        <ul id="checklist-items" class="space-y-2"></ul>
                        <div class="flex gap-2">
                             <input type="text" id="new-checklist-item-input" placeholder="Añadir un elemento..." class="flex-grow px-3 py-1.5 border border-gray-300 rounded-md shadow-sm focus:ring-orange-600 focus:border-red-500 text-sm">
                             <button type="button" id="add-checklist-item-btn" class="px-4 py-1.5 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 text-sm font-medium">Añadir</button>
                        </div>
                    </div>

                    <hr>
                    <div class="space-y-4">
                        <h4 class="text-md font-semibold text-gray-800">Actividad y Comentarios</h4>
                        <div class="flex gap-2">
                             <textarea id="new-comment-input" placeholder="Escribe un comentario..." rows="2" class="flex-grow px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-orange-600 focus:border-red-500 text-sm"></textarea>
                        </div>
                        <div class="text-right">
                           <button type="button" id="add-comment-btn" class="px-4 py-2 bg-orange-600 text-white rounded-md hover:bg-orange-600 text-sm font-medium">Guardar Comentario</button>
                        </div>
                        <ul id="comments-list" class="space-y-3"></ul>
                    </div>

                    <div class="TimeBoxing-section">
                        <h4 class="text-md font-semibold text-gray-800 mb-4">⏰ TimeBoxing</h4>
                        <div class="space-y-4">
                            <label for="TimeBoxing-checkbox" class="flex items-center justify-between p-4 rounded-lg bg-orange-50 border border-orange-200 cursor-pointer hover:bg-orange-100 transition-all">
                                <div class="flex items-center gap-4">
                                    <div class="bg-orange-100 p-2 rounded-full">
                                        <svg class="h-6 w-6 text-orange-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                                    </div>
                                    <div>
                                        <p class="font-semibold text-gray-800">Activar TimeBoxing</p>
                                        <p class="text-xs text-gray-500">Bloquea tiempo específico para esta tarea</p>
                                    </div>
                                </div>
                                <div class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="TimeBoxing-checkbox" class="sr-only peer">
                                    <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-focus:ring-2 peer-focus:ring-orange-300 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-orange-600"></div>
                                </div>
                            </label>
                            
                            <div id="TimeBoxing-config" class="hidden space-y-3 p-4 bg-gray-50 rounded-lg">
                                <div class="grid grid-cols-2 gap-3">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Fecha</label>
                                        <input type="date" id="TimeBoxing-date" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Hora Inicio</label>
                                        <input type="time" id="TimeBoxing-start" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm">
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Hora Fin</label>
                                    <input type="time" id="TimeBoxing-end" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="flex-shrink-0 flex justify-between items-center p-4 border-t border-gray-200 bg-gray-50">
                    <div class="flex space-x-3">
                         <button type="button" id="delete-card-btn" class="px-4 py-2 bg-white border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50 text-sm font-medium">Eliminar Tarjeta</button>
                         <button type="button" id="add-card-cancel-btn" class="px-4 py-2 bg-white border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50 text-sm font-medium">Cancelar</button>
                        <button type="submit" class="px-4 py-2 bg-orange-600 text-white rounded-md hover:bg-orange-600 text-sm font-medium">Guardar Tarjeta</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
    <div id="assignee-selector-modal" class="hidden fixed inset-0 z-[52] flex items-center justify-center p-4">
        <div id="assignee-selector-overlay" class="absolute inset-0 backdrop-blur-sm bg-black bg-opacity-50"></div>
        <div class="bg-white rounded-lg p-6 z-10 w-96 max-w-[90vw]">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-900">Asignar Tarea</h3>
                <button type="button" id="assignee-selector-close-btn" class="p-1 rounded-full text-gray-400 hover:bg-gray-200">&times;</button>
            </div>
            <div id="assignee-selector-list" class="space-y-2 max-h-60 overflow-y-auto pr-2">
                </div>
            <div class="flex justify-end space-x-3 pt-4">
                <button type="button" id="assignee-selector-cancel-btn" class="px-4 py-2 bg-white border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50 text-sm font-medium">Cancelar</button>
                <button type="button" id="save-assignees-btn" class="px-4 py-2 bg-orange-600 text-white rounded-md hover:bg-orange-700 text-sm font-medium">Guardar Asignación</button>
            </div>
        </div>
    </div>


    <div id="attendance-modal" class="hidden fixed inset-0 z-[52] flex items-center justify-center p-4">
        <div id="attendance-overlay" class="absolute inset-0 backdrop-blur-sm bg-black bg-opacity-50"></div>
        <div class="bg-white rounded-lg p-6 z-10 w-full max-w-lg transform transition-all scale-95 opacity-0">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-900">Asistencia del Tablero</h3>
                <button type="button" id="attendance-close-btn" class="p-1 rounded-full text-gray-400 hover:bg-gray-200 hover:text-gray-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <div class="mb-4">
                <input type="text" id="attendance-filter-input" placeholder="Filtrar por nombre o email..." class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-orange-600 focus:border-red-500 text-sm">
            </div>
            <div class="space-y-4 max-h-[60vh] overflow-y-auto pr-2">
                <div>
                    <h4 class="text-xs font-bold text-gray-500 uppercase mb-2 flex justify-between items-center">
                        <span>Conectados</span>
                        <span id="attendance-online-count" class="px-2 py-0.5 bg-green-100 text-green-800 rounded-full text-xs font-semibold">0</span>
                    </h4>
                    <div id="attendance-list-online" class="space-y-1"></div>
                </div>
                <div>
                    <h4 class="text-xs font-bold text-gray-500 uppercase mb-2 flex justify-between items-center">
                        <span>Desconectados</span>
                        <span id="attendance-offline-count" class="px-2 py-0.5 bg-gray-100 text-gray-800 rounded-full text-xs font-semibold">0</span>
                    </h4>
                    <div id="attendance-list-offline" class="space-y-1"></div>
                </div>
            </div>
        </div>
    </div>








    <div id="loader-view" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; justify-content: center; align-items: center; flex-direction: column; background-color: #FFFFFF; z-index: 9999;">
            <div class="focux-loader">
                <div class="bar"></div>
                <div class="bar"></div>
                <div class="bar"></div>
            </div>
            <div class="focus-text">FOCUX</div>
        </div>




    <div id="generic-confirm-modal" class="hidden fixed inset-0 z-[53] flex items-center justify-center">
        <div id="generic-confirm-overlay" class="absolute inset-0 backdrop-blur-sm bg-black bg-opacity-60"></div>
        <div class="bg-white rounded-lg p-6 z-10 w-96 max-w-[90vw] transform transition-all scale-95 opacity-0">
            <h3 id="generic-confirm-title" class="text-lg font-semibold text-gray-900 mb-2">Confirmar Acción</h3>
            <p id="generic-confirm-message" class="text-gray-600 mb-6">¿Estás seguro de que quieres continuar?</p>
            <div class="flex justify-end space-x-3">
                <button type="button" id="generic-confirm-cancel-btn" class="px-4 py-2 bg-white border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50 text-sm font-medium">Cancelar</button>
                <button type="button" id="generic-confirm-ok-btn" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 text-sm font-medium">Confirmar</button>
            </div>
        </div>
    </div>


    <div id="share-board-modal" class="hidden fixed inset-0 z-[52] flex items-center justify-center">

        <div id="share-board-overlay" class="absolute inset-0 backdrop-blur-sm bg-black bg-opacity-50"></div>
        <div class="bg-white rounded-lg p-6 z-10 w-[500px] max-w-[90vw] transform transition-all scale-95 opacity-0">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-900">Compartir Tablero</h3>
                <button type="button" id="share-board-close-btn" class="p-1 rounded-full text-gray-400 hover:bg-gray-200">
                    <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            
            <div class="p-4 rounded-lg bg-gray-50 border border-gray-200 mb-4">
                <p class="text-sm font-medium text-gray-700 mb-2">Invitar por email</p>
                <div class="flex items-center gap-2">
                    <input type="email" id="share-new-recipient-email" placeholder="Email del usuario a invitar" class="flex-grow px-3 py-1.5 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 text-sm">
                    <button type="button" id="share-add-user-btn" class="px-4 py-1.5 bg-blue-500 text-white rounded-md hover:bg-blue-600 text-sm font-medium">Invitar</button>
                </div>
                <p id="share-modal-status" class="text-xs text-center font-medium mt-2 h-4"></p>
            </div>

            <div class="p-4 rounded-lg bg-gray-50 border border-gray-200 mb-4">
                <p class="text-sm font-medium text-gray-700 mb-2">Invitar masivamente desde Excel</p>
                <p class="text-xs text-gray-500 mb-3">Selecciona un archivo .xlsx donde la primera columna (A) contenga los correos.</p>
                <input type="file" id="excel-file-input" class="hidden" accept=".xlsx, .xls">
                <div class="flex items-center gap-2">
                    <label for="excel-file-input" class="flex-grow text-center px-4 py-2 bg-white border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50 text-sm font-medium cursor-pointer truncate">
                        <span id="excel-file-label">Seleccionar archivo...</span>
                    </label>
                    <button type="button" id="share-from-excel-btn" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 text-sm font-medium disabled:opacity-50" disabled>Invitar</button>
                </div>
                <p id="share-excel-status" class="text-xs text-center font-medium mt-2 h-4"></p>
            </div>

            <div>
                <h4 class="font-semibold text-gray-800 mb-2">Personas con Acceso</h4>
                <ul id="collaborators-list" class="space-y-2 max-h-60 overflow-y-auto pr-2">
                </ul>
            </div>
        </div>
    </div>

    <div id="ai-group-chat-modal" class="hidden fixed inset-0 z-[53] flex items-center justify-center p-4">
        <div id="ai-group-chat-overlay" class="absolute inset-0 backdrop-blur-sm bg-black bg-opacity-50"></div>
        <div class="bg-white rounded-lg p-6 z-10 w-full max-w-sm max-h-[80vh] flex flex-col transform transition-all scale-95 opacity-0">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-900">Iniciar Reunión de IA</h3>
                <button type="button" id="ai-group-chat-close-btn" class="p-1 rounded-full text-gray-400 hover:bg-gray-200 hover:text-gray-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <p class="text-sm text-gray-600 mb-4">Selecciona los asistentes con los que quieres conversar.</p>
            <div id="ai-group-chat-list" class="flex-grow space-y-2 overflow-y-auto pr-2">
                </div>
            <div class="flex justify-end space-x-3 pt-4 border-t">
                <button type="button" id="ai-group-chat-cancel-btn" class="px-4 py-2 bg-white border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50 text-sm font-medium">Cancelar</button>
                <button type="button" id="ai-group-chat-start-btn" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 text-sm font-medium" disabled>Iniciar Reunión</button>
            </div>
        </div>
    </div>

    <div id="user-selector-modal" class="hidden fixed inset-0 z-[52] flex items-center justify-center">
            <div id="user-selector-overlay" class="absolute inset-0 backdrop-blur-sm bg-black bg-opacity-50"></div>
            <div class="bg-white rounded-lg p-6 z-10 w-96 max-w-[90vw] transform transition-all scale-95 opacity-0">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-900">Iniciar Nuevo Chat</h3>
                    <button type="button" id="user-selector-close-btn" class="p-1 rounded-full text-gray-400 hover:bg-gray-200 hover:text-gray-600">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                    </button>
                </div>
                <div class="mb-4">
                    <input type="text" id="new-chat-user-search" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-orange-600 focus:border-red-500" placeholder="Buscar por nombre o email...">
                </div>
                <div id="new-chat-user-list" class="space-y-2 max-h-60 overflow-y-auto pr-2">
                    </div>
            </div>
        </div>


    <div id="pexels-modal" class="hidden fixed inset-0 z-[52]">
        <div id="pexels-overlay" class="modal-overlay fixed inset-0 bg-black bg-opacity-70 opacity-0"></div>
        <div id="pexels-content" class="bg-gray-100 h-full w-[600px] max-w-full absolute top-0 right-0 shadow-2xl flex flex-col transform transition-transform duration-300 ease-in-out translate-x-full">
            <div class="flex-shrink-0 flex items-center justify-between p-4 border-b border-gray-200 bg-white">
                <h3 class="text-lg font-semibold text-gray-900">Buscar Imágenes en Pexels</h3>
                <button type="button" id="pexels-close-btn" class="p-1 rounded-full text-gray-400 hover:bg-gray-200 hover:text-gray-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <div class="flex-shrink-0 p-4 bg-white border-b">
                <form id="pexels-search-form" class="flex gap-2">
                    <input type="search" id="pexels-search-input" placeholder="Buscar imágenes (ej: oficina, naturaleza, foco)..." required class="flex-grow w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-orange-600 focus:border-red-500">
                    <button type="submit" class="px-4 py-2 bg-orange-600 text-white rounded-md hover:bg-orange-700 font-medium">Buscar</button>
                </form>
            </div>
            <div id="pexels-grid-container" class="flex-grow p-4 overflow-y-auto">
                <div id="pexels-loader" class="hidden text-center py-10">
                    <p class="text-gray-600">Buscando imágenes...</p>
                </div>
                <div id="pexels-grid" class="grid grid-cols-2 md:grid-cols-3 gap-4">
                    </div>
                <div id="pexels-no-results" class="hidden text-center py-10">
                    <p class="text-gray-600">No se encontraron resultados. Intenta con otra búsqueda.</p>
                </div>
            </div>
            <div class="flex-shrink-0 text-center p-2 bg-white border-t">
                <a href="https://www.pexels.com" target="_blank" class="text-xs text-gray-500 hover:text-orange-600">Imágenes cortesía de Pexels</a>
            </div>
        </div>
    </div>

    <div id="TimeBoxing-active-overlay" class="TimeBoxing-overlay">
        <div class="TimeBoxing-modal">
            <div class="text-6xl mb-4">⏰</div>
            <h2 class="text-2xl font-bold text-gray-800 mb-4">¡TimeBoxing Activado!</h2>
            <p class="text-lg text-gray-600 mb-2" id="TimeBoxing-task-title"></p>
            <p class="text-sm text-gray-500" id="TimeBoxing-task-details"></p>
            <div class="mt-6">
                <p class="text-sm text-orange-600 font-medium">El temporizador iniciará en 5 segundos...</p>
            </div>
        </div>
    </div>


    <div id="documents-container" class="hidden pt-24 min-h-screen">
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 p-6" style="align-items: start;">
            
            <div id="documents-column">
                <div class="flex justify-between items-center mb-6 w-full">
                    <h2 class="text-2xl font-bold text-orange-600">Documentos</h2>
                    <button id="add-document-btn" class="px-4 py-2 bg-orange-600 text-white text-sm font-semibold rounded-lg shadow-sm hover:bg-orange-700 transition-colors flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M6 2a2 2 0 00-2 2v12a2 2 0 002 2h8a2 2 0 002-2V7.414A2 2 0 0015.414 6L12 2.586A2 2 0 0010.586 2H6zm5 6a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V8z" clip-rule="evenodd" /></svg>
                        Agregar Documento
                    </button>
                </div>
                <div id="documents-grid" class="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-3 gap-6 w-full">
                    <div class="col-span-full text-center py-8 text-gray-500">
                        No hay documentos en este tablero. ¡Agrega uno!
                    </div>
                </div>
            </div>
            
            <div id="references-column" class="lg:border-l lg:pl-8 border-gray-200">
                <div class="flex justify-between items-center mb-6 w-full">
                    <h2 class="text-2xl font-bold text-blue-600">Referencias</h2>
                    <button id="add-reference-btn" class="px-4 py-2 bg-blue-600 text-white text-sm font-semibold rounded-lg shadow-sm hover:bg-blue-700 transition-colors flex items-center gap-2">
                         <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M12.586 4.586a2 2 0 112.828 2.828l-3 3a2 2 0 01-2.828 0 1 1 0 00-1.414 1.414 4 4 0 005.656 0l3-3a4 4 0 00-5.656-5.656l-1.5 1.5a1 1 0 101.414 1.414l1.5-1.5zm-5 5a2 2 0 012.828 0 1 1 0 101.414-1.414 4 4 0 00-5.656 0l-3 3a4 4 0 105.656 5.656l1.5-1.5a1 1 0 10-1.414-1.414l-1.5 1.5a2 2 0 11-2.828-2.828l3-3z" clip-rule="evenodd" /></svg>
                        Agregar Referencia
                    </button>
                </div>
                <div id="references-grid" class="space-y-4 w-full">
                    <div class="text-center py-8 text-gray-500">
                        No hay referencias guardadas.
                    </div>
                </div>
            </div>
        </div>
    </div>





    <div id="change-cover-modal" class="hidden fixed inset-0 z-[52] flex items-center justify-center p-4">
        <div id="change-cover-overlay" class="absolute inset-0 backdrop-blur-sm bg-black bg-opacity-60"></div>
        <div class="bg-white rounded-lg p-6 z-10 w-full max-w-md transform transition-all scale-95 opacity-0">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-900">Actualizar Documento</h3>
                <button type="button" id="change-cover-close-btn" class="p-1 rounded-full text-gray-400 hover:bg-gray-200">&times;</button>
            </div>
            <form id="change-cover-form" class="space-y-6">
                <input type="hidden" id="change-cover-doc-id">
                <input type="hidden" id="doc-cover-url-hidden">
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Portada del Documento</label>
                    <div id="cover-preview-container" class="w-full h-40 bg-gray-100 rounded-md mb-2 flex items-center justify-center border border-dashed">
                        <span class="text-xs text-gray-500">Vista previa de la imagen</span>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <button type="button" id="cover-from-pc-btn" class="w-full text-center px-4 py-2 bg-white border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50 text-sm font-medium">Subir del PC</button>
                        <button type="button" id="cover-from-pexels-btn" class="w-full text-center px-4 py-2 bg-gray-800 text-white rounded-md hover:bg-black text-sm font-medium">Buscar en Pexels</button>
                    </div>
                    <input type="file" id="cover-file-input" class="hidden" accept="image/*">
                </div>

                <div>
                    <label for="doc-password" class="block text-sm font-medium text-gray-700 mb-1">Proteger con Contraseña (Opcional)</label>
                    <input type="password" id="doc-password" placeholder="Deja en blanco para no usar contraseña" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-orange-600 focus:border-red-500">
                </div>

                <div class="flex justify-end space-x-3 pt-2">
                    <button type="button" id="change-cover-cancel-btn" class="px-4 py-2 bg-white border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50 text-sm font-medium">Cancelar</button>
                    <button type="submit" id="change-cover-submit-btn" class="px-4 py-2 bg-orange-600 text-white rounded-md hover:bg-orange-700 text-sm font-medium">Guardar Cambios</button>
                </div>
            </form>
        </div>
    </div>


    <div id="add-reference-modal" class="hidden fixed inset-0 z-[52] flex items-center justify-center p-4">
        <div id="add-reference-overlay" class="absolute inset-0 backdrop-blur-sm bg-black bg-opacity-60"></div>
        <div class="bg-white rounded-lg p-6 z-10 w-full max-w-md transform transition-all scale-95 opacity-0">
            <div class="flex items-center justify-between mb-4">
                <h3 id="reference-modal-title" class="text-lg font-semibold text-gray-900">Agregar Nueva Referencia</h3>
                <button type="button" id="add-reference-close-btn" class="p-1 rounded-full text-gray-400 hover:bg-gray-200">&times;</button>
            </div>
            <form id="add-reference-form" class="space-y-4">
                <input type="hidden" id="reference-id-input">
                <div>
                    <label for="reference-title-input" class="block text-sm font-medium text-gray-700 mb-1">Título</label>
                    <input type="text" id="reference-title-input" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="Ej: Documentación Oficial de Vue.js">
                </div>
                <div>
                    <label for="reference-url-input" class="block text-sm font-medium text-gray-700 mb-1">URL del Enlace</label>
                    <input type="url" id="reference-url-input" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" placeholder="https://ejemplo.com/recurso">
                </div>
                <div class="flex justify-end space-x-3 pt-4">
                    <button type="button" id="add-reference-cancel-btn" class="px-4 py-2 bg-white border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50 text-sm font-medium">Cancelar</button>
                    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 text-sm font-medium">Guardar Referencia</button>
                </div>
            </form>
        </div>
    </div>

    <div id="TimeBoxing-finished-overlay" class="TimeBoxing-overlay">
        <div class="TimeBoxing-modal">
            <div class="text-6xl mb-4">⏰</div>
            <h2 class="text-2xl font-bold text-gray-800 mb-4">¡Tiempo Terminado!</h2>
            <p class="text-lg text-gray-600 mb-4">Tu sesión de TimeBoxing ha finalizado.</p>
            <button id="TimeBoxing-finished-ok" class="px-6 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700">
                Entendido
            </button>
        </div>
    </div>

    <div id="timer-container" class="timer-container hidden">
        <div id="timer-text"></div>
    </div>

    <div id="mr-focus-container">
        <div id="mr-focus-tip" class="hidden"></div>
        <div id="mr-focus-avatar">
            <img src="https://i.ibb.co/TqmsjjdW/Imagen-de-Whats-App-2025-08-20-a-las-21-12-47-5259b14f-removebg-preview-removebg-preview.png" alt="Mr. Focus">
        </div>
    </div>

    <div id="pomodoro-timer-widget" 
         class="hidden relative p-3 rounded-xl shadow-2xl font-mono transition-all duration-300 bg-white/95 backdrop-blur-sm border border-gray-200" 
         style="position: fixed; bottom: 1.25rem; left: 1.25rem; width: 12rem; z-index: 10001;">
        
        <button id="pomodoro-close-widget-btn" 
                class="absolute -top-2 -right-2 w-6 h-6 bg-gray-700 text-white rounded-full flex items-center justify-center hover:bg-black transition-colors" 
                title="Detener y cerrar temporizador">
            &times;
        </button>
        
        <div id="pomodoro-status" class="text-xs font-bold mb-2 text-center rounded-full px-3 py-1 transition-colors duration-300 truncate"></div>
        <div id="pomodoro-time" class="text-4xl font-bold tracking-wider text-center text-slate-800"></div>
    </div>

<script type="text/javascript" src="https://unpkg.com/trix@2.0.0/dist/trix.umd.min.js"></script>

<script>


document.addEventListener('DOMContentLoaded', () => {


    const regenerateBtn = document.getElementById('regenerate-suggestions-btn');
    if (regenerateBtn) {
        regenerateBtn.addEventListener('click', () => {
            if (currentEditorForAISuggestions) {
                // Llama a la función principal de nuevo con el editor guardado
                getWritingSuggestionsAI(currentEditorForAISuggestions);
            }
        });
    }

    // Notifications elements
    const notificationsBtn = document.getElementById('notifications-btn');
    const notificationsDropdown = document.getElementById('notifications-dropdown');
    const notificationsBadge = document.getElementById('notifications-badge');
    const notificationsList = document.getElementById('notifications-list');
    const clearNotificationsBtn = document.getElementById('clear-notifications-btn');
    const notesViewBtn = document.getElementById('notes-view-btn');
    const notesContainer = document.getElementById('notes-container');



    // API Configuration
    const API_BASE_URL = 'https://focux-app.onrender.com';
    
    // Authentication Check
    const currentUser = JSON.parse(localStorage.getItem('user') || 'null');
    if (!currentUser) {
        window.location.href = 'index.html';
        return;
    }


    // --- AÑADIR ESTE BLOQUE COMPLETO ---
    // Cargar dinámicamente el logo de la institución
    const institutionLogoImg = document.getElementById('institution-logo-img');
    if (institutionLogoImg) {
        const defaultLogo = "https://i.postimg.cc/Qt6r571n/Adobe-Express-file.png";
        
        // La URL del logo ahora viene desde el login y se guarda en localStorage
        const dbLogoUrl = currentUser.logo_url; 
        
        institutionLogoImg.src = dbLogoUrl || defaultLogo;
        
        // Si la URL personalizada falla, vuelve al logo por defecto
        institutionLogoImg.onerror = () => {
            console.warn('La URL del logo personalizado falló. Usando el logo por defecto.');
            institutionLogoImg.src = defaultLogo;
        };
    }


    const PASTEL_TAG_COLORS = [
        'bg-slate-200 text-slate-800',
        'bg-gray-200 text-gray-800',
        'bg-zinc-200 text-zinc-800',
        'bg-neutral-200 text-neutral-800',
        'bg-stone-200 text-stone-800',
        'bg-red-200 text-red-800',
        'bg-orange-200 text-orange-800',
        'bg-amber-200 text-amber-800',
        'bg-yellow-200 text-yellow-800',
        'bg-lime-200 text-lime-800',
        'bg-green-200 text-green-800',
        'bg-emerald-200 text-emerald-800',
        'bg-teal-200 text-teal-800',
        'bg-cyan-200 text-cyan-800',
        'bg-sky-200 text-sky-800',
        'bg-blue-200 text-blue-800',
        'bg-indigo-200 text-indigo-800',
        'bg-violet-200 text-violet-800',
        'bg-purple-200 text-purple-800',
        'bg-fuchsia-200 text-fuchsia-800',
        'bg-pink-200 text-pink-800',
        'bg-rose-200 text-rose-800'
    ];


    function formatAiResponse(text) {
        if (!text) return '';
        return text.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>').replace(/\n/g, '<br>');
    }
    

    // ... Pega aquí el RESTO de tus funciones de JavaScript que ya funcionaban ...
    // (loadUserBoards, createCardElement, saveBoardData, etc.)

    // ========================================================================
    // == 4. INICIALIZACIÓN DE LA APLICACIÓN
    // ========================================================================
    
    // Asigna los listeners a las pestañas
    document.getElementById('chat-mode-board').addEventListener('click', () => switchChatMode('board'));
    document.getElementById('chat-mode-general').addEventListener('click', () => switchChatMode('general'));
    document.getElementById('chat-mode-ai').addEventListener('click', () => switchChatMode('ai'));





    const urlParams = new URLSearchParams(window.location.search);
    const isFirstLogin = urlParams.get('firstLogin') === 'true';
    const userForTrialCheck = JSON.parse(localStorage.getItem('user') || 'null');

    if (userForTrialCheck && userForTrialCheck.access_expires_on) {
        const expiryDateStr = userForTrialCheck.access_expires_on;
        const lastDayFlag = `lastDayNotified_v2_${userForTrialCheck.email}_${expiryDateStr}`;
        
        const now = new Date();
        const expiryDate = new Date(expiryDateStr + 'T23:59:59');
        const diffTime = expiryDate - now;
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

        const isLastDay = (diffDays === 1 && !localStorage.getItem(lastDayFlag));

        // MOSTRAR EL MODAL SI: es el primer login (detectado por URL) O si es el último día.
        if (isFirstLogin || isLastDay) {
            const modal = document.getElementById('trial-welcome-modal');
            const content = modal.querySelector('.transform');
            const titleEl = document.getElementById('trial-welcome-title').querySelector('span');
            const messageEl = document.getElementById('trial-welcome-message');
            const subtitleEl = document.getElementById('trial-welcome-subtitle');

            if (isFirstLogin) {
                titleEl.textContent = `¡Bienvenido a Focux!`;
                messageEl.textContent = `Has iniciado tu período de prueba gratuito. Tienes ${diffDays} días para explorar todas las herramientas de productividad que hemos diseñado para potenciar tus proyectos.`;
                subtitleEl.textContent = "Bienvenido a un mundo de organización y enfoque.";
            } else { // isLastDay
                titleEl.textContent = `🔔 Recordatorio Amigable`;
                messageEl.textContent = `Tu período de prueba de Focux está a punto de finalizar. Mañana será tu último día para acceder a todas las funcionalidades.`;
                subtitleEl.textContent = "Para continuar sin interrupciones, por favor, contacta al administrador y consulta los planes de licencia.";
                localStorage.setItem(lastDayFlag, 'true');
            }
            
            modal.classList.remove('hidden');
            setTimeout(() => content.classList.remove('scale-95', 'opacity-0'), 10);
            
            document.getElementById('trial-welcome-ok-btn').onclick = () => {
                content.classList.add('scale-95', 'opacity-0');
                setTimeout(() => modal.classList.add('hidden'), 200);
            };

            // Limpiar la URL para que el modal no aparezca si se recarga la página
            window.history.replaceState({}, document.title, window.location.pathname);
        }
    }

















    // Inicializar el plan del usuario
    if (!currentUser.plan) {
        currentUser.plan = 'Básico';
        localStorage.setItem('user', JSON.stringify(currentUser));
    }

    const userNameEl = document.getElementById('user-name');
    if (userNameEl && currentUser && currentUser.first_name && currentUser.last_name) {
        userNameEl.textContent = `${currentUser.first_name} ${currentUser.last_name}`;
    } else if (userNameEl && currentUser) {
        userNameEl.textContent = currentUser.email; // Fallback al email si no hay nombre
    }
    
    console.log('🔗 Intentando conectar Socket.IO a:', API_BASE_URL);

    const socket = io(API_BASE_URL, {
        reconnectionAttempts: 5,
        reconnectionDelay: 1000,
        timeout: 10000,
        transports: ['websocket', 'polling'],
        extraHeaders: {
            'ngrok-skip-browser-warning': 'true'
        }
    });


    let cardDataStore = new Map();

    let conversationsCache = []; 

    let isProgrammaticallyChangingTrix = false; 

    let draggedCard = null;

    let draggedColumn = null;

    let currentColumnId = null;

    let currentCardId = null;

    let activeTagFilter = null;

    let currentCalendarDate = new Date();

    let pexelsTarget = 'card';

    let boardOptions = {};

    let deleteTargetType, deleteTargetId;



    let notifications = JSON.parse(localStorage.getItem('focux_notifications') || '[]');

    let notificationsReadCount = notifications.filter(n => !n.read).length;





    socket.on('connect', () => {
        console.log('🔌 ✅ Socket.IO conectado exitosamente.');

        if (currentUser && currentUser.email) {
            // 1. Suscribe al usuario a su canal personal para recibir mensajes privados.
            //    Esto le dice al servidor a dónde enviar los mensajes directos para este usuario.
            socket.emit('subscribe_to_personal_channel', { email: currentUser.email });

            // 2. Pide la lista de conversaciones de chat personal existentes.
            //    El servidor responderá con un evento 'global_chat_conversations' para poblar la lista.
            socket.emit('global_chat_list_conversations', { email: currentUser.email });
        }
    });


    socket.on('board_was_updated', (data) => {
        // Solo reacciona si el cambio lo hizo OTRO usuario para evitar parpadeos
        if (data.board_id == currentBoardId && data.email !== currentUser.email) {
            console.log('🔄 Sincronizando cambios de contenido (tarjetas/columnas)...');
            
            // --- CORRECCIÓN CLAVE ---
            // Se ha eliminado la línea "loadBoardData(currentBoardId);"
            // Ahora, este evento ya no fuerza una recarga completa, permitiendo
            // que los eventos más específicos (como 'card_moved') manejen
            // las actualizaciones de forma sutil.
        }
    });




    // Listener para cuando el DUEÑO cambia los permisos o miembros del tablero
    socket.on('permissions_updated', (data) => {
        // Solo recarga si la actualización es para el tablero actual
        if (data.board_id == currentBoardId) {
            console.log('📢 Permisos o miembros cambiados. Recargando datos del tablero...');
            loadBoardData(currentBoardId);
        }
    });

    // Listener para la notificación DIRECTA que recibe un usuario cuando su propio permiso cambia
    socket.on('my_permission_updated', (data) => {
        if (data.board_id == currentBoardId) {
            console.log(`✅ ¡MIS PERMISOS HAN CAMBIADO! Nuevo nivel: ${data.new_permission_level}`);
            
            // Actualiza la variable de estado DE INMEDIATO
            currentUserPermissionLevel = data.new_permission_level;
            
            // Aplica los cambios a la interfaz DE INMEDIATO para desbloquear/bloquear funciones
            updateUIForPermissions(currentUserPermissionLevel);
        }
    });


    socket.on('card_deleted', (data) => {
        // Solo reaccionar si la tarjeta eliminada pertenece al tablero actual
        if (data.board_id !== currentBoardId) return;

        console.log(`↓ Recibiendo eliminación de tarjeta en tiempo real: ${data.card_id}`);
        const cardId = data.card_id;

        // 1. Quitar la tarjeta del almacén de datos local
        cardDataStore.delete(cardId);

        // 2. Buscar el elemento HTML de la tarjeta en la página
        const cardElement = document.getElementById(cardId);
        if (cardElement) {
            // 3. Aplicar una animación de salida y luego eliminarla del DOM
            cardElement.classList.add('animate__animated', 'animate__zoomOut');
            setTimeout(() => {
                cardElement.remove();
                // 4. Actualizar los contadores de las columnas para que reflejen el cambio
                updateColumnHeaders();
            }, 500); // Duración de la animación en milisegundos
        } else {
             // Si por alguna razón el elemento no está, al menos actualiza los contadores
             updateColumnHeaders();
        }
    });





    socket.on('connect_error', (error) => {
        console.error('❌ Error de conexión Socket.IO:', error);
    });

    socket.on('disconnect', (reason) => {
        console.log('🔌 ❌ Socket.IO desconectado:', reason);
    });

    socket.on('chat_message_received', (data) => {
        if (data.board_id == currentBoardId) {
            // Evita volver a pintar tu propio mensaje que ya se mostró
            if (data.user_email !== currentUser.email) {
                appendBoardChatMessage(data);
            }
        }
    });

    // ========================================================================
    // == LISTENERS PARA LA SINCRONIZACIÓN EN TIEMPO REAL
    // ========================================================================





    socket.on('reconnect', (attemptNumber) => {
        console.log('🔌 🔄 Socket.IO reconectado después de', attemptNumber, 'intentos');
    });


    socket.on('note_created', (data) => {
        // 1. La condición ahora solo verifica si la nota pertenece al tablero actual.
        //    Esto asegura que el caché se actualice incluso si el usuario no está viendo la pestaña de notas.
        if (data.board_id === currentBoardId) {
            
            // 2. Verificamos si la nota ya existe en el caché local para evitar duplicados.
            const noteExists = notesCache.some(n => n.id === data.note.id);
            
            if (!noteExists) {
                // 3. Si la nota es nueva, la añadimos al inicio del caché.
                notesCache.unshift(data.note);
                console.log(`SOCKET: Nota [${data.note.id}] añadida al caché. Total: ${notesCache.length}`);

                // 4. [LA CORRECCIÓN CLAVE] Solo volvemos a dibujar la vista si el usuario
                //    está actualmente en la pestaña de notas. Esto previene la doble
                //    renderización que causa el error.
                if (notesContainer.classList.contains('active')) {
                    renderNotes();
                }
            }
        }
    });

    socket.on('note_updated', (data) => {
        if (data.board_id === currentBoardId && notesContainer.classList.contains('active')) {
            console.log('SOCKET: Nota actualizada en tiempo real', data.note);
            const index = notesCache.findIndex(n => n.id === data.note.id);
            if (index !== -1) {
                // Reemplazar la nota vieja con la nueva en el caché
                notesCache[index] = data.note;
                renderNotes();
            }
        }
    });

    socket.on('note_deleted', (data) => {
        if (data.board_id === currentBoardId && notesContainer.classList.contains('active')) {
            console.log('SOCKET: Nota eliminada en tiempo real, ID:', data.note_id);
            // Filtrar para eliminar la nota del caché
            notesCache = notesCache.filter(n => n.id !== data.note_id);
            renderNotes();
        }
    });


// Global chat DOM elements
    const userSelectorModal = document.getElementById('user-selector-modal');
    const userSelectorOverlay = document.getElementById('user-selector-overlay');
    const userSelectorContent = userSelectorModal.querySelector('.transform');
    const newChatUserList = document.getElementById('new-chat-user-list');

    // Muestra el modal de selección de usuario
    async function showUserSelectorModal() {
        userSelectorModal.classList.remove('hidden');
        setTimeout(() => {
            userSelectorContent.classList.remove('scale-95', 'opacity-0');
            userSelectorContent.classList.add('scale-100', 'opacity-100');
        }, 10);

        await fetchAllUsersForSelector();
    }

    // Oculta el modal de selección de usuario
    function hideUserSelectorModal() {
        userSelectorContent.classList.add('scale-95', 'opacity-0');
        setTimeout(() => userSelectorModal.classList.add('hidden'), 200);
    }


    async function fetchAllUsersForSelector() {
        newChatUserList.innerHTML = '<div class="p-4 text-center text-gray-500">Cargando...</div>';
        try {
            const response = await fetch(`${API_BASE_URL}/users/directory`);
            const data = await response.json();
            if (data.success) {
                const otherUsers = data.users.filter(user => user.email !== currentUser.email);
                renderUserSelectorList(otherUsers);
            } else {
                newChatUserList.innerHTML = '<div class="p-4 text-center text-red-500">Error al cargar usuarios.</div>';
            }
        } catch (error) {
            newChatUserList.innerHTML = '<div class="p-4 text-center text-red-500">Error de conexión.</div>';
        }
    }


    socket.on('global_chat_conversations', (data) => renderConversationList(data.conversations || []));
    socket.on('global_chat_history', (data) => renderGeneralChatConversation(data));



    function renderConversationList(conversations) {
        const container = document.getElementById('user-directory-container');
        conversationsCache = conversations;
        container.innerHTML = `
            <div class="flex-shrink-0 p-3 border-b">
                <div class="flex justify-between items-center mb-2">
                    <h4 class="font-bold text-gray-800">Chats</h4>
                    <button id="add-new-conversation-btn" class="px-3 py-1 bg-orange-600 text-white rounded-md text-sm font-medium hover:bg-orange-700">+ Nuevo</button>
                </div>
            </div>
            <div class="flex-grow overflow-y-auto">
                ${conversations.length > 0 ? conversations.map(c => conversationListItemTemplate(c)).join('') : '<div class="p-4 text-center text-sm text-gray-500">No tienes chats.</div>'}
            </div>
        `;
        container.querySelector('#add-new-conversation-btn').onclick = showUserSelectorModal;
        container.querySelectorAll('.conversation-list-item').forEach(item => {
            item.onclick = () => {
                socket.emit('global_chat_start', { email: currentUser.email, partner_email: item.dataset.email });
            };
        });
    }


    // --- PLANTILLA CORREGIDA PARA EL DIRECTORIO DE USUARIOS AL CREAR NUEVO CHAT ---
    function renderUserSelectorList(users) {
        newChatUserList.innerHTML = '';
        users.forEach(user => {
            const fullName = `${user.first_name} ${user.last_name}`;
            const initials = fullName.split(' ').map(n=>n[0]).join('').substring(0,2);

            const item = document.createElement('div');
            item.className = 'flex items-center p-2 rounded-lg cursor-pointer hover:bg-gray-100';
            item.dataset.email = user.email;

            // --- CORRECCIÓN AQUÍ: Se asegura de mostrar nombre y correo ---
            item.innerHTML = `
                <div class="chat-avatar ${getUserColor(user.email).bg} mr-3">${initials}</div>
                <div class="flex-grow">
                    <div class="font-semibold text-gray-800 text-sm">${fullName}</div>
                    <div class="text-xs text-gray-500">${user.email}</div>
                </div>
            `;
            // --- FIN DE LA CORRECCIÓN ---

            item.addEventListener('click', () => {
                hideUserSelectorModal();
                socket.emit('global_chat_start', { email: currentUser.email, partner_email: user.email });
            });
            newChatUserList.appendChild(item);
        });

        document.getElementById('new-chat-user-search').addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase();
            newChatUserList.querySelectorAll('.flex.items-center').forEach(item => {
                const email = item.dataset.email.toLowerCase();
                const name = item.querySelector('.font-semibold').textContent.toLowerCase();
                item.style.display = (email.includes(query) || name.includes(query)) ? 'flex' : 'none';
            });
        });
    }




    // Event listeners para el nuevo modal
    userSelectorModal.querySelector('#user-selector-close-btn').addEventListener('click', hideUserSelectorModal);
    userSelectorOverlay.addEventListener('click', hideUserSelectorModal);




    const MINIMUM_LOADER_TIME = 150;







    async function loadGeneralChatUserDirectory() {
        currentGeneralConvId = null;
        const userDirContainer = document.getElementById('user-directory-container');
        const convContainer = document.getElementById('conversation-view-container');
        userDirContainer.classList.remove('hidden');
        userDirContainer.classList.add('flex');
        convContainer.classList.add('hidden');
        
        userDirContainer.innerHTML = '<div class="p-4 text-center text-gray-500">Cargando conversaciones...</div>';

        try {
            // --- INICIO DE LA CORRECCIÓN ---
            // Se cambia la llamada para obtener el directorio completo de usuarios
            const response = await fetch(`${API_BASE_URL}/users/directory`, {
                headers: { 'ngrok-skip-browser-warning': 'true' }
            });
            const data = await response.json();

            if (data.success && data.users) {
                // Se renderiza el directorio de usuarios en lugar de la lista de conversaciones
                renderUserDirectory(data.users);
            } else {
                throw new Error(data.message || 'No se pudo cargar el directorio.');
            }
            // --- FIN DE LA CORRECCIÓN ---

        } catch (error) {
            userDirContainer.innerHTML = '<div class="p-4 text-center text-red-500">Error de conexión al cargar conversaciones.</div>';
        }
    }


    socket.on('global_chat_conversations', (data) => {
        const conversations = data.conversations || [];
        renderConversationList(conversations);
        
        // Calcular el total de mensajes no leídos
        const totalUnread = conversations.reduce((sum, conv) => sum + (conv.unread_count || 0), 0);
        const totalBadge = document.getElementById('chat-total-unread-badge');
        
        // --- INICIO DE LA CORRECCIÓN ---
        // Se añade una verificación para asegurar que el elemento 'totalBadge' existe
        // antes de intentar modificarlo. Esto previene el error 'Cannot read properties of null'.
        if (totalBadge) {
            if (totalUnread > 0) {
                totalBadge.textContent = totalUnread;
                totalBadge.classList.remove('hidden');
                totalBadge.classList.add('flex');
            } else {
                totalBadge.classList.add('hidden');
            }
        }
        // --- FIN DE LA CORRECCIÓN ---
    });




    const excelFileInput = document.getElementById('excel-file-input');
    const excelFileLabel = document.getElementById('excel-file-label');
    const shareFromExcelBtn = document.getElementById('share-from-excel-btn');
    const shareExcelStatus = document.getElementById('share-excel-status');

    excelFileInput.addEventListener('change', () => {
        if (excelFileInput.files.length > 0) {
            excelFileLabel.textContent = excelFileInput.files[0].name;
            shareFromExcelBtn.disabled = false;
        } else {
            excelFileLabel.textContent = 'Seleccionar archivo...';
            shareFromExcelBtn.disabled = true;
        }
    });

    shareFromExcelBtn.addEventListener('click', async () => {
        const file = excelFileInput.files[0];
        if (!file || !currentBoardId) return;

        shareExcelStatus.textContent = 'Subiendo e invitando...';
        shareExcelStatus.className = 'text-xs text-center font-medium text-yellow-600 mt-2 h-4';
        shareFromExcelBtn.disabled = true;

        const formData = new FormData();
        formData.append('excel_file', file);
        formData.append('sharer_email', currentUser.email);

        try {
            const response = await fetch(`${API_BASE_URL}/boards/${currentBoardId}/share_bulk`, {
                method: 'POST',
                headers: { 'ngrok-skip-browser-warning': 'true' },
                body: formData
            });

            const result = await response.json();
            
            if (result.success) {
                shareExcelStatus.textContent = result.message;
                shareExcelStatus.className = 'text-xs text-center font-medium text-green-600 mt-2 h-4';
                
                // Actualizar la lista de tableros en memoria y la UI
                const boardToUpdate = boardsData.find(b => b.id === currentBoardId);
                if (boardToUpdate) {
                    boardToUpdate.shared_with = result.shared_with;
                }
                populateShareModal(); // Refresca la lista de colaboradores en el modal
                updateBoardSelector(); // Refresca el dropdown principal

            } else {
                shareExcelStatus.textContent = `Error: ${result.message}`;
                shareExcelStatus.className = 'text-xs text-center font-medium text-red-600 mt-2 h-4';
            }

        } catch (error) {
            shareExcelStatus.textContent = 'Error de red al subir el archivo.';
            shareExcelStatus.className = 'text-xs text-center font-medium text-red-600 mt-2 h-4';
        } finally {
            // Resetear el input de archivo
            excelFileInput.value = '';
            excelFileLabel.textContent = 'Seleccionar archivo...';
        }
    });


    // Manejar notificaciones de asignación de manera dirigida en el cliente.
    socket.on('assignment_notification', (data) => {
        console.log('Recibida notificación de asignación:', data);
        // Solo mostrar la notificación si el usuario actual es el asignado.
        if (currentUser && currentUser.email.toLowerCase().trim() === data.assignee_email.toLowerCase().trim()) {
            addNotificationToList(data);
            console.log('Mostrando notificación porque el usuario coincide.');
        } else {
            console.log('Ignorando notificación de asignación para otro usuario.');
        }
    });

    // --- NUEVO BLOQUE: Listener para notificaciones eliminadas ---
    socket.on('notification_deleted', (data) => {
        const deletedNotificationId = data.id;
        console.log(`📡 Evento 'notification_deleted' recibido para ID: ${deletedNotificationId}`);
        
        // Filtrar la notificación eliminada del array local
        notifications = notifications.filter(n => n.id !== deletedNotificationId);
        
        // Actualizar el contador de no leídas
        notificationsReadCount = notifications.filter(n => !n.read).length;
        
        // Guardar el estado actualizado en localStorage
        localStorage.setItem('focux_notifications', JSON.stringify(notifications));
        
        // Actualizar la interfaz de usuario
        updateNotificationsUI();
        
        console.log(`🗑️ Notificación con ID ${deletedNotificationId} eliminada de la UI. Total: ${notifications.length}`);
    });




    socket.on('card_was_moved', (data) => {
        console.log('↓ [EVENTO] Otro usuario movió una tarjeta:', data);
        
        if (data.board_id == currentBoardId) {
            const task = cardDataStore.get(data.card_id);
            if (task) {
                // Aplicamos el cambio específico al estado local
                task.columnId = data.new_column_id;
                task.order = data.new_order;
                
                // Reordenamos otras tarjetas en la misma columna si es necesario
                cardDataStore.forEach(card => {
                    if (card.id !== data.card_id && card.columnId === data.new_column_id && card.order >= data.new_order) {
                        card.order += 1;
                    }
                });

                // Actualizamos la interfaz
                renderAllCards();
            }
        }
    });


    // Global state
    let currentBoardId = null;
    let boardsData = [];
    let isLoading = false;
    let autoSaveTimeout = null;
    let currentUserPermissionLevel = 'viewer'; // Default to viewer





    // DOM REFERENCES (keeping all existing ones from original code)
    const boardContainer = document.getElementById('kanban-board-container');
    const board = document.getElementById('kanban-board');
    const searchInput = document.getElementById('search-input');
    const addColumnHeaderBtn = document.getElementById('add-column-header-btn');
    const tagFilterBtn = document.getElementById('tag-filter-btn');
    const tagFilterDropdown = document.getElementById('tag-filter-dropdown');
    const boardViewBtn = document.getElementById('board-view-btn');
    const calendarViewBtn = document.getElementById('calendar-view-btn');
    const calendarContainer = document.getElementById('calendar-container');
    const calendarGrid = document.getElementById('calendar-grid');
    const calendarMonthYear = document.getElementById('calendar-month-year');
    const prevMonthBtn = document.getElementById('prev-month-btn');
    const nextMonthBtn = document.getElementById('next-month-btn');
    
    // Añadir después de las otras referencias DOM
    const logoutModal = document.getElementById('logout-modal');
    const logoutOverlay = document.getElementById('logout-overlay');
    const logoutCancel = document.getElementById('logout-cancel');
    const logoutConfirm = document.getElementById('logout-confirm');
    const eisenhowerViewBtn = document.getElementById('eisenhower-view-btn'); // NUEVO
    const eisenhowerContainer = document.getElementById('eisenhower-container'); // NUEVO

    const ganttViewBtn = document.getElementById('gantt-view-btn');
    const ganttContainer = document.getElementById('gantt-container');



    const userPlanEl = document.getElementById('user-plan');
    const upgradePlanModal = document.getElementById('upgrade-plan-modal');
    const upgradePlanOverlay = document.getElementById('upgrade-plan-overlay');
    const upgradePlanCloseBtn = document.getElementById('upgrade-plan-close-btn');

    // Función para mostrar el modal de "Mejorar Plan"
    function showUpgradePlanModal() {
        // Actualizar la apariencia de las tarjetas de plan
        const planCards = document.querySelectorAll('#upgrade-plan-modal .kanban-column');
        planCards.forEach(card => {
            card.classList.remove('border-orange-500', 'border-blue-400', 'border-gray-300');
            card.classList.add('border-gray-200');
            card.querySelector('.column-header .bg-orange-600')?.remove();
        });

        // Marcar el plan actual
        const planCard = document.getElementById(`plan-${currentUser.plan.toLowerCase()}-card`);
        if (planCard) {
            planCard.classList.remove('border-gray-200');
            planCard.classList.add('border-orange-500', 'shadow-xl');
            const header = planCard.querySelector('.column-header');
            const badge = document.createElement('span');
            badge.className = 'text-sm font-semibold text-white px-3 py-1 rounded-full bg-orange-600';
            badge.textContent = 'Actual';
            header.appendChild(badge);
        }

        upgradePlanModal.classList.remove('hidden');
        setTimeout(() => {
            upgradePlanModal.querySelector('.transform').classList.remove('scale-95', 'opacity-0');
            upgradePlanModal.querySelector('.transform').classList.add('scale-100', 'opacity-100');
        }, 10);
    }
    
    // Función para ocultar el modal de "Mejorar Plan"
    function hideUpgradePlanModal() {
        upgradePlanModal.querySelector('.transform').classList.add('scale-95', 'opacity-0');
        setTimeout(() => upgradePlanModal.classList.add('hidden'), 200);
    }

    function simpleHash(str) {
        let hash = 0;
        for (let i = 0; i < str.length; i++) {
            const char = str.charCodeAt(i);
            hash = (hash << 5) - hash + char;
            hash |= 0; // Convert to 32bit integer
        }
        return Math.abs(hash);
    }

    function getUserColor(email) {
        const colors = [
            { bg: 'bg-red-500', text: 'text-white' },
            { bg: 'bg-sky-500', text: 'text-white' },
            { bg: 'bg-emerald-500', text: 'text-white' },
            { bg: 'bg-amber-500', text: 'text-white' },
            { bg: 'bg-violet-500', text: 'text-white' },
            { bg: 'bg-rose-500', text: 'text-white' },
            { bg: 'bg-cyan-500', text: 'text-white' },
            { bg: 'bg-fuchsia-500', text: 'text-white' },
        ];
        const hash = simpleHash(email || '');
        return colors[hash % colors.length];
    }

    function renderUserPlan() {
        const upgradeBtn = document.getElementById('upgrade-plan-btn');
        const userPlanEl = document.getElementById('user-plan');
        
        if (!upgradeBtn || !userPlanEl) return;
        
        userPlanEl.textContent = `Plan: ${currentUser.plan}`;
        
        if (currentUser.plan !== 'Profesional') {
            upgradeBtn.classList.remove('hidden');
            // Aseguramos que el listener se agregue una sola vez
            // Se elimina el listener existente para evitar duplicados
            upgradeBtn.removeEventListener('click', showUpgradePlanModal); 
            // Se añade un nuevo listener que mostrará el mensaje o el modal
            upgradeBtn.addEventListener('click', () => {
                // Muestra un mensaje temporal de "en construcción"
                alert('La funcionalidad de "Mejorar Plan" está actualmente en construcción. ¡Pronto estará disponible!');
                // Si aún quieres mostrar el modal de planes después del mensaje, descomenta la siguiente línea:
                // showUpgradePlanModal(); 
            });
        } else {
            upgradeBtn.classList.add('hidden');
        }
    }

    // Agrega estas líneas en la sección de inicialización del DOM (DOMContentLoaded)
    // Asegúrate de que `currentUser` ya esté definido y contenga el plan.
    if (currentUser) {
        renderUserPlan();
    }
    
    // Event listeners para cerrar el modal
    upgradePlanCloseBtn.addEventListener('click', hideUpgradePlanModal);
    upgradePlanOverlay.addEventListener('click', hideUpgradePlanModal);
    notesViewBtn.addEventListener('click', () => switchView('notes'));

    // Event listeners para el modal de notas
    document.getElementById('note-editor-close-btn').addEventListener('click', closeNoteModal);
    document.getElementById('note-editor-cancel-btn').addEventListener('click', closeNoteModal);
    document.getElementById('note-editor-overlay').addEventListener('click', (e) => {
        if (e.target === document.getElementById('note-editor-overlay')) {
            closeNoteModal();
        }
    });

    document.getElementById('note-editor-form').addEventListener('submit', (e) => {
        e.preventDefault();
        saveNoteFromModal();
    });

    document.getElementById('delete-note-btn').addEventListener('click', () => {
        if (currentNoteId) {
            closeNoteModal();
            deleteNote(currentNoteId);
        }
    });

    // Botones de imagen
    document.getElementById('insert-image-pc-btn').addEventListener('click', () => {
        document.getElementById('note-image-input').click();
    });

    document.getElementById('note-image-input').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            insertImageFromFile(file, selectedImageSize);
            e.target.value = ''; // Limpiar input
        }
    });

    document.getElementById('insert-image-pexels-btn').addEventListener('click', () => {
        pexelsTarget = 'note';
        openDrawer(document.getElementById('pexels-overlay'), document.getElementById('pexels-content'));
        if (document.getElementById('pexels-grid').innerHTML === '') {
            searchPexelsImages('naturaleza, trabajo, inspiración');
        }
    });

    // Selector de tamaño de imagen
    document.querySelectorAll('.image-size-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('.image-size-btn').forEach(b => {
                b.classList.remove('bg-orange-50', 'border-orange-300');
                b.classList.add('border-gray-300');
            });
            btn.classList.add('bg-orange-50', 'border-orange-300');
            btn.classList.remove('border-gray-300');
            selectedImageSize = btn.dataset.size;
        });
    });





    // New board selector elements
    const boardSelectorBtn = document.getElementById('board-selector-btn');
    const currentBoardName = document.getElementById('current-board-name');
    const boardDropdownMenu = document.getElementById('board-dropdown-menu');
    const autoSaveIndicator = document.getElementById('auto-save-indicator');
    const createBoardModal = document.getElementById('create-board-modal');
    const createBoardForm = document.getElementById('create-board-form');
    const logoutBtn = document.getElementById('logout-btn');
    
    // All existing modal references (keeping from original)
    const columnEditorModal = document.getElementById('column-editor-modal');
    const columnEditorForm = document.getElementById('column-editor-form');
    const columnEditorCancelBtn = document.getElementById('column-editor-cancel-btn');
    const columnEditorCloseBtn = document.getElementById('column-editor-close-btn');
    const columnEditorOverlay = document.getElementById('column-editor-overlay');
    const columnEditorContent = document.getElementById('column-editor-content');
    const deleteColumnBtn = document.getElementById('delete-column-btn');
    const addCardModal = document.getElementById('add-card-modal');
    const addCardForm = document.getElementById('add-card-form');
    const addCardCancelBtn = document.getElementById('add-card-cancel-btn');
    const addCardCloseBtn = document.getElementById('add-card-close-btn');
    const addCardOverlay = document.getElementById('add-card-overlay');
    const addCardContent = document.getElementById('add-card-content');
    const deleteCardBtn = document.getElementById('delete-card-btn');
    const addChecklistItemBtn = document.getElementById('add-checklist-item-btn');
    const addCommentBtn = document.getElementById('add-comment-btn');
    const openChatbotBtn = document.getElementById('open-chatbot-btn');
    const chatbotOverlay = document.getElementById('chatbot-overlay');
    const chatbotContent = document.getElementById('chatbot-content');
    const chatbotCloseBtn = document.getElementById('chatbot-close-btn');
    const chatbotForm = document.getElementById('chatbot-form');
    const chatbotInput = document.getElementById('chatbot-input');
    const chatbotMessages = document.getElementById('chatbot-messages');
    
    // Board options elements
    const boardOptionsBtn = document.getElementById('board-options-btn');
    const boardOptionsModal = document.getElementById('board-options-modal');
    const boardOptionsOverlay = document.getElementById('board-options-overlay');
    const boardOptionsContent = document.getElementById('board-options-content');
    const boardOptionsCloseBtn = document.getElementById('board-options-close-btn');
    const uploadBgBtn = document.getElementById('upload-bg-btn');
    const pexelsBgBtn = document.getElementById('pexels-bg-btn');
    const boardBgInput = document.getElementById('board-bg-input');
    const blurSlider = document.getElementById('blur-slider');
    const opacitySlider = document.getElementById('opacity-slider');
    const columnOpacitySlider = document.getElementById('column-opacity-slider');
    const columnColorSwatches = document.getElementById('column-color-swatches');
    const boardOverlay = document.getElementById('board-overlay');
    const resetBoardOptionsBtn = document.getElementById('reset-board-options-btn');
    const boardBgColorSwatches = document.getElementById('board-bg-color-swatches');
    
    // -- INICIO DEL BLOQUE A AÑADIR --
    // Telegram elements
    const telegramConnectCheckbox = document.getElementById('telegram-connect-checkbox');
    const telegramConfigContainer = document.getElementById('telegram-config-container');
    const telegramChatIdInput = document.getElementById('telegram-chat-id');
    const connectTelegramBtn = document.getElementById('connect-telegram-btn');
    const telegramStatus = document.getElementById('telegram-status');
    // -- FIN DEL BLOQUE A AÑADIR --


    // Pexels elements
    const pexelsModal = document.getElementById('pexels-modal');
    const pexelsOverlay = document.getElementById('pexels-overlay');
    const pexelsContent = document.getElementById('pexels-content');
    const pexelsCloseBtn = document.getElementById('pexels-close-btn');
    const attendanceModal = document.getElementById('attendance-modal');
    const attendanceOverlay = document.getElementById('attendance-overlay');
    const attendanceContent = attendanceModal.querySelector('.transform');
    const attendanceCloseBtn = document.getElementById('attendance-close-btn');
    const openParticipantsBtn = document.getElementById('open-active-users');





    const pexelsSearchForm = document.getElementById('pexels-search-form');
    const pexelsSearchInput = document.getElementById('pexels-search-input');
    const pexelsGrid = document.getElementById('pexels-grid');
    const pexelsLoader = document.getElementById('pexels-loader');
    const pexelsNoResults = document.getElementById('pexels-no-results');
    const openPexelsBtn = document.getElementById('open-pexels-btn');
    const uploadFromPcBtn = document.getElementById('upload-from-pc-btn');
    const cardAttachmentInput = document.getElementById('card-attachment');
    
    // Confirm delete modal
    const confirmDeleteModal = document.getElementById('confirm-delete-modal');
    const confirmDeleteOverlay = document.getElementById('confirm-delete-overlay');
    const confirmDeleteMessage = document.getElementById('confirm-delete-message');
    const confirmDeleteCancel = document.getElementById('confirm-delete-cancel');
    const confirmDeleteOk = document.getElementById('confirm-delete-ok');
    
    // Mr. Focus elements
    const mrFocusAvatar = document.getElementById('mr-focus-avatar');
    const mrFocusTip = document.getElementById('mr-focus-tip');
    

    // CONFIGURATION (mantén sólo las clases completas)
    const COLUMN_COLORS = {
      'bg-gray-200':   'border-gray-400',
      'bg-red-200':    'border-red-400',
      'bg-yellow-200': 'border-yellow-400',
      'bg-green-200':  'border-green-400',
      'bg-indigo-200': 'border-indigo-400',
      'bg-purple-200': 'border-purple-400',
      'bg-pink-200':   'border-pink-400'
    };

    const CARD_PASTEL_COLORS = { 'bg-white': 'border-gray-200', 'bg-rose-100': 'border-rose-200', 'bg-amber-100': 'border-amber-200', 'bg-emerald-100': 'border-emerald-200', 'bg-sky-100': 'border-sky-200', 'bg-violet-100': 'border-violet-200', 'bg-slate-100': 'border-slate-200' };
    const BOARD_PASTEL_COLORS = ['bg-white', 'bg-slate-100', 'bg-red-100', 'bg-orange-100', 'bg-amber-100', 'bg-lime-100', 'bg-green-100', 'bg-cyan-100', 'bg-sky-100', 'bg-indigo-100', 'bg-fuchsia-100', 'bg-rose-100'];
    const COLUMN_BODY_COLORS = ['bg-white', 'bg-gray-50', 'bg-red-50', 'bg-yellow-50', 'bg-green-50', 'bg-blue-50', 'bg-indigo-50', 'bg-purple-50'];
    const TAILWIND_TO_RGB = {
        'bg-white': '255, 255, 255',
        'bg-gray-50': '249, 250, 251',
        'bg-red-50': '254, 242, 242',
        'bg-yellow-50': '254, 252, 232',
        'bg-green-50': '240, 253, 244',
        'bg-blue-50': '239, 246, 255',
        'bg-indigo-50': '238, 242, 255',
        'bg-purple-50': '245, 243, 255'
    };

    let TAGS_CONFIG = {
        'Urgente': { color: 'bg-red-200 text-red-800' },
        'No Urgente': { color: 'bg-green-200 text-green-800' },
        'Importante': { color: 'bg-yellow-200 text-yellow-800' },
        'No Importante': { color: 'bg-gray-200 text-gray-800' }
    };
    
    let columnsConfig = [];
    

    

    const NOTE_COLORS = {
        'note-yellow': { name: 'Amarillo', bg: 'bg-yellow-200', border: 'border-yellow-400' },
        'note-blue': { name: 'Azul', bg: 'bg-blue-200', border: 'border-blue-400' },
        'note-green': { name: 'Verde', bg: 'bg-green-200', border: 'border-green-400' },
        'note-pink': { name: 'Rosa', bg: 'bg-pink-200', border: 'border-pink-400' },
        'note-purple': { name: 'Morado', bg: 'bg-purple-200', border: 'border-purple-400' },
        'note-gray': { name: 'Gris', bg: 'bg-gray-200', border: 'border-gray-400' }
    };
    
    const getRandomColorClass = () => ['bg-pink-200 text-pink-800', 'bg-purple-200 text-purple-800', 'bg-cyan-200 text-cyan-800'][Math.floor(Math.random() * 3)];
    const CHECK_ICON_SVG = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-black" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>`;
    
    const PEXELS_API_KEY = 'm4fry4g5oHc3bGUbLnPWxlPrs3a0gpzRfXfWsYuyYQi3b27KYSIv0XlK';
    
    
    const mrFocusContainer = document.getElementById('mr-focus-container');
    let focuxMessages = [];
    let currentMessageIndex = 0;
    let messageInterval;

    async function loadFocuxMessages() {
        if (!currentUser || !currentUser.email || !currentUser.manager_id) return;
        try {
            const res = await fetchJSON(`/focux_messages?email=${currentUser.email}&manager_id=${currentUser.manager_id}`);
            if (res.success && res.messages.length > 0) {
                focuxMessages = res.messages;
                mrFocusContainer.style.display = 'flex';
                currentMessageIndex = 0; // Reiniciar índice
                startMessageRotation();
            } else {
                focuxMessages = [];
                mrFocusContainer.style.display = 'none';
                clearInterval(messageInterval);
            }
        } catch (e) {
            console.error("No se pudieron cargar los mensajes de Focux.", e);
            mrFocusContainer.style.display = 'none';
            clearInterval(messageInterval);
        }
    }



    // AGREGAR nueva función para formatear contenido
    function formatMessageContent(content) {
        if (!content) return '';
        
        return content
            // Títulos
            .replace(/^### (.*$)/gm, '<h3 style="font-size: 1.1em; font-weight: 700; margin: 8px 0 4px 0; color: #1f2937;">$1</h3>')
            .replace(/^## (.*$)/gm, '<h2 style="font-size: 1.25em; font-weight: 700; margin: 10px 0 6px 0; color: #1f2937;">$1</h2>')
            .replace(/^# (.*$)/gm, '<h1 style="font-size: 1.4em; font-weight: 800; margin: 12px 0 8px 0; color: #1f2937;">$1</h1>')
            
            // Negrilla y cursiva
            .replace(/\*\*(.*?)\*\*/g, '<strong style="font-weight: 700;">$1</strong>')
            .replace(/\*(.*?)\*/g, '<em style="font-style: italic;">$1</em>')
            
            // Saltos de línea
            .replace(/\n\n/g, '</p><p style="margin: 8px 0;">')
            .replace(/\n/g, '<br>')
            
            // Envolver en párrafo si no hay títulos
            .replace(/^(?!<h[1-6])/gm, '<p style="margin: 4px 0;">')
            .replace(/(?<!>)$/gm, '</p>')
            
            // Limpiar párrafos vacíos
            .replace(/<p[^>]*><\/p>/g, '')
            .replace(/<p[^>]*><br><\/p>/g, '<br>');
    }



    setInterval(() => {
        loadFocuxMessages();
    }, 300000); // 5 minutos = 300,000 ms

               
    // CORRECCIÓN 4: Recargar mensajes cuando la ventana recupera el foco
    document.addEventListener('visibilitychange', () => {
        if (!document.hidden) {
            // La ventana volvió a estar visible, recargar mensajes
            setTimeout(() => {
                loadFocuxMessages();
            }, 1000);
        }
    });

    // CORRECCIÓN 5: Recargar mensajes cada vez que se cambia de pestaña
    window.addEventListener('focus', () => {
        setTimeout(() => {
            loadFocuxMessages();
        }, 1000);
    });



    // CORRECCIÓN 7: Escuchar cambios desde el panel de admin
    window.addEventListener('storage', (e) => {
        if (e.key === 'focux_messages_updated') {
            console.log('🔄 Detectados cambios en mensajes Focux desde admin');
            setTimeout(() => {
                loadFocuxMessages();
            }, 2000); // Esperar 2 segundos para que se guarden los cambios
        }
    });






    // ===== AÑADE ESTA FUNCIÓN COMPLETA ANTES DE loadUserBoards() =====

    async function loadPendingNotifications() {
        try {
            const response = await fetch(`${API_BASE_URL}/notifications/pending?email=${encodeURIComponent(currentUser.email)}`, {
                headers: {
                    'ngrok-skip-browser-warning': 'true',
                    'Content-Type': 'application/json'
                }
            });
            
            if (response.ok) {
                const data = await response.json();
                if (data.success && data.notifications.length > 0) {
                    const existingNotificationIds = new Set(notifications.map(n => n.id));
                    const newNotifications = data.notifications.filter(serverNotification => !existingNotificationIds.has(serverNotification.id));

                    if (newNotifications.length > 0) {
                        newNotifications.forEach(notification => {
                            notifications.unshift({
                                id: notification.id,
                                title: notification.title,
                                message: notification.message,
                                timestamp: notification.timestamp,
                                type: notification.type,
                                read: false
                            });
                        });

                        localStorage.setItem('focux_notifications', JSON.stringify(notifications));
                        notificationsReadCount = notifications.filter(n => !n.read).length;
                        updateNotificationsUI();
                        
                        console.log(`📬 Cargadas ${newNotifications.length} nuevas notificaciones pendientes.`);
                    } else {
                        console.log('📬 No hay notificaciones nuevas pendientes para agregar.');
                    }
                }
            }
        } catch (error) {
            console.error('Error cargando notificaciones pendientes:', error);
        }
    }



    async function loadUserBoards() {
        try {
            setAutoSaveStatus('saving');
            console.log('🔍 Cargando lista de tableros para:', currentUser.email);
            
            const response = await fetch(`${API_BASE_URL}/boards?email=${encodeURIComponent(currentUser.email)}`, {
                headers: { 'ngrok-skip-browser-warning': 'true', 'Content-Type': 'application/json' }
            });
            
            if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            
            const data = await response.json();
            
            if (data.success) {
                boardsData = data.boards || [];
                // La línea que llamaba a renderStickerPanel() ha sido eliminada de aquí.

                if (boardsData.length > 0) {
                    processAndRenderBoard(boardsData[0]);
                } else {
                    hideMainLoader();
                    showCreateBoardModal();
                }
                
                updateBoardSelector();
                setAutoSaveStatus('saved');
                
            } else {
                throw new Error(data.message || 'Error desconocido del servidor');
            }
            
        } catch (error) {
            console.error('💥 Error en loadUserBoards:', error);
            currentBoardName.textContent = "Error de conexión";
            board.innerHTML = `<div class="p-8 text-center text-xl text-white/70 backdrop-blur-sm bg-black/20 rounded-lg">Error conectando con el servidor. Verifica tu conexión.</div>`;
            setAutoSaveStatus('error');
            hideMainLoader();
            throw error;
        }
    }

    const shareModal = document.getElementById('share-board-modal');
    const shareModalContent = shareModal.querySelector('.transform');
    const shareModalStatus = document.getElementById('share-modal-status');
    const collaboratorsList = document.getElementById('collaborators-list');
    const addUserBtn = document.getElementById('share-add-user-btn');

    // Función para abrir el modal de compartir
    function openShareModal() {
        shareModal.classList.remove('hidden');
        setTimeout(() => {
            shareModalContent.classList.remove('scale-95', 'opacity-0');
            shareModalContent.classList.add('scale-100', 'opacity-100');
        }, 10);
        populateShareModal();
    }



    async function populateShareModal() {
        const boardData = boardsData.find(b => b.id === currentBoardId);
        const collaboratorsList = document.getElementById('collaborators-list');
        
        if (!boardData || !boardData.owner_email) {
            collaboratorsList.innerHTML = '<li>Error al cargar datos de colaboradores.</li>';
            return;
        }

        collaboratorsList.innerHTML = '<li>Cargando...</li>';
        
        const ownerEmail = boardData.owner_email.toLowerCase();
        const isCurrentUserOwner = currentUser.email.toLowerCase() === ownerEmail;

        // --- INICIO DE LA CORRECCIÓN CLAVE ---
        // Se mapean los colaboradores para mostrar su nombre completo y el control de permisos.
        const collaboratorItems = (boardData.shared_with || []).map(collaborator => {
            if (!collaborator || !collaborator.user_email) return '';

            const isOwner = collaborator.user_email.toLowerCase() === ownerEmail;
            const fullName = `${collaborator.first_name || ''} ${collaborator.last_name || ''}`.trim();

            let permissionControl = '';
            // Solo el propietario puede cambiar permisos, y no puede cambiarse el suyo.
            if (isCurrentUserOwner && !isOwner) {
                permissionControl = `
                    <select class="permission-select text-sm rounded border-gray-300 shadow-sm" data-email="${collaborator.user_email}">
                        <option value="editor" ${collaborator.permission_level === 'editor' ? 'selected' : ''}>Editor</option>
                        <option value="viewer" ${collaborator.permission_level === 'viewer' ? 'selected' : ''}>Lector</option>
                    </select>
                    <button data-email="${collaborator.user_email}" class="remove-collaborator-btn p-1.5 text-red-500 hover:bg-red-100 rounded-full" title="Quitar acceso">
                        &times;
                    </button>
                `;
            } else {
                const roleText = isOwner ? 'Dueño' : (collaborator.permission_level === 'editor' ? 'Editor' : 'Lector');
                permissionControl = `<span class="text-sm text-gray-600 px-2">${roleText}</span>`;
            }

            return `
                <li class="flex items-center justify-between p-2 bg-gray-100 rounded-md">
                    <div class="flex flex-col">
                        <span class="font-medium text-gray-800">${fullName}</span>
                        <span class="text-xs text-gray-500">${collaborator.user_email}</span>
                    </div>
                    <div class="flex items-center gap-2">
                        ${permissionControl}
                    </div>
                </li>
            `;
        }).join('');
        // --- FIN DE LA CORRECCIÓN CLAVE ---

        collaboratorsList.innerHTML = collaboratorItems || '<li>No hay colaboradores.</li>';
    }




    function openBoardOptionsModal() {
        blurSlider.value = boardOptions.blurLevel;
        opacitySlider.value = boardOptions.overlayOpacity;
        columnOpacitySlider.value = boardOptions.columnOpacity;

        boardBgColorSwatches.innerHTML = '';
        BOARD_PASTEL_COLORS.forEach(colorClass => {
            const swatch = document.createElement('button');
            swatch.type = 'button';
            swatch.className = `w-8 h-8 rounded-full cursor-pointer border-2 flex items-center justify-center ${colorClass} border-gray-300`;
            swatch.dataset.color = colorClass;
            if (boardOptions.backgroundColorClass === colorClass) {
                swatch.innerHTML = CHECK_ICON_SVG;
                swatch.classList.add('ring-2', 'ring-offset-1', 'ring-orange-600');
            }
            swatch.addEventListener('click', () => {
                boardOptions.backgroundColorClass = colorClass;
                boardOptions.backgroundUrl = '';
                applyBoardOptions();
                scheduleAutoSave();
                openBoardOptionsModal();
            });
            boardBgColorSwatches.appendChild(swatch);
        });

        columnColorSwatches.innerHTML = '';
        COLUMN_BODY_COLORS.forEach(colorClass => {
            const swatch = document.createElement('button');
            swatch.type = 'button';
            swatch.className = `w-8 h-8 rounded-md cursor-pointer border-2 flex items-center justify-center ${colorClass} border-gray-300`;
            swatch.dataset.color = colorClass;
            if (boardOptions.columnColor === colorClass) {
                swatch.innerHTML = CHECK_ICON_SVG;
                swatch.classList.add('ring-2', 'ring-offset-1', 'ring-orange-600');
            }
            swatch.addEventListener('click', () => {
                boardOptions.columnColor = colorClass;
                applyBoardOptions();
                scheduleAutoSave();
                openBoardOptionsModal();
            });
            columnColorSwatches.appendChild(swatch);
        });

        // Lógica para Mr. Focux
        const focuxIntervalSelect = document.getElementById('mr-focux-interval-select');
        focuxIntervalSelect.value = boardOptions.mrFocuxInterval || 5;
        focuxIntervalSelect.onchange = (e) => {
            boardOptions.mrFocuxInterval = parseInt(e.target.value, 10);
            startMessageRotation(); // Reinicia la rotación con el nuevo intervalo
            scheduleAutoSave();
        };

        // Lógica para Etiquetas
        const currentTagMode = boardOptions.tagColorMode || 'default';
        const tagColorSelector = document.getElementById('pastel-tag-color-selector');
        document.querySelector(`input[name="tag-color-style"][value="${currentTagMode}"]`).checked = true;
        tagColorSelector.classList.toggle('hidden', currentTagMode !== 'pastel');
        
        const tagColorSwatches = document.getElementById('pastel-tag-color-swatches');
        tagColorSwatches.innerHTML = '';
        PASTEL_TAG_COLORS.forEach(colorClass => {
            const swatch = document.createElement('button');
            swatch.type = 'button';
            swatch.className = `w-8 h-8 rounded-md cursor-pointer border-2 flex items-center justify-center ${colorClass.split(' ')[0]} border-gray-300`;
            swatch.dataset.colorClass = colorClass;
            if (boardOptions.tagColorClass === colorClass) {
                swatch.innerHTML = CHECK_ICON_SVG.replace('text-black', 'text-white');
                swatch.classList.add('ring-2', 'ring-offset-1', 'ring-orange-600');
            }
            swatch.addEventListener('click', () => {
                boardOptions.tagColorClass = colorClass;
                renderAllCards();
                scheduleAutoSave();
                openBoardOptionsModal();
            });
            tagColorSwatches.appendChild(swatch);
        });

        document.querySelectorAll('input[name="tag-color-style"]').forEach(radio => {
            radio.onchange = (e) => {
                boardOptions.tagColorMode = e.target.value;
                if (boardOptions.tagColorMode === 'default') {
                    boardOptions.tagColorClass = null;
                }
                tagColorSelector.classList.toggle('hidden', boardOptions.tagColorMode !== 'pastel');
                renderAllCards();
                scheduleAutoSave();
            };
        });

        telegramConnectCheckbox.checked = boardOptions.telegramConnected || false;
        telegramConfigContainer.classList.toggle('hidden', !telegramConnectCheckbox.checked);
        telegramChatIdInput.value = boardOptions.telegramChatId || '';
        updateTelegramStatusUI();
        
        openDrawer(boardOptionsOverlay, boardOptionsContent);
    }

    function resetBoardToDefault() {
        boardOptions = { ...DEFAULT_BOARD_OPTIONS };
        startMessageRotation(); // Reinicia Mr. Focux a su estado por defecto
        applyBoardOptions();
        scheduleAutoSave();
        openBoardOptionsModal();
    }


    function renderGanttChart() {
        const wrapper = document.getElementById('gantt-chart-wrapper');
        wrapper.innerHTML = ''; // Limpiar contenido anterior

        const tasks = Array.from(cardDataStore.values())
            .filter(task => task.startDate)
            .sort((a, b) => new Date(a.startDate) - new Date(b.startDate));

        if (tasks.length === 0) {
            wrapper.innerHTML = `
                <div class="text-center p-10 bg-white rounded-lg border">
                    <h3 class="font-semibold text-gray-700">No hay tareas para mostrar.</h3>
                    <p class="text-sm text-gray-500 mt-1">Añade una fecha de inicio a tus tarjetas para verlas en el diagrama de Gantt.</p>
                </div>`;
            return;
        }

        const dayInMillis = 1000 * 60 * 60 * 24;
        const projectStartDate = new Date(tasks[0].startDate + 'T00:00:00');
        const projectEndDate = new Date(Math.max(...tasks.map(t => new Date((t.endDate || t.startDate) + 'T00:00:00').getTime())));
        
        const totalDays = Math.ceil((projectEndDate - projectStartDate) / dayInMillis) + 1;

        // --- INICIO DE LA MODIFICACIÓN: Lógica de Ancho Dinámico ---
        const MIN_DAY_WIDTH = 40; // Ancho mínimo para cada día en proyectos largos.
        const TASK_COL_WIDTH = 250; // Ancho de la columna de Tareas (fijado en CSS).
        
        // Se calcula el ancho real disponible para la línea de tiempo.
        const availableTimelineWidth = wrapper.clientWidth - TASK_COL_WIDTH;
        
        // Se calcula el ancho que ocuparía el proyecto con el ancho mínimo por día.
        const minProjectWidth = totalDays * MIN_DAY_WIDTH;
        
        let dayWidth; // Esta será nuestra variable para el ancho de cada día.

        // Si el proyecto es corto y no llena el espacio, se calcula un nuevo ancho para que se expanda.
        if (minProjectWidth < availableTimelineWidth) {
            dayWidth = availableTimelineWidth / totalDays;
        } else {
            // Si el proyecto es largo, se usa el ancho mínimo y se activará el scroll horizontal.
            dayWidth = MIN_DAY_WIDTH;
        }
        // --- FIN DE LA MODIFICACIÓN ---

        const chart = document.createElement('div');
        chart.className = 'gantt-chart';

        const headerRow = document.createElement('div');
        headerRow.className = 'gantt-header-days';
        headerRow.innerHTML = `<div class="gantt-cell gantt-task-header p-2">Tareas</div>`;

        const timelineHeader = document.createElement('div');
        timelineHeader.className = 'gantt-timeline';
        timelineHeader.style.gridTemplateColumns = `repeat(${totalDays}, ${dayWidth}px)`;

        for (let i = 0; i < totalDays; i++) {
            const currentDate = new Date(projectStartDate.getTime() + i * dayInMillis);
            const dayItem = document.createElement('div');
            dayItem.className = 'gantt-day-header-item';
            if ([0, 6].includes(currentDate.getDay())) {
                dayItem.classList.add('is-weekend');
            }
            dayItem.innerHTML = `
                <span class="font-medium">${currentDate.toLocaleDateString('es-ES', { weekday: 'short' }).charAt(0)}</span>
                <span>${currentDate.getDate()}</span>
            `;
            timelineHeader.appendChild(dayItem);
        }
        headerRow.appendChild(timelineHeader);
        chart.appendChild(headerRow);

        tasks.forEach(task => {
            const taskRow = document.createElement('div');
            taskRow.className = 'gantt-task-row';
            const taskNameCell = `<div class="gantt-task-name" title="Abrir: ${task.title}">${task.title}</div>`;

            const taskBarsContainer = document.createElement('div');
            taskBarsContainer.className = 'gantt-bars-container';
            taskBarsContainer.style.gridTemplateColumns = `repeat(${totalDays}, ${dayWidth}px)`;
            
            for (let i = 0; i < totalDays; i++) {
                const line = document.createElement('div');
                line.className = 'gantt-day-line';
                const currentDate = new Date(projectStartDate.getTime() + i * dayInMillis);
                if ([0, 6].includes(currentDate.getDay())) {
                     line.classList.add('is-weekend');
                }
                taskBarsContainer.appendChild(line);
            }

            const taskStartDate = new Date(task.startDate + 'T00:00:00');
            const taskEndDate = new Date((task.endDate || task.startDate) + 'T00:00:00');
            const startOffsetDays = Math.floor((taskStartDate - projectStartDate) / dayInMillis);
            const durationDays = Math.ceil((taskEndDate - taskStartDate) / dayInMillis) + 1;

            const taskBar = document.createElement('div');
            taskBar.className = 'gantt-task-bar';
            taskBar.style.left = `${startOffsetDays * dayWidth}px`;
            taskBar.style.width = `${durationDays * dayWidth - 4}px`;
            taskBar.style.backgroundColor = '#f97316';
            taskBar.innerHTML = `<span class="gantt-bar-label">${task.title}</span>`;
            taskBar.onclick = () => openCardDrawer(task.id);

            taskBarsContainer.appendChild(taskBar);
            taskRow.innerHTML = taskNameCell;
            taskRow.appendChild(taskBarsContainer);
            chart.appendChild(taskRow);

            if (task.checklist && task.checklist.length > 0) {
                task.checklist.forEach(item => {
                    const subtaskRow = document.createElement('div');
                    subtaskRow.className = 'gantt-task-row';
                    const subtaskNameCell = `
                        <div class="gantt-subtask-name" title="${item.text}">
                            <span class="subtask-icon ${item.completed ? 'bg-green-500' : 'bg-gray-300'}"></span>
                            ${item.text}
                        </div>
                    `;

                    const subtaskBarsContainer = taskBarsContainer.cloneNode(true);
                    subtaskBarsContainer.querySelector('.gantt-task-bar')?.remove();

                    const subtaskBar = document.createElement('div');
                    subtaskBar.className = 'gantt-subtask-bar';
                    subtaskBar.style.left = `${startOffsetDays * dayWidth}px`;
                    subtaskBar.style.width = `${durationDays * dayWidth - 4}px`;
                    if(item.completed) subtaskBar.style.backgroundColor = '#16a34a';

                    subtaskBarsContainer.appendChild(subtaskBar);
                    subtaskRow.innerHTML = subtaskNameCell;
                    subtaskRow.appendChild(subtaskBarsContainer);
                    chart.appendChild(subtaskRow);
                });
            }
        });

        wrapper.appendChild(chart);
    }


    function exportGanttToPDF() {
        try {
            const { jsPDF } = window.jspdf;
            const tasks = Array.from(cardDataStore.values())
                .filter(task => task.startDate)
                .sort((a, b) => new Date(a.startDate) - new Date(b.startDate));

            if (tasks.length === 0) {
                alert("No hay tareas con fechas para exportar a PDF.");
                return;
            }

            // 1. --- CONFIGURACIÓN DEL DOCUMENTO Y CÁLCULOS INICIALES ---
            const doc = new jsPDF({ orientation: 'landscape', format: 'a4' });
            const pageHeight = doc.internal.pageSize.getHeight();
            const pageWidth = doc.internal.pageSize.getWidth();
            const margin = 15;
            const taskColWidth = 70; // Ancho para la columna de nombres de tareas
            const dayColWidth = 12;  // Ancho fijo para cada columna de día
            const dayInMillis = 1000 * 60 * 60 * 24;

            const projectStartDate = new Date(tasks[0].startDate + 'T00:00:00Z');
            const projectEndDate = new Date(Math.max(...tasks.map(t => new Date((t.endDate || t.startDate) + 'T00:00:00Z').getTime())));
            const totalDays = Math.ceil((projectEndDate - projectStartDate) / dayInMillis) + 1;

            // 2. --- LÓGICA DE PAGINACIÓN HORIZONTAL ---
            const timelineWidthAvailable = pageWidth - (margin * 2) - taskColWidth;
            const daysPerPage = Math.floor(timelineWidthAvailable / dayColWidth);
            const numPages = Math.ceil(totalDays / daysPerPage);

            const allDateHeaders = [];
            for (let i = 0; i < totalDays; i++) {
                const currentDate = new Date(projectStartDate.getTime() + i * dayInMillis);
                allDateHeaders.push(`${currentDate.getDate()}\n${currentDate.toLocaleDateString('es-ES', { month: 'short' })}`);
            }
            
            // Aplanar tareas y subtareas para el cuerpo de la tabla
            const tableRowsData = [];
            tasks.forEach(task => {
                tableRowsData.push({ ...task, isSubtask: false });
                if (task.checklist && task.checklist.length > 0) {
                    task.checklist.forEach(item => {
                        tableRowsData.push({ 
                            title: item.text, 
                            startDate: task.startDate, 
                            endDate: task.endDate, 
                            completed: item.completed, 
                            isSubtask: true 
                        });
                    });
                }
            });

            // 3. --- BUCLE PARA GENERAR CADA PÁGINA ---
            for (let pageIndex = 0; pageIndex < numPages; pageIndex++) {
                if (pageIndex > 0) {
                    doc.addPage();
                }

                // Título y subtítulo en cada página
                const boardName = document.getElementById('current-board-name').textContent;
                doc.setFontSize(18);
                doc.setTextColor(40, 40, 40);
                doc.setFont('helvetica', 'bold');
                doc.text(`Cronograma: ${boardName}`, pageWidth / 2, margin + 5, { align: 'center' });
                doc.setFontSize(10);
                doc.setTextColor(100, 100, 100);
                doc.setFont('helvetica', 'normal');
                doc.text(`Generado: ${new Date().toLocaleDateString('es-ES')}`, pageWidth / 2, margin + 12, { align: 'center' });


                const startDayOfPage = pageIndex * daysPerPage;
                const endDayOfPage = Math.min(startDayOfPage + daysPerPage, totalDays);
                
                // Cabeceras para la página actual
                const head = [['Tareas']];
                head[0].push(...allDateHeaders.slice(startDayOfPage, endDayOfPage));

                // Cuerpo de la tabla (solo nombres, las barras se dibujan después)
                const body = tableRowsData.map(row => {
                    const title = row.isSubtask ? `    • ${row.title}` : row.title;
                    return [title, ...Array(endDayOfPage - startDayOfPage).fill('')];
                });

                // 4. --- DIBUJAR LA TABLA CON AUTOTABLE ---
                doc.autoTable({
                    head: head,
                    body: body,
                    startY: margin + 20,
                    theme: 'grid',
                    styles: { 
                        fontSize: 6, 
                        cellPadding: 1.5, 
                        valign: 'middle',
                        lineWidth: 0.1,
                        lineColor: [220, 220, 220]
                    },
                    headStyles: { 
                        fillColor: [41, 128, 185], 
                        textColor: 255, 
                        fontStyle: 'bold', 
                        halign: 'center',
                        minCellHeight: 10
                    },
                    columnStyles: {
                        0: { cellWidth: taskColWidth, fontStyle: 'bold', halign: 'left' }
                    },
                    alternateRowStyles: { fillColor: [245, 245, 245] },
                    
                    didDrawPage: (data) => {
                        // Pie de página
                        const pageCount = doc.internal.getNumberOfPages();
                        doc.setFontSize(8);
                        doc.setTextColor(150, 150, 150);
                        doc.text(`Página ${pageIndex + 1} de ${numPages}`, margin, pageHeight - 10);
                    },

                    didDrawCell: (data) => {
                        if (data.section === 'body' && data.column.index > 0) {
                            const dayIndexOnPage = data.column.index - 1;
                            const actualDayIndex = startDayOfPage + dayIndexOnPage;
                            const currentDate = new Date(projectStartDate.getTime() + actualDayIndex * dayInMillis);
                            const task = tableRowsData[data.row.index];
                            const taskStartDate = new Date(task.startDate + 'T00:00:00Z');
                            const taskEndDate = new Date((task.endDate || task.startDate) + 'T00:00:00Z');

                            // Dibujar las barras de Gantt
                            if (currentDate >= taskStartDate && currentDate <= taskEndDate) {
                                const barHeight = task.isSubtask ? 3 : 5;
                                const yPos = data.cell.y + (data.cell.height - barHeight) / 2;
                                let barColor = task.isSubtask ? [52, 152, 219] : [230, 126, 34]; // Azul para subtareas, Naranja para tareas
                                if (task.completed) barColor = [39, 174, 96]; // Verde para completadas
                                
                                doc.setFillColor(...barColor);
                                doc.rect(data.cell.x, yPos, data.cell.width, barHeight, 'F');
                            }
                        }
                    }
                });
            }

            // 5. --- GUARDAR EL PDF ---
            doc.save(`Gantt_Focux_${document.getElementById('current-board-name').textContent.replace(/\s+/g, '_')}.pdf`);

        } catch (error) {
            console.error("Error al exportar a PDF:", error);
            alert("Ocurrió un error inesperado al generar el PDF. Asegúrate de que las librerías jsPDF estén cargadas.");
        }
    }



    async function handlePermissionChange(collaboratorEmail, newPermission) {
        shareModalStatus.textContent = 'Actualizando permiso...';
        shareModalStatus.className = 'text-xs text-center font-medium text-yellow-600';

        try {
            const response = await fetch(`${API_BASE_URL}/boards/${currentBoardId}/collaborators/update`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json', 'ngrok-skip-browser-warning': 'true' },
                body: JSON.stringify({
                    owner_email: currentUser.email,
                    collaborator_email: collaboratorEmail,
                    permission_level: newPermission
                })
            });
            const result = await response.json();

            if (result.success) {
                shareModalStatus.textContent = 'Permiso actualizado.';
                shareModalStatus.className = 'text-xs text-center font-medium text-green-600';
                
                const boardToUpdate = boardsData.find(b => b.id === currentBoardId);
                if (boardToUpdate) boardToUpdate.shared_with = result.shared_with;
                
            } else {
                shareModalStatus.textContent = `Error: ${result.message}`;
                shareModalStatus.className = 'text-xs text-center font-medium text-red-600';
            }
        } catch (error) {
            shareModalStatus.textContent = 'Error de conexión.';
            shareModalStatus.className = 'text-xs text-center font-medium text-red-600';
        }
    }

    const inviteContainer = document.querySelector('#share-new-recipient-email').parentElement;
    inviteContainer.insertAdjacentHTML('afterend', `
        <div class="flex items-center gap-2 mt-2">
            <label for="invite-permission-level" class="text-sm font-medium text-gray-700">Permiso:</label>
            <select id="invite-permission-level" class="text-sm rounded border-gray-300">
                <option value="viewer" selected>Lector (Solo ver)</option>
                <option value="editor">Editor (Modificar)</option>
            </select>
        </div>
    `);






    // Evento para el botón "Gestionar Acceso" en el panel de opciones
    document.getElementById('open-share-modal-btn').addEventListener('click', openShareModal);

    // Eventos para cerrar el modal
    shareModal.querySelector('#share-board-close-btn').addEventListener('click', () => {
        shareModalContent.classList.add('scale-95', 'opacity-0');
        setTimeout(() => shareModal.classList.add('hidden'), 200);
    });
    shareModal.querySelector('#share-board-overlay').addEventListener('click', () => {
        shareModalContent.classList.add('scale-95', 'opacity-0');
        setTimeout(() => shareModal.classList.add('hidden'), 200);
    });


    // REEMPLAZA ESTE BLOQUE EN Tablero.html

    addUserBtn.addEventListener('click', async () => {
        const recipientEmail = document.getElementById('share-new-recipient-email').value.trim();
        const permissionLevel = document.getElementById('invite-permission-level').value;
        if (!recipientEmail) return;

        shareModalStatus.textContent = 'Invitando...';

        try {
            const response = await fetch(`${API_BASE_URL}/boards/${currentBoardId}/share`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    sharer_email: currentUser.email, 
                    recipient_email: recipientEmail,
                    permission_level: permissionLevel
                })
            });
            const result = await response.json();

            if (result.success) {
                shareModalStatus.textContent = '¡Invitación enviada!';
                document.getElementById('share-new-recipient-email').value = '';
                
                // --- INICIO DE LA CORRECCIÓN CLAVE ---
                // Actualizamos la lista de colaboradores en nuestro tablero local
                const boardToUpdate = boardsData.find(b => b.id === currentBoardId);
                if (boardToUpdate) {
                    boardToUpdate.shared_with = result.shared_with;
                }
                // --- FIN DE LA CORRECCIÓN CLAVE ---
                
                populateShareModal();
                updateBoardSelector();
            } else {
                shareModalStatus.textContent = `Error: ${result.message}`;
            }
        } catch (error) {
            shareModalStatus.textContent = 'Error de conexión.';
        }
    });

    collaboratorsList.addEventListener('change', async (e) => {
        if (e.target.classList.contains('permission-select')) {
            const email = e.target.dataset.email;
            const newPermission = e.target.value;
            
            shareModalStatus.textContent = 'Actualizando permiso...';
            shareModalStatus.className = 'text-xs text-center font-medium text-yellow-600 h-4';

            try {
                const response = await fetch(`${API_BASE_URL}/boards/${currentBoardId}/collaborators/update`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json', 'ngrok-skip-browser-warning': 'true' },
                    body: JSON.stringify({
                        owner_email: currentUser.email,
                        collaborator_email: email,
                        permission_level: newPermission
                    })
                });
                const result = await response.json();

                if (result.success) {
                    shareModalStatus.textContent = 'Permiso actualizado.';
                    shareModalStatus.className = 'text-xs text-center font-medium text-green-600 h-4';
                    
                    // Sincroniza el estado local con la respuesta del servidor
                    const boardIndex = boardsData.findIndex(b => b.id === currentBoardId);
                    if (boardIndex !== -1) {
                        boardsData[boardIndex] = result.board;
                    }
                    
                } else {
                    shareModalStatus.textContent = `Error: ${result.message}`;
                    shareModalStatus.className = 'text-xs text-center font-medium text-red-600 h-4';
                }
            } catch (error) {
                shareModalStatus.textContent = 'Error de conexión.';
                shareModalStatus.className = 'text-xs text-center font-medium text-red-600 h-4';
            }
        }
    });

    // REEMPLAZA el listener de 'click' en collaboratorsList
    collaboratorsList.addEventListener('click', async (e) => {
        if (e.target.classList.contains('remove-collaborator-btn')) {
            const emailToRemove = e.target.dataset.email;
            
            const confirmed = await showGenericConfirmModal(
                'Quitar Acceso', 
                `¿Estás seguro de que quieres quitar el acceso a ${emailToRemove}?`
            );
            if (!confirmed) return;

            shareModalStatus.textContent = 'Quitando acceso...';
            shareModalStatus.className = 'text-xs text-center font-medium text-yellow-600';

            try {
                const response = await fetch(`${API_BASE_URL}/boards/${currentBoardId}/share`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json', 'ngrok-skip-browser-warning': 'true' },
                    body: JSON.stringify({ 
                        remover_by_email: currentUser.email, 
                        email_to_remove: emailToRemove
                    })
                });
                const result = await response.json();

                if (result.success) {
                    shareModalStatus.textContent = 'Acceso eliminado correctamente.';
                    shareModalStatus.className = 'text-xs text-center font-medium text-green-600';
                    
                    // --- CORRECCIÓN CLAVE ---
                    const boardIndex = boardsData.findIndex(b => b.id === currentBoardId);
                    if (boardIndex !== -1) {
                        boardsData[boardIndex] = result.board;
                    }

                    populateShareModal();
                } else {
                    shareModalStatus.textContent = `Error: ${result.message}`;
                    shareModalStatus.className = 'text-xs text-center font-medium text-red-600';
                }
            } catch (error) {
                shareModalStatus.textContent = 'Error de conexión.';
                shareModalStatus.className = 'text-xs text-center font-medium text-red-600';
            }
        }
    });


    // Evento delegado para eliminar colaboradores
    collaboratorsList.addEventListener('click', async (e) => {
        if (e.target.classList.contains('remove-collaborator-btn')) {
            const emailToRemove = e.target.dataset.email;
            
            // --- CAMBIO PRINCIPAL AQUÍ ---
            // Reemplazamos el confirm() del navegador por nuestro modal personalizado
            const confirmed = await showGenericConfirmModal(
                'Quitar Acceso', 
                `¿Estás seguro de que quieres quitar el acceso a ${emailToRemove}? Esta acción no se puede deshacer.`
            );

            if (!confirmed) {
                return; // Si el usuario cancela, no hacemos nada.
            }
            // --- FIN DEL CAMBIO ---

            shareModalStatus.textContent = 'Quitando acceso...';
            shareModalStatus.className = 'text-xs text-center font-medium text-yellow-600';

            try {
                const response = await fetch(`${API_BASE_URL}/boards/${currentBoardId}/share`, {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json', 'ngrok-skip-browser-warning': 'true' },
                    body: JSON.stringify({ remover_by_email: currentUser.email, email_to_remove: emailToRemove })
                });
                const result = await response.json();

                if (result.success) {
                    shareModalStatus.textContent = 'Acceso eliminado correctamente.';
                    shareModalStatus.className = 'text-xs text-center font-medium text-green-600';
                    
                    const boardToUpdate = boardsData.find(b => b.id === currentBoardId);
                    if (boardToUpdate) boardToUpdate.shared_with = result.shared_with;
                    populateShareModal();
                } else {
                    shareModalStatus.textContent = `Error: ${result.message}`;
                    shareModalStatus.className = 'text-xs text-center font-medium text-red-600';
                }
            } catch (error) {
                shareModalStatus.textContent = 'Error de conexión.';
                shareModalStatus.className = 'text-xs text-center font-medium text-red-600';
            }
        }
    });


    let availableAssistants = [];
    let chatHistories = {};
    let selectedAssistantsForGroupChat = new Set();
    let activeGroupAssistants = [];
    let isGroupChatActive = false;
    
    const aiGroupChatModal = document.getElementById('ai-group-chat-modal');
    const aiGroupChatList = document.getElementById('ai-group-chat-list');
    const aiGroupChatStartBtn = document.getElementById('ai-group-chat-start-btn');
    
    
    async function loadAndRenderAssistants() {
        const aiView = document.getElementById('ai-chat-view');
        if (!aiView) {
            console.error("Error crítico: El contenedor #ai-chat-view no existe.");
            return;
        }
        aiView.innerHTML = `<div class="p-6 text-center text-sm text-gray-500">Cargando asistentes...</div>`;

        try {
            const response = await fetch(`${API_BASE_URL}/assistants?email=${encodeURIComponent(currentUser.email)}`, {
                headers: { 'ngrok-skip-browser-warning': 'true' }
            });
            if (!response.ok) {
                throw new Error(`Error del servidor: ${response.status}`);
            }
            const data = await response.json();
            if (data.success && Array.isArray(data.assistants) && data.assistants.length > 0) {
                availableAssistants = data.assistants.filter(a => a && a.id && a.name && a.avatar_url);
                if (availableAssistants.length === 0) {
                    throw new Error("Los datos de los asistentes recibidos son inválidos.");
                }

                aiView.innerHTML = `
                    <div class="p-3 border-b flex gap-2">
                        <input type="text" id="ai-assistant-filter" placeholder="Buscar asistente...">
                        <button id="group-chat-btn">Reunión</button>
                    </div>
                    <div id="ai-assistant-list" class="flex-1 overflow-y-auto">
                        ${availableAssistants.map(a => `
                            <button class="assistant-list-item flex items-center p-3 w-full text-left border-b hover:bg-gray-50 cursor-pointer" data-assistant-id="${a.id}" data-assistant-name="${a.name}" data-assistant-description="${a.description || ''}">
                                <img src="${a.avatar_url}" alt="${a.name}" class="w-12 h-12 rounded-full mr-3 object-cover">
                                <div class="min-w-0">
                                    <div class="font-semibold text-gray-800 truncate">${a.description || 'Asistente de IA'}</div>
                                    <div class="text-xs text-gray-500 font-medium">${a.name}</div>
                                </div>
                            </button>
                        `).join('')}
                    </div>
                `;

                document.getElementById('ai-assistant-filter').addEventListener('input', (e) => {
                    const query = e.target.value.toLowerCase();
                    const listItems = document.querySelectorAll('.assistant-list-item');
                    listItems.forEach(item => {
                        const name = item.dataset.assistantName.toLowerCase();
                        const description = item.dataset.assistantDescription.toLowerCase();
                        if (name.includes(query) || description.includes(query)) {
                            item.style.display = 'flex';
                        } else {
                            item.style.display = 'none';
                        }
                    });
                });

                document.getElementById('group-chat-btn').addEventListener('click', showGroupChatSelectorModal);

                document.querySelectorAll('.assistant-list-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const id = item.dataset.assistantId;
                        const assistant = availableAssistants.find(a => String(a.id) === String(id));
                        if (assistant) renderAssistantConversation(assistant);
                    });
                });

            } else {
                aiView.innerHTML = `<div class="p-6 text-center text-sm text-gray-500">Aún no hay asistentes configurados.</div>`;
            }
        } catch (error) {
            console.error('Error final al cargar asistentes:', error);
            aiView.innerHTML = `
                <div class="p-6 text-center text-sm text-red-600">
                    <p class="font-semibold">No se pudieron cargar los asistentes.</p>
                    <p class="text-xs mt-1">${error.message}</p>
                    <button id="retry-assistants-load" class="mt-4 px-3 py-1 bg-gray-200 text-gray-800 rounded text-sm hover:bg-gray-300">Reintentar</button>
                </div>
            `;
            document.getElementById('retry-assistants-load').addEventListener('click', loadAndRenderAssistants);
        }
    }
    
    function showGroupChatSelectorModal() {
        if (availableAssistants.length === 0) {
            alert('No hay asistentes disponibles para iniciar una reunión.');
            return;
        }

        selectedAssistantsForGroupChat.clear();
        aiGroupChatList.innerHTML = '';

        availableAssistants.forEach(a => {
            const item = document.createElement('label');
            item.className = 'flex items-center p-2 rounded-lg cursor-pointer hover:bg-gray-100';
            item.innerHTML = `
                <input type="checkbox" data-assistant-id="${a.id}" class="h-4 w-4 text-green-600 focus:ring-green-500 rounded mr-3">
                <img src="${a.avatar_url}" alt="${a.name}" class="w-8 h-8 rounded-full mr-3 object-cover">
                <div class="flex-grow">
                    <span class="text-sm font-medium text-gray-800">${a.description || 'Asistente de IA'}</span>
                    <p class="text-xs text-gray-500">${a.name}</p>
                </div>
            `;
            item.querySelector('input').addEventListener('change', (e) => {
                if (e.target.checked) {
                    selectedAssistantsForGroupChat.add(e.target.dataset.assistantId);
                } else {
                    selectedAssistantsForGroupChat.delete(e.target.dataset.assistantId);
                }
                aiGroupChatStartBtn.disabled = selectedAssistantsForGroupChat.size < 2;
            });
            aiGroupChatList.appendChild(item);
        });

        aiGroupChatStartBtn.disabled = true;
        aiGroupChatModal.classList.remove('hidden');
        setTimeout(() => {
            aiGroupChatModal.querySelector('.transform').classList.remove('scale-95', 'opacity-0');
        }, 10);
    }
    
    function hideGroupChatSelectorModal() {
        aiGroupChatModal.querySelector('.transform').classList.add('scale-95', 'opacity-0');
        setTimeout(() => aiGroupChatModal.classList.add('hidden'), 200);
    }
    
    function renderAssistantConversation(assistant) {
      const aiView = document.getElementById('ai-chat-view');
      if (!aiView) return;
      
      isGroupChatActive = false;

      aiView.innerHTML = `
        <div class="flex-shrink-0 flex items-center gap-3 p-3 bg-white border-b">
          <button id="back-to-assistants-btn" class="px-2 py-1 border rounded text-sm hover:bg-gray-50">&larr;</button>
          <img src="${assistant.avatar_url}" alt="${assistant.name}" class="w-10 h-10 rounded-full object-cover">
          <div class="min-w-0">
            <div class="font-semibold text-gray-800 truncate">${assistant.description || 'Asistente de IA'}</div>
            <p class="text-xs text-green-600 font-medium">${assistant.name}</p>
          </div>
        </div>
        <div id="ai-active-chat-messages" class="flex-1 p-4 overflow-y-auto space-y-4"></div>
        <div class="flex-shrink-0 p-3 border-t">
          <form id="ai-active-chat-form" class="flex items-center gap-2">
            <input type="text" id="ai-active-chat-input" placeholder="Habla con ${assistant.name.split(' ')[0]}..." class="chat-input-field text-sm" autocomplete="off">
            <button type="submit" class="chat-send-btn">
              <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>
            </button>
          </form>
        </div>
      `;

      const messagesContainer = document.getElementById('ai-active-chat-messages');
      if (!chatHistories[assistant.id]) {
        chatHistories[assistant.id] = [{ 
            sender: 'ai', 
            content: `¡Hola! Soy ${assistant.description}. ¿En qué puedo ayudarte?`,
            assistant_id: assistant.id 
        }];
      }
      chatHistories[assistant.id].forEach(msg => appendAiChatMessage(msg, messagesContainer, false));
      messagesContainer.scrollTop = messagesContainer.scrollHeight;

      document.getElementById('back-to-assistants-btn').onclick = loadAndRenderAssistants;

      document.getElementById('ai-active-chat-form').onsubmit = (e) => {
        e.preventDefault();
        const input = document.getElementById('ai-active-chat-input');
        const text = (input.value || '').trim();
        if (text) {
          askAssistant(text, [assistant], messagesContainer);
          input.value = '';
        }
      };
    }
    
    function appendAiChatMessage(message, container, saveToHistory = true) {
        if (!message || !message.content) return;
        
        const isUserMessage = message.sender === 'user';
        const senderAssistant = message.assistant_id ? availableAssistants.find(a => a.id === message.assistant_id) : null;
        
        if (!isGroupChatActive && senderAssistant && saveToHistory) {
             if (!chatHistories[senderAssistant.id]) chatHistories[senderAssistant.id] = [];
             chatHistories[senderAssistant.id].push(message);
        }
        
        if (isGroupChatActive && saveToHistory) {
            if (!chatHistories['group']) chatHistories['group'] = [];
            chatHistories['group'].push(message);
        }

        const el = document.createElement('div');
        el.className = `ai-chat-message ${isUserMessage ? 'from-user' : 'from-ai'}`;
        
        let htmlContent;

        if (isUserMessage) {
            htmlContent = `<div class="ai-chat-bubble">${message.content.replace(/\*\*(.*?)\*\*/g,'<b>$1</b>').replace(/\n/g,'<br>')}</div>`;
        } else {
            // Lógica para chat grupal con un solo avatar de "reunión"
            if (isGroupChatActive) {
                htmlContent = `
                    <div class="flex-shrink-0">
                        <img src="https://i.ibb.co/KCcD2Bm/imagen-2025-08-17-171553752.png" class="ai-avatar">
                    </div>
                    <div>
                        <p class="text-xs font-bold text-gray-800 mb-1">${senderAssistant ? senderAssistant.description : 'Reunión'}</p>
                        <div class="ai-chat-bubble">${message.content.replace(/\*\*(.*?)\*\*/g,'<b>$1</b>').replace(/\n/g,'<br>')}</div>
                    </div>
                `;
            } else {
                // Lógica para chat individual
                const avatarUrl = senderAssistant ? senderAssistant.avatar_url : 'https://i.ibb.co/ZR8zNXGn/imagen-2025-08-17-163425695.png';
                htmlContent = `
                    <div class="flex-shrink-0">
                        <img src="${avatarUrl}" class="ai-avatar">
                    </div>
                    <div>
                        <p class="text-xs font-bold text-gray-800 mb-1">${senderAssistant ? senderAssistant.description : 'Asistente'}</p>
                        <div class="ai-chat-bubble">${message.content.replace(/\*\*(.*?)\*\*/g,'<b>$1</b>').replace(/\n/g,'<br>')}</div>
                    </div>
                `;
            }
        }
        
        el.innerHTML = htmlContent;
        container.appendChild(el);
        container.scrollTop = container.scrollHeight;
        return el;
    }
    
    document.getElementById('ai-group-chat-close-btn').addEventListener('click', hideGroupChatSelectorModal);
    document.getElementById('ai-group-chat-cancel-btn').addEventListener('click', hideGroupChatSelectorModal);
    document.getElementById('ai-group-chat-overlay').addEventListener('click', hideGroupChatSelectorModal);
    document.getElementById('ai-group-chat-start-btn').addEventListener('click', startGroupChat);


    document.getElementById('export-gantt-pdf-btn').addEventListener('click', exportGanttToPDF);

    function findMostSuitableAssistant(message, assistants) {
        const keywords = message.toLowerCase().split(/\s+/);
        let bestMatch = null;
        let highestScore = 0;

        assistants.forEach(assistant => {
            const profile = (assistant.description + ' ' + assistant.name).toLowerCase();
            let score = 0;
            keywords.forEach(keyword => {
                if (keyword.length > 3 && profile.includes(keyword)) {
                    score++;
                }
            });
            if (score > highestScore) {
                highestScore = score;
                bestMatch = assistant;
            }
        });
        return bestMatch;
    }
    
    async function askAssistant(userMessage, assistantsToAsk, messagesContainer) {
        const chatHistoryKey = isGroupChatActive ? 'group' : assistantsToAsk[0].id;
        const currentHistory = chatHistories[chatHistoryKey] || [];
        
        const userMsgObj = { sender: 'user', content: userMessage, assistant_id: null };
        appendAiChatMessage(userMsgObj, messagesContainer);

        const typingIndicator = appendAiChatMessage({ sender: 'ai', content: '<div class="typing-indicator"><span></span><span></span><span></span></div>' }, messagesContainer, false);
        
        const unifiedHistory = currentHistory.map(msg => ({ 
            sender: msg.sender, 
            content: msg.content 
        }));

        let assistantsToRespond = [];
        if (isGroupChatActive) {
            // 1. Verificar si el usuario se dirigió a un asistente por nombre.
            const mentionedAssistant = assistantsToAsk.find(a => userMessage.toLowerCase().includes(a.name.toLowerCase()));
            
            if (mentionedAssistant) {
                assistantsToRespond.push(mentionedAssistant);
            } else {
                const mostSuitable = findMostSuitableAssistant(userMessage, assistantsToAsk);
                
                if (mostSuitable) {
                    assistantsToRespond.push(mostSuitable);
                } else {
                    const randomAssistant = assistantsToAsk[Math.floor(Math.random() * assistantsToAsk.length)];
                    assistantsToRespond.push(randomAssistant);
                }
            }
        } else {
            assistantsToRespond = assistantsToAsk;
        }

        const responses = await Promise.all(
            assistantsToRespond.map(async (assistant) => {
                try {
                    const response = await fetch(`${API_BASE_URL}/chat/ask`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'ngrok-skip-browser-warning': 'true' },
                        body: JSON.stringify({
                            assistant_id: assistant.id,
                            message: userMessage,
                            user_email: currentUser.email,
                            history: unifiedHistory
                        })
                    });
                    const data = await response.json();
                    const reply = data.success ? (data.reply || '') : 'Lo siento, tuve un problema al procesar tu solicitud.';
                    return { assistant, reply };
                } catch (e) {
                    console.error(e);
                    return { assistant, reply: 'Error de conexión.' };
                }
            })
        );
        
        typingIndicator.remove();

        responses.forEach(({ assistant, reply }) => {
            appendAiChatMessage({ sender: 'ai', content: reply, assistant_id: assistant.id }, messagesContainer);
        });
    }

    function startGroupChat() {
        const assistantIds = Array.from(selectedAssistantsForGroupChat);
        if (assistantIds.length < 2) return;

        activeGroupAssistants = availableAssistants.filter(a => assistantIds.includes(a.id));
        if (activeGroupAssistants.length < 2) return;
        
        chatHistories['group'] = [];
        
        isGroupChatActive = true;
        
        renderGroupChatConversation(activeGroupAssistants);
        hideGroupChatSelectorModal();
    }
    
    function renderGroupChatConversation(assistants) {
        const aiView = document.getElementById('ai-chat-view');
        if (!aiView) return;

        const groupNames = assistants.map(a => a.name.split(' ')[0]).join(', ');
        const avatars = `<img src="https://i.ibb.co/KCcD2Bm/imagen-2025-08-17-171553752.png" alt="Grupo" class="w-10 h-10 rounded-full object-cover">`;

        aiView.innerHTML = `
            <div class="flex-shrink-0 flex items-center gap-3 p-3 bg-white border-b">
              <button id="back-to-assistants-btn" class="px-2 py-1 border rounded text-sm hover:bg-gray-50">&larr;</button>
              ${avatars}
              <div class="min-w-0">
                <div class="font-semibold text-gray-800 truncate">Reunión con ${groupNames}</div>
                <p class="text-xs text-green-600 font-medium">Chat en curso</p>
              </div>
            </div>
            <div id="ai-active-chat-messages" class="flex-1 p-4 overflow-y-auto space-y-4"></div>
            <div class="flex-shrink-0 p-3 border-t">
              <form id="ai-active-chat-form" class="flex items-center gap-2">
                <input type="text" id="ai-active-chat-input" placeholder="Envía un mensaje a todos..." class="chat-input-field text-sm" autocomplete="off">
                <button type="submit" class="chat-send-btn">
                  <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>
                </button>
              </form>
            </div>
        `;
        
        document.getElementById('back-to-assistants-btn').onclick = loadAndRenderAssistants;

        const messagesContainer = document.getElementById('ai-active-chat-messages');
        const firstMessage = {
            sender: 'ai',
            content: `¡Hola a todos! Soy una reunión con ${groupNames}. ¿En qué podemos ayudar?`,
            assistant_id: 'group_greeting'
        };
        appendAiChatMessage(firstMessage, messagesContainer, true);

        document.getElementById('ai-active-chat-form').onsubmit = (e) => {
            e.preventDefault();
            const input = document.getElementById('ai-active-chat-input');
            const text = (input.value || '').trim();
            if (text) {
                askAssistant(text, assistants, messagesContainer);
                input.value = '';
            }
        };
    }

    // REEMPLAZA tu función switchChatMode con esta versión de PRUEBA
    async function switchChatMode(mode) {
      currentChatMode = mode;
      document.querySelectorAll('.chat-mode-btn').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('.chat-view').forEach(v => v.classList.remove('active'));
      
      const activate = (id) => {
          const element = document.getElementById(id);
          if (element) {
              element.classList.add('active');
          }
      };

      if (mode === 'board') {
        activate('chat-mode-board');
        activate('board-chat-view');
        if(document.getElementById('chat-messages').innerHTML === ''){
            fetchChatHistory(currentBoardId);
        }
      } else if (mode === 'general') {
        activate('chat-mode-general');
        activate('general-chat-view');
        socket.emit('global_chat_list_conversations', { email: currentUser.email });
      } else if (mode === 'ai') {
        activate('chat-mode-ai');
        activate('ai-chat-view');
        loadAndRenderAssistants();
      }
    }

    // Asegura que el botón "Asistentes" cambia al modo 'ai' (si no estaba enlazado)
    document.getElementById('chat-mode-ai')?.addEventListener('click', () => switchChatMode('ai'));


    // --- FUNCIÓN CORREGIDA ---
    function openAiChatModal() {
        if (availableAssistants.length === 0) {
            alert('No hay asistentes de IA configurados en este momento.');
            return;
        }

        isAiChatOpen = true;
        currentAssistantIndex = 0;
        updateAssistantDisplay();
        
        aiModal.classList.remove('hidden');
        
        setTimeout(() => {
            aiModalOverlay.classList.remove('opacity-0');
            aiModalContent.classList.remove('translate-x-full');
        }, 10);
    }

    // --- FUNCIÓN CORREGIDA ---
    function closeAiChatModal() {
        isAiChatOpen = false;
        
        aiModalOverlay.classList.add('opacity-0');
        aiModalContent.classList.add('translate-x-full');

        setTimeout(() => {
            aiModal.classList.add('hidden');
        }, 300); // Espera a que termine la transición de 300ms
    }


    function sendBeaconSave() {
        if (!currentBoardId) return;

        const boardData = cleanBoardDataForSaving();
        const payload = JSON.stringify({
            email: currentUser.email,
            boardData: boardData
        });

        // Crea una instancia de Blob con el payload y el tipo de contenido
        const blob = new Blob([payload], { type: 'application/json' });

        // Usa sendBeacon para enviar los datos de forma fiable
        // Nota: sendBeacon no puede usar el método PUT. Usaremos una nueva ruta POST en el backend.
        navigator.sendBeacon(`${API_BASE_URL}/boards/${currentBoardId}/save-beacon`, blob);

        console.log('📦 Datos enviados a través de sendBeacon antes de cerrar la página.');
    }

    // Guardado automático al salir o recargar la página
    window.addEventListener('beforeunload', (e) => {
        // Llama a la función de guardado fiable
        sendBeaconSave();
        // El navegador no espera por la respuesta, pero la petición se envía.
    });

    async function createNewBoard(name, columns = null) {
        try {
            setAutoSaveStatus('saving');
            const response = await fetch(`${API_BASE_URL}/boards`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'ngrok-skip-browser-warning': 'true' },
                body: JSON.stringify({
                    email: currentUser.email,
                    name: name,
                    columns: columns // Pasa las columnas al backend
                })
            });
            const data = await response.json();
            if (data.success) {
                await loadUserBoards();
                await loadBoardData(data.board_id);
                setAutoSaveStatus('saved');
                return true;
            } else {
                throw new Error(data.message);
            }
        } catch (error) {
            console.error('Error creando tablero:', error);
            alert('Error creando el tablero: ' + error.message);
            setAutoSaveStatus('error');
            return false;
        }
    }






    function updateTelegramStatusUI() {
        if (boardOptions.telegramConnected && boardOptions.telegramChatId) {
            telegramStatus.innerHTML = `Estado: <span class="font-medium text-green-600">✅ Conectado (ID: ${boardOptions.telegramChatId})</span>.`;
        } else if (boardOptions.telegramConnected) {
            telegramStatus.innerHTML = `Estado: <span class="font-medium text-yellow-600">⚠️ Habilitado, falta Chat ID</span>.`;
        } else {
            telegramStatus.innerHTML = `Estado: <span class="font-medium text-red-600">❌ No conectado</span>.`;
        }
    }


    async function saveBoardData() {
        if (!currentBoardId || isLoading) {
            console.log("No se puede guardar: no hay tablero o está cargando.");
            return;
        }

        try {
            setAutoSaveStatus('saving');

            // --- INICIO DE LA CORRECCIÓN CLAVE ---
            // La línea original era: boardsData.find(b => b.id === currentBoardId);
            // Si un elemento 'b' en boardsData es inválido (undefined), 'b.id' falla.
            // La corrección 'b && b.id' asegura que solo intentemos leer el 'id'
            // de objetos de tablero que realmente existen, ignorando los corruptos.
            const currentBoard = boardsData.find(b => b && b.id === currentBoardId);
            // --- FIN DE LA CORRECCIÓN CLAVE ---

            if (!currentBoard) {
                console.error("No se encontró el tablero actual para guardar. Forzando recarga de datos.");
                // Como medida de seguridad, si el tablero no se encuentra, intentamos recargar todo.
                await loadUserBoards(); 
                setAutoSaveStatus('error');
                return;
            }

            const boardData = cleanBoardDataForSaving();

            const response = await fetch(`${API_BASE_URL}/boards/${currentBoardId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'ngrok-skip-browser-warning': 'true'
                },
                body: JSON.stringify({
                    email: currentUser.email,
                    boardData: boardData,
                    boardName: currentBoard.name
                })
            });

            const data = await response.json();

            if (data.success) {
                console.log('✅ Guardado exitoso. Emitiendo evento de actualización.');
                socket.emit('board_data_updated', {
                    board_id: currentBoardId,
                    boardData: boardData,
                    email: currentUser.email
                });
                setAutoSaveStatus('saved');
            } else {
                console.error('Error saving board:', data.message);
                setAutoSaveStatus('error');
            }
        } catch (error) {
            console.error('Error saving board:', error);
            setAutoSaveStatus('error');
        }
    }




    async function deleteBoard(boardId) {
        try {
            const response = await fetch(`${API_BASE_URL}/boards/${boardId}?email=${encodeURIComponent(currentUser.email)}`, {
                method: 'DELETE',
                headers: {
                    'ngrok-skip-browser-warning': 'true'
                }
            });
            
            const data = await response.json();
            
            if (data.success) {
                await loadUserBoards();
                return true;
            } else {
                console.error('Error deleting board:', data.message);
                alert('Error eliminando el tablero: ' + data.message);
                return false;
            }
        } catch (error) {
            console.error('Error deleting board:', error);
            alert('Error eliminando el tablero');
            return false;
        }
    }
        

    async function loadBoardData(boardId) {
        isLoading = true;
        board.innerHTML = '';
        showMainLoader();

        try {
            const dataFetchPromise = fetch(`${API_BASE_URL}/boards/${boardId}?email=${encodeURIComponent(currentUser.email)}`, {
                headers: { 'ngrok-skip-browser-warning': 'true' }
            });
            const minTimePromise = new Promise(resolve => setTimeout(resolve, MINIMUM_LOADER_TIME));
            const [response] = await Promise.all([dataFetchPromise, minTimePromise]);
            const result = await response.json();

            if (!result.success) {
                throw new Error(result.message);
            }
            
            // Llama a la nueva función centralizada para renderizar el tablero
            processAndRenderBoard(result.board);

        } catch (error) {
            console.error("Error cargando datos del tablero:", error);
            board.innerHTML = `<div class="p-8 text-center text-xl text-red-400 backdrop-blur-sm bg-black/20 rounded-lg">Error al cargar el tablero: ${error.message}</div>`;
            hideMainLoader();
            isLoading = false;
        }
    }


    document.getElementById('add-reference-btn').addEventListener('click', () => openAddReferenceModal());
    document.getElementById('add-reference-close-btn').addEventListener('click', closeAddReferenceModal);
    document.getElementById('add-reference-cancel-btn').addEventListener('click', closeAddReferenceModal);
    document.getElementById('add-reference-overlay').addEventListener('click', closeAddReferenceModal);

    document.getElementById('add-reference-form').addEventListener('submit', (e) => {
        e.preventDefault();
        const id = document.getElementById('reference-id-input').value;
        const title = document.getElementById('reference-title-input').value.trim();
        const url = document.getElementById('reference-url-input').value.trim();

        if (!title || !url) return;

        if (id) { // Editando
            const refIndex = referencesCache.findIndex(r => r.id === id);
            if (refIndex > -1) {
                referencesCache[refIndex] = { ...referencesCache[refIndex], title, url };
            }
        } else { // Creando
            const newRef = {
                id: 'ref-' + Date.now() + Math.random().toString(36).substr(2, 9),
                title,
                url
            };
            referencesCache.unshift(newRef);
        }

        renderReferences();
        scheduleAutoSave();
        closeAddReferenceModal();
    });

    document.getElementById('references-grid').addEventListener('click', async (e) => {
        const editBtn = e.target.closest('.edit-reference-btn');
        if (editBtn) {
            openAddReferenceModal(editBtn.dataset.refId);
        }

        const deleteBtn = e.target.closest('.delete-reference-btn');
        if (deleteBtn) {
            const refId = deleteBtn.dataset.refId;
            const ref = referencesCache.find(r => r.id === refId);
            const confirmed = await showGenericConfirmModal(
                'Eliminar Referencia', 
                `¿Estás seguro de que quieres eliminar la referencia "${ref.title}"?`
            );
            if (confirmed) {
                referencesCache = referencesCache.filter(r => r.id !== refId);
                renderReferences();
                scheduleAutoSave();
            }
        }
    });


    function processAndRenderBoard(boardData) {
        if (!boardData || !boardData.id) {
            console.error("Se intentó procesar un tablero inválido.", boardData);
            hideMainLoader();
            return;
        }

        if (currentBoardId && currentBoardId !== boardData.id) {
            socket.emit('leave_board', { board_id: currentBoardId });
        }

        currentBoardId = boardData.id;
        socket.emit('join_board', { board_id: currentBoardId, email: currentUser.email });

        const ownerEmail = (boardData.owner_email || '').toLowerCase();
        const currentUserEmail = (currentUser.email || '').toLowerCase();

        if (ownerEmail === currentUserEmail) {
            currentUserPermissionLevel = 'editor';
        } else {
            const self = (boardData.shared_with || []).find(c => c && c.user_email && c.user_email.toLowerCase() === currentUserEmail);
            currentUserPermissionLevel = self ? self.permission_level : 'viewer';
        }
        
        console.log(`🔒 Nivel de permiso para este tablero: ${currentUserPermissionLevel}`);

        const data = boardData.data || {};
        columnsConfig = data.columns || [];
        boardOptions = { ...DEFAULT_BOARD_OPTIONS, ...(data.boardOptions || {}) };

        cardDataStore.clear();
        (data.cards || []).forEach(card => {
            if (!card.id) card.id = 'card-' + Date.now() + Math.random().toString(36).substr(2, 9);
            cardDataStore.set(card.id, card);
        });

        currentBoardName.textContent = boardData.name || 'Tablero';

        const chatContainer = document.getElementById('collaborative-chat-container');
        const chatBox = document.getElementById('chat-box');
        const isShared = Array.isArray(boardData.shared_with) && boardData.shared_with.length > 1;

        chatContainer.classList.remove('hidden');
        if (isShared) {
            chatBox.classList.add('is-shared-board');
            chatBox.classList.remove('is-solo-board');
            switchChatMode('board');
        } else {
            chatBox.classList.add('is-solo-board');
            chatBox.classList.remove('is-shared-board');
            switchChatMode('general');
        }

        initializeBoard();
        
        // El resto de la lógica de carga final
        isLoading = false;
        hideMainLoader();
        updateUIForPermissions(currentUserPermissionLevel);
    }
    
    function updateUIForPermissions(level) {
        const isEditor = level === 'editor';
        console.log(`🎨 Aplicando UI para permisos de: ${level}. ¿Es editor? ${isEditor}`);

        // Ocultar/mostrar botones principales
        document.getElementById('add-column-header-btn').style.display = isEditor ? 'flex' : 'none';
        document.getElementById('board-options-btn').style.display = isEditor ? 'flex' : 'none';
        document.querySelectorAll('.add-card-btn').forEach(btn => btn.style.display = isEditor ? 'flex' : 'none');

        // Habilitar/deshabilitar arrastrar y soltar en columnas y tarjetas
        document.querySelectorAll('.kanban-column, .kanban-card').forEach(el => {
            el.draggable = isEditor;
        });

        // Ocultar menús de acciones y manijas de arrastre
        document.querySelectorAll('.card-actions, .column-drag-handle, .column-header .flex-grow').forEach(el => {
            el.style.pointerEvents = isEditor ? 'auto' : 'none';
            el.style.cursor = isEditor ? 'pointer' : 'default';
        });

        // --- BLOQUE ELIMINADO ---
        // El siguiente bloque de código que deshabilita el chat ha sido eliminado para
        // permitir que todos los usuarios puedan escribir en él.
    }


    // --- Utilidades para Chats Personales ---
    function conversationId(a, b) {
        const al = (a || '').trim().toLowerCase();
        const bl = (b || '').trim().toLowerCase();
        return [al, bl].sort().join('__');
    }

    let currentDMWith = null;

    // Llamar esto cuando el usuario abre "Chats Personales" o al iniciar la app
    async function loadPersonalChatPartners() {
        try {
            const res = await fetch(`${API_BASE_URL}/direct-chats/partners?me=${encodeURIComponent(currentUser.email)}`, {
                headers: { 'ngrok-skip-browser-warning': 'true' }
            });
            const data = await res.json();
            const listEl = document.getElementById('personal-chats-list'); // lista de conversaciones
            if (!listEl) return;
            listEl.innerHTML = '';

            const partners = (data.success && Array.isArray(data.partners)) ? data.partners : [];
            if (partners.length === 0) {
                listEl.innerHTML = `<div class="text-sm text-gray-500">Aún no tienes chats.</div>`;
                return;
            }

            partners.forEach(email => {
                const item = document.createElement('button');
                item.className = 'w-full text-left px-3 py-2 rounded hover:bg-gray-100';
                item.textContent = email;
                item.addEventListener('click', () => {
                    openPersonalChat(email);
                });
                listEl.appendChild(item);
            });
        } catch (e) {
            console.error('Partners DM:', e);
        }
    }

    function openPersonalChat(otherEmail) {
        // Salir de sala anterior de conversación normalizada
        if (currentDMWith) {
            socket.emit('leave_direct', { me: currentUser.email, with: currentDMWith });
        }
        currentDMWith = otherEmail;

        // Unirse a sala normalizada (para eventos 'direct_message')
        socket.emit('join_direct', { me: currentUser.email, with: currentDMWith });

        // Cargar historial desde el backend (persistido en Excel)
        loadDirectChatHistory(currentUser.email, currentDMWith);
    }

    async function loadDirectChatHistory(me, other) {
        try {
            const res = await fetch(`${API_BASE_URL}/direct-chats/history?me=${encodeURIComponent(me)}&with=${encodeURIComponent(other)}`, {
                headers: { 'ngrok-skip-browser-warning': 'true' }
            });
            const data = await res.json();
            if (data.success) {
                renderDirectChatMessages(data.messages || []);
            } else {
                renderDirectChatMessages([]);
            }
        } catch (e) {
            console.error('Historial DM:', e);
            renderDirectChatMessages([]);
        }
    }

    function renderDirectChatMessages(messages) {
        const box = document.getElementById('personal-chat-messages'); // contenedor de mensajes
        if (!box) return;
        box.innerHTML = '';
        (messages || []).forEach(m => {
            const row = document.createElement('div');
            row.className = 'py-1 text-sm';
            const who = (m.from_name || m.from_email || '').trim();
            const when = (m.timestamp || '').replace('T', ' ').split('.')[0];
            row.textContent = `[${when}] ${who}: ${m.message}`;
            box.appendChild(row);
        });
        box.scrollTop = box.scrollHeight;
    }


    // Botón ENVIAR del chat personal
    const btn = document.getElementById('personal-chat-send'); // <-- ajusta si tu ID es otro
    if (btn) {
        btn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            sendDirectMessage(); // dispara el envío
        });
    }

    // Enter para enviar (Shift+Enter = salto de línea)
    const input = document.getElementById('personal-chat-input'); // <-- ajusta si tu ID es otro
    if (input) {
        input.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendDirectMessage();
            }
        });
    }

    // Si el input está dentro de un <form>, evita el submit/recarga
    const form = document.getElementById('personal-chat-form'); // <-- si usas un form, ponle ID
    if (form) {
        form.addEventListener('submit', (e) => {
            e.preventDefault();
            e.stopPropagation();
            sendDirectMessage();
        });
    }



    function sendDirectMessage() {
        const input = document.getElementById('personal-chat-input'); // <-- ajusta ID si difiere
        if (!input) {
            console.warn('⚠️ No existe el input del chat personal');
            return;
        }
        const text = (input.value || '').trim();
        if (!text) return;

        if (!currentUser || !currentUser.email) {
            console.warn('⚠️ No hay usuario logueado');
            return;
        }
        if (!currentDMWith) {
            console.warn('⚠️ No hay conversación abierta (currentDMWith vacío)');
            return;
        }

        const payload = {
            from_email: String(currentUser.email).trim(),
            from_name: `${currentUser.first_name || ''} ${currentUser.last_name || ''}`.trim() || String(currentUser.email).trim(),
            to_email: String(currentDMWith).trim(),
            to_name: String(currentDMWith).trim(),
            message: text
        };

        // Usa el MISMO evento que maneja el backend (ver bloque en app.py)
        console.debug('📤 Enviando DM:', payload);
        socket.emit('private_message', payload);

        // Limpia y mantiene foco
        input.value = '';
        input.focus();
    }


    async function openPersonalChat(otherEmail) {
        // Salir de la sala anterior
        if (currentDMWith) {
            socket.emit('leave_direct', { me: currentUser.email, with: currentDMWith });
        }

        currentDMWith = otherEmail;

        // Unirse a la sala normalizada (para recibir 'direct_message')
        socket.emit('join_direct', { me: currentUser.email, with: currentDMWith });

        // Habilitar UI de envío
        const btn = document.getElementById('personal-chat-send');
        const input = document.getElementById('personal-chat-input');
        if (btn) btn.disabled = false;
        if (input) input.disabled = false;

        // Cargar historial persistido
        await loadDirectChatHistory(currentUser.email, currentDMWith);
    }

    // Listener entrante (añadir una sola vez)
    socket.on('direct_message', (msg) => {
        // Solo si estamos en esta conversación
        if (!currentDMWith) return;
        const cid = conversationId(msg.from_email, msg.to_email);
        const currentCid = conversationId(currentUser.email, currentDMWith);
        if (cid !== currentCid) return;

        const box = document.getElementById('personal-chat-messages');
        if (!box) return;
        const row = document.createElement('div');
        row.className = 'py-1 text-sm';
        const who = (msg.from_name || msg.from_email || '').trim();
        const when = (msg.timestamp || '').replace('T', ' ').split('.')[0];
        row.textContent = `[${when}] ${who}: ${msg.message}`;
        box.appendChild(row);
        box.scrollTop = box.scrollHeight;

        // Refrescar lista de partners (aparece tras primer mensaje si estaba vacía)
        loadPersonalChatPartners();
    });



    const startMeetingBtn = document.getElementById('start-meeting-btn');
    const meetingInviteModal = document.getElementById('meeting-invite-modal');
    const meetingInviteOverlay = document.getElementById('meeting-invite-overlay');
    const meetingUserList = document.getElementById('meeting-user-list');
    const meetingSelectAll = document.getElementById('meeting-select-all-users');
    const meetingInviteCancelBtn = document.getElementById('meeting-invite-cancel-btn');
    const meetingInviteCallBtn = document.getElementById('meeting-invite-call-btn');



    const toggleMuteBtn = document.getElementById('toggle-mute-btn');
    const raiseHandBtn = document.getElementById('raise-hand-btn');
    const hangUpBtn = document.getElementById('hang-up-btn');


    async function populateAudioDeviceLists() {
        try {
            // Pedir permiso es necesario para que los navegadores revelen los nombres de los dispositivos
            await navigator.mediaDevices.getUserMedia({ audio: true });

            const devices = await navigator.mediaDevices.enumerateDevices();
            const audioInputs = devices.filter(device => device.kind === 'audioinput');
            const audioOutputs = devices.filter(device => device.kind === 'audiooutput');

            // Llenar lista de Micrófonos (Entrada)
            micSelect.innerHTML = '';
            if (audioInputs.length > 0) {
                audioInputs.forEach(device => {
                    const option = document.createElement('option');
                    option.value = device.deviceId;
                    option.textContent = device.label || `Micrófono ${micSelect.options.length + 1}`;
                    micSelect.appendChild(option);
                });
            } else {
                micSelect.innerHTML = '<option>No se encontraron micrófonos</option>';
            }

            // Llenar lista de Altavoces (Salida)
            speakerSelect.innerHTML = '';
            if (audioOutputs.length > 0) {
                audioOutputs.forEach(device => {
                    const option = document.createElement('option');
                    option.value = device.deviceId;
                    option.textContent = device.label || `Altavoz ${speakerSelect.options.length + 1}`;
                    speakerSelect.appendChild(option);
                });
            } else {
                speakerSelect.innerHTML = '<option>No se encontraron salidas de audio</option>';
            }

        } catch (error) {
            console.error("Error al enumerar dispositivos de audio:", error);
            micSelect.innerHTML = '<option>Error al listar micrófonos</option>';
            speakerSelect.innerHTML = '<option>Error al listar altavoces</option>';
        }
    }

    // --- NUEVA FUNCIÓN: Crear visualizador de voz ---
    function createVoiceVisualizer(stream, canvas) {
        if (!audioContext) audioContext = new (window.AudioContext || window.webkitAudioContext)();
        
        const source = audioContext.createMediaStreamSource(stream);
        const analyser = audioContext.createAnalyser();
        analyser.fftSize = 256; // Tamaño del análisis
        const bufferLength = analyser.frequencyBinCount;
        const dataArray = new Uint8Array(bufferLength);
        
        source.connect(analyser); // Conectar la fuente al analizador
        
        const ctx = canvas.getContext('2d');
        const draw = () => {
            const instanceId = requestAnimationFrame(draw);
            visualizerInstances.set(canvas, instanceId); // Guardar ID para poder cancelarlo

            analyser.getByteFrequencyData(dataArray);
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            const barWidth = (canvas.width / bufferLength) * 1.5;
            let barHeight;
            let x = 0;
            let totalVolume = 0;

            for(let i = 0; i < bufferLength; i++) {
                barHeight = dataArray[i] / 2;
                totalVolume += barHeight;
                
                // Dibujar las barras
                const g = barHeight + (25 * (i/bufferLength));
                const b = 50 * (i/bufferLength);
                ctx.fillStyle = `rgb(249, 115, 22, ${barHeight / 100})`; // Naranja Focux con opacidad
                ctx.fillRect(x, canvas.height - barHeight / 2, barWidth, barHeight);
                x += barWidth + 1;
            }
        };
        draw();
    }



    // === UI reunión de voz ===
    const meetingCallModal = document.getElementById('meeting-call-modal');
    const meetingParticipants = document.getElementById('meeting-participants');
    const meetingMuteBtn = document.getElementById('meeting-mute-btn');
    const meetingRaiseHandBtn = document.getElementById('meeting-raise-hand-btn');
    const meetingLeaveBtn = document.getElementById('meeting-leave-btn');

    const micSelect = document.getElementById('mic-select');
    const speakerSelect = document.getElementById('speaker-select');

 

    // Función para generar un nombre de sala único
    function generateRoomName(boardId) {
        const timestamp = Date.now();
        const randomStr = Math.random().toString(36).substring(7);
        return `focux-board-${boardId}-${timestamp}-${randomStr}`;
    }



    function toggleHandRaise() {
      const me = participants.get(currentUser.email);
      me.handRaised = !me.handRaised;
      participants.set(me.email, me);
      renderParticipants();
      socket.emit('meeting_state_change', { room_name: meetingRoomName, user_info: me });
    }

    function renderParticipants() {
      meetingParticipants.innerHTML = '';
      [...participants.values()].forEach(p => {
        const div = document.createElement('div');
        div.className = `participant-item ${p.handRaised ? 'hand-raised' : ''}`;
        div.innerHTML = `
          <div class="flex items-center gap-2">
            <div class="assigned-avatar bg-orange-200 text-orange-800">${(p.name || 'NN').split(' ').map(n=>n[0]).join('').slice(0,2)}</div>
            <div class="flex flex-col">
              <span class="text-sm font-medium">${p.name}${p.muted ? ' — <span class="text-red-600">MUTEADO</span>' : ''}</span>
              <span class="text-xs text-gray-500">${p.email}</span>
            </div>
          </div>
          <svg class="w-5 h-5 hand-raised-icon" viewBox="0 0 24 24" fill="currentColor"><path d="M9 11V3h2v8h1V5h2v6h1V7h2v6c0 1.657-1.343 3-3 3h-2v3H8v-5H7a3 3 0 0 1-3-3V7h2v4h3z"/></svg>
        `;
        meetingParticipants.appendChild(div);
      });
    }


    function broadcastState() {
      const me = participants.get(currentUser.email);
      socket.emit('meeting_state_change', { room_name: meetingRoomName, user_info: me });
    }

    function setAutoSaveStatus(status) {
        autoSaveIndicator.className = `auto-save-indicator ${status}`;
        
        const statusText = {
            'saving': 'Guardando...',
            'saved': 'Guardado',
            'error': 'Error'
        };
        
        autoSaveIndicator.querySelector('span').textContent = statusText[status] || 'Guardado';
    }
    
    function scheduleAutoSave() {
        // En lugar de programar un guardado, lo ejecutamos de inmediato.
        // El estado 'isLoading' y 'currentBoardId' ya se verifican en saveBoardData.
        console.log("Guardado inmediato solicitado.");
        saveBoardData();
    }


    function cleanBoardDataForSaving() {
        const activeCards = Array.from(cardDataStore.values()).filter(card => {
            if (!card.TimeBoxing) return true;
            if (card.TimeBoxing.completed) return false;
            if (card.TimeBoxing.endDateTime) {
                const endTime = new Date(card.TimeBoxing.endDateTime);
                const now = new Date();
                if (endTime <= now) return false;
            }
            return true;
        });

        const boardData = {
            columns: columnsConfig.slice(0, 10),
            cards: activeCards.slice(0, 100),
            boardOptions: boardOptions,
            tagsConfig: TAGS_CONFIG
        };

        boardData.cards = boardData.cards.map(card => ({
            id: card.id,
            title: card.title?.substring(0, 200) || '',
            description: card.description?.substring(0, 2000) || '',
            columnId: card.columnId,
            order: card.order,
            color: card.color,
            startDate: card.startDate,
            endDate: card.endDate,
            startTime: card.startTime,
            endTime: card.endTime,
            allDay: card.allDay,
            tags: (card.tags || []).slice(0, 10),
            checklist: (card.checklist || []).slice(0, 20),
            comments: (card.comments || []).slice(0, 10),
            attachment: card.attachment,
            TimeBoxing: card.TimeBoxing,
            assignedTo: card.assignedTo || [],
            isCompleted: card.isCompleted || false,
        }));

        return boardData;
    }


    async function changeBoardCategory(boardId, currentCategory, event) {
        event.stopPropagation(); // Evita que se seleccione el tablero
        
        // Añadimos la nueva categoría al ciclo
        const categories = ["Personal", "Laboral", "Institucional"];
        const currentIndex = categories.indexOf(currentCategory);
        const newCategory = categories[(currentIndex + 1) % categories.length];

        const boardToUpdate = boardsData.find(b => b.id === boardId);
        if (boardToUpdate) {
            boardToUpdate.category = newCategory;
            updateBoardSelector(); 
        }

        try {
            const response = await fetch(`${API_BASE_URL}/boards/${boardId}/category`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json', 'ngrok-skip-browser-warning': 'true' },
                body: JSON.stringify({ email: currentUser.email, category: newCategory })
            });
            const result = await response.json();
            if (!result.success) {
                alert(`Error al cambiar categoría: ${result.message}`);
                if (boardToUpdate) {
                    boardToUpdate.category = currentCategory; // Revertir
                    updateBoardSelector();
                }
            }
        } catch (error) {
            alert('Error de conexión al cambiar la categoría.');
            if (boardToUpdate) {
                boardToUpdate.category = currentCategory; // Revertir
                updateBoardSelector();
            }
        }
    }


    function updateBoardSelector() {
        const currentBoard = boardsData.find(b => b.id === currentBoardId);
        currentBoardName.textContent = currentBoard ? currentBoard.name : 'Tablero no encontrado';

        currentBoardName.removeEventListener('dblclick', openEditNameModal);
        currentBoardName.addEventListener('dblclick', openEditNameModal);

        boardDropdownMenu.innerHTML = '';

        const searchContainer = document.createElement('div');
        searchContainer.innerHTML = `<input type="text" id="board-filter-input" placeholder="Buscar tablero..." class="w-full px-3 py-2 text-sm border-b border-gray-200 outline-none">`;
        boardDropdownMenu.appendChild(searchContainer);

        const listContainer = document.createElement('div');
        boardDropdownMenu.appendChild(listContainer);

        const boardsByCategory = boardsData.reduce((acc, board) => {
            const category = board.category || 'Personal';
            if (!acc[category]) acc[category] = [];
            acc[category].push(board);
            return acc;
        }, {});

        const renderSection = (title, boards) => {
            if (boards.length === 0) return;

            const header = document.createElement('h3');
            header.className = 'board-section-header';
            header.textContent = title;
            listContainer.appendChild(header);

            boards.forEach(boardData => {
                const item = document.createElement('div');
                item.className = `board-dropdown-item ${boardData.id === currentBoardId ? 'active' : ''}`;
                
                const isOwner = boardData.owner_email && (boardData.owner_email.toLowerCase() === currentUser.email.toLowerCase());
                const isShared = boardData.shared_with && boardData.shared_with.length > 1;
                
                const sharedIndicatorHtml = isShared 
                    ? `<div class="board-category-tag board-category-shared" title="Compartido con ${boardData.shared_with.length} personas">
                         <div class="indicator-content">
                           <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor"><path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z" /></svg>
                           <span>${boardData.shared_with.length}</span>
                         </div>
                       </div>`
                    : '';

                const category = boardData.category || 'Personal';
                let categoryClass = 'board-category-personal';
                if (category === 'Laboral') categoryClass = 'board-category-laboral';
                else if (category === 'Institucional') categoryClass = 'board-category-institucional';

                item.innerHTML = `
                    <div class="flex flex-col flex-grow min-w-0">
                        <span class="board-name-text truncate">${boardData.name}</span>
                        <div class="board-meta-container">
                            <span class="board-category-tag ${categoryClass}" title="Cambiar categoría">${category}</span>
                            ${sharedIndicatorHtml}
                        </div>
                    </div>
                    <div class="flex items-center self-start pt-1">
                        ${isOwner ? `<button class="delete-board-btn" data-board-id="${boardData.id}" title="Eliminar tablero">&times;</button>` : ''}
                    </div>
                `;
                
                const categoryTag = item.querySelector('.board-category-tag:not(.board-category-shared)');
                if (categoryTag) {
                    categoryTag.addEventListener('click', (event) => {
                        changeBoardCategory(boardData.id, category, event);
                    });
                }
                
                // --- INICIO DE LA CORRECCIÓN CLAVE ---
                item.addEventListener('click', (e) => {
                    if (e.target.closest('.delete-board-btn')) {
                        e.stopPropagation();
                        showConfirmDelete('board', boardData.id, boardData.name);
                    } else if (!e.target.closest('.board-category-tag')) {
                        const selectedBoard = boardsData.find(b => b.id === boardData.id);
                        if (selectedBoard) {
                            processAndRenderBoard(selectedBoard);
                            updateBoardSelector();
                            boardDropdownMenu.classList.add('hidden');
                        }
                    }
                });
                // --- FIN DE LA CORRECCIÓN CLAVE ---
                listContainer.appendChild(item);
            });
        };

        const sortedCategories = Object.keys(boardsByCategory).sort();
        sortedCategories.forEach(category => {
            renderSection(category, boardsByCategory[category]);
        });

        const createItem = document.createElement('div');
        createItem.className = 'board-dropdown-item create-board-item';
        createItem.innerHTML = '<span>+ Crear Nuevo Tablero</span>';
        createItem.addEventListener('click', () => {
            boardDropdownMenu.classList.add('hidden');
            showCreateBoardModal();
        });
        listContainer.appendChild(createItem);

        const filterInput = document.getElementById('board-filter-input');
        filterInput.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            listContainer.querySelectorAll('.board-dropdown-item').forEach(item => {
                const name = item.querySelector('.board-name-text')?.textContent.toLowerCase();
                if (name && name.includes(searchTerm)) {
                    item.style.display = 'flex';
                } else if (!item.classList.contains('create-board-item')) {
                    item.style.display = 'none';
                }
            });

            listContainer.querySelectorAll('.board-section-header').forEach(header => {
                let nextElement = header.nextElementSibling;
                let hasVisibleItems = false;
                while (nextElement && (nextElement.classList.contains('board-dropdown-item') || nextElement.classList.contains('board-section-header'))) {
                    if (nextElement.classList.contains('board-section-header')) break;
                    if (nextElement.style.display !== 'none') {
                        hasVisibleItems = true;
                        break;
                    }
                    nextElement = nextElement.nextElementSibling;
                }
                header.style.display = hasVisibleItems ? 'block' : 'none';
            });
        });
    }

    
    function openEditNameModal() {
        const modal = document.getElementById('edit-board-name-modal');
        const input = document.getElementById('new-board-name-input');
        const currentBoard = boardsData.find(b => b.id === currentBoardId);
        
        if (currentBoard) {
            input.value = currentBoard.name;
        }

        modal.classList.remove('hidden');
        setTimeout(() => {
            modal.querySelector('.transform').classList.remove('scale-95', 'opacity-0');
            modal.querySelector('.transform').classList.add('scale-100', 'opacity-100');
            input.focus();
            input.select();
        }, 10);
    }

    function closeEditNameModal() {
        const modal = document.getElementById('edit-board-name-modal');
        modal.querySelector('.transform').classList.add('scale-95', 'opacity-0');
        setTimeout(() => modal.classList.add('hidden'), 200);
    }
    
    // Asigna el evento dblclick al nombre del tablero.
    // Asegúrate de que esta línea esté después de que 'currentBoardName' ha sido definido.
    currentBoardName.addEventListener('dblclick', openEditNameModal);
    
    // Eventos para cerrar el modal
    document.getElementById('edit-board-name-close-btn').addEventListener('click', closeEditNameModal);
    document.getElementById('edit-board-name-cancel-btn').addEventListener('click', closeEditNameModal);
    document.getElementById('edit-board-name-overlay').addEventListener('click', closeEditNameModal);

    // Evento para el formulario de guardado
    document.getElementById('edit-board-name-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const newName = document.getElementById('new-board-name-input').value.trim();
        
        if (!newName || newName === currentBoardName.textContent) {
            closeEditNameModal();
            return;
        }

        const currentBoard = boardsData.find(b => b.id === currentBoardId);
        if (currentBoard) {
            const oldName = currentBoard.name;
            currentBoard.name = newName;
            currentBoardName.textContent = newName;
            
            try {
                const response = await fetch(`${API_BASE_URL}/boards/${currentBoardId}/name`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json', 'ngrok-skip-browser-warning': 'true' },
                    body: JSON.stringify({ email: currentUser.email, boardName: newName })
                });

                if (response.ok) {
                    console.log(`✅ Nombre del tablero actualizado en el servidor: ${newName}`);
                    // Opcional: Notificar a otros clientes de la actualización
                } else {
                    const errorData = await response.json();
                    console.error('❌ Error al guardar el nombre del tablero:', errorData.message);
                    // Revertir el nombre en el frontend si falla el guardado
                    currentBoard.name = oldName;
                    currentBoardName.textContent = oldName;
                    alert('Error al guardar el nombre: ' + errorData.message);
                }
            } catch (error) {
                console.error('❌ Error de red al guardar el nombre:', error);
                currentBoard.name = oldName;
                currentBoardName.textContent = oldName;
                alert('Error de conexión al guardar el nombre.');
            }
        }
        
        closeEditNameModal();
    });

    document.getElementById('edit-board-name-close-btn').addEventListener('click', closeEditNameModal);
    document.getElementById('edit-board-name-cancel-btn').addEventListener('click', closeEditNameModal);
    document.getElementById('edit-board-name-overlay').addEventListener('click', closeEditNameModal);

    document.getElementById('edit-board-name-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const newName = document.getElementById('new-board-name-input').value.trim();
        
        if (!newName || newName === currentBoardName.textContent) {
            closeEditNameModal();
            return;
        }

        const currentBoard = boardsData.find(b => b.id === currentBoardId);
        if (currentBoard) {
            const oldName = currentBoard.name;
            currentBoard.name = newName;
            currentBoardName.textContent = newName;
            
            try {
                const response = await fetch(`${API_BASE_URL}/boards/${currentBoardId}/name`, {
                    method: 'PATCH',
                    headers: { 'Content-Type': 'application/json', 'ngrok-skip-browser-warning': 'true' },
                    body: JSON.stringify({ email: currentUser.email, boardName: newName })
                });

                if (response.ok) {
                    console.log(`✅ Nombre del tablero actualizado en el servidor: ${newName}`);
                } else {
                    const errorData = await response.json();
                    console.error('❌ Error al guardar el nombre del tablero:', errorData.message);
                    // Revertir el nombre en el frontend si falla el guardado
                    currentBoard.name = oldName;
                    currentBoardName.textContent = oldName;
                    alert('Error al guardar el nombre: ' + errorData.message);
                }
            } catch (error) {
                console.error('❌ Error de red al guardar el nombre:', error);
                // Revertir el nombre en el frontend si hay un error de red
                currentBoard.name = oldName;
                currentBoardName.textContent = oldName;
                alert('Error de conexión al guardar el nombre.');
            }
        }
        
        closeEditNameModal();
    });


    const chatUserCount = document.getElementById('chat-user-count');
    const chatTypingIndicator = document.getElementById('chat-typing-indicator');
    let typingTimeout = null;






    async function joinAudioMeetingForBoard(boardId) {
      if (isInCall) return;
      meetingRoomName = `meeting_${boardId}`;

      await populateAudioDeviceLists();

      // Escoger mic actual
      const selectedMicId = micSelect.value;
      const constraints = {
        audio: { deviceId: selectedMicId ? { exact: selectedMicId } : undefined, echoCancellation: true, noiseSuppression: true },
        video: false
      };

      const stream = await navigator.mediaDevices.getUserMedia(constraints);
      localAudioTrack = stream;
      isInCall = true;
      meetingCallModal.classList.remove('hidden');

      const myInfo = {
        email: currentUser.email,
        name: `${currentUser.firstName} ${currentUser.lastName}`,
        muted: false,
        handRaised: false
      };
      participants.set(currentUser.email, myInfo);

      // Entrar muteado por defecto (opcional)
      toggleMute(true);
      renderParticipants();

      // Visualizador propio (si tienes canvas con id `viz-${email}`)
      const myCanvas = document.getElementById(`viz-${currentUser.email}`);
      if (myCanvas) createVoiceVisualizer(stream, myCanvas);

      socket.emit('join_meeting_room', { room_name: meetingRoomName, user_info: myInfo });
    }

    function leaveAudioMeeting() {
      if (!isInCall) return;

      socket.emit('leave_meeting_room', { room_name: meetingRoomName });

      Object.values(peerConnections).forEach(pc => pc.close());
      for (const k in peerConnections) delete peerConnections[k];

      if (localAudioTrack) { localAudioTrack.getTracks().forEach(t => t.stop()); localAudioTrack = null; }

      remoteAudioElements.forEach((el) => { try { el.srcObject = null; el.remove(); } catch(_){} });
      remoteAudioElements.clear();

      participants.clear();
      renderParticipants();

      isInCall = false;
      meetingRoomName = null;
    }

    // Enlaza tus botones a estas funciones
    document.getElementById('start-meeting-btn')?.addEventListener('click', () => joinAudioMeetingForBoard(currentBoardId));
    meetingLeaveBtn?.addEventListener('click', leaveAudioMeeting);


    let __allUsersSnapshot = [];


    const dashboardBtn = document.getElementById('dashboard-btn');
    const dashboardModal = document.getElementById('dashboard-modal');
    const dashboardOverlay = document.getElementById('dashboard-overlay');
    const dashboardContent = dashboardModal.querySelector('.transform');
    const dashboardDataContainer = document.getElementById('dashboard-content');
    const dashboardCloseBtn = document.getElementById('dashboard-close-btn');

    function showDashboardModal() {
        dashboardModal.classList.remove('hidden');
        setTimeout(() => dashboardContent.classList.remove('scale-95', 'opacity-0'), 10);
        fetchDashboardData();
    }

    function hideDashboardModal() {
        dashboardContent.classList.add('scale-95', 'opacity-0');
        setTimeout(() => dashboardModal.classList.add('hidden'), 200);
    }

    async function fetchDashboardData() {
        const loader = document.getElementById('dashboard-loader');
        const grid = document.getElementById('dashboard-grid');
        
        loader.style.display = 'flex';
        grid.style.display = 'none';

        try {
            const response = await fetch(`${API_BASE_URL}/boards?email=${encodeURIComponent(currentUser.email)}`, {
                headers: { 'ngrok-skip-browser-warning': 'true' }
            });
            const boardsResponse = await response.json();
            
            if (!boardsResponse.success) {
                throw new Error(boardsResponse.message || "No se pudieron cargar los datos de los tableros.");
            }

            const allCards = [];
            const allBoards = boardsResponse.boards || [];

            allBoards.forEach(board => {
                const boardData = board.data || {};
                const boardCards = boardData.cards || [];
                const columnsMap = new Map((boardData.columns || []).map(col => [col.id, col.title]));

                boardCards.forEach(card => {
                    allCards.push({
                        ...card,
                        boardName: board.name,
                        columnName: columnsMap.get(card.columnId) || 'Sin Columna'
                    });
                });
            });

            const totalCards = allCards.length;
            const completedCards = allCards.filter(c => c.isCompleted).length;
            
            const today = new Date();
            today.setHours(0, 0, 0, 0); 

            // CÁLCULO MEJORADO: Ahora obtenemos la lista de tareas vencidas, no solo el contador.
            const overdueTasksList = allCards
                .filter(c => !c.isCompleted && c.dueDate && new Date(c.dueDate) < today)
                .sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));
            
            const overdueCards = overdueTasksList.length;

            const overallPerformance = totalCards > 0 ? Math.round((completedCards / totalCards) * 100) : 0;
            
            const workloadDistribution = allCards.reduce((acc, card) => {
                if (!card.isCompleted) {
                    const columnName = card.columnName;
                    acc[columnName] = (acc[columnName] || 0) + 1;
                }
                return acc;
            }, {});

            const endOfToday = new Date();
            endOfToday.setHours(23, 59, 59, 999);
            const sevenDaysFromNow = new Date();
            sevenDaysFromNow.setDate(endOfToday.getDate() + 7);

            const upcomingTasks = allCards
                .filter(c => !c.isCompleted && c.dueDate && new Date(c.dueDate) >= endOfToday && new Date(c.dueDate) <= sevenDaysFromNow)
                .sort((a, b) => new Date(a.dueDate) - new Date(b.dueDate));
            
            const processedStats = {
                totalCards,
                completedCards,
                overdueCards,
                overdueTasksList, // <-- Se añade la nueva lista
                overallPerformance,
                workloadDistribution,
                upcomingTasks
            };
            
            renderDashboardData(processedStats);

        } catch (error) {
            document.getElementById('dashboard-content').innerHTML = `<div class="p-8 text-center text-red-600">${error.message}</div>`;
        } finally {
            loader.style.display = 'none';
            grid.style.display = 'grid';
        }
    }

    function renderDashboardData(stats) {
        if (!stats || stats.totalCards === 0) {
            document.getElementById('dashboard-grid').innerHTML = `<div class="col-span-12 text-center py-16">
                <h3 class="text-xl font-semibold text-gray-700">No hay datos suficientes para generar un análisis.</h3>
                <p class="text-gray-500 mt-2">¡Empieza a crear y completar tareas para ver tu productividad en acción!</p>
            </div>`;
            return;
        }

        document.getElementById('total-cards-stat').textContent = stats.totalCards;
        document.getElementById('completed-cards-stat').textContent = stats.completedCards;
        document.getElementById('overdue-cards-stat').textContent = stats.overdueCards;

        document.getElementById('performance-value').textContent = `${stats.overallPerformance}%`;
        const performanceBar = document.getElementById('performance-bar');
        setTimeout(() => {
            performanceBar.style.width = `${stats.overallPerformance}%`;
        }, 100);

        const workloadContainer = document.getElementById('workload-chart-container');
        workloadContainer.innerHTML = '';
        const workloadLabels = Object.keys(stats.workloadDistribution);
        if (workloadLabels.length > 0) {
            const workloadData = Object.values(stats.workloadDistribution);
            const workloadChart = createHorizontalBarChart(workloadLabels, workloadData, '#F97316');
            workloadContainer.appendChild(workloadChart);
        } else {
             workloadContainer.innerHTML = '<p class="text-center text-gray-500 h-full flex items-center justify-center">¡No tienes tareas pendientes!</p>';
        }

        const upcomingList = document.getElementById('upcoming-tasks-list');
        upcomingList.innerHTML = '';
        if (stats.upcomingTasks.length > 0) {
            stats.upcomingTasks.slice(0, 10).forEach(task => {
                const li = document.createElement('li');
                const dueDate = new Date(task.dueDate);
                const today = new Date();
                today.setHours(23, 59, 59, 999);
                const diffTime = dueDate - today;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
                
                let borderColor = 'border-gray-400';
                if (diffDays <= 1) borderColor = 'border-red-500';
                else if (diffDays <= 3) borderColor = 'border-yellow-500';

                li.className = `upcoming-task-item ${borderColor}`;
                li.innerHTML = `
                    <p class="title truncate">${task.title}</p>
                    <p class="details">${task.boardName} &bull; Vence en ${diffDays} día(s)</p>
                `;
                upcomingList.appendChild(li);
            });
        } else {
            upcomingList.innerHTML = '<p class="text-sm text-gray-500 text-center py-4">¡Sin vencimientos próximos!</p>';
        }

        // --- NUEVO BLOQUE: Renderizar la lista de Tareas Vencidas ---
        const overdueList = document.getElementById('overdue-tasks-list');
        overdueList.innerHTML = '';
        if (stats.overdueTasksList.length > 0) {
            stats.overdueTasksList.forEach(task => {
                const li = document.createElement('li');
                const dueDate = new Date(task.dueDate);
                const today = new Date();
                today.setHours(0,0,0,0);
                const diffTime = today - dueDate;
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                // Usamos la clase de borde rojo para todas las vencidas
                li.className = `upcoming-task-item border-red-500`;
                li.innerHTML = `
                    <p class="title truncate">${task.title}</p>
                    <p class="details">${task.boardName} &bull; Venció hace ${diffDays} día(s)</p>
                `;
                overdueList.appendChild(li);
            });
        } else {
            overdueList.innerHTML = '<p class="text-sm text-gray-500 text-center py-4">¡Excelente! No tienes tareas vencidas.</p>';
        }
    }

    // --- FUNCIONES AUXILIARES PARA GRÁFICAS (SIN CAMBIOS, PERO INCLUIR PARA ASEGURAR) ---

    function createBarChart(labels, data, color) {
        const container = document.createElement('div');
        container.style.position = 'relative';
        container.style.width = '100%';
        container.style.height = '100%';
        
        const tooltip = document.createElement('div');
        tooltip.className = 'chart-tooltip';
        container.appendChild(tooltip);

        const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
        svg.setAttribute('width', '100%');
        svg.setAttribute('height', '100%');
        svg.setAttribute('viewBox', `0 0 500 250`);
        svg.style.overflow = 'visible';

        const maxDataValue = Math.max(...data, 1);
        const chartHeight = 200;
        const barWidth = 40;
        const barMargin = 20;

        // Eje Y (líneas de guía)
        for (let i = 0; i <= 4; i++) {
            const y = 220 - (i * (chartHeight / 4));
            const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            line.setAttribute('x1', 0);
            line.setAttribute('y1', y);
            line.setAttribute('x2', 500);
            line.setAttribute('y2', y);
            line.setAttribute('stroke', '#e5e7eb');
            line.setAttribute('stroke-width', '1');
            svg.appendChild(line);

            const labelValue = Math.ceil(maxDataValue / 4 * i);
            if (labelValue > 0 || i === 0){
                 const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                text.setAttribute('x', -5);
                text.setAttribute('y', y + 3);
                text.setAttribute('font-size', '10');
                text.setAttribute('fill', '#9ca3af');
                text.setAttribute('text-anchor', 'end');
                text.textContent = labelValue;
                svg.appendChild(text);
            }
        }
        
        labels.forEach((label, i) => {
            const barHeight = (data[i] / maxDataValue) * chartHeight;
            const x = i * (barWidth + barMargin) + 30;
            
            const bar = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
            bar.setAttribute('x', x);
            bar.setAttribute('y', 220);
            bar.setAttribute('width', barWidth);
            bar.setAttribute('height', 0);
            bar.setAttribute('fill', color);
            bar.setAttribute('rx', 4);
            bar.classList.add('chart-bar');
            
            // Animación
            const anim = document.createElementNS('http://www.w3.org/2000/svg', 'animate');
            anim.setAttribute('attributeName', 'height');
            anim.setAttribute('from', '0');
            anim.setAttribute('to', barHeight);
            anim.setAttribute('dur', '0.5s');
            anim.setAttribute('begin', `${i * 0.05}s`);
            anim.setAttribute('fill', 'freeze');
            bar.appendChild(anim);

            const animY = document.createElementNS('http://www.w3.org/2000/svg', 'animate');
            animY.setAttribute('attributeName', 'y');
            animY.setAttribute('from', '220');
            animY.setAttribute('to', 220 - barHeight);
            animY.setAttribute('dur', '0.5s');
            animY.setAttribute('begin', `${i * 0.05}s`);
            animY.setAttribute('fill', 'freeze');
            bar.appendChild(animY);

            bar.addEventListener('mousemove', (e) => {
                tooltip.style.opacity = '1';
                const rect = container.getBoundingClientRect();
                tooltip.style.left = `${e.clientX - rect.left + 15}px`;
                tooltip.style.top = `${e.clientY - rect.top}px`;
                tooltip.innerHTML = `<strong>${label}</strong>: ${data[i]} completada(s)`;
            });
            bar.addEventListener('mouseleave', () => {
                tooltip.style.opacity = '0';
            });

            svg.appendChild(bar);

            const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            text.setAttribute('x', x + barWidth / 2);
            text.setAttribute('y', 240);
            text.setAttribute('font-size', '10');
            text.setAttribute('fill', '#6b7280');
            text.setAttribute('text-anchor', 'middle');
            text.textContent = label;
            svg.appendChild(text);
        });
        
        container.appendChild(svg);
        return container;
    }

    function createHorizontalBarChart(labels, data, color) {
        const container = document.createElement('div');
        container.style.width = '100%';
        container.style.height = '100%';
        container.style.position = 'relative';

        const tooltip = document.createElement('div');
        tooltip.className = 'chart-tooltip';
        container.appendChild(tooltip);

        const maxDataValue = Math.max(...data, 1);

        const chartContent = document.createElement('div');
        chartContent.className = 'space-y-3';

        labels.forEach((label, i) => {
            const barContainer = document.createElement('div');
            const barWidthPercentage = (data[i] / maxDataValue) * 100;
            
            barContainer.innerHTML = `
                <div class="flex justify-between items-center mb-1">
                    <span class="text-sm font-medium text-gray-700 truncate pr-2">${label}</span>
                    <span class="text-sm font-bold text-gray-800">${data[i]}</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-4">
                    <div class="h-4 rounded-full chart-bar" style="width: 0%; background-color: ${color}; transition: width 0.5s ease-out;"></div>
                </div>
            `;
            
            const bar = barContainer.querySelector('.chart-bar');
            setTimeout(() => {
                bar.style.width = `${barWidthPercentage}%`;
            }, 100 + i * 50);

            bar.addEventListener('mousemove', (e) => {
                tooltip.style.opacity = '1';
                const rect = container.getBoundingClientRect();
                tooltip.style.left = `${e.clientX - rect.left + 15}px`;
                tooltip.style.top = `${e.clientY - rect.top}px`;
                tooltip.innerHTML = `<strong>${label}</strong>: ${data[i]} tarea(s)`;
            });
            bar.addEventListener('mouseleave', () => {
                tooltip.style.opacity = '0';
            });
            
            chartContent.appendChild(barContainer);
        });

        container.appendChild(chartContent);
        return container;
    }

    dashboardBtn.addEventListener('click', showDashboardModal);
    dashboardCloseBtn.addEventListener('click', hideDashboardModal);
    dashboardOverlay.addEventListener('click', hideDashboardModal);
    // ======== BLOQUE A AÑADIR - FIN ========

















    // Busca en tiempo real
    const __searchInput = document.getElementById('active-users-search');
    __searchInput?.addEventListener('input', (e) => {
      renderActiveUsersList(__allUsersSnapshot, e.target.value || '');
    });





    document.getElementById('open-active-users')?.addEventListener('click', (e) => {
      e.stopPropagation();
      openActiveUsersModal();
    });
    document.getElementById('close-active-users')?.addEventListener('click', () => {
      document.getElementById('active-users-modal')?.classList.add('hidden');
    });
    document.getElementById('close-active-users-2')?.addEventListener('click', () => {
      document.getElementById('active-users-modal')?.classList.add('hidden');
    });
    document.getElementById('active-users-backdrop')?.addEventListener('click', () => {
      document.getElementById('active-users-modal')?.classList.add('hidden');
    });



    const participantsModal = document.getElementById('active-users-modal');
    const participantsList = document.getElementById('participants-list');
    const closeParticipantsBtn = document.getElementById('close-active-users');
    const participantsOverlay = document.getElementById('active-users-backdrop');
    const participantsFilterInput = document.getElementById('participants-filter-input');




    /**
     * Dibuja la lista de colaboradores en el modal.
     * @param {Array} collaborators - El array de colaboradores del tablero.
     * @param {string} filter - El texto para filtrar la lista.
     */


    // Se usa delegación de eventos en 'document.body' porque algunos botones se crean dinámicamente
    document.body.addEventListener('click', (e) => {
        // Botón "Ver Participantes" en el chat del tablero
        if (e.target.id === 'open-active-users' || e.target.closest('#open-active-users')) {
            e.stopPropagation();
            openParticipantsModal(); // Ahora la función ya existe
        }
        
        // Botón de asistencia en el pie de página de una columna
        if (e.target.id === 'attendance-btn' || e.target.closest('#attendance-btn')) {
            openParticipantsModal();
        }
    });

    // Listeners para cerrar el modal
    attendanceCloseBtn.addEventListener('click', closeParticipantsModal);
    attendanceOverlay.addEventListener('click', closeParticipantsModal);
    
    // Listener para el filtro de búsqueda dentro del modal
    document.getElementById('attendance-filter-input').addEventListener('input', (e) => {
        renderAttendanceList(currentCollaborators, e.target.value);
    });



    const changePasswordModal = document.getElementById('change-password-modal');
    const changePasswordBtn = document.getElementById('change-password-btn');

    function showChangePasswordModal() {
        changePasswordModal.classList.remove('hidden');
        setTimeout(() => {
            changePasswordModal.querySelector('.transform').classList.remove('scale-95', 'opacity-0');
            document.getElementById('current-password').focus();
        }, 10);
    }

    function hideChangePasswordModal() {
        changePasswordModal.querySelector('.transform').classList.add('scale-95', 'opacity-0');
        setTimeout(() => {
            changePasswordModal.classList.add('hidden');
            document.getElementById('change-password-form').reset();
            document.getElementById('change-password-status').textContent = '';
        }, 200);
    }

    changePasswordBtn.addEventListener('click', () => {
        // Primero cerramos el menú de perfil
        profileMenuDropdown.classList.add('hidden');
        // Luego abrimos el modal de cambio de contraseña
        showChangePasswordModal();
    });

    document.getElementById('change-password-close-btn').addEventListener('click', hideChangePasswordModal);
    document.getElementById('change-password-cancel-btn').addEventListener('click', hideChangePasswordModal);
    document.getElementById('change-password-overlay').addEventListener('click', hideChangePasswordModal);

    document.getElementById('change-password-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const statusEl = document.getElementById('change-password-status');
        const currentPassword = document.getElementById('current-password').value;
        const newPassword = document.getElementById('new-password').value;
        const confirmNewPassword = document.getElementById('confirm-new-password').value;

        if (newPassword !== confirmNewPassword) {
            statusEl.textContent = 'Las nuevas contraseñas no coinciden.';
            statusEl.className = 'text-xs text-center font-medium h-4 text-red-600';
            return;
        }
        
        if (newPassword.length < 4) {
            statusEl.textContent = 'La nueva contraseña debe tener al menos 4 caracteres.';
            statusEl.className = 'text-xs text-center font-medium h-4 text-red-600';
            return;
        }

        statusEl.textContent = 'Actualizando...';
        statusEl.className = 'text-xs text-center font-medium h-4 text-yellow-600';

        try {
            const response = await fetch(`${API_BASE_URL}/user/change-password`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'ngrok-skip-browser-warning': 'true' },
                body: JSON.stringify({
                    email: currentUser.email,
                    current_password: currentPassword,
                    new_password: newPassword
                })
            });

            const result = await response.json();

            if (result.success) {
                statusEl.textContent = 'Contraseña actualizada con éxito.';
                statusEl.className = 'text-xs text-center font-medium h-4 text-green-600';
                setTimeout(hideChangePasswordModal, 1500);
            } else {
                statusEl.textContent = `Error: ${result.message}`;
                statusEl.className = 'text-xs text-center font-medium h-4 text-red-600';
            }
        } catch (error) {
            statusEl.textContent = 'Error de conexión con el servidor.';
            statusEl.className = 'text-xs text-center font-medium h-4 text-red-600';
        }
    });



    const DEFAULT_BOARD_OPTIONS = {
        backgroundUrl: 'https://i.postimg.cc/52PBb46r/Chat-GPT-Image-3-ago-2025-20-01-05-1.png',
        backgroundColorClass: null,
        blurLevel: 0,
        overlayOpacity: 15,
        columnColor: 'bg-gray-50',
        columnOpacity: 85,
        telegramConnected: false,
        telegramChatId: '',
        tagColorMode: 'default',
        tagColorClass: null,
        mrFocuxInterval: 5 // <-- AÑADIR ESTA LÍNEA (5 minutos por defecto)
    };


    function createCardElement(task) {
        const cardColor = task.color || 'bg-white';
        const card = document.createElement('div');
        card.className = `kanban-card group ${cardColor} rounded-lg shadow-sm mb-3 flex flex-col border hover:shadow-md hover:border-red-400 transition-all duration-200 relative`;
        card.draggable = true;
        card.id = task.id;
        card.style.borderColor = CARD_PASTEL_COLORS[cardColor] || '#e5e7eb';

        const attachmentHtml = task.attachment 
            ? `<img src="${task.attachment}" alt="Adjunto" class="w-full h-32 object-cover rounded-t-lg">` 
            : '';

        let dateRangeHtml = '';
        if (task.startDate && !task.isCompleted) {
            const startDate = new Date(task.startDate + 'T00:00:00');
            const endDate = task.endDate ? new Date(task.endDate + 'T00:00:00') : startDate;
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            let statusText = '', dateColor = 'text-gray-500';
            
            if (today < startDate) {
                statusText = `(Próximo)`;
                dateColor = 'text-blue-600';
            } else if (today >= startDate && today <= endDate) {
                statusText = `(En curso)`;
                dateColor = 'text-green-600 font-bold';
            } else if (today > endDate) {
                statusText = `(Vencido)`;
                dateColor = 'text-red-600';
            }
            
            const formattedStart = startDate.toLocaleDateString("es-ES", { day: 'numeric', month: 'short' });
            const formattedEnd = (task.endDate && task.startDate !== task.endDate)
                ? endDate.toLocaleDateString("es-ES", { day: 'numeric', month: 'short' })
                : '';
            
            const dateDisplay = formattedEnd ? `${formattedStart} - ${formattedEnd}` : formattedStart;

            dateRangeHtml = `<div class="mt-2 flex items-center text-xs ${dateColor} font-medium"><svg class="w-4 h-4 mr-1 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg><span class="font-semibold">${dateDisplay}</span><span class="ml-1.5 font-normal">${statusText}</span></div>`;
        }

        const tagsHtml = `<div class="flex flex-wrap gap-x-2 gap-y-1 items-center mt-auto pt-2">${
            (Array.isArray(task.tags) && task.tags.length > 0) 
            ? task.tags.map(tag => {
                const tagText = (typeof tag === 'object' && tag.text) ? tag.text : tag;
                if (!tagText) return '';
                
                let colorClass = '';
                if (boardOptions.tagColorMode === 'pastel') {
                    colorClass = boardOptions.tagColorClass || PASTEL_TAG_COLORS[0];
                } else {
                    colorClass = TAGS_CONFIG[tagText]?.color || getRandomColorClass();
                }
                
                return `<span class="px-2 py-0.5 text-xs font-medium rounded-full ${colorClass}">${tagText}</span>`;
            }).join('') 
            : ''
        }</div>`;

        let statsAndAssigneesHtml = '';
        const hasChecklist = task.checklist && task.checklist.length > 0;
        const hasComments = task.comments && task.comments.length > 0;
        const hasAssignees = task.assignedTo && task.assignedTo.length > 0;
        if (hasChecklist || hasComments || hasAssignees) {
            statsAndAssigneesHtml += '<div class="flex items-center justify-between pt-3 mt-auto">';
            let assigneesHtml = '';
            if (hasAssignees) {
                const avatarsHtml = task.assignedTo.map(email => {
                    const color = getUserColor(email);
                    const initials = email.substring(0, 2);
                    return `<div class="assigned-avatar ${color.bg} ${color.text}" title="${email}">${initials}</div>`;
                }).join('');
                assigneesHtml = `<div class="flex -space-x-3">${avatarsHtml}</div>`;
            }
            statsAndAssigneesHtml += `<div>${assigneesHtml}</div>`;
            let statsIcons = '';
            if (hasChecklist) {
                const completed = task.checklist.filter(i => i.completed).length;
                statsIcons += `<span class="flex items-center gap-1 text-xs text-gray-500"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg> ${completed}/${task.checklist.length}</span>`;
            }
            if (hasComments) {
                statsIcons += `<span class="flex items-center gap-1 text-xs text-gray-500 ml-3"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 5v8a2 2 0 01-2 2h-5l-5 4v-4H4a2 2 0 01-2-2V5a2 2 0 012-2h12a2 2 0 012 2zM7 8H5v2h2V8zm2 0h2v2H9V8zm6 0h-2v2h2V8z" clip-rule="evenodd" /></svg> ${task.comments.length}</span>`;
            }
            statsAndAssigneesHtml += `<div class="flex items-center">${statsIcons}</div>`;
            statsAndAssigneesHtml += '</div>';
        }

        const formattedDescription = formatAiResponse(task.description);
        const descriptionHtml = formattedDescription ? `<div class="text-sm text-gray-600 mt-1 line-clamp-2 pointer-events-none trix-preview">${formattedDescription}</div>` : '';
        const completedBadgeHtml = task.isCompleted ? `<span class="absolute top-2 right-2 bg-blue-500 text-white text-xs font-bold px-2 py-1 rounded-full">Completada</span>` : '';
        const contentHtml = `<div class="p-3 flex flex-col flex-grow"><p class="font-semibold text-gray-800 pointer-events-none">${task.title}</p>${descriptionHtml}${dateRangeHtml}${tagsHtml}${statsAndAssigneesHtml}</div>${completedBadgeHtml}`;
        const actionsMenuHtml = `<div class="card-actions absolute bottom-2 right-2"><button class="card-actions-btn p-1.5 rounded-full bg-white/50 backdrop-blur-sm hover:bg-gray-200 transition-colors opacity-0 group-hover:opacity-100 focus:opacity-100"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-gray-700" viewBox="0 0 20 20" fill="currentColor"><path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zM11.379 5.793L3 14.172V17h2.828l8.38-8.379-2.83-2.828z" /></svg></button><div class="card-actions-menu hidden absolute bottom-full right-0 mb-2 w-56 bg-white rounded-md shadow-lg z-10 border border-gray-200 py-1"><a href="#" class="duplicate-card-btn flex items-center gap-3 px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Duplicar Tarjeta</a><a href="#" class="move-card-column-btn flex items-center gap-3 px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Mover a...</a><a href="#" class="move-card-board-btn flex items-center gap-3 px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Mover a otro tablero...</a><div class="my-1 border-t border-gray-100"></div><a href="#" class="delete-card-btn flex items-center gap-3 px-4 py-2 text-sm text-red-600 hover:bg-red-50">Eliminar Tarjeta</a></div></div>`;
        card.innerHTML = attachmentHtml + contentHtml + actionsMenuHtml;
        if (task.isCompleted) { card.classList.add('opacity-70'); }
        card.addEventListener('dragstart', (e) => { e.stopPropagation(); card.classList.add('dragging-card'); draggedCard = card; });
        card.addEventListener('dragend', () => { card.classList.remove('dragging-card'); draggedCard = null; setTimeout(updateColumnHeaders, 0); });
        card.addEventListener('click', (e) => { if (!e.target.closest('.card-actions')) { e.stopPropagation(); document.querySelectorAll('.card-actions-menu').forEach(m => m.classList.add('hidden')); openCardDrawer(task.id); } });
        
        return card;
    }


    // === NUEVO: abrir/cerrar modal y pedir snapshot ===
    const openActiveUsersBtn = document.getElementById('open-active-users');
    const modal = document.getElementById('active-users-modal');
    const closeActiveUsersBtn = document.getElementById('close-active-users');
    const closeActiveUsersBtn2 = document.getElementById('close-active-users-2');
    const backdrop = document.getElementById('active-users-backdrop');



    openActiveUsersBtn?.addEventListener('click', (e) => {
      e.stopPropagation();
      openActiveUsersModal();
    });
    closeActiveUsersBtn?.addEventListener('click', closeActiveUsersModal);
    closeActiveUsersBtn2?.addEventListener('click', closeActiveUsersModal);
    backdrop?.addEventListener('click', closeActiveUsersModal);

    socket.on('user_is_typing', (data) => {
        chatTypingIndicator.innerHTML = `
            <span class="text-xs text-gray-500 font-medium">${data.user_name} está escribiendo...</span>
            <div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div>
        `;
    });

    socket.on('user_stopped_typing', () => {
        chatTypingIndicator.innerHTML = '';
    });

    // AÑADE ESTA FUNCIÓN PARA ABRIR LA VENTANA MODAL
    function openEditNameModal() {
        const modal = document.getElementById('edit-board-name-modal');
        const input = document.getElementById('new-board-name-input');
        const currentBoard = boardsData.find(b => b.id === currentBoardId);
        
        if (currentBoard) {
            input.value = currentBoard.name;
        }

        modal.classList.remove('hidden');
        setTimeout(() => {
            modal.querySelector('.transform').classList.remove('scale-95', 'opacity-0');
            modal.querySelector('.transform').classList.add('scale-100', 'opacity-100');
            input.focus();
            input.select();
        }, 10);
    }


    function showMainLoader() {
        const loader = document.getElementById('loader-view');
        if (loader) loader.style.display = 'flex';
    }

    function hideMainLoader() {
        const loader = document.getElementById('loader-view');
        if (loader) loader.style.display = 'none';
    }



    // AÑADE ESTA FUNCIÓN PARA CERRAR LA VENTANA MODAL
    function closeEditNameModal() {
        const modal = document.getElementById('edit-board-name-modal');
        modal.querySelector('.transform').classList.add('scale-95', 'opacity-0');
        setTimeout(() => modal.classList.add('hidden'), 200);
    }

    // AÑADE LOS EVENT LISTENERS PARA EL MODAL DE EDICIÓN
    document.getElementById('edit-board-name-close-btn').addEventListener('click', closeEditNameModal);
    document.getElementById('edit-board-name-cancel-btn').addEventListener('click', closeEditNameModal);
    document.getElementById('edit-board-name-overlay').addEventListener('click', closeEditNameModal);
    document.getElementById('edit-board-name-form').addEventListener('submit', (e) => {
        e.preventDefault();
        const newName = document.getElementById('new-board-name-input').value.trim();
        
        if (newName && newName !== currentBoardName.textContent) {
            const currentBoard = boardsData.find(b => b.id === currentBoardId);
            if (currentBoard) {
                currentBoard.name = newName;
                currentBoardName.textContent = newName;
                scheduleAutoSave(); // Dispara el guardado automático
            }
        }
        closeEditNameModal();
    });
    
    function showCreateBoardModal() {
        createBoardModal.classList.remove('hidden');
        document.getElementById('new-board-name').focus();
    }
    
    function hideCreateBoardModal() {
        createBoardModal.classList.add('hidden');
        createBoardForm.reset();
    }
    
    // Keep all existing utility functions from original code
    function debounce(func, timeout = 150){
      let timer;
      return (...args) => {
        clearTimeout(timer);
        timer = setTimeout(() => { func.apply(this, args); }, timeout);
      };
    }
    
    function adjustColumnWidths() {
        if (window.innerWidth <= 768) {
            board.style.gridAutoColumns = '1fr';
            return;
        }
        const numColsToShow = 5;
        const containerWidth = boardContainer.clientWidth;
        const boardStyles = window.getComputedStyle(board);
        const gap = parseFloat(boardStyles.gap);
        const paddingLeft = parseFloat(boardStyles.paddingLeft);
        const paddingRight = parseFloat(boardStyles.paddingRight);
        const totalPadding = paddingLeft + paddingRight;
        const totalGap = (numColsToShow - 1) * gap;
        const availableWidth = containerWidth - totalPadding - totalGap;
        let columnWidth = Math.floor(availableWidth / numColsToShow);
        if (columnWidth < 320) columnWidth = 320;
        board.style.gridAutoColumns = `${columnWidth}px`;
    }
    
    function applyBoardOptions() {
        if (!boardOptions) return;
        BOARD_PASTEL_COLORS.forEach(c => boardContainer.classList.remove(c));

        if (boardOptions.backgroundUrl) {
            boardContainer.style.backgroundImage = `url('${boardOptions.backgroundUrl}')`;
            boardContainer.style.backgroundColor = '';
        } else {
            boardContainer.style.backgroundImage = 'none';
            boardContainer.classList.add(boardOptions.backgroundColorClass || 'bg-white');
        }

        board.style.backdropFilter = `blur(${boardOptions.blurLevel || 0}px)`;
        boardOverlay.style.opacity = `${(boardOptions.overlayOpacity || 0) / 100}`;

        const rgbColor = TAILWIND_TO_RGB[boardOptions.columnColor || 'bg-white'];
        const alpha = (boardOptions.columnOpacity || 100) / 100;
        document.querySelectorAll('.kanban-column').forEach(colEl => {
            colEl.style.backgroundColor = `rgba(${rgbColor}, ${alpha})`;
        });
    }
    

    function openDrawer(overlay, content) {
        overlay.parentElement.classList.remove('hidden');
        setTimeout(() => {
            overlay.classList.remove('opacity-0');
            content.classList.remove('translate-x-full');
        }, 10);
    }

    function closeDrawer(overlay, content) {
        overlay.classList.add('opacity-0');
        content.classList.add('translate-x-full');
        setTimeout(() => {
            overlay.parentElement.classList.add('hidden');
            // --- LÍNEA AÑADIDA PARA CORREGIR EL ERROR ---
            renderAllCards(); // Vuelve a dibujar todas las tarjetas para reflejar cualquier cambio
        }, 300);
    }
    
    function initializeBoard() {
        board.innerHTML = '';
        columnsConfig.forEach(c => board.appendChild(createColumnElement(c)));
        renderAllCards();
        adjustColumnWidths();
        applyBoardOptions();
    }
    





    function formatAiResponse(text) {
        if (!text) return '';
        return text.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>').replace(/\n/g, '<br>');
    }


    let pendingBoardName = null; // Guardará el nombre del tablero mientras se elige la plantilla
    const templateSelectorModal = document.getElementById('template-selector-modal');

    const KANBAN_TEMPLATES = [
        {
            id: 'original',
            title: 'Original',
            image_url: 'https://i.ibb.co/vx8CdfR7/Sin-t-tulo.png',
            columns_desc: 'Por Hacer | En Proceso | En Revisión | Hecho',
            why: 'La configuración clásica y flexible. Ideal para personalizar desde cero y adaptarse a cualquier flujo de trabajo.',
            how: 'Usa las columnas base y renómbralas o añade nuevas según las fases específicas de tu proyecto.',
            columns: [
                { title: 'Por hacer (To Do)', color: 'bg-red-200' },
                { title: 'En proceso (In Progress)', color: 'bg-yellow-200' },
                { title: 'En revisión (In Review)', color: 'bg-indigo-200' },
                { title: 'Hecho (Done)', color: 'bg-green-200' }
            ]
        },
        {
            id: 'minimalista',
            title: 'Minimalista Pro',
            image_url: 'https://i.ibb.co/p6NBY3WD/Sin-t-tulo2.png',
            columns_desc: 'Pendiente | En Curso | Completado',
            why: 'Simplicidad que funciona para el 90% de proyectos. Fácil de entender y mantener.',
            how: 'Limita "En Curso" a un máximo de 3 tareas para enfocarte. Perfecto para equipos pequeños y proyectos personales.',
            columns: [
                { title: 'Pendiente', color: 'bg-gray-200' },
                { title: 'En Curso', color: 'bg-blue-200' },
                { title: 'Completado', color: 'bg-green-200' }
            ]
        },
        {
            id: 'sprint',
            title: 'Sprint Semanal',
            image_url: 'https://i.ibb.co/spXjCSXR/Sin-t-tulo3.png',
            columns_desc: 'Ideas | Esta Semana | Hoy | Finalizado',
            why: 'Combina planificación temporal con ejecución diaria. Muy visual y motivador.',
            how: 'Planifica tu semana el lunes moviendo tareas a "Esta Semana", y cada día elige tus prioridades para "Hoy".',
            columns: [
                { title: 'Ideas', color: 'bg-purple-200' },
                { title: 'Esta Semana', color: 'bg-indigo-200' },
                { title: 'Hoy', color: 'bg-yellow-200' },
                { title: 'Finalizado', color: 'bg-green-200' }
            ]
        },
        {
            id: 'pipeline',
            title: 'Pipeline Completo',
            image_url: 'https://i.ibb.co/GQ85MMqd/Sin-t-tulo4.png',
            columns_desc: 'Por Definir | Listo | Desarrollando | Revisando | Probando | Entregado',
            why: 'Control total del flujo de trabajo con puntos de calidad. Escalable y profesional.',
            how: 'Define criterios claros para cada transición (Definition of Done). Perfecto para equipos de 5-15 personas.',
            columns: [
                { title: 'Por Definir', color: 'bg-gray-200' },
                { title: 'Listo para Empezar', color: 'bg-blue-200' },
                { title: 'Desarrollando', color: 'bg-yellow-200' },
                { title: 'Revisando', color: 'bg-indigo-200' },
                { title: 'Probando', color: 'bg-pink-200' },
                { title: 'Entregado', color: 'bg-green-200' }
            ]
        },
        {
            id: 'scrum',
            title: 'Scrum Moderno',
            image_url: 'https://i.ibb.co/vx0d8yM2/Sin-t-tulo5.png',
            columns_desc: 'Backlog | Sprint | Desarrollo | Revisión | Producción',
            why: 'Metodología ágil simplificada pero completa. Muy adoptada en la industria tecnológica.',
            how: 'Usa sprints de 1-2 semanas, haz reuniones diarias y retrospectivas. Ideal para equipos de desarrollo.',
            columns: [
                { title: 'Product Backlog', color: 'bg-gray-200' },
                { title: 'Sprint Backlog', color: 'bg-indigo-200' },
                { title: 'Desarrollo', color: 'bg-blue-200' },
                { title: 'Revisión / QA', color: 'bg-yellow-200' },
                { title: 'Producción', color: 'bg-green-200' }
            ]
        },
        {
            id: 'multi',
            title: 'Multipropósito',
            image_url: 'https://i.ibb.co/d0YpVgbj/Sin-t-tulo6.png',
            columns_desc: 'Inbox | Planificado | Ejecutando | Cerrado',
            why: 'Funciona para cualquier tipo de proyecto: creativo, técnico, personal o empresarial.',
            how: '"Inbox" captura todo, "Planificado" prioriza, y "Ejecutando" limita el trabajo en curso.',
            columns: [
                { title: 'Inbox', color: 'bg-gray-200' },
                { title: 'Planificado', color: 'bg-blue-200' },
                { title: 'Ejecutando', color: 'bg-yellow-200' },
                { title: 'Cerrado', color: 'bg-green-200' }
            ]
        }
    ];




    // View dropdown functionality
    const viewSelectorBtn = document.getElementById('view-selector-btn');
    const viewDropdownMenu = document.getElementById('view-dropdown-menu');
    const currentViewName = document.getElementById('current-view-name');

    viewSelectorBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        viewDropdownMenu.classList.toggle('hidden');
    });

    document.addEventListener('click', (e) => {
        if (!viewSelectorBtn.contains(e.target) && !viewDropdownMenu.contains(e.target)) {
            viewDropdownMenu.classList.add('hidden');
        }
    });

    // In Tablero.html, replace the existing updateViewDropdown function with this one:

    function updateViewDropdown(activeView) {
        document.querySelectorAll('.view-dropdown-item').forEach(item => {
            item.classList.remove('active');
        });
        
        const viewNames = {
            'board': 'Tablero',
            'calendar': 'Calendario', 
            'notes': 'Notas',
            'documents': 'Documentos',
            'gantt': 'Diagrama de Gantt',
            'eisenhower': 'Eisenhower'
        };
        
        currentViewName.textContent = viewNames[activeView] || 'Tablero';
        
        const activeButton = document.getElementById(`${activeView}-view-btn`);
        if (activeButton) {
            activeButton.classList.add('active');
        }
        
        viewDropdownMenu.classList.add('hidden');
    }

    
    function createScheduledTimeBoxingCard(task) {
        console.log(`🎯 Creando tarjeta programada para: ${task.title}`);
        
        const card = createCardElement(task);
        
        // Diseño más elegante para TimeBoxing programado
        card.classList.add('scheduled-TimeBoxing-card');
        card.style.borderColor = '#f97316';
        card.style.borderWidth = '2px';
        card.style.background = 'linear-gradient(135deg, #ffffff, #fff7ed)';
        card.style.boxShadow = '0 4px 12px rgba(249, 115, 22, 0.15)';
        
        const cardBody = card.querySelector('.p-3');
        if (cardBody) {
            // Header con ícono y badge más elegante
            const TimeBoxingHeader = document.createElement('div');
            TimeBoxingHeader.className = 'flex items-center justify-between mb-3 p-2 bg-orange-50 rounded-lg border border-orange-200';
            TimeBoxingHeader.innerHTML = `
                <div class="flex items-center gap-2">
                    <div class="w-2 h-2 bg-orange-500 rounded-full animate-pulse"></div>
                    <span class="text-orange-700 font-semibold text-xs">TimeBoxing</span>
                </div>
                <svg class="w-4 h-4 text-orange-500" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path>
                </svg>
            `;
            
            // Countdown timer más elegante
            const countdownDisplay = document.createElement('div');
            const uniqueId = `countdown-display-${task.id}`;
            countdownDisplay.id = uniqueId;
            countdownDisplay.className = 'text-center bg-gradient-to-r from-orange-500 to-orange-600 text-white font-bold py-3 px-4 rounded-lg my-2 text-sm shadow-lg';
            countdownDisplay.textContent = 'Calculando...';
            
            console.log(`📍 Creando elemento countdown con ID: ${uniqueId}`);
            
            // Insertar elementos al inicio del cuerpo
            cardBody.insertBefore(countdownDisplay, cardBody.firstChild);
            cardBody.insertBefore(TimeBoxingHeader, cardBody.firstChild);
            
            console.log(`⏰ Datos TimeBoxing:`, {
                startDateTime: task.TimeBoxing.startDateTime,
                endDateTime: task.TimeBoxing.endDateTime,
                isActive: task.TimeBoxing.isActive
            });
            
            // Iniciar el countdown
            startCountdownTimer(task);
        }
        
        return card;
    }
        




    function startCountdownTimer(task) {
        setTimeout(() => {
            const countdownDisplay = document.getElementById(`countdown-display-${task.id}`);
            if (!countdownDisplay) {
                console.log(`❌ No se encontró countdown display para tarea: ${task.id}`);
                return;
            }
            
            console.log(`⏰ Iniciando countdown para: ${task.title}`);
            
            const updateCountdown = () => {
                const now = new Date();
                const startTime = new Date(task.TimeBoxing.startDateTime);
                const endTime = new Date(task.TimeBoxing.endDateTime);
                const timeUntilStart = startTime.getTime() - now.getTime();
                
                // Si ya debería haber iniciado pero aún no se ha procesado
                if (timeUntilStart <= 0) {
                    // Mostrar tiempo transcurrido desde el inicio en lugar de "Iniciando"
                    const timeFromStart = now.getTime() - startTime.getTime();
                    const timeRemaining = endTime.getTime() - now.getTime();
                    
                    if (timeRemaining > 0) {
                        // Mostrar tiempo restante de la sesión EN ROJO
                        const hours = Math.floor(timeRemaining / (1000 * 60 * 60));
                        const minutes = Math.floor((timeRemaining % (1000 * 60 * 60)) / (1000 * 60));
                        const seconds = Math.floor((timeRemaining % (1000 * 60)) / 1000);
                        
                        let timeText = '';
                        if (hours > 0) {
                            timeText = `Activo: ${hours}h ${minutes}m ${seconds}s`;
                        } else if (minutes > 0) {
                            timeText = `Activo: ${minutes}m ${seconds}s`;
                        } else {
                            timeText = `Activo: ${seconds}s`;
                        }
                        
                        countdownDisplay.textContent = timeText;
                        // CAMBIADO A ROJO cuando está activo
                        countdownDisplay.className = 'text-center bg-gradient-to-r from-red-500 to-red-600 text-white font-bold py-3 px-4 rounded-lg my-2 text-sm shadow-lg animate-pulse';
                    } else {
                        countdownDisplay.textContent = 'Finalizando...';
                        countdownDisplay.className = 'text-center bg-gradient-to-r from-red-700 to-red-800 text-white font-bold py-3 px-4 rounded-lg my-2 text-sm shadow-lg animate-pulse';
                    }
                    return;
                }
                
                // Tiempo hasta el inicio (estado normal en naranja)
                const days = Math.floor(timeUntilStart / (1000 * 60 * 60 * 24));
                const hours = Math.floor((timeUntilStart % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((timeUntilStart % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((timeUntilStart % (1000 * 60)) / 1000);
                
                let countdownText = '';
                let className = 'text-center bg-gradient-to-r from-orange-500 to-orange-600 text-white font-bold py-3 px-4 rounded-lg my-2 text-sm shadow-lg';
                
                if (days > 0) {
                    countdownText = `Inicia en: ${days}d ${hours}h ${minutes}m`;
                } else if (hours > 0) {
                    countdownText = `Inicia en: ${hours}h ${minutes}m ${seconds}s`;
                } else if (minutes > 0) {
                    countdownText = `Inicia en: ${minutes}m ${seconds}s`;
                } else {
                    countdownText = `Inicia en: ${seconds}s`;
                    // Mantener naranja pero con pulse cuando quedan pocos segundos
                    className += ' animate-pulse';
                }
                
                countdownDisplay.textContent = countdownText;
                countdownDisplay.className = className;
                console.log(`📱 Actualizando countdown: ${countdownText}`);
            };
            
            // Actualizar inmediatamente
            updateCountdown();
            
            // Actualizar cada segundo
            const countdownInterval = setInterval(() => {
                const displayElement = document.getElementById(`countdown-display-${task.id}`);
                if (!displayElement) {
                    console.log(`🛑 Elemento countdown eliminado, deteniendo interval para: ${task.title}`);
                    clearInterval(countdownInterval);
                    return;
                }
                updateCountdown();
            }, 1000);
            
            // Guardar referencia del interval
            if (!task.TimeBoxing.intervals) {
                task.TimeBoxing.intervals = [];
            }
            task.TimeBoxing.intervals.push(countdownInterval);
            
        }, 100);
    }



    // Función opcional para mostrar toast notifications
    function showToastNotification(title, message) {
        // Crear elemento de toast
        const toast = document.createElement('div');
        toast.className = 'fixed top-4 right-4 bg-white border-l-4 border-orange-500 rounded-lg shadow-lg p-4 max-w-sm z-50';
        toast.innerHTML = `
            <div class="flex items-start">
                <div class="flex-shrink-0">
                    <svg class="h-5 w-5 text-orange-500" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                    </svg>
                </div>
                <div class="ml-3 w-0 flex-1">
                    <p class="text-sm font-medium text-gray-900">${title}</p>
                    <p class="mt-1 text-sm text-gray-500">${message}</p>
                </div>
                <div class="ml-4 flex-shrink-0 flex">
                    <button class="toast-close bg-white rounded-md inline-flex text-gray-400 hover:text-gray-500">
                        <span class="sr-only">Cerrar</span>
                        <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                        </svg>
                    </button>
                </div>
            </div>
        `;
        
        // Agregar al DOM
        document.body.appendChild(toast);
        
        // Evento para cerrar
        toast.querySelector('.toast-close').addEventListener('click', () => {
            toast.remove();
        });
        
        // Auto-remover después de 5 segundos
        setTimeout(() => {
            if (toast.parentNode) {
                toast.remove();
            }
        }, 5000);
    }



    function showToast(arg1, arg2 = '') {
        const TYPES = ['success', 'error', 'info', 'warning'];
        if (typeof arg2 === 'string' && TYPES.includes(arg2.toLowerCase())) {
          const type = arg2.toLowerCase();
          const title = (type === 'error') ? 'Error' : (type === 'success' ? 'Éxito' : 'Aviso');
        } else {
          // Asumir firma (título, mensaje)
        }
    }



    // ========================================================================
    // == INICIO: BLOQUE CORREGIDO PARA LA VISTA DIARIA DEL CALENDARIO (V3) ==
    // ========================================================================

    const dayViewModal = document.getElementById('day-view-modal');
    const dayViewOverlay = document.getElementById('day-view-overlay');
    const dayViewCloseBtn = document.getElementById('day-view-close-btn');
    const dayViewTitle = document.getElementById('day-view-title');
    const dayViewAllDayTasks = document.getElementById('day-view-all-day-tasks');
    const dayViewHourlyContainer = document.getElementById('day-view-hourly-container');

    function showDayViewModal(dateStr) {
        console.log(`[Modal Día] Abriendo para la fecha: ${dateStr}`);
        
        const date = new Date(dateStr + 'T00:00:00');
        dayViewTitle.textContent = date.toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

        const tasksForDay = Array.from(cardDataStore.values()).filter(t => t.dueDate === dateStr);
        console.log(`[Modal Día] Tareas encontradas para este día:`, tasksForDay);

        const allDayTasks = tasksForDay.filter(t => t.allDay !== false);
        dayViewAllDayTasks.innerHTML = '';
        if (allDayTasks.length > 0) {
            allDayTasks.forEach(task => {
                const taskEl = document.createElement('div');
                taskEl.className = `px-2 py-1 text-xs font-medium rounded cursor-pointer ${task.color || 'bg-gray-100'} border ${CARD_PASTEL_COLORS[task.color] || 'border-gray-200'}`;
                taskEl.textContent = task.title;
                taskEl.title = `Abrir tarjeta: ${task.title}`;
                taskEl.onclick = () => openCardDrawer(task.id);
                dayViewAllDayTasks.appendChild(taskEl);
            });
        } else {
            dayViewAllDayTasks.innerHTML = '<span class="text-xs text-gray-400">Sin eventos de todo el día.</span>';
        }

        const hourlyTasks = tasksForDay.filter(t => t.allDay === false);
        console.log(`[Modal Día] Tareas con hora específica para renderizar:`, hourlyTasks);
        renderHourlyView(hourlyTasks);
        
        dayViewModal.classList.remove('hidden');
    }

    function hideDayViewModal() {
        dayViewModal.classList.add('hidden');
    }

    function renderHourlyView(tasks) {
        dayViewHourlyContainer.innerHTML = '';
        const hourHeight = 60;

        const timelineWrapper = document.createElement('div');
        timelineWrapper.className = 'relative w-full';
        timelineWrapper.style.height = `${24 * hourHeight}px`;

        for (let i = 0; i < 24; i++) {
            const hourLine = document.createElement('div');
            hourLine.className = 'absolute w-full border-t border-gray-200';
            hourLine.style.top = `${i * hourHeight}px`;
            hourLine.style.left = '4rem';

            const hourLabel = document.createElement('span');
            hourLabel.className = 'absolute -top-2.5 -left-12 text-xs text-gray-400 bg-white px-1';
            hourLabel.textContent = `${i.toString().padStart(2, '0')}:00`;
            
            hourLine.appendChild(hourLabel);
            timelineWrapper.appendChild(hourLine);
        }
        
        if (tasks.length === 0) {
            timelineWrapper.innerHTML += '<p class="text-center text-gray-400 text-sm pt-8">No hay actividades programadas con hora específica.</p>';
        } else {
            tasks.forEach(task => {
                if (!task.startTime || !task.endTime) return;

                const [startHour, startMinute] = task.startTime.split(':').map(Number);
                const [endHour, endMinute] = task.endTime.split(':').map(Number);

                const startTotalMinutes = startHour * 60 + startMinute;
                const endTotalMinutes = endHour * 60 + endMinute;
                
                if (endTotalMinutes <= startTotalMinutes) {
                    console.warn('[Render Hora] Tarea omitida (hora final es anterior a la de inicio):', task);
                    return;
                }

                const top = (startTotalMinutes / 60) * hourHeight;
                const durationMinutes = endTotalMinutes - startTotalMinutes;
                const height = (durationMinutes / 60) * hourHeight;

                const eventEl = document.createElement('div');
                eventEl.className = `absolute right-2 p-2 rounded-lg border-l-4 ${task.color || 'bg-gray-100'} overflow-hidden cursor-pointer`;
                eventEl.style.left = '4.5rem';
                eventEl.style.top = `${top}px`;
                eventEl.style.height = `${height}px`;
                eventEl.style.minHeight = '24px';
                eventEl.style.borderColor = CARD_PASTEL_COLORS[task.color] || '#e5e7eb';
                eventEl.title = `Abrir tarjeta: ${task.title}`;
                
                eventEl.innerHTML = `
                    <p class="font-semibold text-sm text-gray-800 truncate">${task.title}</p>
                    <p class="text-xs text-gray-500">${task.startTime} - ${task.endTime}</p>
                `;
                
                eventEl.onclick = () => openCardDrawer(task.id);
                
                timelineWrapper.appendChild(eventEl);
            });
        }

        dayViewHourlyContainer.appendChild(timelineWrapper);
        
        // --- INICIO DE LA LÍNEA CORREGIDA ---
        // Usamos el título del modal, que sí está disponible en este scope, para saber si es hoy.
        const isToday = (new Date()).toDateString() === (new Date(dayViewTitle.textContent)).toDateString();
        // --- FIN DE LA LÍNEA CORREGIDA ---
        const scrollHour = isToday ? (new Date()).getHours() : 7;
        dayViewHourlyContainer.scrollTop = Math.max(0, (scrollHour - 1) * hourHeight);
    }

    dayViewCloseBtn.addEventListener('click', hideDayViewModal);
    dayViewOverlay.addEventListener('click', hideDayViewModal);

    // ========================================================================
    // == FIN: BLOQUE CORREGIDO PARA LA VISTA DIARIA DEL CALENDARIO (V3) ==
    // ========================================================================








    let referencesCache = [];
    let currentReferenceId = null;

    async function loadAndRenderDocuments() {
        if (!currentBoardId) return;

        const documentsGrid = document.getElementById('documents-grid');
        const referencesGrid = document.getElementById('references-grid');
        documentsGrid.innerHTML = '<p class="col-span-full text-center text-gray-500">Cargando documentos...</p>';
        referencesGrid.innerHTML = '<p class="text-center text-gray-500 text-sm mt-6">Cargando referencias...</p>';
        
        try {
            // Cargar Documentos
            const docResponse = await fetch(`${API_BASE_URL}/documents?email=${encodeURIComponent(currentUser.email)}&board_id=${currentBoardId}`, {
                headers: { 'ngrok-skip-browser-warning': 'true' }
            });
            if (!docResponse.ok) throw new Error(`Error al cargar documentos: ${docResponse.statusText}`);
            const docData = await docResponse.json();
            if (docData.success) {
                documentsCache = docData.documents;
                renderDocuments();
            } else {
                documentsGrid.innerHTML = `<p class="col-span-full text-center text-red-500">Error: ${docData.message}</p>`;
            }

            // Cargar Referencias
            const refResponse = await fetch(`${API_BASE_URL}/references?email=${encodeURIComponent(currentUser.email)}&board_id=${currentBoardId}`, {
                headers: { 'ngrok-skip-browser-warning': 'true' }
            });
            if (!refResponse.ok) throw new Error(`Error al cargar referencias: ${refResponse.statusText}`);
            const refData = await refResponse.json();
            if (refData.success) {
                referencesCache = refData.references;
                renderReferences();
            } else {
                 referencesGrid.innerHTML = `<p class="text-center text-red-500 text-sm mt-6">Error: ${refData.message}</p>`;
            }

        } catch (error) {
            console.error('Error fetching documents/references:', error);
            documentsGrid.innerHTML = `<p class="col-span-full text-center text-red-500">Error de conexión al cargar documentos.</p>`;
            referencesGrid.innerHTML = `<p class="text-center text-red-500 text-sm mt-6">Error de conexión al cargar referencias.</p>`;
        }
    }

    function renderReferences() {
        const grid = document.getElementById('references-grid');
        grid.innerHTML = '';
        if (referencesCache.length === 0) {
            grid.innerHTML = '<p class="text-center text-gray-500 text-sm mt-6">No hay referencias guardadas.</p>';
            return;
        }
        referencesCache.forEach(ref => {
            const refEl = createReferenceElement(ref);
            grid.appendChild(refEl);
        });
    }

    function openAddReferenceModal(refId = null) {
        const modal = document.getElementById('add-reference-modal');
        const form = document.getElementById('add-reference-form');
        const titleEl = document.getElementById('reference-modal-title');
        
        form.reset();
        currentReferenceId = refId;

        if (refId) {
            const reference = referencesCache.find(r => r.id == refId);
            if (reference) {
                titleEl.textContent = 'Editar Referencia';
                document.getElementById('reference-id-input').value = refId;
                document.getElementById('reference-title-input').value = reference.title;
                document.getElementById('reference-url-input').value = reference.url;
            }
        } else {
            titleEl.textContent = 'Agregar Nueva Referencia';
        }

        modal.classList.remove('hidden');
        setTimeout(() => modal.querySelector('.transform').classList.remove('scale-95', 'opacity-0'), 10);
    }

    function closeAddReferenceModal() {
        const modal = document.getElementById('add-reference-modal');
        modal.querySelector('.transform').classList.add('scale-95', 'opacity-0');
        setTimeout(() => modal.classList.add('hidden'), 200);
    }

    document.getElementById('add-reference-btn').addEventListener('click', () => openAddReferenceModal());
    document.getElementById('add-reference-close-btn').addEventListener('click', closeAddReferenceModal);
    document.getElementById('add-reference-cancel-btn').addEventListener('click', closeAddReferenceModal);
    document.getElementById('add-reference-overlay').addEventListener('click', closeAddReferenceModal);

    document.getElementById('add-reference-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const id = document.getElementById('reference-id-input').value;
        const title = document.getElementById('reference-title-input').value.trim();
        const url = document.getElementById('reference-url-input').value.trim();
        if (!title || !url) return;

        const isEditing = !!id;
        const endpoint = isEditing ? `${API_BASE_URL}/references/${id}` : `${API_BASE_URL}/references`;
        const method = isEditing ? 'PUT' : 'POST';

        try {
            const response = await fetch(endpoint, {
                method: method,
                headers: { 'Content-Type': 'application/json', 'ngrok-skip-browser-warning': 'true' },
                body: JSON.stringify({
                    board_id: currentBoardId,
                    email: currentUser.email,
                    title: title,
                    url: url
                })
            });
            
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message || `Error del servidor: ${response.status}`);
            }

            const result = await response.json();

            if (result.success) {
                if (isEditing) {
                    // Si se está editando, reemplaza el elemento existente en el caché
                    const refIndex = referencesCache.findIndex(r => r.id == id);
                    if (refIndex > -1) {
                        referencesCache[refIndex] = result.reference;
                    }
                } else {
                    // Si se está creando, añade el nuevo elemento al inicio del caché
                    referencesCache.unshift(result.reference);
                }
                // Actualiza la interfaz y cierra el modal
                renderReferences();
                closeAddReferenceModal();
            } else {
                alert(`Error al guardar: ${result.message}`);
            }
        } catch (error) {
            console.error('Error de conexión al guardar la referencia:', error);
            alert(`Error de conexión al guardar la referencia.`);
        }
    });

    document.getElementById('references-grid').addEventListener('click', async (e) => {
        const editBtn = e.target.closest('.edit-reference-btn');
        if (editBtn) {
            openAddReferenceModal(editBtn.dataset.refId);
        }

        const deleteBtn = e.target.closest('.delete-reference-btn');
        if (deleteBtn) {
            const refId = deleteBtn.dataset.refId;
            const ref = referencesCache.find(r => r.id == refId);
            const confirmed = await showGenericConfirmModal('Eliminar Referencia', `¿Estás seguro de que quieres eliminar la referencia "${ref.title}"?`);
            
            if (confirmed) {
                 try {
                    const response = await fetch(`${API_BASE_URL}/references/${refId}`, {
                        method: 'DELETE',
                        headers: { 'Content-Type': 'application/json', 'ngrok-skip-browser-warning': 'true' },
                        body: JSON.stringify({ board_id: currentBoardId, email: currentUser.email })
                    });
                    const result = await response.json();
                    if(result.success) {
                        referencesCache = referencesCache.filter(r => r.id != refId);
                        renderReferences();
                    } else {
                        alert(`Error: ${result.message}`);
                    }
                } catch(error) {
                    alert('Error de conexión al eliminar la referencia.');
                }
            }
        }
    });


    function renderDocuments() {
        const documentsGrid = document.getElementById('documents-grid');
        documentsGrid.innerHTML = '';
        if (documentsCache.length === 0) {
            documentsGrid.innerHTML = '<p class="col-span-full text-center text-gray-500 mt-8">No hay documentos en este tablero. ¡Agrega uno!</p>';
            return;
        }
        documentsCache.forEach(doc => {
            const docEl = createDocumentElement(doc);
            documentsGrid.appendChild(docEl);
        });
    }





    function createReferenceElement(ref) {
        const refEl = document.createElement('div');
        refEl.className = 'flex items-center gap-4 p-3 bg-white border rounded-lg shadow-sm hover:shadow-md transition-shadow';
        
        let domain = 'enlace';
        try {
            domain = new URL(ref.url).hostname.replace('www.', '');
        } catch (e) { /* Ignorar URL inválida */ }

        refEl.innerHTML = `
            <a href="${ref.url}" target="_blank" class="flex-shrink-0">
                <img src="https://icons.duckduckgo.com/ip3/${domain}.ico" 
                     onerror="this.onerror=null; this.src='https://i.ibb.co/6gT3Y8d/link-symbol-for-interface-svgrepo-com.png';" 
                     alt="Icono" class="w-10 h-10 object-contain bg-gray-100 p-1 rounded-md">
            </a>
            <a href="${ref.url}" target="_blank" class="flex-grow min-w-0">
                <p class="font-semibold text-gray-800 truncate">${ref.title}</p>
                <p class="text-xs text-blue-600 truncate">${ref.url}</p>
            </a>
            <div class="flex-shrink-0 flex items-center gap-2">
                <button class="edit-reference-btn p-1.5 text-gray-500 hover:text-blue-600 hover:bg-blue-50 rounded-full" data-ref-id="${ref.id}" title="Editar">
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828zM3 14a1 1 0 011-1h2a1 1 0 110 2H4a1 1 0 01-1-1z"></path></svg>
                </button>
                <button class="delete-reference-btn p-1.5 text-gray-500 hover:text-red-600 hover:bg-red-50 rounded-full" data-ref-id="${ref.id}" title="Eliminar">
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>
                </button>
            </div>
        `;
        return refEl;
    }








    function renderCalendar() {
        calendarGrid.innerHTML = '';
        const month = currentCalendarDate.getMonth();
        const year = currentCalendarDate.getFullYear();

        calendarMonthYear.textContent = new Date(year, month).toLocaleDateString('es-ES', { month: 'long', year: 'numeric' });

        const firstDayOfMonth = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();

        ['Dom', 'Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb'].forEach(day => {
            const dayNameEl = document.createElement('div');
            dayNameEl.className = 'calendar-day-name';
            dayNameEl.textContent = day;
            calendarGrid.appendChild(dayNameEl);
        });
        
        for (let i = 0; i < firstDayOfMonth; i++) {
            const emptyCell = document.createElement('div');
            emptyCell.className = 'calendar-day other-month';
            calendarGrid.appendChild(emptyCell);
        }

        // --- INICIO DE LA LÓGICA MODIFICADA ---

        // Obtener y ordenar las tareas con fecha de inicio para una renderización consistente
        const tasksWithDates = Array.from(cardDataStore.values())
            .filter(t => t.startDate)
            .sort((a, b) => new Date(a.startDate) - new Date(b.startDate));

        for (let day = 1; day <= daysInMonth; day++) {
            const dayCell = document.createElement('div');
            dayCell.className = 'calendar-day';
            const currentDate = new Date(Date.UTC(year, month, day));
            const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            
            dayCell.classList.add('cursor-pointer', 'hover:bg-gray-50');
            dayCell.addEventListener('click', () => showDayViewModal(dateStr));

            const dayNumber = document.createElement('div');
            dayNumber.className = 'day-number';
            dayNumber.textContent = day;
            dayCell.appendChild(dayNumber);

            const today = new Date();
            today.setHours(0, 0, 0, 0);
            if (currentDate.getTime() === today.getTime()) {
                dayCell.classList.add('today');
            }
            
            const eventsContainer = document.createElement('div');
            eventsContainer.className = 'calendar-events';
            
            // Revisar cada tarea para ver si se debe mostrar en este día
            tasksWithDates.forEach(task => {
                const startDate = new Date(task.startDate + 'T00:00:00Z');
                // Si no hay fecha final, se asume que dura solo un día
                const endDate = task.endDate ? new Date(task.endDate + 'T00:00:00Z') : startDate;

                // Comprobar si el día actual está dentro del rango de la tarea
                if (currentDate >= startDate && currentDate <= endDate) {
                    const eventEl = document.createElement('div');
                    const cardColor = task.color || 'bg-slate-100';
                    eventEl.className = `calendar-event ${cardColor}`;
                    eventEl.textContent = task.title;
                    eventEl.title = task.title;
                    eventEl.dataset.cardId = task.id;

                    // Añadir clases para la apariencia de barra continua
                    eventEl.classList.add('bar-segment');
                    if (currentDate.getTime() === startDate.getTime()) {
                        eventEl.classList.add('bar-start');
                    }
                    if (currentDate.getTime() === endDate.getTime()) {
                        eventEl.classList.add('bar-end');
                    }
                    
                    eventEl.addEventListener('click', (e) => {
                        e.stopPropagation(); 
                        openCardDrawer(task.id)
                    });
                    eventsContainer.appendChild(eventEl);
                    dayCell.classList.add('has-events');
                }
            });
            
            dayCell.appendChild(eventsContainer);
            calendarGrid.appendChild(dayCell);
        }
        // --- FIN DE LA LÓGICA MODIFICADA ---
    }




    let currentEditorForAISuggestions = null;

    // Función para mostrar el modal de sugerencias
    function showSuggestionsModal(isLoading = false) {
        const modal = document.getElementById('ai-suggestions-modal');
        const content = modal.querySelector('.transform');
        const listContainer = document.getElementById('suggestions-list-container');
        
        if (isLoading) {
            listContainer.innerHTML = `
                <div class="text-center p-8">
                    <svg class="animate-spin h-8 w-8 text-blue-600 mx-auto mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                    <p class="text-gray-600 font-medium">Generando sugerencias...</p>
                </div>`;
        }
        
        modal.classList.remove('hidden');
        setTimeout(() => {
            content.classList.remove('scale-95', 'opacity-0');
            content.classList.add('scale-100', 'opacity-100');
        }, 10);
    }

    function hideSuggestionsModal() {
        const modal = document.getElementById('ai-suggestions-modal');
        const content = modal.querySelector('.transform');
        content.classList.add('scale-95', 'opacity-0');
        setTimeout(() => modal.classList.add('hidden'), 200);
    }

    function renderSuggestions(suggestions) {
        const listContainer = document.getElementById('suggestions-list-container');
        listContainer.innerHTML = '';
        if (!suggestions || suggestions.length === 0) {
            listContainer.innerHTML = '<p class="text-center p-8 text-gray-500">No se pudieron generar sugerencias.</p>';
            return;
        }

        suggestions.forEach(text => {
            const suggestionCard = document.createElement('div');
            suggestionCard.className = 'p-4 border rounded-lg mb-3 bg-gray-50';
            const formattedText = text.replace(/\n/g, '<br>');

            suggestionCard.innerHTML = `
                <div class="text-gray-800 trix-content">${formattedText}</div>
                <div class="flex items-center justify-end gap-2 mt-3">
                    <button class="copy-btn text-xs font-semibold text-gray-600 hover:text-black p-2 rounded-md hover:bg-gray-200">Copiar</button>
                    <button class="use-text-btn text-xs font-semibold text-white bg-blue-600 hover:bg-blue-700 px-3 py-2 rounded-md">Usar este texto</button>
                </div>
            `;
            
            suggestionCard.querySelector('.copy-btn').addEventListener('click', () => {
                navigator.clipboard.writeText(text);

            });
            
            suggestionCard.querySelector('.use-text-btn').addEventListener('click', () => {
                if (currentEditorForAISuggestions && currentEditorForAISuggestions.editor) {
                    currentEditorForAISuggestions.editor.loadHTML(formattedText);
                }
                hideSuggestionsModal();
            });

            listContainer.appendChild(suggestionCard);
        });
    }


    async function getWritingSuggestionsAI(editorElement) {
        if (!editorElement || !editorElement.editor) return;

        currentEditorForAISuggestions = editorElement; // Guardar referencia al editor actual
        const originalText = editorElement.editor.getDocument().toString().trim();

        if (!originalText) {
            alert("No hay texto para generar sugerencias.");
            return;
        }

        showSuggestionsModal(true); // Mostrar modal en estado de carga

        try {
            const response = await fetch(`${API_BASE_URL}/ai/writing-suggestions`, { // <-- URL CORREGIDA
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'ngrok-skip-browser-warning': 'true' 
                },
                body: JSON.stringify({ text: originalText }) // <-- MANEJO DE DATOS CORREGIDO
            });

            const data = await response.json();

            if (data.success && Array.isArray(data.suggestions)) {
                renderSuggestions(data.suggestions);
            } else {
                throw new Error(data.message || "La IA devolvió un formato inesperado.");
            }
        } catch (error) {
            console.error("Error al obtener sugerencias de la IA:", error);
            const listContainer = document.getElementById('suggestions-list-container');
            listContainer.innerHTML = `<p class="p-8 text-center text-red-600">${error.message}</p>`;
        }
    }




    
    // Listeners para el nuevo modal
    document.getElementById('ai-suggestions-close-btn').addEventListener('click', hideSuggestionsModal);
    document.getElementById('ai-suggestions-overlay').addEventListener('click', hideSuggestionsModal);


    function switchView(view) {
        // 1. Ocultar todos los contenedores principales
        boardContainer.classList.remove('active', 'flex');
        calendarContainer.classList.remove('active', 'flex');
        eisenhowerContainer.classList.remove('active', 'flex');
        notesContainer.classList.remove('active', 'block');
        documentsContainer.classList.remove('active', 'block');
        ganttContainer.classList.remove('active', 'flex');

        boardContainer.classList.add('hidden');
        calendarContainer.classList.add('hidden');
        eisenhowerContainer.classList.add('hidden');
        notesContainer.classList.add('hidden');
        documentsContainer.classList.add('hidden');
        ganttContainer.classList.add('hidden');
        
        const boardSelectorBtn = document.getElementById('board-selector-btn');

        // 2. Lógica para mostrar el contenedor correcto
        if (view === 'board') {
            boardSelectorBtn.disabled = false;
            boardSelectorBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            boardContainer.classList.remove('hidden');
            boardContainer.classList.add('active', 'flex');
            adjustColumnWidths();
        } else {
            boardSelectorBtn.disabled = true;
            boardSelectorBtn.classList.add('opacity-50', 'cursor-not-allowed');
            
            if (view === 'calendar') {
                calendarContainer.classList.remove('hidden');
                calendarContainer.classList.add('active', 'flex');
                renderCalendar();
            } else if (view === 'eisenhower') {
                eisenhowerContainer.classList.remove('hidden');
                eisenhowerContainer.classList.add('active', 'flex');
                renderEisenhowerMatrix();
            } else if (view === 'notes') {
                notesContainer.classList.remove('hidden');
                notesContainer.classList.add('active', 'block');
                loadAndRenderNotes();
            } else if (view === 'documents') {
                documentsContainer.classList.remove('hidden');
                documentsContainer.classList.add('active', 'block');
                loadAndRenderDocuments();
            } else if (view === 'gantt') {
                ganttContainer.classList.remove('hidden');
                ganttContainer.classList.add('active', 'flex');
                renderGanttChart();
            }
        }
        
        updateViewDropdown(view);
    }
    
    function showInfoModal(title, message) {
        const modal = document.getElementById('info-modal');
        const content = modal.querySelector('.transform');
        document.getElementById('info-modal-title').textContent = title;
        document.getElementById('info-modal-message').textContent = message;

        modal.classList.remove('hidden');
        setTimeout(() => content.classList.remove('scale-95', 'opacity-0'), 10);

        const close = () => {
            content.classList.add('scale-95', 'opacity-0');
            setTimeout(() => modal.classList.add('hidden'), 200);
        };

        document.getElementById('info-modal-ok-btn').onclick = close;
        document.getElementById('info-modal-overlay').onclick = close;
    }


    function populateAndShowViewCardModal(cardId) {
        const task = cardDataStore.get(cardId);
        if (!task) return;

        // Poblar título
        const titleContainer = document.getElementById('view-card-title-container');
        titleContainer.innerHTML = `<h2 class="text-2xl font-bold text-gray-800">${task.title}</h2>`;

        // Poblar adjunto
        const attachmentContainer = document.getElementById('view-card-attachment-container');
        attachmentContainer.innerHTML = task.attachment ? `<img src="${task.attachment}" class="w-full rounded-lg shadow-md">` : '';

        // Poblar descripción
        const descriptionContainer = document.getElementById('view-card-description-container');
        descriptionContainer.innerHTML = `<h4 class="text-sm font-semibold text-gray-600 mb-2">Descripción</h4><div class="prose prose-sm max-w-none trix-preview">${task.description || '<p class="text-gray-400">Sin descripción.</p>'}</div>`;

        // Poblar fecha de vencimiento
        const dueDateContainer = document.getElementById('view-card-due-date-container');
        dueDateContainer.innerHTML = `<h4 class="text-sm font-semibold text-gray-600 mb-2">Fecha de Vencimiento</h4><p>${task.dueDate ? new Date(task.dueDate + 'T00:00:00').toLocaleDateString("es-ES") : 'No establecida'}</p>`;
        
        // Poblar asignados
        const assigneesContainer = document.getElementById('view-card-assignees-container');
        let assigneesHtml = '<h4 class="text-sm font-semibold text-gray-600 mb-2">Asignado a</h4>';
        if (task.assignedTo && task.assignedTo.length > 0) {
            assigneesHtml += `<div class="flex items-center space-x-2">${task.assignedTo.map(email => `<div class="assigned-avatar ${getUserColor(email).bg} ${getUserColor(email).text}" title="${email}">${email.substring(0, 2).toUpperCase()}</div>`).join('')}</div>`;
        } else {
            assigneesHtml += '<p class="text-gray-400">Nadie asignado.</p>';
        }
        assigneesContainer.innerHTML = assigneesHtml;

        // Poblar etiquetas
        const tagsContainer = document.getElementById('view-card-tags-container');
        let tagsHtml = '<h4 class="text-sm font-semibold text-gray-600 mb-2">Etiquetas</h4>';
        if (task.tags && task.tags.length > 0) {
            tagsHtml += `<div class="flex flex-wrap gap-2">${task.tags.map(tag => `<span class="px-2 py-0.5 text-xs font-medium rounded-full ${TAGS_CONFIG[tag.text]?.color || 'bg-gray-200'}">${tag.text}</span>`).join('')}</div>`;
        } else {
            tagsHtml += '<p class="text-gray-400">Sin etiquetas.</p>';
        }
        tagsContainer.innerHTML = tagsHtml;
        
        // Poblar checklist
        const checklistContainer = document.getElementById('view-card-checklist-container');
        let checklistHtml = '<h4 class="text-sm font-semibold text-gray-600 mb-2">Checklist</h4>';
        if (task.checklist && task.checklist.length > 0) {
            checklistHtml += '<ul class="space-y-2">';
            task.checklist.forEach(item => {
                checklistHtml += `<li class="flex items-center"><input type="checkbox" class="h-4 w-4 rounded border-gray-300" ${item.completed ? 'checked' : ''} disabled><span class="ml-2 text-sm ${item.completed ? 'line-through text-gray-500' : ''}">${item.text}</span></li>`;
            });
            checklistHtml += '</ul>';
        } else {
            checklistHtml += '<p class="text-gray-400">Sin checklist.</p>';
        }
        checklistContainer.innerHTML = checklistHtml;

        // Poblar comentarios
        const commentsContainer = document.getElementById('view-card-comments-container');
        let commentsHtml = '<h4 class="text-sm font-semibold text-gray-600 mb-2">Comentarios</h4>';
        if (task.comments && task.comments.length > 0) {
            commentsHtml += '<ul class="space-y-3">';
            task.comments.sort((a,b) => b.timestamp - a.timestamp).forEach(comment => {
                commentsHtml += `<li class="p-3 bg-gray-50 rounded-md"><p class="text-sm text-gray-800">${comment.text}</p><p class="text-xs text-gray-400 mt-1">${new Date(comment.timestamp).toLocaleString()}</p></li>`;
            });
            commentsHtml += '</ul>';
        } else {
            commentsHtml += '<p class="text-gray-400">Sin comentarios.</p>';
        }
        commentsContainer.innerHTML = commentsHtml;
        
        // Abrir el drawer
        openDrawer(document.getElementById('view-card-overlay'), document.getElementById('view-card-content'));
    }

    function renderAllCards() {
        const tasksByColumn = new Map();
        columnsConfig.forEach(col => tasksByColumn.set(col.id, []));
        
        cardDataStore.forEach(task => {
            if (tasksByColumn.has(task.columnId)) {
                tasksByColumn.get(task.columnId).push(task);
            }
        });

        tasksByColumn.forEach((tasks, columnId) => {
            const columnContent = document.querySelector(`#${columnId} .kanban-column-content`);
            if (columnContent) {
                columnContent.innerHTML = '';
                tasks.sort((a, b) => a.order - b.order);
                tasks.forEach(task => {
                    const now = new Date();
                    
                    if (task.TimeBoxing && task.TimeBoxing.isActive) {
                        const startTime = new Date(task.TimeBoxing.startDateTime);
                        const endTime = new Date(task.TimeBoxing.endDateTime);
                        
                        if (startTime <= now && endTime > now) {
                            columnContent.appendChild(createTimeBoxingCard(task));
                        } else if (startTime > now) {
                            columnContent.appendChild(createScheduledTimeBoxingCard(task));
                        } else {
                            columnContent.appendChild(createCardElement(task));
                        }
                    } else {
                        columnContent.appendChild(createCardElement(task));
                    }
                });
            }
        });
        
        applyFilters();
    }
    
    function renderEisenhowerMatrix() {
        document.querySelectorAll('.eisenhower-tasks').forEach(quadrant => quadrant.innerHTML = '');

        const allCards = Array.from(cardDataStore.values());
        
        allCards.forEach(task => {
            const tags = task.tags?.map(t => t.text) || [];
            
            let quadrantId = null;
            const hasUrgente = tags.includes('Urgente');
            const hasNoUrgente = tags.includes('No Urgente');
            const hasImportante = tags.includes('Importante');
            const hasNoImportante = tags.includes('No Importante');
            
            if (hasUrgente && hasImportante) {
                quadrantId = 'do';
            } else if (hasNoUrgente && hasImportante) {
                quadrantId = 'plan';
            } else if (hasUrgente && hasNoImportante) {
                quadrantId = 'delegate';
            } else if (hasNoUrgente && hasNoImportante) {
                quadrantId = 'eliminate';
            }

            if (quadrantId) {
                const quadrant = document.querySelector(`#eisenhower-${quadrantId} .eisenhower-tasks`);
                if (quadrant) {
                    const cardEl = document.createElement('div');
                    cardEl.className = 'eisenhower-card';
                    cardEl.id = task.id;
                    cardEl.draggable = true;
                    
                    // Mostrar fecha si existe
                    let dueDateHtml = '';
                    if (task.dueDate) {
                        const dueDate = new Date(task.dueDate + 'T00:00:00');
                        const today = new Date();
                        dueDate.setHours(0, 0, 0, 0);
                        today.setHours(0, 0, 0, 0);
                        const diffInDays = Math.round((dueDate.getTime() - today.getTime()) / (1000 * 60 * 60 * 24));
                        
                        let dateColor = 'text-gray-500';
                        if (diffInDays < 0) dateColor = 'text-red-600';
                        else if (diffInDays === 0) dateColor = 'text-orange-500';
                        else if (diffInDays === 1) dateColor = 'text-yellow-600';
                        
                        dueDateHtml = `<div class="flex items-center gap-1 mt-2"><svg class="w-3 h-3 ${dateColor}" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg><span class="text-xs ${dateColor}">${dueDate.toLocaleDateString('es-ES')}</span></div>`;
                    }
                    
                    const tagListHtml = tags.length > 0 ? `<div class="flex flex-wrap gap-1 mt-2">${tags.map(tag => `<span class="px-2 py-0.5 text-xs font-medium rounded-full ${TAGS_CONFIG[tag]?.color || 'bg-gray-200 text-gray-800'}">${tag}</span>`).join('')}</div>` : '';
                    
                    cardEl.innerHTML = `
                        <div class="font-semibold text-gray-800">${task.title}</div>
                        ${dueDateHtml}
                        ${tagListHtml}
                    `;
                    cardEl.title = task.title;
                    cardEl.addEventListener('click', () => openCardDrawer(task.id));

                    cardEl.addEventListener('dragstart', (e) => {
                        e.stopPropagation();
                        draggedCardForMatrix = cardEl;
                        draggedCardData = task;
                        setTimeout(() => cardEl.classList.add('opacity-50'), 0);
                    });
                    
                    quadrant.appendChild(cardEl);
                }
            }
        });
    }


    let currentChatMode = 'board';
    let currentGeneralConvId = null;

    // DOM Elements
    const chatBox = document.getElementById('chat-box');
    const chatHeader = document.getElementById('chat-header');
    const chatToggleIcon = document.getElementById('chat-toggle-icon');
    const chatModeSelector = document.getElementById('chat-mode-selector');
    const chatModeBoardBtn = document.getElementById('chat-mode-board');
    const chatModeGeneralBtn = document.getElementById('chat-mode-general');
    const boardChatView = document.getElementById('board-chat-view');
    const generalChatView = document.getElementById('general-chat-view');
    const chatMessages = document.getElementById('chat-messages');
    const chatForm = document.getElementById('chat-form');
    const chatInput = document.getElementById('chat-input');

    // --- Lógica del Chat del Tablero ---

    async function loadBoardChatHistory(boardId) {
        try {
            const res = await fetch(`${API_BASE_URL}/boards/${boardId}/chat`, {
                headers: { 'ngrok-skip-browser-warning': 'true' }
            });
            const data = await res.json();
            if (data.success) {
                renderBoardChatMessages(data.messages || []);
            }
        } catch (err) {
            console.error('Error cargando historial de chat:', err);
        }
    }

    chatModeBoardBtn.addEventListener('click', () => switchChatMode('board'));
    chatModeGeneralBtn.addEventListener('click', () => switchChatMode('general'));

    async function fetchChatHistory(boardId) {
        try {
            // --- INICIO DE LA CORRECCIÓN CLAVE ---
            // Añadimos el email del usuario a la petición
            const response = await fetch(`${API_BASE_URL}/boards/${boardId}/chat?email=${encodeURIComponent(currentUser.email)}`, {
                headers: { 'ngrok-skip-browser-warning': 'true' }
            });
            // --- FIN DE LA CORRECCIÓN CLAVE ---
            const data = await response.json();
            if (data.success) {
                renderBoardChatMessages(data.messages || []);
            } else {
                 document.getElementById('chat-messages').innerHTML = `<div class="text-center text-red-500 text-sm p-4">Error: ${data.message}</div>`;
            }
        } catch (error) {
            console.error("Error cargando historial de chat del tablero:", error);
            document.getElementById('chat-messages').innerHTML = '<div class="text-center text-red-500 text-sm p-4">Error de conexión al cargar el historial.</div>';
        }
    }

    // 3. Reemplaza la función de renderizado con esta versión mejorada
    function renderBoardChatMessages(messages) {
        // Apunta al contenedor correcto con el ID 'chat-messages'
        const container = document.getElementById('chat-messages');
        if (!container) return;
        
        container.innerHTML = '';
        let lastSenderEmail = null;
        
        messages.forEach(msg => {
            const isGrouped = msg.user_email === lastSenderEmail;
            appendBoardChatMessage(msg, isGrouped); // Reutiliza la función de renderizado de burbujas
            lastSenderEmail = msg.user_email;
        });
        
        // Hacer scroll hasta el final
        container.scrollTop = container.scrollHeight;
    }


    function sendBoardChatMessage() {
        const input = document.getElementById('board-chat-input');
        if (!input || !input.value.trim() || !currentBoardId) return;

        const payload = {
            board_id: currentBoardId,
            user_email: currentUser.email,
            // --- INICIO DE LA CORRECCIÓN ---
            // Añadimos el nombre del usuario al paquete de datos que enviamos
            user_name: `${currentUser.first_name || ''} ${currentUser.last_name || ''}`.trim() || currentUser.email,
            // --- FIN DE LA CORRECCIÓN ---
            message: input.value.trim()
        };

        // Muestra el mensaje en tu propia pantalla inmediatamente
        appendBoardChatMessage(payload); 
        
        // Envía el mensaje al servidor para que lo guarde y lo retransmita a otros
        socket.emit('new_chat_message', payload);
        
        input.value = '';
        input.focus();
    }

    socket.on('chat_message', (msg) => {
        // Solo pintar si corresponde a este tablero
        if (String(msg.board_id) !== String(currentBoardId)) return;

        const list = document.getElementById('board-chat-messages'); // <-- ajusta a tu ID real
        if (!list) return;

        const item = document.createElement('div');
        item.className = 'py-1 text-sm';
        const who = (msg.user_name || msg.user_email || '').trim();
        const when = (msg.timestamp || '').replace('T', ' ').split('.')[0];
        item.textContent = `[${when}] ${who}: ${msg.message}`;
        list.appendChild(item);
        list.scrollTop = list.scrollHeight;
    });

    function updateAssistantDisplay() {
        if (availableAssistants.length === 0) return;
        
        const assistant = availableAssistants[currentAssistantIndex];
        
        // Actualizar UI
        document.getElementById('ai-chat-avatar').src = assistant.avatar_url;
        document.getElementById('ai-chat-title').textContent = assistant.name;
        document.getElementById('ai-chat-input-active').placeholder = `Pregúntale a ${assistant.name.split(' ')[0]}...`;

        // Cargar y mostrar historial
        const messagesContainer = document.getElementById('ai-chat-messages-container');
        aiMessages = messagesContainer; // Reasignar variable global
        messagesContainer.innerHTML = '';
        
        if (!chatHistories[assistant.id]) {
            const greeting = { sender: 'from-ai', content: `<div class="ai-chat-bubble">¡Hola! Soy ${assistant.name}. ¿En qué puedo ayudarte?</div>` };
            chatHistories[assistant.id] = [greeting];
        }
        
        chatHistories[assistant.id].forEach(msg => appendAiChatMessage(msg.sender, msg.content, false));
        setTimeout(() => { if(aiMessages) aiMessages.scrollTop = aiMessages.scrollHeight; }, 50);
    }

    // AÑADE estos listeners para los botones de navegación de asistentes
    document.getElementById('ai-chat-prev-btn').addEventListener('click', () => {
        if (availableAssistants.length > 0) {
            currentAssistantIndex = (currentAssistantIndex - 1 + availableAssistants.length) % availableAssistants.length;
            updateAssistantDisplay();
        }
    });

    document.getElementById('ai-chat-next-btn').addEventListener('click', () => {
        if (availableAssistants.length > 0) {
            currentAssistantIndex = (currentAssistantIndex + 1) % availableAssistants.length;
            updateAssistantDisplay();
        }
    });

    function setupChatUI(isShared) {
        const chatContainer = document.getElementById('collaborative-chat-container');
        chatContainer.classList.remove('hidden');

        // --- CORRECCIÓN ---
        // Se restaura la lógica original: las pestañas solo aparecen si el tablero es compartido.
        if (isShared) {
            // En tableros compartidos, se muestran ambas pestañas.
            chatModeSelector.classList.remove('hidden');
            switchChatMode('board'); // Inicia en "Chat Grupal"
        } else {
            // En tableros no compartidos, se ocultan las pestañas y solo se muestra el chat personal.
            chatModeSelector.classList.add('hidden');
            switchChatMode('general');
        }
    }

    function assistantDirectoryItemTemplate(assistant) {
        return `
            <div class="assistant-list-item flex items-center p-3 border-b border-gray-100 cursor-pointer hover:bg-gray-50" data-assistant-id="${assistant.id}">
                <img src="${assistant.avatar_url}" alt="${assistant.name}" class="w-12 h-12 rounded-full mr-4 object-cover">
                <div class="flex-grow min-w-0">
                    <div class="font-semibold text-gray-800 truncate">${assistant.name}</div>
                    <p class="text-sm text-gray-500 truncate">${assistant.description || 'Asistente de IA'}</p>
                </div>
            </div>
        `;
    }

    function renderUserDirectory(users) {
        const userDirContainer = document.getElementById('user-directory-container');
        userDirContainer.innerHTML = `
            <div class="flex-shrink-0 p-3 border-b">
                <input type="text" id="user-directory-search" class="chat-input-field" placeholder="Buscar usuario por nombre o email...">
            </div>
            <div id="user-directory-list" class="flex-grow overflow-y-auto">
                ${users.map(user => userDirectoryItemTemplate(user)).join('')}
            </div>
        `;

        document.getElementById('user-directory-search').addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase();
            document.querySelectorAll('.user-directory-item').forEach(item => {
                const name = item.dataset.name.toLowerCase();
                const email = item.dataset.email.toLowerCase();
                item.style.display = (name.includes(query) || email.includes(query)) ? 'flex' : 'none';
            });
        });
    }

    function userDirectoryItemTemplate(user) {
        const fullName = `${user.first_name} ${user.last_name}`;
        const initials = (fullName).split(' ').map(n => n[0]).join('').substring(0, 2);
        return `
            <div class="user-directory-item" data-name="${fullName}" data-email="${user.email}">
                <div class="chat-avatar ${getUserColor(user.email).bg} mr-3">${initials}</div>
                <div class="flex-grow">
                    <div class="font-semibold text-gray-800 text-sm">${fullName}</div>
                    <div class="text-xs text-gray-500">${user.email}</div>
                </div>
            </div>
        `;
    }


    // Listener para la lista de conversaciones
    generalChatView.addEventListener('click', (e) => {
        const convItem = e.target.closest('.conversation-list-item');
        if (convItem) {
            const peerEmail = convItem.dataset.email;
            if (peerEmail) {
                socket.emit('global_chat_start', { email: currentUser.email, partner_email: peerEmail });
            }
        }
    });




    function renderAssistantsList(assistants) {
      const container = document.getElementById('ai-directory-container');
      const conv = document.getElementById('ai-conversation-container');

      container.innerHTML = '';

      assistants.forEach(assistant => {
        const btn = document.createElement('button');
        btn.className = "flex items-center gap-3 p-3 border-b hover:bg-gray-50 transition text-left";
        btn.innerHTML = `
          <div class="flex flex-col">
            <span class="font-medium">${assistant.name}</span>
            <span class="text-xs text-gray-500">${assistant.description || ''}</span>
          </div>
        `;
        btn.onclick = () => {
          container.classList.add('hidden');
          conv.classList.remove('hidden');
          conv.classList.add('flex');
          conv.innerHTML = `
            <div class="flex items-center gap-3 p-3 bg-white border-b">
              <button class="p-1 rounded-full" id="back-to-ai">&larr;</button>
              <div class="font-semibold">${assistant.name}</div>
            </div>
            <div id="ai-conversation-messages" class="flex-1 overflow-y-auto p-4"></div>
            <form id="ai-conversation-form" class="flex items-center gap-2 p-3 border-t">
              <input type="text" id="ai-conversation-input" class="chat-input-field flex-1" placeholder="Escribe un mensaje...">
              <button type="submit" class="chat-send-btn">Enviar</button>
            </form>
          `;

          document.getElementById('back-to-ai').onclick = () => {
            conv.classList.add('hidden');
            container.classList.remove('hidden');
          };

          document.getElementById('ai-conversation-form').onsubmit = (e) => {
            e.preventDefault();
            const text = document.getElementById('ai-conversation-input').value.trim();
            if (!text) return;
            socket.emit('assistant_chat_message', { id: assistant.id, text });
            document.getElementById('ai-conversation-input').value = '';
          };
        };
        container.appendChild(btn);
      });
    }


    /* ==================================================================== */
    /* === PASO 2: REEMPLAZA TODA LA LÓGICA DE POMODORO CON ESTE BLOQUE === */
    /* ==================================================================== */

    // ==== INICIO: LÓGICA DE POMODORO (VERSIÓN CON PERSISTENCIA) ====
    const pomodoroBtn = document.getElementById('pomodoro-btn');
    const pomodoroModal = document.getElementById('pomodoro-modal');
    const pomodoroOverlay = document.getElementById('pomodoro-overlay');
    const pomodoroContent = pomodoroModal.querySelector('.transform');
    const pomodoroCloseBtn = document.getElementById('pomodoro-close-btn');
    const pomodoroCancelBtn = document.getElementById('pomodoro-cancel-btn');
    const pomodoroForm = document.getElementById('pomodoro-form');
    const pomodoroTaskNameInput = document.getElementById('pomodoro-task-name');

    const pomodoroWidget = document.getElementById('pomodoro-timer-widget');
    const pomodoroStatusEl = document.getElementById('pomodoro-status');
    const pomodoroTimeEl = document.getElementById('pomodoro-time');
    const pomodoroCloseWidgetBtn = document.getElementById('pomodoro-close-widget-btn');

    let pomodoroSettings = {};
    let currentInterval = 1;
    let isWorkSession = true;
    let pomodoroTimer = null;

    function openPomodoroModal() {
        pomodoroModal.classList.remove('hidden');
        setTimeout(() => pomodoroContent.classList.remove('scale-95', 'opacity-0'), 10);
    }

    function closePomodoroModal() {
        pomodoroContent.classList.add('scale-95', 'opacity-0');
        setTimeout(() => pomodoroModal.classList.add('hidden'), 200);
    }

    function stopPomodoroTimer() {
        clearInterval(pomodoroTimer);
        pomodoroTimer = null;
        pomodoroWidget.classList.add('hidden');
        localStorage.removeItem('pomodoroState');
        console.log('Pomodoro detenido y estado limpiado.');
    }

    function playNotificationSound() {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        oscillator.type = 'sine';
        oscillator.frequency.setValueAtTime(440, audioContext.currentTime);
        gainNode.gain.setValueAtTime(0.5, audioContext.currentTime);
        oscillator.start();
        oscillator.stop(audioContext.currentTime + 0.5);
    }

    function formatTime(ms) {
        const totalSeconds = Math.round(ms / 1000);
        const minutes = Math.floor(totalSeconds / 60).toString().padStart(2, '0');
        const seconds = (totalSeconds % 60).toString().padStart(2, '0');
        return `${minutes}:${seconds}`;
    }

    function startCountdown(durationMinutes, sessionType) {
        clearInterval(pomodoroTimer);
        const endTime = Date.now() + durationMinutes * 60 * 1000;
        
        // Guardar estado en localStorage
        const pomodoroState = {
            settings: pomodoroSettings,
            isRunning: true,
            sessionType: sessionType,
            currentInterval: currentInterval,
            endTime: endTime
        };
        localStorage.setItem('pomodoroState', JSON.stringify(pomodoroState));

        pomodoroTimer = setInterval(() => {
            const timeLeft = endTime - Date.now();
            if (timeLeft <= 0) {
                clearInterval(pomodoroTimer);
                pomodoroTimeEl.textContent = "00:00";
                playNotificationSound();
                advancePomodoroState();
                return;
            }
            pomodoroTimeEl.textContent = formatTime(timeLeft);
        }, 1000);
    }

    function advancePomodoroState() {
        isWorkSession = !isWorkSession;
        if (!isWorkSession) {
            if (currentInterval % pomodoroSettings.intervals === 0) {
                runPomodoroSession(pomodoroSettings.longBreak, 'Descanso Largo', 'long-break');
            } else {
                runPomodoroSession(pomodoroSettings.shortBreak, 'Descanso Corto', 'short-break');
            }
        } else {
            currentInterval++;
            runPomodoroSession(pomodoroSettings.work, `Trabajo #${currentInterval}`, 'work');
        }
    }

    function runPomodoroSession(duration, statusText, sessionType) {
        pomodoroWidget.classList.remove('pomodoro-work', 'pomodoro-short-break', 'pomodoro-long-break');
        const statusDisplay = (sessionType === 'work' && pomodoroSettings.taskName) ? pomodoroSettings.taskName : statusText;
        pomodoroStatusEl.textContent = statusDisplay;

        if (sessionType === 'work') {
            pomodoroWidget.classList.add('pomodoro-work');
        } else if (sessionType === 'short-break') {
            pomodoroWidget.classList.add('pomodoro-short-break');
        } else {
            pomodoroWidget.classList.add('pomodoro-long-break');
        }
        
        startCountdown(duration, sessionType);
    }

    function resumeCountdown(savedState) {
        const timeLeft = savedState.endTime - Date.now();
        if (timeLeft <= 0) {
            localStorage.removeItem('pomodoroState');
            return;
        }
        
        pomodoroSettings = savedState.settings;
        currentInterval = savedState.currentInterval;
        const sessionType = savedState.sessionType;
        isWorkSession = sessionType === 'work';

        const statusMap = {
            'work': pomodoroSettings.taskName || `Trabajo #${currentInterval}`,
            'short-break': 'Descanso Corto',
            'long-break': 'Descanso Largo'
        };

        pomodoroWidget.classList.remove('hidden');
        pomodoroWidget.classList.remove('pomodoro-work', 'pomodoro-short-break', 'pomodoro-long-break');
        pomodoroStatusEl.textContent = statusMap[sessionType];

        if (sessionType === 'work') pomodoroWidget.classList.add('pomodoro-work');
        else if (sessionType === 'short-break') pomodoroWidget.classList.add('pomodoro-short-break');
        else pomodoroWidget.classList.add('pomodoro-long-break');
        
        pomodoroTimeEl.textContent = formatTime(timeLeft);

        pomodoroTimer = setInterval(() => {
            const newTimeLeft = savedState.endTime - Date.now();
            if (newTimeLeft <= 0) {
                clearInterval(pomodoroTimer);
                pomodoroTimeEl.textContent = "00:00";
                playNotificationSound();
                advancePomodoroState();
                return;
            }
            pomodoroTimeEl.textContent = formatTime(newTimeLeft);
        }, 1000);
    }

    // Lógica de inicialización al cargar la página
    function initializePomodoro() {
        const savedState = JSON.parse(localStorage.getItem('pomodoroState'));
        if (savedState && savedState.isRunning && savedState.endTime > Date.now()) {
            console.log('Reanudando sesión de Pomodoro...');
            resumeCountdown(savedState);
        }
    }

    // Event Listeners
    pomodoroBtn.addEventListener('click', openPomodoroModal);
    pomodoroCloseBtn.addEventListener('click', closePomodoroModal);
    pomodoroCancelBtn.addEventListener('click', closePomodoroModal);
    pomodoroOverlay.addEventListener('click', closePomodoroModal);
    pomodoroCloseWidgetBtn.addEventListener('click', stopPomodoroTimer);

    pomodoroForm.addEventListener('submit', (e) => {
        e.preventDefault();
        pomodoroSettings = {
            taskName: pomodoroTaskNameInput.value.trim(),
            work: parseInt(document.getElementById('pomodoro-work-duration').value),
            shortBreak: parseInt(document.getElementById('pomodoro-short-break').value),
            longBreak: parseInt(document.getElementById('pomodoro-long-break').value),
            intervals: parseInt(document.getElementById('pomodoro-intervals').value)
        };
        
        currentInterval = 1;
        isWorkSession = true;
        
        closePomodoroModal();
        pomodoroWidget.classList.remove('hidden');
        runPomodoroSession(pomodoroSettings.work, `Trabajo #${currentInterval}`, 'work');
    });

    // Ejecutar al cargar el DOM
    initializePomodoro();
    // ==== FIN: LÓGICA DE POMODORO ====



    function appendBoardChatMessage(msg) {
        const container = document.getElementById('chat-messages');
        if (!container) {
            console.error("Error crítico: No se encontró el contenedor de mensajes #chat-messages.");
            return;
        }

        // Determina si el mensaje es del usuario actual
        const isMe = msg.user_email === currentUser.email;
        
        // Comprueba el último mensaje para agrupar burbujas
        const lastMessageEl = container.querySelector('.chat-message-wrapper:last-child');
        const lastSenderEmail = lastMessageEl ? lastMessageEl.dataset.email : null;
        const isGrouped = msg.user_email === lastSenderEmail;

        const wrapper = document.createElement('div');
        wrapper.dataset.email = msg.user_email;
        wrapper.className = `chat-message-wrapper animate__animated animate__fadeInUp animate__faster ${isMe ? 'from-me' : 'from-others'} ${isGrouped ? 'grouped' : ''}`;
        
        const color = getUserColor(msg.user_email);
        const userName = msg.user_name || 'Usuario';
        const initials = userName.split(' ').map(n => n[0]).join('').substring(0, 2);
        
        const isSticker = msg.message && /\.(jpeg|jpg|gif|png|webp)$/i.test(msg.message);
        const messageContent = isSticker 
            ? `<img src="${msg.message}" alt="Sticker" class="max-w-[120px] max-h-[120px] object-contain">`
            : `<div class="chat-bubble">${msg.message}</div>`;

        wrapper.innerHTML = `
            <div class="chat-avatar ${color.bg}" title="${userName}">${initials}</div>
            <div class="chat-content">
                <div class="chat-sender-name">${isMe ? 'Tú' : userName.split(' ')[0]}</div>
                ${messageContent}
            </div>
        `;
        
        container.appendChild(wrapper);
        
        // Forzar el scroll hasta el final para ver el nuevo mensaje
        setTimeout(() => {
            container.scrollTop = container.scrollHeight;
        }, 50);
    }

    function appendGeneralChatMessage(msg, container) {
        if (!container) return;

        // Admite estructuras {text} o {message}
        const rawContent = (msg && (msg.text || msg.message || '')).trim();
        const isSticker = /^data:image\//i.test(rawContent) ||
                          /\.(png|jpe?g|gif|webp|svg)$/i.test(rawContent);

        const lastMessageEl = container.querySelector('.chat-message-wrapper:last-child');
        const lastSenderEmail = lastMessageEl ? lastMessageEl.dataset.email : null;
        const isMe = msg.sender_email === currentUser.email;
        const isGrouped = msg.sender_email === lastSenderEmail;

        // Nombre/Iniciales
        let senderName = 'Desconocido';
        if (isMe) {
            senderName = 'Tú';
        } else {
            const peerConv = conversationsCache.find(c => c.peer_email === msg.sender_email);
            senderName = peerConv ? peerConv.peer_name : (msg.sender_email || 'Usuario');
        }
        const initials = senderName.split(' ').map(n => n[0]).join('').substring(0, 2);

        const wrapper = document.createElement('div');
        wrapper.dataset.email = msg.sender_email;
        wrapper.className = `chat-message-wrapper animate__animated animate__fadeInUp animate__faster ${isMe ? 'from-me' : 'from-others'} ${isGrouped ? 'grouped' : ''}`;

        const bubble = isSticker
            ? `<img src="${rawContent}" alt="Sticker" class="max-w-[120px] max-h-[120px] object-contain">`
            : `<div class="chat-bubble">${rawContent}</div>`;

        wrapper.innerHTML = `
            <div class="chat-avatar ${getUserColor(msg.sender_email).bg}" title="${senderName}">${initials}</div>
            <div class="chat-content">
                <div class="chat-sender-name">${senderName}</div>
                ${bubble}
            </div>
        `;
        container.appendChild(wrapper);
        container.scrollTop = container.scrollHeight;
    }


    function sendMessage(messageContent) {
        const content = (messageContent || '').trim();
        if (!content) return;

        if (currentChatMode === 'board') {
            const payload = {
                board_id: currentBoardId,
                user_email: currentUser.email,
                user_name: `${currentUser.first_name || ''} ${currentUser.last_name || ''}`.trim(),
                message: content
            };
            appendBoardChatMessage(payload);
            socket.emit('new_chat_message', payload);

        } else if (currentChatMode === 'general') {
            const peerEmail = document.getElementById('conversation-view-container').dataset.peerEmail;
            if (!peerEmail) return;

            const payload = {
                sender_email: currentUser.email,
                receiver_email: peerEmail,
                text: content,
                sender_name: `${currentUser.first_name || ''} ${currentUser.last_name || ''}`.trim()
            };
            
            socket.emit('global_chat_send', payload);
        }
    }


    function conversationListItemTemplate(conv) {
        const initials = (conv.peer_name || 'NN').split(' ').map(n=>n[0]).join('').substring(0,2);
        const color = getUserColor(conv.peer_email).bg;
        const lastTs = conv.last_ts ? new Date(conv.last_ts).toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' }) : '';
        
        const unreadBadge = conv.unread_count > 0 
            ? `<span class="flex h-5 min-w-[20px] items-center justify-center rounded-full bg-red-600 px-1.5 text-xs font-bold text-white">${conv.unread_count}</span>` 
            : '';

        return `
            <div class="group relative conversation-list-item" data-conv-id="${conv.conv_id}" data-email="${conv.peer_email}" data-name="${conv.peer_name}">
                <div class="chat-avatar ${color} mr-3">${initials}</div>
                <div class="flex-grow min-w-0">
                    <div class="font-semibold text-gray-800 text-sm truncate">${conv.peer_name}</div>
                    <div class="text-xs text-gray-500 truncate">${conv.peer_email}</div>
                </div>
                <div class="flex flex-col items-end gap-1">
                    <div class="text-xs text-gray-400 self-start">${lastTs}</div>
                    ${unreadBadge}
                </div>
                
                <div class="absolute top-1 right-1 flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                    <button class="delete-conversation-btn p-1.5 rounded-full hover:bg-red-100 text-red-600" title="Eliminar chat" data-conv-id="${conv.conv_id}">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>
                    </button>
                </div>
            </div>
        `;
    }


    function renderGeneralChatConversation(data) {
        currentGeneralConvId = data.conv_id;
        const userDir = document.getElementById('user-directory-container');
        const convView = document.getElementById('conversation-view-container');
        userDir.classList.add('hidden');
        convView.classList.remove('hidden');
        convView.classList.add('flex');
        convView.dataset.peerEmail = data.peer_email;

        convView.innerHTML = `
            <div id="conversation-header" class="flex items-center justify-between gap-3 p-3 bg-gray-50 border-b">
                <div class="flex items-center gap-3">
                     <button id="back-to-directory-btn" class="p-1 rounded-full hover:bg-gray-200">&larr;</button>
                     <div class="font-semibold text-sm">${data.peer_name}</div>
                </div>
                <div class="flex items-center gap-2">
                    <button id="clear-active-conversation-btn" class="p-1.5 rounded-full hover:bg-yellow-100 text-yellow-600" title="Vaciar chat" data-conv-id="${data.conv_id}">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                    </button>
                    <button id="delete-active-conversation-btn" class="p-1.5 rounded-full hover:bg-red-100 text-red-600" title="Eliminar chat" data-conv-id="${data.conv_id}">
                         <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>
                    </button>
                </div>
            </div>
            <div id="general-chat-messages" class="flex-grow p-4 overflow-y-auto flex flex-col gap-2"></div>
            <div class="flex-shrink-0 p-3 border-t">
                <form id="general-chat-form" class="flex items-center gap-2">
                    <input type="text" id="general-chat-input" placeholder="Escribe un mensaje..." class="chat-input-field" autocomplete="off">
                    <button type="submit" class="chat-send-btn">
                        <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>
                    </button>
                </form>
            </div>
        `;

        const messagesContainer = document.getElementById('general-chat-messages');
        (data.messages || []).forEach(msg => appendGeneralChatMessage(msg, messagesContainer));
        messagesContainer.scrollTop = messagesContainer.scrollHeight;

        document.getElementById('back-to-directory-btn').onclick = () => {
            convView.classList.add('hidden');
            userDir.classList.remove('hidden');
            currentGeneralConvId = null;
            socket.emit('global_chat_list_conversations', { email: currentUser.email });
        };

        document.getElementById('general-chat-form').onsubmit = (e) => {
            e.preventDefault();
            const input = document.getElementById('general-chat-input');
            if (input.value.trim()) {
                sendMessage(input.value);
                input.value = '';
            }
        };
        
        document.getElementById('clear-active-conversation-btn').onclick = (e) => handleClearConversation(e.currentTarget.dataset.convId);
        document.getElementById('delete-active-conversation-btn').onclick = (e) => handleDeleteConversation(e.currentTarget.dataset.convId, true);
        
        socket.emit('mark_general_chat_read', { conv_id: data.conv_id, user_email: currentUser.email });
    }

    socket.on('global_chat_new_message', (data) => {
        if (currentGeneralConvId === data.conv_id) {
            const container = document.getElementById('general-chat-messages');
            if (container) {
                appendGeneralChatMessage(data, container);
                if (data.sender_email !== currentUser.email && document.visibilityState === 'visible') {
                    socket.emit('mark_general_chat_read', { conv_id: data.conv_id, user_email: currentUser.email });
                }
            }
        }
        socket.emit('global_chat_list_conversations', { email: currentUser.email });
    });

    async function handleDeleteConversation(convId, isActiveConversation = false) {
        const confirmed = await showGenericConfirmModal(
            'Eliminar Chat',
            '¿Estás seguro? Se borrará permanentemente toda la conversación para ambos participantes.'
        );
        if (confirmed) {
            console.log(`Emitiendo 'global_chat_delete_conversation' para ${convId}`);
            socket.emit('global_chat_delete_conversation', {
                conv_id: convId,
                user_email: currentUser.email
            });
            // Si es la conversación activa, volvemos a la lista principal de chats
            if (isActiveConversation) {
                document.getElementById('back-to-directory-btn').click();
            }
        }
    }

    // Función para manejar el vaciado de una conversación
    async function handleClearConversation(convId) {
        const confirmed = await showGenericConfirmModal(
            'Vaciar Chat',
            'Se borrarán todos los mensajes de esta conversación. El chat permanecerá en tu lista.'
        );
        if (confirmed) {
            console.log(`Emitiendo 'global_chat_clear_conversation' para ${convId}`);
            socket.emit('global_chat_clear_conversation', {
                conv_id: convId,
                user_email: currentUser.email
            });
        }
    }

    // Listener de eventos unificado para el panel de chats personales
    generalChatView.addEventListener('click', (e) => {
        // Botón para eliminar un chat de la lista
        const deleteBtn = e.target.closest('.delete-conversation-btn');
        if (deleteBtn) {
            e.stopPropagation();
            handleDeleteConversation(deleteBtn.dataset.convId);
            return;
        }
        
        // Botón para vaciar un chat de la lista
        const clearBtn = e.target.closest('.clear-conversation-btn');
        if (clearBtn) {
            e.stopPropagation();
            handleClearConversation(clearBtn.dataset.convId);
            return;
        }
        
        // Clic en un item de la lista para abrir la conversación
        const convItem = e.target.closest('.conversation-list-item');
        if (convItem) {
            const peerEmail = convItem.dataset.email;
            if (peerEmail) {
                socket.emit('global_chat_start', { email: currentUser.email, partner_email: peerEmail });
            }
        }
    });

    // Listener para cuando el servidor confirma la eliminación del chat
    socket.on('conversation_deleted', (data) => {
        console.log(`Recibido 'conversation_deleted' para ${data.conv_id}, actualizando lista.`);
        // Refrescamos la lista de conversaciones para que desaparezca la eliminada
        socket.emit('global_chat_list_conversations', { email: currentUser.email });
    });

    // Listener para cuando el servidor confirma el vaciado del chat
    socket.on('conversation_cleared', (data) => {
        console.log(`Recibido 'conversation_cleared' para ${data.conv_id}, actualizando UI.`);
        // Si la conversación vaciada es la que está abierta, vaciamos los mensajes en la pantalla
        if (currentGeneralConvId === data.conv_id) {
            const messagesContainer = document.getElementById('general-chat-messages');
            if (messagesContainer) {
                messagesContainer.innerHTML = '';
            }
        }
        // Y siempre refrescamos la lista para actualizar el "último mensaje"
        socket.emit('global_chat_list_conversations', { email: currentUser.email });
    });

    // Socket Listeners for General Chat
    socket.on('global_chat_history', (data) => {
        renderGeneralChatConversation(data);
    });



    // General Chat Toggle
    chatHeader.addEventListener('click', () => {
        chatBox.classList.toggle('h-12');
        chatBox.classList.toggle('h-[500px]');
        chatToggleIcon.classList.toggle('rotate-180');
        if (!chatBox.classList.contains('h-12')) {
            setTimeout(() => {
                const activeMessages = document.querySelector('.chat-view.active > div:first-of-type');
                if(activeMessages) activeMessages.scrollTop = activeMessages.scrollHeight;
            }, 300);
        }
    });


    let draggedCardForMatrix = null;
    let draggedCardData = null;
    let notesCache = []; // Cache for notes to avoid constant fetching


    document.querySelectorAll('.eisenhower-quadrant').forEach(quadrant => {
        quadrant.addEventListener('dragover', (e) => {
            e.preventDefault();
            quadrant.classList.add('bg-gray-200/50');
        });

        quadrant.addEventListener('dragleave', () => {
            quadrant.classList.remove('bg-gray-200/50');
        });
        
        quadrant.addEventListener('drop', (e) => {
            e.preventDefault();
            quadrant.classList.remove('bg-gray-200/50');

            if (!draggedCardForMatrix || !draggedCardData) return;
            
            const targetQuadrantId = quadrant.dataset.quadrant;

            // 1. Actualizar las etiquetas de la tarjeta
            const newTags = [];
            if (targetQuadrantId === 'do') {
                newTags.push({ text: 'Urgente' }, { text: 'Importante' });
            } else if (targetQuadrantId === 'plan') {
                newTags.push({ text: 'No Urgente' }, { text: 'Importante' });
            } else if (targetQuadrantId === 'delegate') {
                newTags.push({ text: 'Urgente' }, { text: 'No Importante' });
            } else if (targetQuadrantId === 'eliminate') {
                newTags.push({ text: 'No Urgente' }, { text: 'No Importante' });
            }
            
            draggedCardData.tags = newTags;

            // 2. Asignar el cuadrante directamente a la tarjeta
            draggedCardData.eisenhowerQuadrant = targetQuadrantId;

            // 3. Actualizar la UI y el servidor
            renderEisenhowerMatrix();
            renderAllCards();
            scheduleAutoSave();
        });
    });

    document.addEventListener('dragend', () => {
        if (draggedCardForMatrix) {
            draggedCardForMatrix.classList.remove('opacity-50');
        }
        draggedCardForMatrix = null;
        draggedCardData = null;
    });
    
    function getDragAfterCard(container, y) {
        const draggableElements = [...container.querySelectorAll('.kanban-card:not(.dragging-card)')];
        return draggableElements.reduce((closest, child) => {
            const box = child.getBoundingClientRect();
            const offset = y - box.top - box.height / 2;
            if (offset < 0 && offset > closest.offset) {
                return { offset: offset, element: child };
            } else {
                return closest;
            }
        }, { offset: Number.NEGATIVE_INFINITY }).element;
    }

    function getDragAfterColumn(container, x) {
        const draggableElements = [...container.querySelectorAll('.kanban-column:not(.dragging-column)')];
        return draggableElements.reduce((closest, child) => {
            const box = child.getBoundingClientRect();
            const offset = x - box.left - box.width / 2;
            if (offset < 0 && offset > closest.offset) {
                return { offset: offset, element: child };
            } else {
                return closest;
            }
        }, { offset: Number.NEGATIVE_INFINITY }).element;
    }
    

    async function loadAndRenderNotes() {
        // <-- MODIFICACIÓN: Verificación más robusta de currentBoardId -->
        if (currentBoardId === null || currentBoardId === undefined) {
            console.warn("loadAndRenderNotes fue llamado sin un currentBoardId válido. Abortando.");
            document.getElementById('notes-grid').innerHTML = '<p class="text-gray-500">Selecciona un tablero para ver sus notas.</p>';
            return;
        }

        try {
            const response = await fetch(`${API_BASE_URL}/notes?email=${encodeURIComponent(currentUser.email)}&board_id=${currentBoardId}`, {
                headers: { 'ngrok-skip-browser-warning': 'true' }
            });
            if (!response.ok) {
                // Lanza un error con el status para que el bloque catch lo maneje
                throw new Error(`Error del servidor: ${response.status}`);
            }
            const data = await response.json();
            if (data.success) {
                notesCache = data.notes;
                renderNotes();
            } else {
                console.error('Fallo al cargar las notas:', data.message);
                document.getElementById('notes-grid').innerHTML = '<p class="text-gray-500">No se pudieron cargar las notas.</p>';
            }
        } catch (error) {
            // Este bloque ahora capturará el error 400
            console.error('Error de red al cargar notas:', error);
            document.getElementById('notes-grid').innerHTML = `<p class="text-red-500">Error de conexión al cargar notas. (${error.message})</p>`;
        }
    }



    function renderNotes() {
        const notesGrid = document.getElementById('notes-grid');
        notesGrid.innerHTML = ''; // Limpiar notas anteriores

        if (notesCache.length === 0) {
            notesGrid.innerHTML = '<p class="col-span-full text-center text-gray-500 mt-8">Aún no tienes notas. ¡Crea una para empezar!</p>';
            return;
        }
        
        // Ordenar por fecha de actualización, la más reciente primero
        notesCache.sort((a, b) => new Date(b.updated_date) - new Date(a.updated_date));

        notesCache.forEach(note => {
            const noteEl = createNoteElement(note);
            notesGrid.appendChild(noteEl);
        });
    }

    const profileMenuBtn = document.getElementById('profile-menu-btn');
    const profileMenuDropdown = document.getElementById('profile-menu-dropdown');

    if (profileMenuBtn && profileMenuDropdown) {
        // Evento para mostrar/ocultar el menú al hacer clic en el botón de perfil
        profileMenuBtn.addEventListener('click', (e) => {
            e.stopPropagation(); // Evita que el clic se propague al documento y cierre el menú inmediatamente
            profileMenuDropdown.classList.toggle('hidden');
        });

        // Evento para cerrar el menú si se hace clic en cualquier otro lugar de la página
        document.addEventListener('click', (e) => {
            if (!profileMenuDropdown.classList.contains('hidden') && !profileMenuBtn.contains(e.target) && !profileMenuDropdown.contains(e.target)) {
                profileMenuDropdown.classList.add('hidden');
            }
        });
    }

    function createNoteElement(note) {
        const noteEl = document.createElement('div');
        const noteColor = note.color || 'note-yellow'; // Color por defecto
        noteEl.className = `note-card ${noteColor} animate__animated animate__fadeIn cursor-pointer`;
        noteEl.dataset.noteId = note.id;

        const updatedDate = new Date(note.updated_date).toLocaleString('es-ES', {
            day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit'
        });

        // Crear vista previa del contenido con imágenes
        const contentPreview = createNotePreview(note.content || '');

        noteEl.innerHTML = `
            <div class="note-preview">
                <div class="note-content-preview">
                    ${contentPreview}
                </div>
            </div>
            <div class="note-footer">
                <span class="note-timestamp">Guardado: ${updatedDate}</span>
                <div class="note-actions">
                    <button class="note-edit-btn" title="Editar nota">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                        </svg>
                    </button>
                    <button class="note-delete-btn" title="Eliminar nota">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                        </svg>
                    </button>
                </div>
            </div>
        `;

        // Event listeners
        noteEl.addEventListener('click', (e) => {
            if (!e.target.closest('.note-actions')) {
                openNoteModal(note.id);
            }
        });

        noteEl.querySelector('.note-edit-btn').addEventListener('click', (e) => {
            e.stopPropagation();
            openNoteModal(note.id);
        });

        noteEl.querySelector('.note-delete-btn').addEventListener('click', (e) => {
            e.stopPropagation();
            deleteNote(note.id);
        });

        return noteEl;
    }

    async function enhanceTextWithAI(editorElement, mode, button) {
        if (!editorElement || !editorElement.editor) return;

        const originalText = editorElement.editor.getDocument().toString().trim();
        if (!originalText) {
            alert("No hay texto para procesar.");
            return;
        }

        const originalButtonContent = button.innerHTML;
        button.disabled = true;
        button.innerHTML = `
            <svg class="animate-spin h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
            Procesando...
        `;

        // --- INICIO DE LA MODIFICACIÓN ---
        // Se define un 'apiMode' para enviar una instrucción más precisa al backend.
        // Cuando el botón presionado es el de "Corregir Ortografía" (mode === 'fix'),
        // enviamos una instrucción específica para que la IA solo corrija y no reescriba.
        let apiMode = mode;
        if (mode === 'fix') {
            apiMode = 'correct_spelling_only'; 
        }
        // --- FIN DE LA MODIFICACIÓN ---

        try {
            const response = await fetch(`${API_BASE_URL}/ai/enhance-text`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'ngrok-skip-browser-warning': 'true' },
                // Se utiliza la nueva variable 'apiMode' en el cuerpo de la solicitud.
                body: JSON.stringify({ text: originalText, mode: apiMode })
            });
            const data = await response.json();

            if (data.success) {
                editorElement.editor.loadHTML(data.enhancedText);
            } else {
                alert("Error de la IA: " + data.message);
            }
        } catch (error) {
            alert("Error de conexión con el servicio de IA.");
        } finally {
            button.disabled = false;
            button.innerHTML = originalButtonContent;
        }
    }

    function createNotePreview(htmlContent) {
        if (!htmlContent || !htmlContent.trim()) {
            return '<div class="note-empty-state">Nota vacía...</div>';
        }

        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = htmlContent;

        let previewContent = '';
        let imageCount = 0;

        const images = tempDiv.querySelectorAll('img');
        images.forEach((img, index) => {
            if (index === 0) { // Solo mostrar la primera imagen
                previewContent += `
                    <div class="note-preview-image">
                        <img src="${img.src}" alt="Imagen de la nota" style="width: 100%; height: 120px; object-fit: cover; border-radius: 8px; margin-bottom: 12px;">
                    </div>`;
            }
            imageCount++;
            img.remove(); // Quitar la imagen para no duplicarla en el texto
        });

        // --- CORRECCIÓN CLAVE ---
        // Usar el innerHTML restante en lugar de textContent para conservar el formato.
        const textContentHTML = tempDiv.innerHTML.trim();
        if (textContentHTML) {
            // Se añade la clase 'trix-content' para que herede estilos base de Trix.
            previewContent += `<div class="note-preview-text trix-content pointer-events-none">${textContentHTML}</div>`;
        }
        // --- FIN DE LA CORRECCIÓN ---

        if (imageCount > 1) {
            previewContent += `
                <div class="note-image-counter">
                    <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                    +${imageCount - 1} más
                </div>`;
        } else if (imageCount === 1 && !textContentHTML) {
            previewContent += `<div class="note-image-only">Nota con imagen</div>`;
        }

        if (!previewContent) {
            return '<div class="note-empty-state">Nota vacía...</div>';
        }

        return previewContent;
    }


    let currentNoteId = null;
    let selectedImageSize = 'medium'; // Por defecto

    function openNoteModal(noteId) {
        const isCreating = !noteId;
        let note;

        if (isCreating) {
            currentNoteId = 'new-note-' + Date.now();
            note = {
                id: currentNoteId,
                content: '',
                color: 'note-yellow'
            };
        } else {
            note = notesCache.find(n => n.id == noteId);
            if (!note) {
                console.error("No se encontró la nota para editar con ID:", noteId);
                return;
            }
            currentNoteId = noteId;
        }

        const modal = document.getElementById('note-editor-modal');
        const overlay = document.getElementById('note-editor-overlay');
        const content = document.getElementById('note-editor-content');
        const form = document.getElementById('note-editor-form');
        
        form.reset();
        form.querySelector('[name="note_id"]').value = note.id;
        document.getElementById('note-modal-title').textContent = isCreating ? 'Nueva Nota' : 'Editar Nota';
        
        const hiddenInput = document.getElementById('note-content-input');
        const trixEditor = document.querySelector('#note-editor-modal trix-editor');
        hiddenInput.value = note.content || '';
        if (trixEditor.editor) {
            trixEditor.editor.loadHTML(note.content || '');
        }

        const noteColorSwatches = document.getElementById('note-color-swatches');
        noteColorSwatches.innerHTML = '';
        const selectedColor = note.color || 'note-yellow';

        Object.keys(NOTE_COLORS).forEach(colorKey => {
            const swatch = document.createElement('button');
            swatch.type = 'button';
            swatch.className = `w-10 h-10 rounded-lg cursor-pointer border-2 flex items-center justify-center ${NOTE_COLORS[colorKey].bg} ${NOTE_COLORS[colorKey].border}`;
            swatch.dataset.color = colorKey;
            
            if (selectedColor === colorKey) {
                swatch.innerHTML = '<svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>';
                swatch.classList.add('ring-2', 'ring-offset-1', 'ring-orange-500');
            }
            
            // --- INICIO DE LA CORRECCIÓN CLAVE ---
            // Se añade la lógica que faltaba para actualizar la selección de color en la interfaz.
            swatch.addEventListener('click', () => {
                // 1. Busca el botón que está seleccionado actualmente.
                const currentSelected = noteColorSwatches.querySelector('.ring-2');
                if (currentSelected) {
                    // 2. Le quita los estilos de "seleccionado".
                    currentSelected.classList.remove('ring-2', 'ring-offset-1', 'ring-orange-500');
                    currentSelected.innerHTML = ''; // Quita el check de confirmación.
                }
                // 3. Añade los estilos de "seleccionado" al botón que acabas de presionar.
                swatch.classList.add('ring-2', 'ring-offset-1', 'ring-orange-500');
                swatch.innerHTML = '<svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>';
            });
            // --- FIN DE LA CORRECCIÓN CLAVE ---

            noteColorSwatches.appendChild(swatch);
        });
        
        openDrawer(overlay, content);
    }



    // Listeners para el modal de visualización de tarjeta
    document.getElementById('view-card-close-btn').addEventListener('click', () => {
        closeDrawer(document.getElementById('view-card-overlay'), document.getElementById('view-card-content'));
    });
    document.getElementById('view-card-overlay').addEventListener('click', (e) => {
        if (e.target.id === 'view-card-overlay') {
            closeDrawer(document.getElementById('view-card-overlay'), document.getElementById('view-card-content'));
        }
    });



    function checkEditPermissionsAndNotify() {
        // Si el usuario es editor, la función devuelve 'true' y la acción continúa.
        if (currentUserPermissionLevel === 'editor') {
            return true;
        }
        
        // --- INICIO DE LA CORRECCIÓN CLAVE ---
        // Si no es editor, simplemente muestra el modal de error y devuelve 'false'.
        // Se elimina la llamada a `loadBoardData(currentBoardId)` que causaba problemas.
        showInfoModal(
            'Acción no permitida', 
            'No tienes permiso para realizar esta acción. Estás con privilegios de solo vista.'
        );
        // --- FIN DE LA CORRECCIÓN CLAVE ---
        
        return false;
    }



    function openAttendanceModal() {
        attendanceModal.classList.remove('hidden');
        setTimeout(() => {
            attendanceContent.classList.remove('scale-95', 'opacity-0');
        }, 10);

        const filterInput = document.getElementById('attendance-filter-input');
        filterInput.value = '';
        
        socket.emit('get_collaborator_status', { board_id: currentBoardId });

        document.getElementById('attendance-list-online').innerHTML = '<p class="text-sm text-gray-500 text-center py-4">Cargando...</p>';
        document.getElementById('attendance-list-offline').innerHTML = '';
    }

    function closeAttendanceModal() {
        attendanceContent.classList.add('scale-95', 'opacity-0');
        setTimeout(() => {
            attendanceModal.classList.add('hidden');
        }, 200);
    }



    function openCardDrawer(cardId, colIdForNewCard = null) {
        const isCreating = !cardId;
        const completeTaskBtn = document.getElementById('complete-task-btn');

        if (currentUserPermissionLevel === 'editor') {
            let task;
            if (isCreating) {
                cardId = 'card-' + Date.now() + Math.random().toString(36).substr(2, 9);
                task = { 
                    id: cardId, title: '', description: '', 
                    startDate: '', endDate: '', attachment: null, 
                    color: 'bg-white', tags: [], checklist: [], comments: [], 
                    columnId: colIdForNewCard, order: Date.now(), assignedTo: [], 
                    isCompleted: false, allDay: true, startTime: '', endTime: '' 
                };
                cardDataStore.set(cardId, task);
                completeTaskBtn.style.display = 'none';
            } else {
                task = cardDataStore.get(cardId);
                if (!task) return;
                completeTaskBtn.style.display = task.isCompleted ? 'none' : 'block';
            }
            
            currentCardId = cardId;
            addCardForm.reset();
            addCardForm.querySelector('[name="card_id"]').value = task.id;
            document.getElementById('modal-title').textContent = isCreating ? 'Crear Tarjeta' : 'Editar Tarjeta';
            deleteCardBtn.style.display = isCreating ? 'none' : 'block';
            addCardForm.querySelector('[name="title"]').value = task.title || '';
            
            renderTagSelectors(task.tags || []);
            
            addCardForm.querySelector('[name="startDate"]').value = task.startDate || '';
            addCardForm.querySelector('[name="endDate"]').value = task.endDate || '';

            const allDayCheckbox = document.getElementById('card-all-day');
            const timeInputsContainer = document.getElementById('card-time-inputs');
            const startTimeInput = document.getElementById('card-start-time');
            const endTimeInput = document.getElementById('card-end-time');
            
            allDayCheckbox.checked = task.allDay !== false;
            startTimeInput.value = task.startTime || '09:00';
            endTimeInput.value = task.endTime || '10:00';
            timeInputsContainer.classList.toggle('hidden', allDayCheckbox.checked);
            
            allDayCheckbox.onchange = () => timeInputsContainer.classList.toggle('hidden', allDayCheckbox.checked);

            const trixEditorElement = addCardForm.querySelector('trix-editor');
            const hiddenDescriptionInput = document.getElementById('card-description-input');

            const improveCardDescBtn = document.getElementById('ai-improve-card-desc');
            const fixCardSpellBtn = document.getElementById('ai-fix-card-spell');

            if (improveCardDescBtn) {
                improveCardDescBtn.onclick = () => getWritingSuggestionsAI(trixEditorElement);
            }
            
            if (fixCardSpellBtn) {
                fixCardSpellBtn.onclick = (e) => enhanceTextWithAI(trixEditorElement, 'fix', e.currentTarget);
            }

            if (trixEditorElement && hiddenDescriptionInput) {
                const description = task.description || '';
                hiddenDescriptionInput.value = description;
                
                isProgrammaticallyChangingTrix = true;
                if (trixEditorElement.editor) {
                    trixEditorElement.editor.loadHTML(description);
                }
                setTimeout(() => {
                    isProgrammaticallyChangingTrix = false; 
                }, 100);
            }

            updateAttachmentPreview(task.attachment);
            
            const cardColorContainer = document.getElementById('card-color-swatches-container');
            cardColorContainer.innerHTML = '';
            const selectedCardColor = task.color || 'bg-white';
            Object.keys(CARD_PASTEL_COLORS).forEach(colorClass => {
                const swatch = document.createElement('button');
                swatch.type = 'button';
                swatch.className = `w-8 h-8 rounded-md cursor-pointer border-2 flex items-center justify-center ${colorClass} ${CARD_PASTEL_COLORS[colorClass]}`;
                swatch.dataset.color = colorClass;
                if (selectedCardColor === colorClass) {
                    swatch.innerHTML = CHECK_ICON_SVG;
                    swatch.classList.add('ring-2', 'ring-offset-1', 'ring-orange-600');
                }
                swatch.addEventListener('click', () => {
                    cardColorContainer.querySelector('.ring-2')?.classList.remove('ring-2', 'ring-offset-1', 'ring-orange-600');
                    cardColorContainer.querySelector('svg')?.remove();
                    swatch.classList.add('ring-2', 'ring-offset-1', 'ring-orange-600');
                    swatch.innerHTML = CHECK_ICON_SVG;
                });
                cardColorContainer.appendChild(swatch);
            });
            
            // =====> INICIO DE LA CORRECCIÓN <=====
            renderAssigneesInDrawer(task); // Llama a la nueva función para mostrar los asignados.
            // =====> FIN DE LA CORRECCIÓN <=====

            renderChecklist(task);
            renderComments(task);
            initializeTimeBoxingInModal(task);
            openDrawer(addCardOverlay, addCardContent);
            attachRealtimeSaveListeners();

        } else {
            if (isCreating) {
                checkEditPermissionsAndNotify();
                return;
            } else {
                populateAndShowViewCardModal(cardId);
            }
        }
    }


    function renderAssigneesInDrawer(task) {
        const assignmentSection = document.getElementById('assignment-section');
        const container = document.getElementById('card-assignment-container');
        if (!assignmentSection || !container) return;

        const board = boardsData.find(b => b.id === currentBoardId);
        // Solo mostrar la sección si el tablero es compartido
        if (board && board.shared_with && board.shared_with.length > 1) {
            assignmentSection.classList.remove('hidden');
        } else {
            assignmentSection.classList.add('hidden');
            return;
        }
        
        container.innerHTML = '';

        const assignedEmails = task.assignedTo || [];
        assignedEmails.forEach(email => {
            const member = board.shared_with.find(m => m.user_email === email);
            const name = member ? `${member.first_name || ''} ${member.last_name || ''}`.trim() : email;
            const initials = name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
            const color = getUserColor(email);
            
            const avatar = document.createElement('div');
            avatar.className = `assigned-avatar ${color.bg} ${color.text}`;
            avatar.title = name;
            avatar.textContent = initials;
            container.appendChild(avatar);
        });

        const addButton = document.createElement('button');
        addButton.type = 'button';
        addButton.className = 'w-7 h-7 bg-gray-200 text-gray-600 rounded-md flex items-center justify-center hover:bg-gray-300 transition-colors';
        addButton.innerHTML = '<svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M11 3a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0V7h2a1 1 0 100-2h-2V3z" /></svg>';
        addButton.title = 'Asignar o cambiar miembro';
        addButton.addEventListener('click', openAssigneeSelectorModal);
        container.appendChild(addButton);
    }

    function openAssigneeSelectorModal() {
        const modal = document.getElementById('assignee-selector-modal');
        const listContainer = document.getElementById('assignee-selector-list');
        const task = cardDataStore.get(currentCardId);
        const board = boardsData.find(b => b.id === currentBoardId);

        if (!task || !board || !board.shared_with) return;
        
        listContainer.innerHTML = '';
        const currentAssignees = new Set(task.assignedTo || []);

        board.shared_with.forEach(member => {
            const memberName = `${member.first_name || ''} ${member.last_name || ''}`.trim() || member.user_email;
            const initials = memberName.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
            const color = getUserColor(member.user_email);
            const isSelected = currentAssignees.has(member.user_email);

            const item = document.createElement('div');
            item.className = `assignee-selector-item ${isSelected ? 'selected' : ''}`;
            item.dataset.email = member.user_email;
            item.innerHTML = `
                <div class="assigned-avatar-large ${color.bg} ${color.text} mr-3">${initials}</div>
                <div class="flex-grow">
                    <div class="font-semibold text-gray-800">${memberName}</div>
                    <div class="text-xs text-gray-500">${member.user_email}</div>
                </div>
                <div class="check-icon text-orange-600">
                    <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>
                </div>
            `;
            item.addEventListener('click', () => item.classList.toggle('selected'));
            listContainer.appendChild(item);
        });
        
        modal.classList.remove('hidden');
    }


    function closeAssigneeSelectorModal() {
        document.getElementById('assignee-selector-modal').classList.add('hidden');
    }

    // Listeners para el modal de asignación
    document.getElementById('assignee-selector-close-btn').addEventListener('click', closeAssigneeSelectorModal);
    document.getElementById('assignee-selector-cancel-btn').addEventListener('click', closeAssigneeSelectorModal);
    document.getElementById('assignee-selector-overlay').addEventListener('click', closeAssigneeSelectorModal);

    document.getElementById('save-assignees-btn').addEventListener('click', () => {
        const task = cardDataStore.get(currentCardId);
        if (!task) return;

        const selectedEmails = [];
        document.querySelectorAll('#assignee-selector-list .assignee-selector-item.selected').forEach(item => {
            selectedEmails.push(item.dataset.email);
        });

        task.assignedTo = selectedEmails;
        
        // Notificar a usuarios asignados (si la lógica existe en el backend)
        socket.emit('card_assigned', {
            board_id: currentBoardId,
            card_id: task.id,
            card_title: task.title,
            assignees: selectedEmails,
            assigner_name: `${currentUser.first_name || ''} ${currentUser.last_name || ''}`.trim()
        });
        
        renderAssigneesInDrawer(task);
        renderAllCards(); // Para actualizar la vista de la tarjeta en el tablero
        scheduleAutoSave();
        closeAssigneeSelectorModal();
    });
    // =====> FIN DE LAS NUEVAS FUNCIONES <=====


    openParticipantsBtn.addEventListener('click', openAttendanceModal);
    attendanceCloseBtn.addEventListener('click', closeAttendanceModal);
    attendanceOverlay.addEventListener('click', closeAttendanceModal);






    // Socket Listeners
    socket.on('collaborator_status_updated', (data) => {
        currentCollaborators = data.collaborators || [];
        const filterInput = document.getElementById('attendance-filter-input');
        renderAttendanceList(currentCollaborators, filterInput.value);
    });

    socket.on('collaborator_status_change', () => {
        if (!attendanceModal.classList.contains('hidden')) {
            socket.emit('get_collaborator_status', { board_id: currentBoardId });
        }
    });



    // Variable global para almacenar la lista de colaboradores actual
    let currentCollaborators = [];

    function closeNoteModal() {
        const overlay = document.getElementById('note-editor-overlay');
        const content = document.getElementById('note-editor-content');
        closeDrawer(overlay, content);
        currentNoteId = null;
    }



    function createUserAttendanceItem(user) {
        const color = getUserColor(user.email);
        const initials = (user.name || 'NN').split(' ').map(n => n[0]).join('').substring(0, 2);
        const statusDot = user.status === 'online'
            ? '<div class="w-2.5 h-2.5 bg-green-500 rounded-full border-2 border-white absolute bottom-0 right-0"></div>'
            : '<div class="w-2.5 h-2.5 bg-gray-400 rounded-full border-2 border-white absolute bottom-0 right-0"></div>';

        return `
            <div class="flex items-center p-2 rounded-lg hover:bg-gray-50">
                <div class="relative mr-3">
                    <div class="chat-avatar ${color.bg}">${initials}</div>
                    ${statusDot}
                </div>
                <div class="flex-grow min-w-0">
                    <div class="font-semibold text-gray-800 text-sm truncate">${user.name}</div>
                    <div class="text-xs text-gray-500 truncate">${user.email}</div>
                </div>
            </div>
        `;
    }


    function renderAttendanceList(collaborators, filter = '') {
        const onlineList = document.getElementById('attendance-list-online');
        const offlineList = document.getElementById('attendance-list-offline');
        const onlineCount = document.getElementById('attendance-online-count');
        const offlineCount = document.getElementById('attendance-offline-count');

        if (!onlineList || !offlineList || !onlineCount || !offlineCount) return;

        const lowerCaseFilter = filter.toLowerCase();
        const filteredCollaborators = collaborators.filter(user =>
            (user.name || '').toLowerCase().includes(lowerCaseFilter) ||
            (user.email || '').toLowerCase().includes(lowerCaseFilter)
        );

        const onlineUsers = filteredCollaborators.filter(user => user.status === 'online');
        const offlineUsers = filteredCollaborators.filter(user => user.status !== 'online');

        onlineCount.textContent = onlineUsers.length;
        offlineCount.textContent = offlineUsers.length;

        onlineList.innerHTML = onlineUsers.length > 0
            ? onlineUsers.map(createUserAttendanceItem).join('')
            : '<p class="text-xs text-gray-500 px-2 py-4 text-center">Nadie conectado.</p>';

        offlineList.innerHTML = offlineUsers.length > 0
            ? offlineUsers.map(createUserAttendanceItem).join('')
            : '<p class="text-xs text-gray-500 px-2 py-4 text-center">Todos están conectados.</p>';
    }



    async function saveNoteFromModal() {
        const isCreating = String(currentNoteId).startsWith('new-note-');
        
        const trixEditor = document.querySelector('#note-editor-modal trix-editor');
        const content = trixEditor.value;
        const selectedColorSwatch = document.querySelector('#note-color-swatches .ring-2');
        const color = selectedColorSwatch ? selectedColorSwatch.dataset.color : 'note-yellow';

        if (isCreating) {
            // CREACIÓN: Enviamos la nota completa al servidor.
            try {
                const response = await fetch(`${API_BASE_URL}/notes`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'ngrok-skip-browser-warning': 'true' },
                    body: JSON.stringify({
                        email: currentUser.email,
                        board_id: currentBoardId,
                        content: content,
                        color: color
                    })
                });
                const data = await response.json();
                
                // --- INICIO DE LA CORRECCIÓN CLAVE ---
                // Se eliminó el código que añadía la nota aquí.
                // Ahora, el cliente que crea la nota simplemente espera a recibir
                // el evento 'note_created' del servidor, igual que los demás.
                // Esto elimina la condición de carrera y el duplicado.
                if (!data.success) {
                    throw new Error(data.message || 'Error del servidor al crear la nota.');
                }
                // --- FIN DE LA CORRECCIÓN CLAVE ---

            } catch (error) {
                console.error('Error al crear la nueva nota:', error);
                alert('No se pudo guardar la nota.');
            }
        } else {
            // EDICIÓN: Funciona como antes, actualizando una nota existente.
            await updateNoteContent(currentNoteId, content, color);
        }
        
        closeNoteModal();
    }



    async function insertImageFromFile(file, size = selectedImageSize) {
        const trixEditor = document.querySelector('#note-editor-modal trix-editor');
        if (!trixEditor || !trixEditor.editor) return;

        try {
            // Determinar dimensiones según el tamaño seleccionado
            const sizes = {
                small: 200,
                medium: 400,
                large: 600,
                full: 800
            };
            
            const maxWidth = sizes[size] || 400;
            
            // Comprimir imagen
            const compressedDataUrl = await compressImage(file, maxWidth, 0.85);
            
            // Crear elemento img para insertar
            const img = document.createElement('img');
            img.src = compressedDataUrl;
            img.style.maxWidth = '100%';
            img.style.height = 'auto';
            img.style.display = 'block';
            img.style.margin = '10px 0';
            img.style.borderRadius = '8px';
            img.style.boxShadow = '0 2px 8px rgba(0,0,0,0.1)';
            
            // Insertar la imagen usando innerHTML
            const currentPosition = trixEditor.editor.getSelectedRange();
            trixEditor.editor.setSelectedRange(currentPosition);
            trixEditor.editor.insertHTML(img.outerHTML);
            
        } catch (error) {
            console.error('Error insertando imagen:', error);
            alert('Error al insertar la imagen');
        }
    }


    // ===== NUEVO BLOQUE DE CÓDIGO CORRECTO =====
    document.body.addEventListener('click', async (e) => {
        // Maneja el clic en CUALQUIER botón de sticker
        const stickerButton = e.target.closest('#board-sticker-btn, #general-sticker-btn');
        if (stickerButton) {
            currentChatMode = stickerButton.id === 'board-sticker-btn' ? 'board' : 'general';

            if (!Array.isArray(allStickers) || allStickers.length === 0) {
                await ensureStickersLoaded();
            }
            renderStickerPanel();
            showStickerModal();
        }
    });


    // DOM REFERENCES (add these new ones)
    const documentsViewBtn = document.getElementById('documents-view-btn');
    const documentsContainer = document.getElementById('documents-container');
    const addDocumentModal = document.getElementById('add-document-modal');



    // APP STATE (add this new one)
    let documentsCache = [];



    let selectedPdfFile = null;

    function openAddDocumentModal() {
        addDocumentModal.classList.remove('hidden');
        setTimeout(() => {
            addDocumentModal.querySelector('.transform').classList.remove('scale-95', 'opacity-0');
        }, 10);
        
        // --- INICIO DE LA MODIFICACIÓN: Lógica para generar y manejar los colores ---
        const colorSwatchesContainer = document.getElementById('new-doc-cover-colors');
        const previewContainer = document.getElementById('new-doc-cover-preview');
        const hiddenUrlInput = document.getElementById('new-doc-thumbnail-url');
        const hiddenColorInput = document.getElementById('new-doc-cover-color-class');
        
        colorSwatchesContainer.innerHTML = ''; // Limpiar antes de generar

        // Usamos la misma constante de colores que ya tienes definida
        BOARD_PASTEL_COLORS.forEach(colorClass => {
            const swatch = document.createElement('button');
            swatch.type = 'button';
            swatch.className = `w-full h-8 rounded-md cursor-pointer border-2 ${colorClass} border-gray-300`;
            swatch.dataset.color = colorClass;
            
            swatch.addEventListener('click', () => {
                // Limpiar selección anterior
                colorSwatchesContainer.querySelectorAll('button').forEach(b => b.innerHTML = '');
                
                // Marcar el seleccionado
                swatch.innerHTML = '<svg class="w-4 h-4 text-gray-800 mx-auto" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>';
                
                // Actualizar la vista previa
                BOARD_PASTEL_COLORS.forEach(c => previewContainer.classList.remove(c));
                previewContainer.classList.add(colorClass);
                previewContainer.style.backgroundImage = 'none';
                previewContainer.innerHTML = '';
                
                // Limpiar la URL de la imagen y guardar el color seleccionado
                hiddenUrlInput.value = '';
                hiddenColorInput.value = colorClass;
            });
            colorSwatchesContainer.appendChild(swatch);
        });
        // --- FIN DE LA MODIFICACIÓN ---
    }




    function createDocumentElement(doc) {
        const docEl = document.createElement('div');
        docEl.className = 'document-card group';

        docEl.innerHTML = `
            <img src="${doc.thumbnail_url}" alt="Portada de ${doc.title}" class="doc-thumbnail" onerror="this.onerror=null;this.src='https://i.ibb.co/kVPCQPZf/imagen-2025-08-19-012405491.png';">
            
            <div class="action-overlay absolute inset-0 bg-black/60 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center gap-4 z-20">
                
                <button class="open-doc-btn p-2.5 bg-white/90 rounded-full text-gray-800 hover:bg-white hover:scale-110 transition-all" title="Abrir documento" data-doc-id="${doc.id}">
                    <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                      <path d="M11 3a1 1 0 100 2h2.586l-6.293 6.293a1 1 0 101.414 1.414L15 6.414V9a1 1 0 102 0V4a1 1 0 00-1-1h-5z" />
                      <path d="M5 5a2 2 0 00-2 2v8a2 2 0 002 2h8a2 2 0 002-2v-3a1 1 0 10-2 0v3H5V7h3a1 1 0 000-2H5z" />
                    </svg>
                </button>
                <button class="delete-doc-btn" title="Eliminar documento" data-doc-id="${doc.id}">
                    <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" /></svg>
                </button>
            </div>

            <div class="doc-info">
                <h4 class="doc-title">${doc.title}</h4>
                <div class="doc-meta">
                    <span class="doc-meta-item">
                        <svg class="w-3 h-3" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M2 5a2 2 0 012-2h8a2 2 0 012 2v10a2 2 0 01-2 2H4a2 2 0 01-2-2V5zm3.293 2.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                        Ver. ${doc.version || 'N/A'}
                    </span>
                    ${doc.password ? `
                    <span class="doc-meta-item" title="Protegido con contraseña">
                        <svg class="w-3 h-3" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 1a4.5 4.5 0 00-4.5 4.5V9H5a2 2 0 00-2 2v6a2 2 0 002 2h10a2 2 0 002-2v-6a2 2 0 00-2-2h-.5V5.5A4.5 4.5 0 0010 1zm3 8V5.5a3 3 0 10-6 0V9h6z" clip-rule="evenodd" /></svg>
                    </span>` : ''}
                </div>
            </div>
        `;
        
        docEl.addEventListener('click', (e) => {
            if (!e.target.closest('button')) {
                window.open(doc.google_drive_file_id, '_blank');
            }
        });

        return docEl;
    }
    
    // Event listeners for Documents view


    document.getElementById('add-document-btn').addEventListener('click', openAddDocumentModal);
        
    document.getElementById('add-document-close-btn').addEventListener('click', closeAddDocumentModal);
    document.getElementById('add-document-cancel-btn').addEventListener('click', closeAddDocumentModal);
    document.getElementById('add-document-overlay').addEventListener('click', closeAddDocumentModal);
    

    const REAL_API_BASE_URL = 'http://127.0.0.1:8080';

    // Lógica para el modal de cambiar portada
    const changeCoverModal = document.getElementById('change-cover-modal');
    const changeCoverForm = document.getElementById('change-cover-form');

    function closeChangeCoverModal() {
        const content = changeCoverModal.querySelector('.transform');
        content.classList.add('scale-95', 'opacity-0');
        setTimeout(() => {
            changeCoverModal.classList.add('hidden');
            changeCoverForm.reset();
        }, 200);
    }

    document.getElementById('change-cover-close-btn').addEventListener('click', closeChangeCoverModal);
    document.getElementById('change-cover-cancel-btn').addEventListener('click', closeChangeCoverModal);
    document.getElementById('change-cover-overlay').addEventListener('click', closeChangeCoverModal);

    document.getElementById('documents-grid').addEventListener('click', async (e) => {
        const openBtn = e.target.closest('.open-doc-btn');
        const deleteBtn = e.target.closest('.delete-doc-btn');

        if (openBtn) {
            const docId = openBtn.dataset.docId;
            const doc = documentsCache.find(d => d.id == docId);
            if (doc && doc.google_drive_file_id) {
                window.open(doc.google_drive_file_id, '_blank');
            }
        }

        if (deleteBtn) {
            const docId = deleteBtn.dataset.docId;
            const doc = documentsCache.find(d => d.id == docId);
            const confirmed = await showGenericConfirmModal(
                'Eliminar Documento', 
                `¿Estás seguro de que quieres eliminar "${doc.title}"? Esta acción no se puede deshacer.`
            );

            if (confirmed) {
                try {
                    // CORRECCIÓN: Usar la variable API_BASE_URL unificada
                    const response = await fetch(`${API_BASE_URL}/documents/${docId}`, {
                        method: 'DELETE',
                        headers: { 'ngrok-skip-browser-warning': 'true' }
                    });
                    const result = await response.json();
                    if (result.success) {
                        documentsCache = documentsCache.filter(d => d.id != docId);
                        renderDocuments();
                    } else {
                        alert(`Error: ${result.message}`);
                    }
                } catch (error) {
                    alert('Error de conexión al eliminar el documento.');
                }
            }
        }
    });

    function closeAddDocumentModal() {
        const content = addDocumentModal.querySelector('.transform');
        content.classList.add('scale-95', 'opacity-0');
        setTimeout(() => {
            addDocumentModal.classList.add('hidden');
            document.getElementById('add-document-form').reset();
            document.getElementById('pdf-file-name').textContent = 'PDF hasta 10MB';
            
            // --- INICIO DE LA MODIFICACIÓN: Limpiar vista previa y campos ocultos ---
            const previewContainer = document.getElementById('new-doc-cover-preview');
            BOARD_PASTEL_COLORS.forEach(c => previewContainer.classList.remove(c));
            previewContainer.classList.add('bg-gray-100');
            previewContainer.innerHTML = 'Vista previa de la portada';
            document.getElementById('new-doc-thumbnail-url').value = '';
            document.getElementById('new-doc-cover-color-class').value = '';
            // --- FIN DE LA MODIFICACIÓN ---

            selectedPdfFile = null;
        }, 200);
    }

    function displayPexelsImages(photos) {
        pexelsGrid.innerHTML = '';
        if (photos.length === 0) {
            pexelsNoResults.textContent = 'No se encontraron resultados. Intenta con otra búsqueda.';
            pexelsNoResults.classList.remove('hidden');
            return;
        }

        photos.forEach(photo => {
            const imgContainer = document.createElement('div');
            imgContainer.className = 'relative rounded-lg overflow-hidden cursor-pointer group';
            imgContainer.innerHTML = `<img src="${photo.src.portrait}" alt="${photo.alt}" class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-110"><div class="absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-40 transition-all duration-300 flex items-center justify-center"><p class="text-white text-lg font-bold opacity-0 group-hover:opacity-100 transition-opacity">Seleccionar</p></div>`;
            
            imgContainer.addEventListener('click', () => {
                let imageUrl;
                
                // Caso para cambiar la portada de un documento existente
                if (pexelsTarget === 'document_cover') {
                    imageUrl = photo.src.large;
                    const hiddenUrlInput = document.getElementById('doc-cover-url-hidden');
                    const previewContainer = document.getElementById('cover-preview-container');
                    if (hiddenUrlInput && previewContainer) {
                        hiddenUrlInput.value = imageUrl;
                        previewContainer.innerHTML = `<img src="${imageUrl}" class="w-full h-full object-cover rounded-md">`;
                    }
                
                // Caso para añadir una portada a un documento nuevo
                } else if (pexelsTarget === 'new_document_cover') {
                    imageUrl = photo.src.large;
                    const hiddenUrlInput = document.getElementById('new-doc-thumbnail-url');
                    const previewContainer = document.getElementById('new-doc-cover-preview');
                     if (hiddenUrlInput && previewContainer) {
                        hiddenUrlInput.value = imageUrl;
                        previewContainer.innerHTML = `<img src="${imageUrl}" class="w-full h-full object-cover rounded-md">`;
                    }

                // Caso para el fondo de un tablero
                } else if (pexelsTarget === 'board') {
                    imageUrl = photo.src.original || photo.src.large2x || photo.src.large;
                    boardOptions.backgroundUrl = imageUrl;
                    boardOptions.backgroundColorClass = null;
                    applyBoardOptions();
                    scheduleAutoSave();

                // Caso para insertar una imagen en una nota
                } else if (pexelsTarget === 'note') {
                    const imageSizes = {
                        small: photo.src.medium,
                        medium: photo.src.large,
                        large: photo.src.large2x || photo.src.large,
                        full: photo.src.original || photo.src.large2x || photo.src.large
                    };
                    imageUrl = imageSizes[selectedImageSize] || photo.src.large;
                    insertImageFromPexels(imageUrl, selectedImageSize);
                
                // Caso por defecto: adjuntar imagen a una tarjeta
                } else { // pexelsTarget === 'card'
                    imageUrl = photo.src.medium;
                    const task = cardDataStore.get(currentCardId);
                    if (task) {
                        task.attachment = imageUrl; 
                        updateAttachmentPreview(task.attachment);
                    }
                }

                closeDrawer(pexelsOverlay, pexelsContent);
            });

            pexelsGrid.appendChild(imgContainer);
        });
    }



    document.getElementById('add-document-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!selectedPdfFile) {
            alert("Por favor, selecciona un archivo PDF.");
            return;
        }
        
        const submitBtn = document.getElementById('add-document-submit-btn');
        submitBtn.disabled = true;
        submitBtn.textContent = 'Subiendo y Procesando...';
        
        const formData = new FormData();
        formData.append('pdf_file', selectedPdfFile);
        formData.append('title', document.getElementById('doc-title').value);
        formData.append('version', document.getElementById('doc-version').value);
        formData.append('email', currentUser.email);
        formData.append('board_id', currentBoardId);
        
        const password = document.getElementById('new-doc-password').value;
        if (password) {
            formData.append('password', password);
        }
        const thumbnailUrl = document.getElementById('new-doc-thumbnail-url').value;
        if (thumbnailUrl) {
            formData.append('thumbnail_url', thumbnailUrl);
        }
        
        const thumbnailColor = document.getElementById('new-doc-cover-color-class').value;
        if (thumbnailColor) {
            formData.append('thumbnail_color', thumbnailColor);
        }

        try {
            // CORRECCIÓN: Usar la variable API_BASE_URL unificada
            const response = await fetch(`${API_BASE_URL}/documents`, {
                method: 'POST',
                headers: { 'ngrok-skip-browser-warning': 'true' }, // Header para ngrok
                body: formData
            });
            const result = await response.json();
            if (result.success) {
                documentsCache.unshift(result.document);
                renderDocuments();
                closeAddDocumentModal();
            } else {
                alert(`Error: ${result.message}`);
            }
        } catch (error) {
            alert('Error de conexión al subir el documento.');
        } finally {
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M5.5 13a3.5 3.5 0 01-.369-6.98 4.5 4.5 0 118.738 0A3.5 3.5 0 0114.5 13H5.5z" /><path d="M9 13.5a1 1 0 011 1v1.5a1 1 0 11-2 0V14.5a1 1 0 011-1z" /></svg> Crear Documento';
        }
    });

    // AÑADE estos nuevos listeners para la selección de portada en el modal de creación
    document.getElementById('new-doc-cover-pc-btn').addEventListener('click', () => {
        document.getElementById('new-doc-cover-file-input').click();
    });
    document.getElementById('new-doc-cover-pexels-btn').addEventListener('click', () => {
        pexelsTarget = 'new_document_cover';
        openDrawer(pexelsOverlay, pexelsContent);
    });
    document.getElementById('new-doc-cover-file-input').addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (file) {
            const imageUrl = await uploadToImgBB(file);
            if (imageUrl) {
                document.getElementById('new-doc-thumbnail-url').value = imageUrl;
                document.getElementById('new-doc-cover-preview').innerHTML = `<img src="${imageUrl}" class="w-full h-full object-cover rounded-md">`;
            }
        }
    });



    // Drag and drop logic
    const dropZone = document.getElementById('pdf-drop-zone');
    const fileInput = document.getElementById('pdf-file-input');
    const fileNameDisplay = document.getElementById('pdf-file-name');

    dropZone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropZone.classList.add('drag-over');
    });
    dropZone.addEventListener('dragleave', () => {
        dropZone.classList.remove('drag-over');
    });
    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.classList.remove('drag-over');
        if (e.dataTransfer.files.length) {
            const file = e.dataTransfer.files[0];
            if (file.type === "application/pdf") {
                fileInput.files = e.dataTransfer.files;
                fileNameDisplay.textContent = file.name;
                selectedPdfFile = file;
            } else {
                alert("Por favor, arrastra solo archivos PDF.");
            }
        }
    });
    fileInput.addEventListener('change', () => {
        if (fileInput.files.length) {
            selectedPdfFile = fileInput.files[0];
            fileNameDisplay.textContent = selectedPdfFile.name;
        }
    });

    document.body.addEventListener('submit', (e) => {
        // Maneja el envío desde el formulario del chat del tablero
        if (e.target.id === 'board-chat-form') {
            e.preventDefault();
            const input = document.getElementById('board-chat-input');
            if (input && input.value.trim()) {
                sendMessage(input.value.trim());
                input.value = '';
            }
        }

        // Maneja el envío desde el formulario del chat personal
        if (e.target.id === 'general-chat-form') {
            e.preventDefault();
            const input = document.getElementById('general-chat-input');
            if (input && input.value.trim()) {
                sendMessage(input.value.trim());
                input.value = '';
            }
        }
    });
    // Listener del formulario de chat general (CORREGIDO Y UNIFICADO)
    // Se usa delegación de eventos, ya que este formulario se crea dinámicamente
    generalChatView.addEventListener('submit', (e) => {
        if (e.target && e.target.id === 'general-chat-form') {
            e.preventDefault();
            const input = document.getElementById('general-chat-input');
            const message = input.value.trim();
            if (message) {
                sendMessage(message); // Usa la función unificada
                input.value = '';
            }
        }
    });











    async function insertImageFromPexels(imageUrl, size = selectedImageSize) {
        const trixEditor = document.querySelector('#note-editor-modal trix-editor');
        if (!trixEditor || !trixEditor.editor) return;

        try {
            // Determinar dimensiones
            const sizes = {
                small: 200,
                medium: 400,
                large: 600,
                full: 800
            };
            
            const maxWidth = sizes[size] || 400;
            
            // Crear elemento img directamente
            const img = document.createElement('img');
            img.src = imageUrl;
            img.style.maxWidth = maxWidth + 'px';
            img.style.height = 'auto';
            img.style.display = 'block';
            img.style.margin = '10px 0';
            img.style.borderRadius = '8px';
            img.style.boxShadow = '0 2px 8px rgba(0,0,0,0.1)';
            img.style.cursor = 'pointer';
            img.title = 'Imagen desde Pexels';
            
            // Insertar la imagen usando innerHTML
            const currentPosition = trixEditor.editor.getSelectedRange();
            trixEditor.editor.setSelectedRange(currentPosition);
            trixEditor.editor.insertHTML(img.outerHTML);
            
        } catch (error) {
            console.error('Error procesando imagen de Pexels:', error);
            alert('Error al insertar la imagen de Pexels');
        }
    }

    function setupImageHandling() {
        const trixEditor = document.querySelector('#note-editor-modal trix-editor');
        if (!trixEditor) return;

        // Manejar paste de imágenes
        trixEditor.addEventListener('paste', async (event) => {
            const items = event.clipboardData?.items;
            if (!items) return;

            for (let item of items) {
                if (item.type.startsWith('image/')) {
                    event.preventDefault();
                    const file = item.getAsFile();
                    if (file) {
                        await insertImageFromFile(file, selectedImageSize);
                    }
                }
            }
        });

        // Manejar drag and drop de imágenes
        trixEditor.addEventListener('dragover', (e) => {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'copy';
        });

        trixEditor.addEventListener('drop', async (e) => {
            e.preventDefault();
            const files = e.dataTransfer.files;
            
            for (let file of files) {
                if (file.type.startsWith('image/')) {
                    await insertImageFromFile(file, selectedImageSize);
                }
            }
        });

        // Agregar botón de redimensionar cuando se selecciona una imagen
        trixEditor.addEventListener('trix-selection-change', () => {
            const selectedAttachments = trixEditor.editor.getSelectedDocument().getAttachments();
            if (selectedAttachments.length > 0) {
                // Aquí podrías agregar controles de redimensionado si lo deseas
            }
        });
    }


    function setupTrixEditor(trixEditor, noteId) {
        // Personalizar la barra de herramientas de Trix
        const toolbar = trixEditor.toolbarElement;
        if (toolbar) {
            // Agregar botones personalizados a la barra de herramientas
            const customButtons = document.createElement('div');
            customButtons.className = 'trix-button-group';
            customButtons.innerHTML = `
                <button type="button" class="trix-button trix-button--icon trix-button--icon-color" data-trix-attribute="color" title="Color de texto">
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M9.93 13.5h4.14L12 7.98zM20 2H4c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-4.05 16.5l-1.14-3H9.17l-1.12 3H5.96l5.11-13h1.86l5.11 13h-2.09z"/>
                    </svg>
                </button>
                <button type="button" class="trix-button trix-button--icon trix-button--icon-highlight" data-trix-attribute="highlight" title="Resaltar texto">
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M6 14l3 3v5h6v-5l3-3V9H6v5zm2-3h8v1.5l-2 2V18h-4v-3.5l-2-2V11z"/>
                    </svg>
                </button>
                <button type="button" class="trix-button trix-button--icon trix-button--icon-align-left" onclick="setTextAlign('left')" title="Alinear izquierda">
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M15 15H3v2h12v-2zm0-8H3v2h12V7zM3 13h18v-2H3v2zm0 8h18v-2H3v2zM3 3v2h18V3H3z"/>
                    </svg>
                </button>
                <button type="button" class="trix-button trix-button--icon trix-button--icon-align-center" onclick="setTextAlign('center')" title="Centrar">
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M7 15v2h10v-2H7zm-4 6h18v-2H3v2zm0-8h18v-2H3v2zm4-6v2h10V7H7zM3 3v2h18V3H3z"/>
                    </svg>
                </button>
                <button type="button" class="trix-button trix-button--icon trix-button--icon-align-right" onclick="setTextAlign('right')" title="Alinear derecha">
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M3 21h18v-2H3v2zm6-4h12v-2H9v2zm-6-4h18v-2H3v2zm6-4h12V7H9v2zM3 3v2h18V3H3z"/>
                    </svg>
                </button>
            `;
            toolbar.appendChild(customButtons);
        }

        // Guardado automático mejorado
        const debouncedUpdate = debounce(() => {
            const content = trixEditor.value;
            updateNoteContent(noteId, content);
        }, 1000);

        // Event listeners para el editor
        trixEditor.addEventListener('trix-change', debouncedUpdate);
        
        // Agregar soporte para insertar imágenes
        trixEditor.addEventListener('trix-file-accept', (event) => {
            const file = event.file;
            if (file && file.type.startsWith('image/')) {
                event.preventDefault();
                insertImageInNote(trixEditor, file);
            }
        });

        // Soporte para enlaces
        trixEditor.addEventListener('trix-action-invoke', (event) => {
            if (event.actionName === 'link') {
                event.preventDefault();
                const url = prompt('Ingresa la URL del enlace:');
                if (url) {
                    trixEditor.editor.activateAttribute('href', url);
                }
            }
        });
    }



    function openParticipantsModal() {
        const modal = document.getElementById('attendance-modal');
        const content = modal.querySelector('.transform');
        
        modal.classList.remove('hidden');
        setTimeout(() => {
            content.classList.remove('scale-95', 'opacity-0');
        }, 10);

        const filterInput = document.getElementById('attendance-filter-input');
        filterInput.value = '';
        
        // Pide al servidor la lista actualizada de colaboradores y su estado
        socket.emit('get_collaborator_status', { board_id: currentBoardId });

        // Muestra un estado de "Cargando..." mientras se reciben los datos
        document.getElementById('attendance-list-online').innerHTML = '<p class="text-sm text-gray-500 text-center py-4">Cargando...</p>';
        document.getElementById('attendance-list-offline').innerHTML = '';
    }

    function closeParticipantsModal() {
        const modal = document.getElementById('attendance-modal');
        const content = modal.querySelector('.transform');
        content.classList.add('scale-95', 'opacity-0');
        setTimeout(() => {
            modal.classList.add('hidden');
        }, 200);
    }




    function appendBoardChatMessage(msg, isGrouped = false) {
        const container = document.getElementById('chat-messages');
        if (!container) {
            console.error("Error crítico: No se encontró el contenedor de mensajes #chat-messages.");
            return;
        }

        const isMe = msg.user_email === currentUser.email;
        const lastMessageEl = container.querySelector('.chat-message-wrapper:last-child');
        const lastSenderEmail = lastMessageEl ? lastMessageEl.dataset.email : null;
        const isGroupedFinal = msg.user_email === lastSenderEmail;

        const wrapper = document.createElement('div');
        wrapper.dataset.email = msg.user_email;
        wrapper.className = `chat-message-wrapper animate__animated animate__fadeInUp animate__faster ${isMe ? 'from-me' : 'from-others'} ${isGroupedFinal ? 'grouped' : ''}`;
        
        const color = getUserColor(msg.user_email);
        const userName = msg.user_name || 'Usuario';
        const initials = userName.split(' ').map(n => n[0]).join('').substring(0, 2);
        
        const isSticker = msg.message && /\.(jpeg|jpg|gif|png|webp)$/i.test(msg.message);
        const messageContent = isSticker 
            ? `<img src="${msg.message}" alt="Sticker" class="max-w-[120px] max-h-[120px] object-contain">`
            : `<div class="chat-bubble">${msg.message}</div>`;

        wrapper.innerHTML = `
            <div class="chat-avatar ${color.bg}" title="${userName}">${initials}</div>
            <div class="chat-content">
                <div class="chat-sender-name">${isMe ? 'Tú' : userName.split(' ')[0]}</div>
                ${messageContent}
            </div>
        `;
        
        container.appendChild(wrapper);
        
        // --- INICIO DE LA CORRECCIÓN ---
        // Se añade un pequeño retardo para asegurar que el DOM se actualice
        // antes de calcular la altura del scroll, garantizando que baje completamente.
        setTimeout(() => {
            container.scrollTop = container.scrollHeight;
        }, 50);
        // --- FIN DE LA CORRECCIÓN ---
    }




    // Función para insertar imágenes en las notas
    async function insertImageInNote(trixEditor, file) {
        try {
            // Comprimir y convertir imagen a base64
            const compressedDataUrl = await compressImage(file, 600, 0.8);
            
            // Crear attachment para Trix
            const attachment = new Trix.Attachment({
                content: compressedDataUrl,
                contentType: file.type,
                filename: file.name
            });
            
            // Insertar en el editor
            trixEditor.editor.insertAttachment(attachment);
        } catch (error) {
            console.error('Error al insertar imagen:', error);
            alert('Error al insertar la imagen');
        }
    }

    // Función para alineación de texto
    function setTextAlign(alignment) {
        const activeEditor = document.querySelector('trix-editor:focus');
        if (activeEditor && activeEditor.editor) {
            const selectedRange = activeEditor.editor.getSelectedRange();
            if (selectedRange) {
                activeEditor.editor.setTextAttribute('textAlign', alignment);
            }
        }
    }

    document.getElementById('add-note-btn').addEventListener('click', () => {
        // Al pasar 'null', le indicamos al editor que estamos creando una nota nueva.
        openNoteModal(null);
    });


    async function updateNoteContent(noteId, newContent, newColor = 'note-yellow') {
        try {
            const response = await fetch(`${API_BASE_URL}/notes/${noteId}`, {
                method: 'PUT',
                headers: { 
                    'Content-Type': 'application/json',
                    'ngrok-skip-browser-warning': 'true'
                },
                body: JSON.stringify({ email: currentUser.email, content: newContent, color: newColor })
            });
            const data = await response.json();
            if (data.success) {
                const noteIndex = notesCache.findIndex(n => n.id == noteId);
                if (noteIndex !== -1) {
                    // Actualizar caché y la marca de tiempo en la UI
                    notesCache[noteIndex].content = newContent;
                    notesCache[noteIndex].color = newColor;
                    notesCache[noteIndex].updated_date = data.note.updated_date;
                    
                    const noteEl = document.querySelector(`[data-note-id='${noteId}']`);
                    if(noteEl) {
                        const timestampEl = noteEl.querySelector('.note-timestamp');
                        const updatedDate = new Date(data.note.updated_date).toLocaleString('es-ES', {
                            day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit'
                        });
                        timestampEl.textContent = `Guardado: ${updatedDate}`;
                    }
                }
            } else {
                console.error('Fallo al actualizar la nota:', data.message);
            }
        } catch (error) {
            console.error('Error de red al actualizar nota:', error);
        }
    }

    async function deleteNote(noteId) {
        const confirmed = await showGenericConfirmModal('Eliminar Nota', '¿Estás seguro de que quieres eliminar esta nota? Esta acción no se puede deshacer.');
        if (!confirmed) return;

        try {
            const response = await fetch(`${API_BASE_URL}/notes/${noteId}?email=${encodeURIComponent(currentUser.email)}`, {
                method: 'DELETE',
                headers: { 'ngrok-skip-browser-warning': 'true' }
            });
            const data = await response.json();
            if (data.success) {
                // Eliminar del caché y de la UI
                notesCache = notesCache.filter(n => n.id != noteId);
                const noteEl = document.querySelector(`[data-note-id='${noteId}']`);
                if (noteEl) {
                    // Añadir animación de salida
                    noteEl.classList.remove('animate__fadeIn');
                    noteEl.classList.add('animate__zoomOut');
                    setTimeout(() => renderNotes(), 500); // Re-renderizar después de la animación
                }
            } else {
                console.error('Fallo al eliminar la nota:', data.message);
            }
        } catch (error) {
            console.error('Error de red al eliminar nota:', error);
        }
    }

    function showConfirmDelete(type, id, name = '') {
        deleteTargetType = type;
        deleteTargetId = id;
        
        let message = '';
        if (type === 'card') {
            message = '¿Está seguro que desea eliminar la tarjeta?';
        } else if (type === 'column') {
            message = '¿Está seguro que desea eliminar la columna?';
        } else if (type === 'board') {
            message = `¿Está seguro que desea eliminar el tablero "${name}"?`;
        }
        
        // Restaurar el estado original del modal (texto visible, botones visibles, sin loader)
        confirmDeleteMessage.textContent = message;
        confirmDeleteMessage.style.display = 'block';
        
        const btnContainer = confirmDeleteModal.querySelector('.flex.justify-end');
        if (btnContainer) btnContainer.classList.remove('hidden');
        
        const existingLoader = document.getElementById('delete-progress-loader');
        if (existingLoader) existingLoader.remove();

        confirmDeleteModal.classList.remove('hidden');
    }

    confirmDeleteOk.addEventListener('click', async () => {
        // 1. UI: Ocultar botones
        const btnContainer = confirmDeleteModal.querySelector('.flex.justify-end');
        if (btnContainer) btnContainer.classList.add('hidden');

        // 2. Cambiar texto por mensajes de "sistema" dinámicos
        const systemMessages = [
            "Conectando con base de datos...",
            "Eliminando registros del sistema...",
            "Limpiando caché y dependencias...",
            "Sincronizando cambios..."
        ];
        
        let msgIndex = 0;
        confirmDeleteMessage.textContent = systemMessages[0];
        confirmDeleteMessage.className = "text-sm font-mono text-orange-700 mb-4 animate-pulse"; // Estilo técnico
        
        // Rotar mensajes cada 800ms para dar sensación de actividad
        const msgInterval = setInterval(() => {
            msgIndex = (msgIndex + 1) % systemMessages.length;
            confirmDeleteMessage.textContent = systemMessages[msgIndex];
        }, 800);

        // 3. Inyectar barra de progreso
        const loaderHTML = `
            <div id="delete-progress-loader" class="mt-4 w-full">
                <div class="w-full bg-gray-200 rounded-full h-2.5 overflow-hidden">
                    <div class="bg-orange-600 h-2.5 rounded-full animate-[progress_1s_ease-in-out_infinite]" style="width: 70%"></div>
                </div>
            </div>
        `;
        confirmDeleteMessage.insertAdjacentHTML('afterend', loaderHTML);

        try {
            if (deleteTargetType === 'card') {
                const response = await fetch(`${API_BASE_URL}/boards/${currentBoardId}/cards/${deleteTargetId}?email=${encodeURIComponent(currentUser.email)}`, {
                    method: 'DELETE',
                    headers: { 'ngrok-skip-browser-warning': 'true' }
                });
                const result = await response.json();
                
                if (result.success) {
                    // ELIMINACIÓN VISUAL INMEDIATA (Sin esperas)
                    const cardEl = document.getElementById(deleteTargetId);
                    if (cardEl) cardEl.remove();
                    
                    // Limpiar datos locales
                    cardDataStore.delete(deleteTargetId);
                    updateColumnHeaders();
                } else {
                    alert(`Error: ${result.message}`);
                }

            } else if (deleteTargetType === 'column') {
                const columnIdToDelete = deleteTargetId;
                const firstColumnId = columnsConfig[0].id;

                cardDataStore.forEach(task => {
                    if (task.columnId === columnIdToDelete) {
                        task.columnId = firstColumnId;
                    }
                });
                
                columnsConfig = columnsConfig.filter(c => c.id !== columnIdToDelete);
                
                socket.emit('column_deleted', {
                    board_id: currentBoardId,
                    column_id: columnIdToDelete
                });
                
                initializeBoard();
                scheduleAutoSave();

            } else if (deleteTargetType === 'board') {
                // Evitar conflictos de auto-guardado
                if (currentBoardId === deleteTargetId) {
                    currentBoardId = null;
                }

                // Llamada manual al API para controlar el error 404
                const response = await fetch(`${API_BASE_URL}/boards/${deleteTargetId}?email=${encodeURIComponent(currentUser.email)}`, {
                    method: 'DELETE',
                    headers: { 'ngrok-skip-browser-warning': 'true' }
                });
                
                const data = await response.json();

                // CORRECCIÓN CLAVE: Si es éxito O si dice "no encontrado", asumimos que se borró bien y no mostramos error.
                if (data.success || (data.message && data.message.toLowerCase().includes('no encontrado'))) {
                    await loadUserBoards();
                } else {
                    // Solo mostrar alerta si es un error real distinto a "no encontrado"
                    console.error('Error eliminando tablero:', data.message);
                    alert('Error del servidor: ' + data.message);
                }
            }
        } catch (error) {
            console.error('Error crítico:', error);
            // Solo alertar si no es un tablero (para evitar spam de alertas si la conexión falló justo al final)
            if (deleteTargetType !== 'board') {
                alert('Ocurrió un error de conexión.');
            }
        } finally {
            clearInterval(msgInterval);
            hideConfirmDelete();
        }
    });

    function hideConfirmDelete() {
        confirmDeleteModal.classList.add('hidden');
    }



    // ========================================================================
    // == INICIO: Bloque de código para registro de actividad en comentarios ==
    // ========================================================================

    /**
     * NUEVA FUNCIÓN: Registra una actividad como un comentario del sistema.
     * @param {string} cardId - El ID de la tarjeta donde se registrará la actividad.
     * @param {string} icon - Un emoji para identificar el tipo de actividad.
     * @param {string} message - El mensaje que describe la acción.
     */
    function logActivity(cardId, icon, message) {
        const task = cardDataStore.get(cardId);
        if (!task) return;

        if (!task.comments) {
            task.comments = [];
        }
        
        const userFullName = `${currentUser.firstName || ''} ${currentUser.lastName || ''}`.trim();

        // Añade el comentario del sistema al array de comentarios de la tarjeta
        task.comments.push({
            id: 'comment-system-' + Date.now() + Math.random(), // ID único
            text: `<strong>${userFullName}</strong> ${message}`,
            timestamp: Date.now(),
            isSystem: true, // Identificador clave para diferenciarlo de un comentario de usuario
            icon: icon
        });
    }


    /**
     * FUNCIÓN MODIFICADA: renderComments
     * Ahora distingue visualmente entre comentarios de usuarios y registros del sistema.
     */
    function renderComments(task) {
        const items = task.comments || [];
        const container = document.getElementById('comments-list');
        container.innerHTML = '';
        
        // Ordena los comentarios por fecha para mostrar una línea de tiempo
        items.sort((a, b) => a.timestamp - b.timestamp).forEach(comment => {
            const li = document.createElement('li');
            const dateStr = new Date(comment.timestamp).toLocaleString('es-ES', { day: 'numeric', month: 'short', year:'numeric', hour: '2-digit', minute: '2-digit' });

            if (comment.isSystem) {
                // Estilo para un registro de actividad del sistema
                li.className = 'flex items-start gap-3 py-1.5';
                li.innerHTML = `
                    <div class="flex-shrink-0 w-5 h-5 flex items-center justify-center text-gray-500 mt-0.5" title="Actividad del sistema">${comment.icon || '🔹'}</div>
                    <div class="flex-grow text-xs text-gray-600">
                        <p>${comment.text}</p>
                        <p class="text-gray-400">${dateStr}</p>
                    </div>
                `;
            } else {
                // Estilo para un comentario de usuario
                const userFullName = comment.user || 'Usuario';
                const userInitials = userFullName.split(' ').map(n => n[0]).join('').substring(0, 2);
                const userColor = getUserColor(comment.user_email || userFullName);

                li.className = 'flex items-start gap-3 p-3 bg-gray-50 rounded-lg';
                li.innerHTML = `
                    <div class="flex-shrink-0 assigned-avatar ${userColor.bg} ${userColor.text}" title="${userFullName}">${userInitials}</div>
                    <div class="flex-grow">
                        <p class="font-semibold text-sm text-gray-800">${userFullName}</p>
                        <p class="text-sm text-gray-700 whitespace-pre-wrap">${comment.text}</p>
                        <p class="text-xs text-gray-400 mt-1 text-right">${dateStr}</p>
                    </div>
                `;
            }
            container.appendChild(li);
        });
        
        setTimeout(() => container.scrollTop = container.scrollHeight, 50);
    }

    /**
     * FUNCIÓN MODIFICADA: createColumnElement
     * Se agrega el registro de actividad cuando una tarjeta cambia de columna.
     */
    function createColumnElement({ id, title, color, attractsToday, attractsOverdue, attractsTag }) {
        const columnEl = document.createElement('div');
        columnEl.className = `kanban-column rounded-xl border border-gray-200/50 shadow-sm`;
        columnEl.id = id;
        columnEl.draggable = true;
        
        const borderColorClass = COLUMN_COLORS[color] || 'border-gray-400';
        const headerEl = document.createElement('div');
        headerEl.className = `column-header flex-shrink-0 flex items-center justify-between p-3 rounded-t-xl border-t-4 ${borderColorClass} bg-white/60 backdrop-blur-sm`;
        headerEl.innerHTML = `<div class="column-drag-handle text-gray-400 hover:text-gray-600 p-1 cursor-grab active:cursor-grabbing"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M7 2a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm3 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0zM7 5a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm3 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0zM7 8a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm3 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm-3 3a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm3 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm-3 3a1 1 0 1 1-2 0 1 1 0 0 1 2 0zm3 0a1 1 0 1 1-2 0 1 1 0 0 1 2 0z"/></svg></div><div class="flex-grow text-center cursor-pointer" title="Haz clic para editar la columna"><h2 class="text-base font-semibold text-gray-800">${title}</h2></div><span class="card-counter text-sm font-medium bg-gray-200 text-gray-600 rounded-full px-2 py-0.5">0</span>`;
        headerEl.querySelector('.flex-grow').addEventListener('click', () => openColumnDrawer(id));
        
        const contentArea = document.createElement('div');
        contentArea.className = 'kanban-column-content p-3 bg-transparent';
        contentArea.addEventListener('dragover', e => { 
            e.preventDefault(); 
            if (!draggedCard) return; 
            const afterElement = getDragAfterCard(contentArea, e.clientY); 
            if (afterElement == null) { 
                contentArea.appendChild(draggedCard); 
            } else { 
                contentArea.insertBefore(draggedCard, afterElement); 
            } 
        });



        contentArea.addEventListener('drop', (e) => {
            e.preventDefault();
            if (!draggedCard) return;

            if (!checkEditPermissionsAndNotify()) {
                return;
            }

            const cardId = draggedCard.id;
            const task = cardDataStore.get(cardId);
            const newColumnId = id;
            const oldColumnId = task.columnId;

            if (oldColumnId !== newColumnId) {
                const oldColumn = columnsConfig.find(c => c.id === oldColumnId);
                const newColumn = columnsConfig.find(c => c.id === newColumnId);
                if (oldColumn && newColumn) {
                    logActivity(cardId, '➡️', `movió esta tarjeta de <strong>${oldColumn.title}</strong> a <strong>${newColumn.title}</strong>.`);
                }
            }

            task.columnId = newColumnId;
            const cardsInNewColumn = Array.from(contentArea.querySelectorAll('.kanban-card'));
            let newOrder = cardsInNewColumn.findIndex(card => card.id === cardId);
            if (newOrder === -1) newOrder = cardsInNewColumn.length - 1;
            task.order = newOrder;

            cardsInNewColumn.forEach((card, index) => {
                const taskToUpdate = cardDataStore.get(card.id);
                if (taskToUpdate) taskToUpdate.order = index;
            });
            
            // Notificamos al servidor del movimiento específico para que lo retransmita.
            const cardOrder = cardsInNewColumn.map(card => card.id);
            socket.emit('card_moved', {
                board_id: currentBoardId,
                card_id: cardId,
                new_column_id: newColumnId,
                new_card_order: cardOrder
            });

            scheduleAutoSave();
        });
        





        const footerEl = document.createElement('div');
        footerEl.className = 'column-footer flex-shrink-0 p-2 rounded-b-xl border-t border-gray-200/50 bg-white/60 backdrop-blur-sm';
        const addCardBtn = document.createElement('button');
        addCardBtn.className = 'add-card-btn w-full text-sm text-gray-500 hover:text-orange-600 hover:bg-gray-100/50 p-2 rounded-lg transition-colors duration-200 flex items-center justify-center gap-2';
        addCardBtn.innerHTML = `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>Añadir tarjeta`;
        addCardBtn.addEventListener('click', () => openCardDrawer(null, id));
        
        footerEl.appendChild(addCardBtn);
        columnEl.append(headerEl, contentArea, footerEl);
        
        columnEl.addEventListener('dragstart', (e) => { 
            if (e.target.classList.contains('kanban-column')) { 
                draggedColumn = columnEl; 
                setTimeout(() => columnEl.classList.add('dragging-column'), 0); 
            } 
        });


        columnEl.addEventListener('dragend', () => { 
            if (draggedColumn) { 
                draggedColumn.classList.remove('dragging-column'); 
                draggedColumn = null; 
                
                // --- INICIO DE LA CORRECCIÓN ---
                const newColumnOrder = Array.from(board.querySelectorAll('.kanban-column')).map(col => col.id); 
                columnsConfig.sort((a, b) => newColumnOrder.indexOf(a.id) - newColumnOrder.indexOf(b.id)); 
                
                // Notificamos a los demás del nuevo orden
                socket.emit('columns_reordered', {
                    board_id: currentBoardId,
                    new_order: newColumnOrder
                });
                
                scheduleAutoSave();
                // --- FIN DE LA CORRECCIÓN ---
            } 
        });
        
        return columnEl;
    }

    /**
     * LISTENER MODIFICADO: addCommentBtn
     * Ahora crea un objeto de comentario completo con información del usuario.
     */
    addCommentBtn.addEventListener('click', () => {
        const input = document.getElementById('new-comment-input');
        const text = input.value.trim();
        if (text && currentCardId) {
            const task = cardDataStore.get(currentCardId);
            if (!task) return;
            if (!task.comments) task.comments = [];
            
            task.comments.push({
                id: 'comment-' + Date.now(),
                text: text,
                timestamp: Date.now(),
                user: `${currentUser.firstName} ${currentUser.lastName}`,
                user_email: currentUser.email, // Guardar email para el color del avatar
                isSystem: false // Marcar como comentario de usuario
            });
            
            scheduleAutoSave();
            renderAllCards(); // Para actualizar el contador de comentarios en la tarjeta
            renderComments(task);
            input.value = '';
        }
    });

    /**
     * LISTENER MODIFICADO: checklist-items
     * Agrega un registro de actividad al completar o desmarcar un ítem.
     */
    document.getElementById('checklist-items').addEventListener('click', (e) => {
        const task = cardDataStore.get(currentCardId);
        if (!task || !task.checklist) return;

        if (e.target.matches('input[type="checkbox"]')) {
            const itemId = e.target.dataset.itemId;
            const item = task.checklist.find(i => i.id === itemId);
            if(item) {
                item.completed = e.target.checked;

                // Registrar la actividad
                if (item.completed) {
                    logActivity(currentCardId, '✅', `completó el ítem del checklist: <em>"${item.text}"</em>.`);
                } else {
                     logActivity(currentCardId, '🔳', `marcó como no completado el ítem: <em>"${item.text}"</em>.`);
                }

                scheduleAutoSave();
                renderAllCards();
                renderChecklist(task);
            }
        }
        if (e.target.matches('.delete-checklist-item-btn')) {
            const itemId = e.target.dataset.itemId;
            const item = task.checklist.find(i => i.id === itemId);
            if(item) {
                logActivity(currentCardId, '🗑️', `eliminó el ítem del checklist: <em>"${item.text}"</em>.`);
                task.checklist = task.checklist.filter(i => i.id !== itemId);
                scheduleAutoSave();
                renderAllCards();
                renderChecklist(task);
            }
        }
    });

    /**
     * LISTENER MODIFICADO: complete-task-btn
     * Registra la finalización de la tarea.
     */
    document.getElementById('complete-task-btn').addEventListener('click', () => {
        if (!currentCardId) return;
        const task = cardDataStore.get(currentCardId);
        if (!task) return;

        task.isCompleted = true;
        task.color = 'bg-white';
        const oldDueDate = task.dueDate;
        task.dueDate = null;
        task.startTime = null;
        task.endTime = null;
        task.allDay = true;
        
        // Registrar la actividad de completar la tarea
        logActivity(currentCardId, '✔️', `marcó esta tarea como completada.`);
        if (oldDueDate) {
             logActivity(currentCardId, '📅', `se eliminó la fecha de vencimiento al completar.`);
        }

        scheduleAutoSave();
        renderAllCards();
        closeDrawer(addCardOverlay, addCardContent);
    });


    function attachRealtimeSaveListeners() {
        const form = document.getElementById('add-card-form');
        if (!form) return;

        const trixEditor = form.querySelector('trix-editor');
        const titleInput = form.querySelector('[name="title"]');
        const startDateInput = form.querySelector('[name="startDate"]');
        const endDateInput = form.querySelector('[name="endDate"]');
        const customTagsInput = form.querySelector('[name="custom_tags"]');
        const colorSwatches = form.querySelector('#card-color-swatches-container');

        // Se añaden verificaciones para evitar errores si un elemento no existe
        if (titleInput) {
            titleInput.addEventListener('input', debouncedSaveFromModal);
        }
        if (startDateInput) {
            startDateInput.addEventListener('change', debouncedSaveFromModal);
        }
        if (endDateInput) {
            endDateInput.addEventListener('change', debouncedSaveFromModal);
        }
        if (customTagsInput) {
            customTagsInput.addEventListener('input', debouncedSaveFromModal);
        }
        if (trixEditor) {
            trixEditor.addEventListener('trix-change', () => {
                if (isProgrammaticallyChangingTrix) {
                    return;
                }
                debouncedSaveFromModal();
            });
        }
        if (colorSwatches) {
            colorSwatches.addEventListener('click', saveCardDataFromModal);
        }
    }




    function saveCardDataFromModal() {
        if (!currentCardId) return;

        // --- INICIO DE LA CORRECCIÓN ---
        const taskData = cardDataStore.get(currentCardId);
        if (!taskData) {
            console.error(`Error crítico: No se encontró la tarjeta con ID ${currentCardId} para guardar.`);
            return;
        }

        // Se crea una copia segura solo si la tarea ya existía con datos.
        const oldTask = taskData.title ? JSON.parse(JSON.stringify(taskData)) : {};
        // --- FIN DE LA CORRECCIÓN ---

        const form = document.getElementById('add-card-form');

        taskData.title = form.querySelector('[name="title"]').value;
        taskData.description = form.querySelector('[name="description"]').value;

        const newStartDate = form.querySelector('[name="startDate"]').value || null;
        const newEndDate = form.querySelector('[name="endDate"]').value || null;
        const allDay = form.querySelector('[name="allDay"]').checked;
        const startTime = form.querySelector('[name="startTime"]').value || null;
        const endTime = form.querySelector('[name="endTime"]').value || null;

        if (newStartDate !== oldTask.startDate) {
            if (!oldTask.startDate && newStartDate) {
                const formattedDate = new Date(newStartDate + 'T00:00:00').toLocaleDateString("es-ES", { year: 'numeric', month: 'long', day: 'numeric' });
                logActivity(currentCardId, '📅', `estableció la fecha de inicio en <strong>${formattedDate}</strong>.`);
            } else if (oldTask.startDate && !newStartDate) {
                logActivity(currentCardId, '🗑️', `eliminó la fecha de inicio.`);
            } else if (oldTask.startDate && newStartDate) {
                const oldFormatted = new Date(oldTask.startDate + 'T00:00:00').toLocaleDateString("es-ES", { month: 'short', day: 'numeric' });
                const newFormatted = new Date(newStartDate + 'T00:00:00').toLocaleDateString("es-ES", { month: 'short', day: 'numeric' });
                logActivity(currentCardId, '🔄', `cambió la fecha de inicio de <strong>${oldFormatted}</strong> a <strong>${newFormatted}</strong>.`);
            }
        }

        taskData.startDate = newStartDate;
        taskData.endDate = newEndDate;
        taskData.allDay = allDay;
        taskData.startTime = startTime;
        taskData.endTime = endTime;

        taskData.color = form.querySelector('#card-color-swatches-container .ring-2')?.dataset.color || 'bg-white';

        const tags = [];
        document.querySelectorAll('#urgency-tags-container .tag-select-btn[aria-checked="true"], #importance-tags-container .tag-select-btn[aria-checked="true"]').forEach(btn => { 
            tags.push({ text: btn.textContent }); 
        });

        const customTagsString = form.querySelector('[name="custom_tags"]').value;
        if (customTagsString) {
            customTagsString.split(',').forEach(tagText => {
                const trimmedTag = tagText.trim();
                if (trimmedTag && !tags.some(t => t.text === trimmedTag)) {
                    tags.push({ text: trimmedTag });
                }
            });
        }
        taskData.tags = tags;

        scheduleAutoSave();
    }




    // Crear una versión de la función de guardado con un retraso de 1.5 segundos
    const debouncedSaveFromModal = debounce(saveCardDataFromModal, 1500);




    
    function moveProgrammedCards() {
        const todayTargetColumn = columnsConfig.find(c => c.attractsToday);
        const overdueTargetColumn = columnsConfig.find(c => c.attractsOverdue);
        let cardsMoved = false;

        const today = new Date();
        today.setHours(0, 0, 0, 0);

        cardDataStore.forEach(task => {
            if (!task.dueDate) return;

            const dueDate = new Date(task.dueDate + 'T00:00:00Z');
            const isOverdue = dueDate < today;
            const isToday = dueDate.getTime() === today.getTime();
            
            let newColumnId = null;

            if (isOverdue && overdueTargetColumn) {
                newColumnId = overdueTargetColumn.id;
            } else if (isToday && todayTargetColumn) {
                newColumnId = todayTargetColumn.id;
            }

            if (newColumnId && task.columnId !== newColumnId) {
                console.log(`✨ Moviendo tarjeta "${task.title}" a la columna "${columnsConfig.find(c => c.id === newColumnId).title}" por programación.`);
                task.columnId = newColumnId;
                task.order = Date.now(); // Mover al final de la columna
                cardsMoved = true;
            }
        });

        if (cardsMoved) {
            renderAllCards();
            if (!calendarContainer.classList.contains('hidden')) {
                renderCalendar();
            }
            scheduleAutoSave();
        }
    }
    
    function openColumnDrawer(columnId) {
        const isCreating = !columnId;
        const columnData = isCreating ? {} : columnsConfig.find(c => c.id === columnId);
        if (!columnData && !isCreating) return;

        columnEditorForm.reset();
        columnEditorForm.querySelector('[name="column_id"]').value = columnId || '';
        document.getElementById('column-modal-title').textContent = isCreating ? 'Crear Columna' : 'Editar Columna';
        document.getElementById('column-name-input').value = columnData.title || '';
        deleteColumnBtn.style.display = isCreating ? 'none' : 'block';

        document.getElementById('attracts-today-checkbox').checked = columnData.attractsToday || false;
        document.getElementById('attracts-overdue-checkbox').checked = columnData.attractsOverdue || false;

        const tagSelect = document.getElementById('attracts-tag-select');
        tagSelect.innerHTML = '<option value="">Ninguna</option>';
        const uniqueTags = getAllUniqueTags();
        uniqueTags.forEach(tagText => {
            const option = document.createElement('option');
            option.value = tagText;
            option.textContent = tagText;
            tagSelect.appendChild(option);
        });
        tagSelect.value = columnData.attractsTag || "";

        document.getElementById('programming-change-notice').classList.add('hidden');

        const colorSwatchesContainer = document.getElementById('color-swatches-container');
        colorSwatchesContainer.innerHTML = '';
        const selectedColor = columnData.color || Object.keys(COLUMN_COLORS)[0];

        Object.keys(COLUMN_COLORS).forEach(colorClass => {
            const swatch = document.createElement('button');
            swatch.type = 'button';
            swatch.className = `w-8 h-8 rounded-md cursor-pointer border-2 flex items-center justify-center ${colorClass.replace('-200', '-400')} border-transparent`;
            swatch.dataset.color = colorClass;
            if (selectedColor === colorClass) {
                swatch.innerHTML = CHECK_ICON_SVG.replace('text-black', 'text-white');
                swatch.classList.add('ring-2', 'ring-offset-1', 'ring-orange-600');
            }


            swatch.addEventListener('click', () => {
                colorSwatchesContainer.querySelector('.ring-2')?.classList.remove('ring-2', 'ring-offset-1', 'ring-orange-600');
                colorSwatchesContainer.querySelector('svg')?.remove();
                swatch.classList.add('ring-2', 'ring-offset-1', 'ring-orange-600');
                swatch.innerHTML = CHECK_ICON_SVG.replace('text-black', 'text-white');
            });
            colorSwatchesContainer.appendChild(swatch);
        });

        openDrawer(columnEditorOverlay, columnEditorContent);
    }
    

    socket.on('new_notification', (data) => {
        // Si el mensaje llega aquí, es 100% para el usuario actual.
        console.log('📬 Notificación recibida. Iniciando proceso de UI...', data);
        addNotificationToList(data);
        const cleanMessage = data.message.replace(/<[^>]*>/g, '');
    });


    socket.on('card_moved', (data) => {
        // Ignora el evento si no es para el tablero actual.
        if (data.board_id !== currentBoardId) return;

        console.log('↓ Recibiendo movimiento de tarjeta en tiempo real:', data);

        const cardElement = document.getElementById(data.card_id);
        const targetColumnContent = document.querySelector(`#${data.new_column_id} .kanban-column-content`);

        if (cardElement && targetColumnContent) {
            // Actualiza el estado local en cardDataStore
            const task = cardDataStore.get(data.card_id);
            if (task) task.columnId = data.new_column_id;
            
            // Reordena todas las tarjetas en la columna de destino según la nueva lista
            data.new_card_order.forEach((id, index) => {
                const cardToUpdate = cardDataStore.get(id);
                if (cardToUpdate) cardToUpdate.order = index;

                // Mueve físicamente el elemento en el DOM
                const cardNode = document.getElementById(id);
                if (cardNode) targetColumnContent.appendChild(cardNode);
            });

            // Actualiza los contadores de las columnas
            updateColumnHeaders();
        }
    });


    socket.on('assistants_updated', async () => {
        console.log('🔄 Recibida actualización de asistentes. Recargando lista...');
        
        // Guardar el ID del asistente actual si el chat está abierto
        const currentAssistantId = isAiChatOpen ? availableAssistants[currentAssistantIndex]?.id : null;

        // Volver a cargar la lista de asistentes desde el servidor
        await fetchAssistants();

        // Si el chat estaba abierto, manejar el cambio
        if (isAiChatOpen && currentAssistantId) {
            // Buscar el asistente en la nueva lista
            const newIndex = availableAssistants.findIndex(a => a.id === currentAssistantId);

            if (newIndex === -1) {
                // Si el asistente fue eliminado, cierra el chat o cambia al primero
                console.log('El asistente actual fue eliminado. Cerrando chat.');
                closeAiChatModal();
            } else {
                // Si el asistente todavía existe, actualiza la vista
                currentAssistantIndex = newIndex;
                updateAssistantDisplay();
            }
        }
    });


    socket.on('columns_reordered', (data) => {
        if (data.board_id !== currentBoardId) return;

        console.log('↓ Recibiendo nuevo orden de columnas:', data.new_order);
        
        // Reordenar el array de configuración local
        columnsConfig.sort((a, b) => data.new_order.indexOf(a.id) - data.new_order.indexOf(b.id));
        
        // Reordenar los elementos en el DOM
        data.new_order.forEach(columnId => {
            const columnElement = document.getElementById(columnId);
            if (columnElement) {
                board.appendChild(columnElement);
            }
        });
    });

    socket.on('column_created', (data) => {
        if (data.board_id !== currentBoardId) return;

        console.log('↓ Recibiendo nueva columna:', data.new_column);
        
        // Añadir la nueva columna a la configuración local
        columnsConfig.push(data.new_column);
        
        // Crear y añadir el elemento de la nueva columna al DOM
        const newColumnElement = createColumnElement(data.new_column);
        board.appendChild(newColumnElement);
        applyBoardOptions(); // Aplica estilos a la nueva columna
    });

    socket.on('column_deleted', (data) => {
        if (data.board_id !== currentBoardId) return;

        console.log('↓ Recibiendo eliminación de columna:', data.column_id);
        const columnId = data.column_id;

        // 1. Mueve las tarjetas de la columna eliminada a la primera columna (en el DOM)
        const firstColumnContent = board.querySelector('.kanban-column .kanban-column-content');
        const columnToDelete = document.getElementById(columnId);
        
        if (columnToDelete && firstColumnContent) {
            const cardsToMove = columnToDelete.querySelectorAll('.kanban-card');
            cardsToMove.forEach(card => firstColumnContent.appendChild(card));
        }

        // 2. Elimina el elemento de la columna del DOM
        if (columnToDelete) {
            columnToDelete.remove();
        }

        // 3. Actualiza la configuración local y los contadores
        columnsConfig = columnsConfig.filter(c => c.id !== columnId);
        updateColumnHeaders();
    });


    function addNotificationToList(notification) {
        console.log('  -> 1. Añadiendo notificación al array local:', notification);
        // Asegurarse de que el ID es un número para comparaciones futuras
        notification.id = Number(notification.id);
        
        // Evitar duplicados
        if (notifications.some(n => n.id === notification.id)) {
            console.log('     -> Ignorado: Notificación duplicada.');
            return;
        }

        notifications.unshift({ ...notification, read: false });
        localStorage.setItem('focux_notifications', JSON.stringify(notifications));
        updateNotificationsUI();
    }

    function updateNotificationsUI() {
        console.log('  -> 2. Actualizando la interfaz de notificaciones.');
        if (!notificationsList || !notificationsBadge) {
            console.error('     -> Error crítico: Elementos de la UI no encontrados (notificationsList o notificationsBadge).');
            return;
        }

        const unreadCount = notifications.filter(n => !n.read).length;
        console.log(`     -> Total: ${notifications.length}, No leídas: ${unreadCount}`);

        if (unreadCount > 0) {
            notificationsBadge.textContent = unreadCount;
            notificationsBadge.classList.remove('hidden');
        } else {
            notificationsBadge.classList.add('hidden');
        }

        if (notifications.length > 0) {
            notificationsList.innerHTML = '';
            notifications.slice(0, 10).forEach(notification => {
                const li = document.createElement('li');
                li.className = `p-4 hover:bg-gray-50 ${notification.read ? 'opacity-75' : 'font-bold'}`;
                const typeIcon = notification.type === 'admin' ? '📢' : '✅';
                const timeStr = new Date(notification.timestamp).toLocaleString('es-ES');
                li.innerHTML = `
                    <div class="flex items-start gap-3">
                        <span class="text-lg mt-1">${typeIcon}</span>
                        <div>
                            <p class="text-sm text-gray-900">${notification.title}</p>
                            <p class="text-sm text-gray-600 mt-1 font-normal">${notification.message}</p>
                            <p class="text-xs text-gray-400 mt-2 font-normal">${timeStr}</p>
                        </div>
                    </div>`;
                notificationsList.appendChild(li);
            });
        } else {
            notificationsList.innerHTML = '<li class="p-4 text-gray-500 text-sm text-center">No tienes notificaciones nuevas.</li>';
        }
        console.log('  -> 3. UI de notificaciones actualizada.');
    }




    if (notificationsBtn) {
        notificationsBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            notificationsDropdown.classList.toggle('hidden');
            
            if (!notificationsDropdown.classList.contains('hidden')) {
                const unreadNotifications = notifications.filter(n => !n.read);
                
                // 1. Marcar como leído localmente para una actualización instantánea de la UI
                notifications.forEach(n => n.read = true);
                notificationsReadCount = 0;
                localStorage.setItem('focux_notifications', JSON.stringify(notifications));
                updateNotificationsUI();
                
                // --- INICIO DE LA CORRECCIÓN ---
                // 2. Si había notificaciones sin leer, informar al servidor en segundo plano
                if (unreadNotifications.length > 0) {
                    fetch(`${API_BASE_URL}/notifications/viewed`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'ngrok-skip-browser-warning': 'true'
                        },
                        body: JSON.stringify({ email: currentUser.email })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            console.log('✅ Servidor notificado: Notificaciones marcadas como vistas.');
                        } else {
                            console.error('❌ Error al notificar al servidor sobre notificaciones vistas.');
                        }
                    })
                    .catch(err => console.error('Error de red al marcar notificaciones como vistas:', err));
                }
                // --- FIN DE LA CORRECCIÓN ---
            }
        });
    }

    if (clearNotificationsBtn) {
        clearNotificationsBtn.addEventListener('click', () => {
            console.log('🧹 Limpiando todas las notificaciones');
            notifications = [];
            notificationsReadCount = 0;
            
            // NUEVO: Limpiar también del localStorage
            localStorage.removeItem('focux_notifications');
            
            updateNotificationsUI();
            notificationsDropdown.classList.add('hidden');
        });
    }

    // Cerrar dropdown al hacer clic fuera
    document.addEventListener('click', (e) => {
        if (notificationsBtn && notificationsDropdown && 
            !notificationsBtn.contains(e.target) && 
            !notificationsDropdown.contains(e.target)) {
            notificationsDropdown.classList.add('hidden');
        }
    });


    
    function renderTagSelectors(existingTags) {
        const urgencyContainer = document.getElementById('urgency-tags-container');
        const importanceContainer = document.getElementById('importance-tags-container');
        const customTagsInput = document.querySelector('input[name="custom_tags"]');
        
        urgencyContainer.innerHTML = '';
        importanceContainer.innerHTML = '';

        const existingTagTexts = (existingTags || []).map(t => (typeof t === 'object' && t.text) ? t.text : t);

        const urgencyTags = { 'Urgente': TAGS_CONFIG['Urgente'], 'No Urgente': TAGS_CONFIG['No Urgente'] };
        const importanceTags = { 'Importante': TAGS_CONFIG['Importante'], 'No Importante': TAGS_CONFIG['No Importante'] };

        const createTagGroup = (container, group, groupName) => {
            Object.keys(group).forEach(tagText => {
                const button = document.createElement('button');
                button.type = 'button';
                button.className = 'tag-select-btn w-full text-left px-3 py-2 text-sm rounded-md border';
                button.textContent = tagText;
                button.dataset.group = groupName;
                
                if (existingTagTexts.includes(tagText)) {
                    button.setAttribute('aria-checked', 'true');
                    button.classList.add('active');
                } else {
                    button.setAttribute('aria-checked', 'false');
                }

                button.addEventListener('click', () => {
                    const isChecked = button.getAttribute('aria-checked') === 'true';
                    
                    // Deseleccionar todos los botones del mismo grupo
                    container.querySelectorAll(`[data-group="${groupName}"]`).forEach(btn => {
                        btn.setAttribute('aria-checked', 'false');
                        btn.classList.remove('active');
                    });
                    
                    // Si el botón no estaba seleccionado, seleccionarlo
                    if (!isChecked) {
                        button.setAttribute('aria-checked', 'true');
                        button.classList.add('active');
                    }
                });
                container.appendChild(button);
            });
        };

        createTagGroup(urgencyContainer, urgencyTags, 'urgency');
        createTagGroup(importanceContainer, importanceTags, 'importance');
        
        const nonPredefined = existingTagTexts.filter(tagText => !TAGS_CONFIG[tagText]);
        customTagsInput.value = nonPredefined.join(', ');
    }



    function renderChecklist(task) {
        const items = task.checklist || [];
        const container = document.getElementById('checklist-items');
        container.innerHTML = '';

        items.forEach(item => {
            const li = document.createElement('li');
            li.className = 'flex items-center gap-3 p-2 hover:bg-gray-100 rounded-md';
            li.innerHTML = `
                <input type="checkbox" data-item-id="${item.id}" class="h-4 w-4 rounded border-gray-300 text-orange-600 focus:ring-orange-600" ${item.completed ? 'checked' : ''}>
                <span class="flex-grow text-sm ${item.completed ? 'line-through text-gray-500' : 'text-gray-800'}">${item.text}</span>
                <button type="button" data-item-id="${item.id}" class="delete-checklist-item-btn text-gray-400 hover:text-orange-600 font-bold text-lg leading-none">&times;</button>
            `;
            container.appendChild(li);
        });

        const completedCount = items.filter(i => i.completed).length;
        const progress = items.length > 0 ? (completedCount / items.length) * 100 : 0;
        document.getElementById('checklist-progress-bar').style.width = `${progress}%`;
    }

    function getAllUniqueTags() {
        const allTags = new Set();
        Object.keys(TAGS_CONFIG).forEach(tag => allTags.add(tag));
        cardDataStore.forEach(card => {
            if (card.tags) {
                card.tags.forEach(tag => allTags.add(tag.text));
            }
        });
        return Array.from(allTags).sort();
    }



    function populateTagFilterDropdown() {
        const allTags = new Set();
        cardDataStore.forEach(card => {
            if (card.tags) {
                card.tags.forEach(tag => allTags.add(tag.text));
            }
        });

        tagFilterDropdown.innerHTML = '';
        const clearOption = document.createElement('a');
        clearOption.href = '#';
        clearOption.className = 'block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100';
        clearOption.textContent = 'Todas las etiquetas';
        clearOption.onclick = (e) => {
            e.preventDefault();
            activeTagFilter = null;
            tagFilterDropdown.classList.add('hidden');
            applyFilters();
        };
        tagFilterDropdown.appendChild(clearOption);

        if (allTags.size > 0) {
             const separator = document.createElement('div');
             separator.className = 'border-t border-gray-100 my-1';
             tagFilterDropdown.appendChild(separator);
        }
        
        Array.from(allTags).sort().forEach(tagText => {
            const option = document.createElement('a');
            option.href = '#';
            option.className = 'flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100';
            
            const tagConfig = TAGS_CONFIG[tagText];
            if (tagConfig) {
                const colorDot = document.createElement('span');
                colorDot.className = `tag-color-dot ${tagConfig.color.split(' ')[0]}`;
                option.appendChild(colorDot);
            } else {
                 const placeholderDot = document.createElement('span');
                 placeholderDot.className = 'tag-color-dot bg-transparent';
                 option.appendChild(placeholderDot);
            }
            
            const textSpan = document.createElement('span');
            textSpan.textContent = tagText;
            option.appendChild(textSpan);
            
            option.onclick = (e) => {
                e.preventDefault();
                activeTagFilter = tagText;
                tagFilterDropdown.classList.add('hidden');
                applyFilters();
            };
            tagFilterDropdown.appendChild(option);
        });
    }

    function applyFilters() {
        const searchTerm = searchInput.value.toLowerCase();
        
        cardDataStore.forEach((data, id) => {
            const cardEl = document.getElementById(id);
            if (!cardEl) return;

            const matchesSearch = data.title.toLowerCase().includes(searchTerm) || (data.description && data.description.toLowerCase().includes(searchTerm));
            const matchesTag = !activeTagFilter || (data.tags && data.tags.some(tag => tag.text === activeTagFilter));

            cardEl.style.display = (matchesSearch && matchesTag) ? 'flex' : 'none';
        });
        
        updateColumnHeaders();
    }
    
    function updateAttachmentPreview(imageUrl) {
        const attachmentPreviewContainer = document.getElementById('attachment-preview-container');
        const attachmentPreview = document.getElementById('attachment-preview');
        attachmentPreview.innerHTML = '';
        if (imageUrl) {
            attachmentPreviewContainer.classList.remove('hidden');
            const img = document.createElement('img');
            img.src = imageUrl;
            img.className = 'w-full h-full object-contain';
            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.innerHTML = '&times;';
            removeBtn.className = 'absolute top-2 right-2 bg-orange-600 text-white rounded-full w-6 h-6 flex items-center justify-center font-bold text-lg';
            removeBtn.onclick = () => {
                const task = cardDataStore.get(currentCardId);
                if (task) task.attachment = null;
                attachmentPreviewContainer.classList.add('hidden');
                cardAttachmentInput.value = '';
            };
            attachmentPreview.append(img, removeBtn);
        } else {
            attachmentPreviewContainer.classList.add('hidden');
        }
    }
    

    const genericConfirmModal = document.getElementById('generic-confirm-modal');
    const genericConfirmContent = genericConfirmModal.querySelector('.transform');
    const genericConfirmTitle = document.getElementById('generic-confirm-title');
    const genericConfirmMessage = document.getElementById('generic-confirm-message');
    const genericConfirmOkBtn = document.getElementById('generic-confirm-ok-btn');
    const genericConfirmCancelBtn = document.getElementById('generic-confirm-cancel-btn');

    /**
     * Muestra un modal de confirmación genérico y devuelve una promesa
     * que se resuelve a 'true' si se confirma, o 'false' si se cancela.
     * @param {string} title El título del modal.
     * @param {string} message El mensaje de confirmación.
     * @returns {Promise<boolean>}
     */
    function showGenericConfirmModal(title, message) {
        return new Promise(resolve => {
            genericConfirmTitle.textContent = title;
            genericConfirmMessage.textContent = message;

            genericConfirmModal.classList.remove('hidden');
            setTimeout(() => genericConfirmContent.classList.remove('scale-95', 'opacity-0'), 10);

            const close = (confirmation) => {
                genericConfirmContent.classList.add('scale-95', 'opacity-0');
                setTimeout(() => genericConfirmModal.classList.add('hidden'), 200);
                resolve(confirmation);
            };

            genericConfirmOkBtn.onclick = () => close(true);
            genericConfirmCancelBtn.onclick = () => close(false);
            genericConfirmModal.querySelector('#generic-confirm-overlay').onclick = () => close(false);
        });
    }


    async function searchPexelsImages(query) {
        pexelsGrid.innerHTML = '';
        pexelsLoader.classList.remove('hidden');
        pexelsNoResults.classList.add('hidden');
        
        try {
            const response = await fetch(`https://api.pexels.com/v1/search?query=${encodeURIComponent(query)}&per_page=30`, {
                headers: {
                    Authorization: PEXELS_API_KEY
                }
            });

            if (!response.ok) {
                throw new Error(`Error de Pexels: ${response.statusText}`);
            }

            const data = await response.json();
            displayPexelsImages(data.photos);

        } catch (error) {
            console.error('Error al buscar en Pexels:', error);
            pexelsNoResults.textContent = 'Ocurrió un error al buscar. Intenta más tarde.';
            pexelsNoResults.classList.remove('hidden');
        } finally {
            pexelsLoader.classList.add('hidden');
        }
    }


    // Añade esta línea al inicio de tu bloque <script>
    const IMGBB_API_KEY = "d482776ffb2a6adc337a1074c9f27732"; // <-- ¡IMPORTANTE! Obtén tu clave en https://api.imgbb.com/

    // AÑADE ESTA NUEVA FUNCIÓN
    async function uploadToImgBB(file) {
        const submitBtn = document.getElementById('change-cover-submit-btn');
        const originalBtnText = submitBtn.textContent;
        submitBtn.disabled = true;
        submitBtn.textContent = 'Subiendo imagen...';

        if (!IMGBB_API_KEY || IMGBB_API_KEY === "TU_API_KEY_DE_IMGBB") {
            alert("Error: La API Key de ImgBB no está configurada en el código de Tablero.html");
            submitBtn.disabled = false;
            submitBtn.textContent = originalBtnText;
            return null;
        }
        
        try {
            const compressedDataUrl = await compressImage(file, 1280, 0.8);
            const base64Image = compressedDataUrl.split(',')[1];
            
            const formData = new FormData();
            formData.append('image', base64Image);

            const response = await fetch(`https://api.imgbb.com/1/upload?key=${IMGBB_API_KEY}`, {
                method: 'POST',
                body: formData,
            });
            
            const result = await response.json();
            
            if (result.success) {
                return result.data.url;
            } else {
                throw new Error(result.error.message);
            }
        } catch (error) {
            console.error("Error subiendo a ImgBB:", error);
            alert(`No se pudo subir la imagen: ${error.message}`);
            return null;
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = originalBtnText;
        }
    }

    // REEMPLAZA la función openChangeCoverModal existente
    function openChangeCoverModal(docId) {
        const doc = documentsCache.find(d => d.id == docId);
        if (!doc) return;

        changeCoverModal.classList.remove('hidden');
        document.getElementById('change-cover-doc-id').value = docId;
        document.getElementById('doc-password').value = doc.password || '';

        const previewContainer = document.getElementById('cover-preview-container');
        const hiddenUrlInput = document.getElementById('doc-cover-url-hidden');

        // Función para actualizar la UI de la portada
        const updateCoverUI = (url) => {
            hiddenUrlInput.value = url;
            previewContainer.innerHTML = `<img src="${url}" class="w-full h-full object-cover rounded-md">`;
        };
        
        updateCoverUI(doc.thumbnail_url); // Mostrar portada actual al abrir

        // Listeners de los botones
        document.getElementById('cover-from-pc-btn').onclick = () => document.getElementById('cover-file-input').click();
        document.getElementById('cover-from-pexels-btn').onclick = () => {
            pexelsTarget = 'document_cover';
            openDrawer(pexelsOverlay, pexelsContent);
        };
        
        document.getElementById('cover-file-input').onchange = async (e) => {
            const file = e.target.files[0];
            if (file) {
                const imageUrl = await uploadToImgBB(file);
                if (imageUrl) {
                    updateCoverUI(imageUrl);
                }
            }
        };
        
        setTimeout(() => {
            changeCoverModal.querySelector('.transform').classList.remove('scale-95', 'opacity-0');
        }, 10);
    }

    // REEMPLAZA el addEventListener del formulario change-cover-form
    changeCoverForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const docId = document.getElementById('change-cover-doc-id').value;
        const newUrl = document.getElementById('doc-cover-url-hidden').value;
        const password = document.getElementById('doc-password').value;
        
        try {
            const response = await fetch(`${REAL_API_BASE_URL}/documents/${docId}/cover`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ url: newUrl, password: password })
            });
            const result = await response.json();
            if (result.success) {
                const docIndex = documentsCache.findIndex(d => d.id == docId);
                if (docIndex !== -1) {
                    documentsCache[docIndex] = result.document;
                    renderDocuments();
                }
                closeChangeCoverModal();
            } else {
                alert(`Error: ${result.message}`);
            }
        } catch (error) {
            alert('Error de conexión al actualizar la portada.');
        }
    });


    
    function updateColumnHeaders() {
            document.querySelectorAll('.kanban-column').forEach(column => {
                const visibleCards = column.querySelectorAll('.kanban-card:not([style*="display: none"])');
                const cardCounterEl = column.querySelector('.card-counter');
                
                // Verificación añadida para asegurar que el elemento existe antes de modificarlo
                if (cardCounterEl) {
                    cardCounterEl.textContent = visibleCards.length;
                }
            });
    }
    

        

    board.addEventListener('click', (e) => {
        const actionsBtn = e.target.closest('.card-actions-btn');
        if (actionsBtn) {
            e.preventDefault();
            e.stopPropagation();

            // --- INICIO DE LA CORRECCIÓN ---
            // La forma anterior de buscar el menú era frágil. Esta nueva forma es más robusta.
            const menu = actionsBtn.parentElement.querySelector('.card-actions-menu');
            if (!menu) return; // Si por alguna razón no se encuentra el menú, no hacer nada.
            // --- FIN DE LA CORRECCIÓN ---
            
            // Cerrar todos los otros menús abiertos para que solo se vea uno a la vez.
            document.querySelectorAll('.card-actions-menu').forEach(m => {
                if (m !== menu) m.classList.add('hidden');
            });
            
            // Mostrar u ocultar el menú actual.
            menu.classList.toggle('hidden');
            return;
        }

        const card = e.target.closest('.kanban-card');
        const cardId = card ? card.id : null;

        if (e.target.matches('.duplicate-card-btn')) {
            e.preventDefault();
            e.stopPropagation();
            if (cardId) duplicateCard(cardId);
            e.target.closest('.card-actions-menu').classList.add('hidden');
        } else if (e.target.matches('.delete-card-btn')) {
            e.preventDefault();
            e.stopPropagation();
            if (cardId) {
                closeDrawer(addCardOverlay, addCardContent);
                showConfirmDelete('card', cardId);
            }
            e.target.closest('.card-actions-menu').classList.add('hidden');
        } else if (e.target.matches('.move-card-column-btn')) {
            e.preventDefault();
            e.stopPropagation();
            if (cardId) openMoveToColumnModal(cardId);
            e.target.closest('.card-actions-menu').classList.add('hidden');
        } else if (e.target.matches('.move-card-board-btn')) {
            e.preventDefault();
            e.stopPropagation();
            if (cardId) openMoveToBoardModal(cardId);
            e.target.closest('.card-actions-menu').classList.add('hidden');
        }
    });

    document.addEventListener('click', (e) => {
        if (!e.target.closest('.card-actions')) {
            document.querySelectorAll('.card-actions-menu').forEach(m => m.classList.add('hidden'));
        }
    });





    // REEMPLAZA la función 'duplicateCard' con esta
    function duplicateCard(cardId) {
        const originalTask = cardDataStore.get(cardId);
        if (!originalTask) return;

        const newTask = JSON.parse(JSON.stringify(originalTask));
        newTask.id = 'card-' + Date.now() + Math.random().toString(36).substr(2, 9);
        newTask.title = `${originalTask.title} (Copia)`;
        newTask.order = originalTask.order + 0.5; // Se posiciona justo después de la original
        
        cardDataStore.set(newTask.id, newTask);

        // --- INICIO DE LA CORRECCIÓN ---
        // Notificamos a los demás que se ha creado (duplicado) una tarjeta.
        socket.emit('card_created', {
            board_id: currentBoardId,
            card: newTask
        });
        // --- FIN DE LA CORRECCIÓN ---

        renderAllCards(); // El creador actualiza su propia vista
        scheduleAutoSave(); // Se guarda el cambio
    }


    socket.on('card_created', (data) => {
        if (data.board_id !== currentBoardId) return;

        console.log('↓ Recibiendo nueva tarjeta en tiempo real:', data.card);
        const newCard = data.card;

        // 1. Añadimos la tarjeta a nuestro almacén de datos local
        cardDataStore.set(newCard.id, newCard);

        // 2. Creamos el elemento HTML de la tarjeta
        const cardElement = createCardElement(newCard);

        // 3. Buscamos la columna correcta y añadimos la tarjeta al final
        const targetColumnContent = document.querySelector(`#${newCard.columnId} .kanban-column-content`);
        if (targetColumnContent) {
            targetColumnContent.appendChild(cardElement);
        }

        // 4. Actualizamos los contadores de las columnas
        updateColumnHeaders();
    });

    const moveToColumnModal = document.getElementById('move-to-column-modal');
    const moveToBoardModal = document.getElementById('move-to-board-modal');

    function openMoveToColumnModal(cardId) {
        const task = cardDataStore.get(cardId);
        if (!task) return;

        document.getElementById('move-card-id-column').value = cardId;
        const select = document.getElementById('move-to-column-select');
        select.innerHTML = '';

        columnsConfig.forEach(col => {
            if (col.id !== task.columnId) {
                const option = document.createElement('option');
                option.value = col.id;
                option.textContent = col.title;
                select.appendChild(option);
            }
        });
        moveToColumnModal.classList.remove('hidden');
    }

    async function openMoveToBoardModal(cardId) {
        document.getElementById('move-card-id-board').value = cardId;
        const boardSelect = document.getElementById('move-to-board-select');
        const columnSelect = document.getElementById('move-to-board-column-select');
        const submitBtn = document.getElementById('move-to-board-submit-btn');

        // Deshabilitar todo mientras se carga la lista
        boardSelect.innerHTML = '<option value="">-- Cargando tableros... --</option>';
        boardSelect.disabled = true;
        columnSelect.innerHTML = '<option value="">-- Seleccione un tablero primero --</option>';
        columnSelect.disabled = true;
        submitBtn.disabled = true;

        try {
            // Obtener la lista de tableros más reciente del servidor
            const response = await fetch(`${API_BASE_URL}/boards?email=${encodeURIComponent(currentUser.email)}`, {
                headers: { 'ngrok-skip-browser-warning': 'true', 'Content-Type': 'application/json' }
            });
            const data = await response.json();
            
            if (data.success && data.boards) {
                // Actualizar la lista global de tableros en el cliente
                boardsData = data.boards;
                
                // Llenar el selector de tableros con la lista fresca
                boardSelect.innerHTML = '<option value="">-- Seleccionar un tablero --</option>';
                boardsData.forEach(board => {
                    if (board.id !== currentBoardId) {
                        const option = document.createElement('option');
                        option.value = board.id;
                        option.textContent = board.name;
                        boardSelect.appendChild(option);
                    }
                });

                // Re-habilitar el selector de tableros y mostrar el modal
                boardSelect.disabled = false;
                moveToBoardModal.classList.remove('hidden');
            } else {
                alert('No se pudo obtener la lista de tableros actualizados. Intenta recargar la página.');
            }
        } catch (error) {
            console.error('Error fetching boards for move modal:', error);
            alert('Error de conexión al intentar obtener la lista de tableros.');
        }
    }

    // Event Listeners para los nuevos modales
    document.getElementById('move-to-column-cancel-btn').addEventListener('click', () => moveToColumnModal.classList.add('hidden'));
    document.getElementById('move-to-column-overlay').addEventListener('click', () => moveToColumnModal.classList.add('hidden'));
    document.getElementById('move-to-board-cancel-btn').addEventListener('click', () => moveToBoardModal.classList.add('hidden'));
    document.getElementById('move-to-board-overlay').addEventListener('click', () => moveToBoardModal.classList.add('hidden'));

    document.getElementById('move-to-column-form').addEventListener('submit', (e) => {
        e.preventDefault();
        const cardId = document.getElementById('move-card-id-column').value;
        const targetColumnId = document.getElementById('move-to-column-select').value;
        const task = cardDataStore.get(cardId);

        if (task && targetColumnId) {
            task.columnId = targetColumnId;
            task.order = Date.now();
            renderAllCards();
            scheduleAutoSave();
            moveToColumnModal.classList.add('hidden');
        }
    });

    document.getElementById('move-to-board-select').addEventListener('change', (e) => {
        const targetBoardId = parseInt(e.target.value);
        const columnSelect = document.getElementById('move-to-board-column-select');
        const submitBtn = document.getElementById('move-to-board-submit-btn');

        columnSelect.innerHTML = '<option value="">-- Cargando columnas... --</option>';
        submitBtn.disabled = true;

        if (!targetBoardId) {
            columnSelect.innerHTML = '<option value="">-- Seleccione un tablero primero --</option>';
            columnSelect.disabled = true;
            return;
        }

        const targetBoardData = boardsData.find(b => b.id === targetBoardId);
        if (targetBoardData && targetBoardData.data.columns) {
            columnSelect.innerHTML = '<option value="">-- Seleccionar columna --</option>';
            targetBoardData.data.columns.forEach(col => {
                const option = document.createElement('option');
                option.value = col.id;
                option.textContent = col.title;
                columnSelect.appendChild(option);
            });
            columnSelect.disabled = false;
        } else {
            columnSelect.innerHTML = '<option value="">-- No se encontraron columnas --</option>';
        }
    });

    document.getElementById('move-to-board-column-select').addEventListener('change', (e) => {
        const submitBtn = document.getElementById('move-to-board-submit-btn');
        submitBtn.disabled = !e.target.value;
    });


    document.getElementById('move-to-board-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const cardId = document.getElementById('move-card-id-board').value;
        const targetBoardId = document.getElementById('move-to-board-select').value;
        const targetColumnId = document.getElementById('move-to-board-column-select').value;
        const submitBtn = document.getElementById('move-to-board-submit-btn');

        submitBtn.disabled = true;
        submitBtn.textContent = 'Moviendo...';

        const url = `${API_BASE_URL}/boards/${parseInt(currentBoardId)}/move-card?email=${encodeURIComponent(currentUser.email)}`;

        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'ngrok-skip-browser-warning': 'true' },
                body: JSON.stringify({
                    cardId: cardId,
                    targetBoardId: parseInt(targetBoardId),
                    targetColumnId: targetColumnId
                })
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.message);
            }

            const result = await response.json();

            if (result.success) {
                // --- LÓGICA SIMPLIFICADA ---
                // 1. Simplemente elimina la tarjeta de la vista actual (tablero de origen).
                cardDataStore.delete(cardId);
                renderAllCards();
                
                // 2. Cierra modales y muestra éxito.
                moveToBoardModal.classList.add('hidden');
                showMoveSuccessModal();
                console.log("✅ Tarjeta movida. La próxima vez que selecciones el tablero de destino, se cargarán los datos frescos.");
                // --- FIN DE LA LÓGICA SIMPLIFICADA ---
            } else {
                alert(`Error al mover la tarjeta: ${result.message}`);
            }

        } catch (error) {
            console.error('Error en la llamada para mover tarjeta:', error);
            alert(`No se pudo conectar con el servidor para mover la tarjeta. Error: ${error.message}`);
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = 'Mover Tarjeta';
        }
    });

// Función para mostrar y manejar el nuevo modal de éxito
function showMoveSuccessModal() {
    const modal = document.getElementById('move-success-modal');
    const content = modal.querySelector('.transform');
    const okBtn = document.getElementById('move-success-ok-btn');
    const overlay = document.getElementById('move-success-overlay');
    
    modal.classList.remove('hidden');
    
    // Animar la entrada del modal
    setTimeout(() => {
        content.classList.remove('scale-95', 'opacity-0');
        content.classList.add('scale-100', 'opacity-100');
    }, 10); 

    const closeModal = () => {
        content.classList.add('scale-95', 'opacity-0');
        setTimeout(() => modal.classList.add('hidden'), 200);
    };

    okBtn.onclick = closeModal;
    overlay.onclick = closeModal;
}



    // Logout
    function showLogoutModal() {
        logoutModal.classList.remove('hidden');
    }

    function hideLogoutModal() {
        logoutModal.classList.add('hidden');
    }

    logoutBtn.addEventListener('click', () => {
        showLogoutModal();
    });
    
    // Board selector
    boardSelectorBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        boardDropdownMenu.classList.toggle('hidden');
    });
    
    document.addEventListener('click', (e) => {
        if (!boardSelectorBtn.contains(e.target) && !boardDropdownMenu.contains(e.target)) {
            boardDropdownMenu.classList.add('hidden');
        }
    });
    
    createBoardForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const boardName = document.getElementById('new-board-name').value.trim();
        if (boardName) {
            hideCreateBoardModal();
            // En lugar de crear el tablero, ahora abrimos el selector de plantillas
            showTemplateSelector(boardName);
        }
    });
    
    document.getElementById('create-board-close-btn').addEventListener('click', hideCreateBoardModal);
    document.getElementById('create-board-cancel-btn').addEventListener('click', hideCreateBoardModal);
    document.getElementById('create-board-overlay').addEventListener('click', (e) => {
        if (e.target === document.getElementById('create-board-overlay')) {
            hideCreateBoardModal();
        }
    });
    

    function showTemplateSelector(boardName) {
        pendingBoardName = boardName; // Guardamos el nombre temporalmente
        renderTemplates();
        
        templateSelectorModal.classList.remove('hidden');
        setTimeout(() => {
            templateSelectorModal.querySelector('.transform').classList.remove('scale-95', 'opacity-0');
        }, 10);
    }

    function hideTemplateSelector() {
        const content = templateSelectorModal.querySelector('.transform');
        content.classList.add('scale-95', 'opacity-0');
        setTimeout(() => {
            templateSelectorModal.classList.add('hidden');
        }, 200);
    }

    function renderTemplates() {
        const grid = document.getElementById('template-selector-grid');
        grid.innerHTML = '';
        KANBAN_TEMPLATES.forEach(template => {
            const card = document.createElement('div');
            card.className = 'template-card';
            card.innerHTML = `
                <img src="${template.image_url}" alt="${template.title}">
                <h3>${template.title}</h3>
                <div class="columns-desc">${template.columns_desc}</div>
                <div class="desc-block">
                    <strong>Por qué es la mejor:</strong> ${template.why}
                    <strong>Cómo usarlo:</strong> ${template.how}
                </div>
            `;
            card.addEventListener('click', () => {
                createBoardFromTemplate(pendingBoardName, template);
            });
            grid.appendChild(card);
        });
    }

    async function createBoardFromTemplate(name, template) {
        hideTemplateSelector();
        showMainLoader();

        const templateColumns = template.columns.map((col, index) => ({
            ...col,
            id: `col-${Date.now()}-${index}` // Asegura IDs únicos
        }));

        try {
            const response = await fetch(`${API_BASE_URL}/boards`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'ngrok-skip-browser-warning': 'true' },
                body: JSON.stringify({
                    email: currentUser.email,
                    name: name,
                    columns: templateColumns // Enviamos las columnas de la plantilla al backend
                })
            });
            const data = await response.json();
            if (data.success) {
                await loadUserBoards();
                await loadBoardData(data.board_id);
            } else {
                throw new Error(data.message);
            }
        } catch (error) {
            console.error('Error creando tablero desde plantilla:', error);
            alert('Error al crear el tablero: ' + error.message);
        } finally {
            hideMainLoader();
        }
    }

    // Añade listeners para cerrar el modal de plantillas
    document.getElementById('template-selector-close-btn').addEventListener('click', hideTemplateSelector);
    document.getElementById('template-selector-overlay').addEventListener('click', hideTemplateSelector);



    // Search and filters
    searchInput.addEventListener('input', applyFilters);
    addColumnHeaderBtn.addEventListener('click', () => openColumnDrawer(null));
    
    const debouncedAdjustColumns = debounce(adjustColumnWidths, 200);
    window.addEventListener('resize', debouncedAdjustColumns);
    
    // View switcher
    boardViewBtn.addEventListener('click', () => switchView('board'));
    calendarViewBtn.addEventListener('click', () => switchView('calendar'));
    eisenhowerViewBtn.addEventListener('click', () => switchView('eisenhower')); // NUEVO
    documentsViewBtn.addEventListener('click', () => switchView('documents'));
    ganttViewBtn.addEventListener('click', () => switchView('gantt'));

    
    // Calendar navigation
    prevMonthBtn.addEventListener('click', () => {
        currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
        renderCalendar();
    });
    nextMonthBtn.addEventListener('click', () => {
        currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
        renderCalendar();
    });
    
    // Tag filters
    tagFilterBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        populateTagFilterDropdown();
        tagFilterDropdown.classList.toggle('hidden');
    });

    document.addEventListener('click', (e) => {
        if (!tagFilterBtn.contains(e.target) && !tagFilterDropdown.contains(e.target)) {
            tagFilterDropdown.classList.add('hidden');
        }
    });
    
    // Drag and drop for columns
    board.addEventListener('dragover', e => {
        e.preventDefault();
        if (!draggedColumn) return;
        const afterElement = getDragAfterColumn(board, e.clientX);
        if (afterElement == null) {
            board.appendChild(draggedColumn);
        } else {
            board.insertBefore(draggedColumn, afterElement);
        }
    });
    

    // Event listeners para el modal de logout
    logoutCancel.addEventListener('click', hideLogoutModal);
    logoutOverlay.addEventListener('click', hideLogoutModal);

    logoutConfirm.addEventListener('click', async () => {
        hideLogoutModal();
        setAutoSaveStatus('saving');
        
        // Guardar datos antes de salir
        try {
            await saveBoardData();
            console.log('✅ Datos guardados antes de cerrar sesión');
        } catch (error) {
            console.error('❌ Error guardando datos antes de salir:', error);
        }
        
        localStorage.removeItem('user');
        // --- LÍNEA CORREGIDA ---
        window.location.href = '/'; 
    });

    // Cerrar modal con ESC
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && !logoutModal.classList.contains('hidden')) {
            hideLogoutModal();
        }
    });


    columnEditorForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const columnId = e.target.querySelector('[name="column_id"]').value;
        const newTitle = e.target.querySelector('[name="column_name"]').value.trim();
        const selectedColor = document.querySelector('#color-swatches-container .ring-2')?.dataset.color || Object.keys(COLUMN_COLORS)[0];
        const attractsToday = e.target.querySelector('[name="attractsToday"]').checked;
        const attractsOverdue = e.target.querySelector('[name="attractsOverdue"]').checked;
        const attractsTag = e.target.querySelector('[name="attractsTag"]').value;

        if (!newTitle) return;

        if (columnId) {
            // --- INICIO DE LA CORRECCIÓN CLAVE ---
            // EDITANDO: Actualiza la configuración local y notifica a los demás.
            const colIndex = columnsConfig.findIndex(c => c.id === columnId);
            if (colIndex > -1) {
                const updatedColumn = { 
                    ...columnsConfig[colIndex], // Mantiene el ID y otras propiedades
                    title: newTitle, 
                    color: selectedColor,
                    attractsToday: attractsToday,
                    attractsOverdue: attractsOverdue,
                    attractsTag: attractsTag || null
                };
                columnsConfig[colIndex] = updatedColumn;

                // Notificamos a los demás sobre la actualización
                socket.emit('column_updated', {
                    board_id: currentBoardId,
                    updated_column: updatedColumn
                });
            }
            // --- FIN DE LA CORRECCIÓN CLAVE ---
        } else {
            // CREANDO: (La lógica para crear una nueva columna no cambia)
            const newColumn = { 
                id: 'column-' + Date.now(), 
                title: newTitle, 
                color: selectedColor,
                attractsToday: attractsToday,
                attractsOverdue: attractsOverdue,
                attractsTag: attractsTag || null
            };
            columnsConfig.push(newColumn);
            socket.emit('column_created', {
                board_id: currentBoardId,
                new_column: newColumn
            });
        }
        
        scheduleAutoSave();
        initializeBoard(); 
        closeDrawer(columnEditorOverlay, columnEditorContent);
    });

    deleteColumnBtn.addEventListener('click', () => {
      const columnId = columnEditorForm.querySelector('[name="column_id"]').value;
      if (!columnId || columnsConfig.length <= 1) {
        alert("No puedes eliminar la última columna.");
        return;
      }
      // Cerramos el cajón ANTES de mostrar la confirmación
      closeDrawer(columnEditorOverlay, columnEditorContent);
      // Usamos nuestro modal de confirmación
      showConfirmDelete('column', columnId);
    });


    [columnEditorCancelBtn, columnEditorCloseBtn].forEach(btn => 
        btn.addEventListener('click', () => closeDrawer(columnEditorOverlay, columnEditorContent))
    );
    columnEditorOverlay.addEventListener('click', (e) => { 
        if(e.target === columnEditorOverlay) closeDrawer(columnEditorOverlay, columnEditorContent); 
    });
    

    addCardForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        saveCardDataFromModal();

        const formData = new FormData(addCardForm);
        const cardId = formData.get('card_id');
        const title = formData.get('title');
        if (!title) return;

        let taskData = cardDataStore.get(cardId);
        if (!taskData) return;

        // --- INICIO DE LA CORRECCIÓN ---
        // Notificamos a los demás que se ha creado una nueva tarjeta.
        socket.emit('card_created', {
            board_id: currentBoardId,
            card: taskData
        });
        // --- FIN DE LA CORRECCIÓN ---
        
        if (!saveTimeBoxingData(taskData)) return;

        const attachmentFile = document.getElementById('card-attachment').files[0];
        if (attachmentFile) {
            const compressedDataUrl = await compressImage(attachmentFile, 800, 0.7);
            taskData.attachment = compressedDataUrl;
        } else if (taskData.attachment && document.getElementById('attachment-preview-container').classList.contains('hidden')) {
            taskData.attachment = null;
        }
        
        scheduleAutoSave();
        renderAllCards();
        if(!calendarContainer.classList.contains('hidden')) renderCalendar();
        closeDrawer(addCardOverlay, addCardContent);
    });



    addChecklistItemBtn.addEventListener('click', () => {
        const input = document.getElementById('new-checklist-item-input');
        const text = input.value.trim();
        if (text && currentCardId) {
            const task = cardDataStore.get(currentCardId);
            if (!task) return;

            if (!task.checklist) task.checklist = [];
            task.checklist.push({ id: 'item-' + Date.now(), text, completed: false });
            scheduleAutoSave();
            renderAllCards();
            renderChecklist(task);
            input.value = '';
        }
    });


    socket.on('column_updated', (data) => {
        if (data.board_id !== currentBoardId) return;

        const updatedColumn = data.updated_column;
        console.log(`↓ Recibiendo actualización de columna: ${updatedColumn.title}`);

        // 1. Actualizar la configuración local
        const colIndex = columnsConfig.findIndex(c => c.id === updatedColumn.id);
        if (colIndex > -1) {
            columnsConfig[colIndex] = updatedColumn;
        }

        // 2. Actualizar el DOM
        const columnElement = document.getElementById(updatedColumn.id);
        if (columnElement) {
            // Actualizar el título
            const titleElement = columnElement.querySelector('.column-header h2');
            if (titleElement) titleElement.textContent = updatedColumn.title;
            
            // Actualizar el color del borde
            const headerElement = columnElement.querySelector('.column-header');
            if (headerElement) {
                Object.values(COLUMN_COLORS).forEach(borderColor => headerElement.classList.remove(borderColor));
                headerElement.classList.add(COLUMN_COLORS[updatedColumn.color] || 'border-gray-400');
            }
        }
    });
    

    
    deleteCardBtn.addEventListener('click', () => {
      showConfirmDelete('card', currentCardId);
    });

    [addCardCancelBtn, addCardCloseBtn].forEach(btn => 
        btn.addEventListener('click', () => closeDrawer(addCardOverlay, addCardContent))
    );
    addCardOverlay.addEventListener('click', (e) => { 
        if(e.target === addCardOverlay) closeDrawer(addCardOverlay, addCardContent); 
    });
    
    // Confirm delete modal
    confirmDeleteCancel.addEventListener('click', hideConfirmDelete);
    confirmDeleteOverlay.addEventListener('click', hideConfirmDelete);



    confirmDeleteOk.addEventListener('click', async () => {
        // 1. UI: Ocultar botones originales
        const btnContainer = confirmDeleteModal.querySelector('.flex.justify-end');
        if (btnContainer) btnContainer.classList.add('hidden');

        // 2. Inyectar Diseño Moderno y Profesional
        // Usamos una estructura limpia, con textos de estado y barra animada por JS
        const loaderHTML = `
            <div id="delete-process-container" class="mt-2 w-full animate__animated animate__fadeIn">
                <div class="flex justify-between items-end mb-2">
                    <span id="dynamic-status-text" class="text-sm font-semibold text-gray-700 tracking-tight">Iniciando solicitud...</span>
                    <span id="progress-percentage" class="text-xs font-bold text-orange-600">0%</span>
                </div>
                <div class="w-full bg-gray-100 rounded-full h-1.5 overflow-hidden shadow-inner border border-gray-200">
                    <div id="dynamic-progress-bar" class="bg-gradient-to-r from-orange-500 to-red-500 h-1.5 rounded-full transition-all duration-300 ease-out" style="width: 0%"></div>
                </div>
                <p class="text-[10px] text-gray-400 mt-2 text-right font-mono">ID: ${deleteTargetId}</p>
            </div>
        `;
        confirmDeleteMessage.innerHTML = loaderHTML; // Reemplazamos el texto simple por el componente completo

        // 3. Lógica de animación de progreso simulado (UX Profesional)
        const progressBar = document.getElementById('dynamic-progress-bar');
        const percentageText = document.getElementById('progress-percentage');
        const statusText = document.getElementById('dynamic-status-text');
        
        const phases = [
            "Verificando permisos...",
            "Conectando con base de datos...",
            "Purgando registros...",
            "Sincronizando cambios..."
        ];

        let progress = 0;
        const progressInterval = setInterval(() => {
            // Aumenta rápido al principio, lento al final, nunca llega a 100% hasta que termine el fetch
            if (progress < 90) {
                progress += Math.random() * 15;
                if (progress > 90) progress = 90;
                
                progressBar.style.width = `${progress}%`;
                percentageText.textContent = `${Math.round(progress)}%`;
                
                // Cambiar textos según el avance
                const phaseIndex = Math.floor((progress / 100) * phases.length);
                if (phases[phaseIndex]) statusText.textContent = phases[phaseIndex];
            }
        }, 200);

        try {
            if (deleteTargetType === 'card') {
                const response = await fetch(`${API_BASE_URL}/boards/${currentBoardId}/cards/${deleteTargetId}?email=${encodeURIComponent(currentUser.email)}`, {
                    method: 'DELETE',
                    headers: { 'ngrok-skip-browser-warning': 'true' }
                });
                const result = await response.json();
                
                if (result.success) {
                    // FINALIZACIÓN EXITOSA
                    clearInterval(progressInterval);
                    progressBar.style.width = '100%';
                    percentageText.textContent = '100%';
                    statusText.textContent = "¡Eliminado!";
                    
                    // --- ELIMINACIÓN VISUAL INSTANTÁNEA ---
                    const cardEl = document.getElementById(deleteTargetId);
                    if (cardEl) {
                        cardEl.style.display = 'none'; // Desaparecer visualmente YA
                        cardEl.remove(); // Eliminar del DOM
                    }
                    
                    // Lógica de datos
                    cardDataStore.delete(deleteTargetId);
                    updateColumnHeaders();
                    
                    // Cerrar modal muy rápido
                    setTimeout(hideConfirmDelete, 150); 
                } else {
                    throw new Error(result.message);
                }

            } else if (deleteTargetType === 'column') {
                const columnIdToDelete = deleteTargetId;
                const firstColumnId = columnsConfig[0].id;

                cardDataStore.forEach(task => {
                    if (task.columnId === columnIdToDelete) task.columnId = firstColumnId;
                });
                
                columnsConfig = columnsConfig.filter(c => c.id !== columnIdToDelete);
                
                socket.emit('column_deleted', {
                    board_id: currentBoardId,
                    column_id: columnIdToDelete
                });
                
                // Simular delay de red para que se vea la barra un momento
                await new Promise(r => setTimeout(r, 600)); 
                
                initializeBoard();
                scheduleAutoSave();
                
                clearInterval(progressInterval);
                hideConfirmDelete();

            } else if (deleteTargetType === 'board') {
                // Prevenir errores de auto-guardado mientras se borra
                if (currentBoardId === deleteTargetId) {
                    currentBoardId = null;
                }

                const response = await fetch(`${API_BASE_URL}/boards/${deleteTargetId}?email=${encodeURIComponent(currentUser.email)}`, {
                    method: 'DELETE',
                    headers: { 'ngrok-skip-browser-warning': 'true' }
                });
                
                const data = await response.json();

                clearInterval(progressInterval);
                progressBar.style.width = '100%';
                percentageText.textContent = '100%';

                // CORRECCIÓN DEL ERROR "Tablero no encontrado":
                // Si es éxito (success: true) O si el mensaje dice que no se encontró (404/mensaje),
                // consideramos que el objetivo se cumplió (el tablero ya no existe).
                const isNotFound = data.message && data.message.toLowerCase().includes('encontrado');
                
                if (data.success || isNotFound) {
                    statusText.textContent = "Redirigiendo...";
                    await loadUserBoards(); // Recargar la lista de tableros
                    setTimeout(hideConfirmDelete, 200);
                } else {
                    // Solo mostrar alerta si es un error real del servidor distinto a 404
                    statusText.textContent = "Error";
                    statusText.classList.add("text-red-600");
                    alert('Error del sistema: ' + data.message);
                    hideConfirmDelete();
                }
            }
        } catch (error) {
            console.error('Error crítico:', error);
            clearInterval(progressInterval);
            
            // Filtro para no mostrar alerta si estamos borrando tarjeta y falló la red pero la UI ya se actualizó
            if (deleteTargetType === 'board') {
                 // Si falló el tablero, restauramos el ID para que no quede la app rota
                 if (currentBoardId === null) currentBoardId = deleteTargetId;
                 alert('No se pudo conectar con el servidor.');
            } else {
                 alert('Ocurrió un error de conexión.');
            }
            hideConfirmDelete();
        }
    });
    
    // Board options
    boardOptionsBtn.addEventListener('click', openBoardOptionsModal);
    [boardOptionsCloseBtn].forEach(btn => 
        btn.addEventListener('click', () => closeDrawer(boardOptionsOverlay, boardOptionsContent))
    );


    telegramConnectCheckbox.addEventListener('change', (e) => {
        const isConnected = e.target.checked;
        boardOptions.telegramConnected = isConnected;

        if (isConnected) {
            telegramConfigContainer.classList.remove('hidden');
        } else {
            telegramConfigContainer.classList.add('hidden');
            // Opcional: limpiar el chat ID al desconectar
            boardOptions.telegramChatId = '';
            telegramChatIdInput.value = '';
        }
        
        updateTelegramStatusUI();
        scheduleAutoSave();
    });

    connectTelegramBtn.addEventListener('click', async () => {
        const chatId = telegramChatIdInput.value.trim();
        if (!chatId) {
            alert('Por favor, ingresa un Chat ID de Telegram.');
            return;
        }

        // Mostrar estado de carga
        const originalText = connectTelegramBtn.textContent;
        connectTelegramBtn.textContent = 'Conectando...';
        connectTelegramBtn.disabled = true;

        try {
            // Enviar al backend para guardar en la base de datos
            const response = await fetch(`${API_BASE_URL}/telegram/connect`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'ngrok-skip-browser-warning': 'true'
                },
                body: JSON.stringify({
                    chat_id: chatId,
                    user_email: currentUser.email
                })
            });

            const data = await response.json();

            if (data.success) {
                // Guardar localmente también
                boardOptions.telegramChatId = chatId;
                boardOptions.telegramConnected = true;
                
                // Actualizar UI
                updateTelegramStatusUI();
                scheduleAutoSave();
                
                // Feedback exitoso
                connectTelegramBtn.textContent = '✅ Conectado';
                
                // Mostrar mensaje de éxito
                console.log('🎉 Telegram conectado exitosamente:', data.message);
                
                setTimeout(() => {
                    connectTelegramBtn.textContent = originalText;
                }, 2000);
                
            } else {
                throw new Error(data.message || 'Error desconocido');
            }

        } catch (error) {
            console.error('❌ Error conectando Telegram:', error);
            alert('Error conectando con Telegram: ' + error.message);
            
            connectTelegramBtn.textContent = '❌ Error';
            setTimeout(() => {
                connectTelegramBtn.textContent = originalText;
            }, 2000);
        } finally {
            connectTelegramBtn.disabled = false;
        }
    });





    function showNotification(message, type = 'info') {
        // Crear elemento de notificación si no existe
        let notification = document.getElementById('telegram-notification');
        if (!notification) {
            notification = document.createElement('div');
            notification.id = 'telegram-notification';
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                z-index: 10000;
                max-width: 400px;
                padding: 16px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                font-weight: 500;
                transform: translateX(100%);
                transition: transform 0.3s ease;
                word-wrap: break-word;
            `;
            document.body.appendChild(notification);
        }
        
        // Configurar estilos según tipo
        if (type === 'success') {
            notification.style.backgroundColor = '#10B981';
            notification.style.color = 'white';
        } else if (type === 'error') {
            notification.style.backgroundColor = '#EF4444';
            notification.style.color = 'white';
        } else {
            notification.style.backgroundColor = '#3B82F6';
            notification.style.color = 'white';
        }
        
        notification.textContent = message;
        
        // Mostrar notificación
        notification.style.transform = 'translateX(0)';
        
        // Ocultar después de 6 segundos para errores, 4 para éxito
        const timeout = type === 'error' ? 6000 : 4000;
        setTimeout(() => {
            notification.style.transform = 'translateX(100%)';
            
            // ELIMINAR del DOM después de que termine la animación
            setTimeout(() => {
                if (notification && notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 300); // 300ms para que termine la animación de salida
        }, timeout);
    }


    boardOptionsOverlay.addEventListener('click', (e) => { 
        if (e.target === boardOptionsOverlay) closeDrawer(boardOptionsOverlay, boardOptionsContent); 
    });

    blurSlider.addEventListener('input', (e) => {
        boardOptions.blurLevel = parseInt(e.target.value);
        applyBoardOptions();
        scheduleAutoSave();
    });

    blurSlider.addEventListener('change', scheduleAutoSave);

    opacitySlider.addEventListener('input', (e) => {
        boardOptions.overlayOpacity = parseInt(e.target.value);
        applyBoardOptions();
        scheduleAutoSave();
    });

    opacitySlider.addEventListener('change', scheduleAutoSave);

    columnOpacitySlider.addEventListener('input', (e) => {
        boardOptions.columnOpacity = parseInt(e.target.value);
        applyBoardOptions();
        scheduleAutoSave();
    });

    columnOpacitySlider.addEventListener('change', scheduleAutoSave);

    uploadBgBtn.addEventListener('click', () => boardBgInput.click());
    pexelsBgBtn.addEventListener('click', () => {
        pexelsTarget = 'board';
        openDrawer(pexelsOverlay, pexelsContent);
        if (pexelsGrid.innerHTML === '') {
            searchPexelsImages('paisaje abstracto');
        }
    });

    resetBoardOptionsBtn.addEventListener('click', resetBoardToDefault);
    
    boardBgInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (event) => {
                boardOptions.backgroundUrl = event.target.result;
                boardOptions.backgroundColorClass = null;
                applyBoardOptions();
                scheduleAutoSave();
            };
            reader.readAsDataURL(file);
        }
    });
    
    // Pexels modal
    openPexelsBtn.addEventListener('click', () => {
        pexelsTarget = 'card';
        openDrawer(pexelsOverlay, pexelsContent);
        if (pexelsGrid.innerHTML === '') {
            searchPexelsImages('foco, trabajo, oficina');
        }
    });

    uploadFromPcBtn.addEventListener('click', () => {
        cardAttachmentInput.click();
    });

    cardAttachmentInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            // Comprimir imagen antes de guardar
            compressImage(file, 800, 0.7).then(compressedDataUrl => {
                const task = cardDataStore.get(currentCardId);
                if(task) {
                    task.attachment = compressedDataUrl;
                    updateAttachmentPreview(task.attachment);
                }
            });
        }
    });

    document.body.addEventListener('input', (e) => {
        // Revisa si el evento de escritura proviene de alguno de los campos de chat
        if (e.target.matches('#board-chat-input, #general-chat-input')) {

            // La lógica del indicador "escribiendo..." solo aplica para el chat del tablero
            if (e.target.id === 'board-chat-input') {
                if (!typingTimeout) {
                    socket.emit('user_typing_start', { board_id: currentBoardId, user_name: currentUser.firstName });
                }
                clearTimeout(typingTimeout);
                typingTimeout = setTimeout(() => {
                    socket.emit('user_typing_stop', { board_id: currentBoardId });
                    typingTimeout = null;
                }, 2000);
            }
        }
    });

    function compressImage(file, maxWidth = 800, quality = 0.7) {
        return new Promise((resolve) => {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const img = new Image();
            
            img.onload = () => {
                // Calcular nuevas dimensiones manteniendo aspect ratio
                let { width, height } = img;
                if (width > maxWidth) {
                    height = (height * maxWidth) / width;
                    width = maxWidth;
                }
                
                canvas.width = width;
                canvas.height = height;
                
                // Dibujar imagen redimensionada
                ctx.drawImage(img, 0, 0, width, height);
                
                // Convertir a base64 comprimido
                const compressedDataUrl = canvas.toDataURL('image/jpeg', quality);
                resolve(compressedDataUrl);
            };
            
            const reader = new FileReader();
            reader.onload = (e) => {
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        });
    }


    [pexelsCloseBtn].forEach(btn => 
        btn.addEventListener('click', () => closeDrawer(pexelsOverlay, pexelsContent))
    );
    pexelsOverlay.addEventListener('click', (e) => { 
        if (e.target === pexelsOverlay) closeDrawer(pexelsOverlay, pexelsContent); 
    });

    pexelsSearchForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const query = pexelsSearchInput.value.trim();
        if (query) {
            searchPexelsImages(query);
        }
    });
    

    const getCurrentBoardStateForChat = () => {
        const cards = Array.from(cardDataStore.values()).map(card => ({
            id: card.id,
            title: card.title,
            description: card.description ? card.description.substring(0, 100) + '...' : '', // Enviar solo un extracto
            columnId: card.columnId,
            dueDate: card.dueDate,
            tags: card.tags ? card.tags.map(t => t.text) : []
        }));

        const columns = columnsConfig.map(col => ({
            id: col.id,
            title: col.title
        }));

        return { columns, cards };
    };


    
    let isMessageVisible = false;
    let messageTimeout;


    function showFocuxMessage() {
        if (focuxMessages.length === 0) {
            mrFocusTip.className = 'hidden';
            return;
        }
        
        // MODIFICACIÓN: Se elige un mensaje al azar del array en lugar de seguir una secuencia.
        const randomIndex = Math.floor(Math.random() * focuxMessages.length);
        const msg = focuxMessages[randomIndex];
        
        // Validar que el mensaje aleatorio seleccionado tenga contenido
        if (!msg || !msg.content) {
            console.warn("Mensaje de Focux aleatorio seleccionado estaba vacío. Se omitirá en este ciclo.");
            return;
        }
        
        // Mapeo de colores
        const colorClasses = {
            blue: 'bg-blue-100 border-blue-300 text-blue-800',
            orange: 'bg-orange-100 border-orange-300 text-orange-800',
            green: 'bg-green-100 border-green-300 text-green-800',
            gray: 'bg-gray-100 border-gray-300 text-gray-800',
        };
        const colorClass = colorClasses[msg.color] || colorClasses['blue'];
        
        const formattedContent = formatMessageContent(msg.content);
        
        let html = `<div class="p-4 rounded-lg ${colorClass} border shadow-lg max-w-80">`;
        
        if (msg.image_url) {
            html += `<img src="${msg.image_url}" class="w-full max-h-40 object-cover rounded-md mb-3" onerror="this.style.display='none'" loading="lazy">`;
        }
        
        html += `<div class="prose prose-sm focux-message-content">${formattedContent}</div>`;
        
        if (msg.button_text && msg.button_url) {
            html += `<a href="${msg.button_url}" target="_blank" class="inline-block mt-3 px-4 py-2 bg-orange-500 text-white text-xs font-bold rounded-lg hover:bg-orange-600 transition-colors">
                            ${msg.button_text}
                         </a>`;
        }
        
        html += `</div>`;
        
        mrFocusTip.innerHTML = html;
        mrFocusTip.className = 'show';
    }

    function startMessageRotation() {
        clearInterval(messageInterval);
        clearTimeout(messageTimeout);
        isMessageVisible = false;
        mrFocusTip.className = 'hidden';
        mrFocusContainer.style.display = 'none';

        if (focuxMessages.length === 0) return;

        const intervalMinutes = boardOptions.mrFocuxInterval || 0;

        if (intervalMinutes === 0) {
            console.log('🤖 Mr. Focux está desactivado.');
            return;
        }
        
        mrFocusContainer.style.display = 'flex';
        const intervalMilliseconds = intervalMinutes * 60 * 1000;
        const messageDisplayDuration = 20000; // 20 segundos

        const showAndRotate = () => {
            showFocuxMessage(); // Muestra un mensaje aleatorio
            isMessageVisible = true;
            
            setTimeout(() => {
                if (mrFocusTip) mrFocusTip.className = 'hidden';
                isMessageVisible = false;
            }, messageDisplayDuration);

            // MODIFICACIÓN: Se elimina la línea que incrementaba el índice secuencial.
        };

        showAndRotate();
        messageInterval = setInterval(showAndRotate, intervalMilliseconds);
        console.log(`🤖 Mr. Focux configurado para aparecer cada ${intervalMinutes} minuto(s).`);
    }

    mrFocusAvatar.addEventListener('click', () => {
        clearTimeout(messageTimeout);
        clearInterval(messageInterval);
        
        if (isMessageVisible) {
            mrFocusTip.className = 'hidden';
            isMessageVisible = false;
            messageTimeout = setTimeout(() => {
                startMessageRotation();
            }, 3000);
        } else {
            // MODIFICACIÓN: Al hacer clic, siempre se muestra un mensaje aleatorio nuevo.
            showFocuxMessage();
            isMessageVisible = true;
            
            messageTimeout = setTimeout(() => {
                mrFocusTip.className = 'hidden';
                isMessageVisible = false;
                // MODIFICACIÓN: Se elimina el incremento del índice para mantener la aleatoriedad.
                startMessageRotation();
            }, 15000);
        }
    });


    // Programming change notice
    const todayCheckbox = document.getElementById('attracts-today-checkbox');
    const overdueCheckbox = document.getElementById('attracts-overdue-checkbox');
    const notice = document.getElementById('programming-change-notice');

    [todayCheckbox, overdueCheckbox].forEach(checkbox => {
        checkbox.addEventListener('change', () => {
            notice.classList.remove('hidden');
        });
    });
    
    // Check if server is running - MEJORADO
    console.log('Verificando conexión con servidor...');
    fetch(`${API_BASE_URL}/health`, {
        headers: {
            'ngrok-skip-browser-warning': 'true'
        }
    })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                console.log('✅ Servidor conectado:', data.message);
            } else {
                console.error('❌ Servidor respondió con error:', data.message);
            }
        })
        .catch(error => {
            console.error('❌ Error de conexión con servidor:', error);
            alert('No se puede conectar con el servidor. Verifica que esté corriendo.');
        });


    // TimeBoxing FUNCTIONALITY
    let TimeBoxingInterval = null;
    let TimeBoxingEndTime = null;
    let currentTimeBoxingCard = null;


    toggleMuteBtn?.addEventListener('click', () => toggleMute());
    raiseHandBtn?.addEventListener('click', toggleHandRaise);
    micSelect?.addEventListener('change', switchMicrophone);
    speakerSelect?.addEventListener('change', switchSpeaker);



    function setupTimeBoxing() {
        const TimeBoxingCheckbox = document.getElementById('TimeBoxing-checkbox');
        const TimeBoxingConfig = document.getElementById('TimeBoxing-config');
        
        if (!TimeBoxingCheckbox || !TimeBoxingConfig) return;
        
        // Remover event listeners previos para evitar duplicados
        const newCheckbox = TimeBoxingCheckbox.cloneNode(true);
        TimeBoxingCheckbox.parentNode.replaceChild(newCheckbox, TimeBoxingCheckbox);
        
        newCheckbox.addEventListener('change', (e) => {
            const config = document.getElementById('TimeBoxing-config');
            if (e.target.checked) {
                config.classList.remove('hidden');
                // Set default date to today
                document.getElementById('TimeBoxing-date').value = new Date().toISOString().split('T')[0];
            } else {
                config.classList.add('hidden');
            }
        });
    }

    function saveTimeBoxingData(task) {
        const isTimeBoxing = document.getElementById('TimeBoxing-checkbox').checked;
        
        // Limpiar cualquier TimeBoxing previo
        if (task.TimeBoxing) {
            clearTimeBoxingInterval(task);
        }
        
        if (isTimeBoxing) {
            const date = document.getElementById('TimeBoxing-date').value;
            const startTime = document.getElementById('TimeBoxing-start').value;
            const endTime = document.getElementById('TimeBoxing-end').value;
            
            if (!date || !startTime || !endTime) {
                alert('Por favor completa todos los campos de TimeBoxing');
                return false;
            }
            
            const startDateTime = new Date(`${date}T${startTime}`);
            const endDateTime = new Date(`${date}T${endTime}`);
            
            if (startDateTime >= endDateTime) {
                alert('La hora de fin debe ser posterior a la hora de inicio');
                return false;
            }
            
            if (startDateTime < new Date()) {
                alert('La fecha y hora de inicio deben ser futuras');
                return false;
            }
            
            task.TimeBoxing = {
                startDateTime: startDateTime.toISOString(),
                endDateTime: endDateTime.toISOString(),
                isActive: true,
                completed: false
            };
            
            console.log(`📝 Guardando TimeBoxing para '${task.title}':`, task.TimeBoxing);
            scheduleTimeBoxing(task);
        } else {
            // Si se desactiva TimeBoxing, limpiar datos
            delete task.TimeBoxing;
        }
        
        return true;
    }

    function scheduleTimeBoxing(task) {
        const startTime = new Date(task.TimeBoxing.startDateTime);
        const now = new Date();
        const timeUntilStart = startTime.getTime() - now.getTime();

        console.log(`⏰ Programando TimeBoxing para '${task.title}'`);
        console.log(`🕐 Hora actual: ${now.toLocaleString('es-ES')}`);
        console.log(`🕐 Hora de inicio: ${startTime.toLocaleString('es-ES')}`);
        console.log(`⏱️ Tiempo hasta inicio: ${Math.round(timeUntilStart / 1000)} segundos`);

        // Si el inicio es inmediato o ya pasó, iniciar ahora
        if (timeUntilStart <= 0) {
            console.log(`🚀 Iniciando TimeBoxing inmediatamente para '${task.title}'`);
            startTimeBoxing(task);
            return;
        }

        // Verificar cada 5 segundos para mayor precisión
        const checkInterval = setInterval(() => {
            const currentTime = new Date();
            const taskStartTime = new Date(task.TimeBoxing.startDateTime);
            
            console.log(`🔍 Verificando tiempo para '${task.title}': ${currentTime.toLocaleTimeString()} vs ${taskStartTime.toLocaleTimeString()}`);
            
            // Si ya es hora de empezar (con margen de 5 segundos)
            if (currentTime >= taskStartTime) {
                console.log(`🚀 ¡Hora de iniciar TimeBoxing para '${task.title}'!`);
                clearInterval(checkInterval);
                
                // Verificar que la tarea aún esté activa y no haya expirado
                const endTime = new Date(task.TimeBoxing.endDateTime);
                if (currentTime < endTime) {
                    startTimeBoxing(task);
                } else {
                    console.log(`⚠️ La tarea '${task.title}' ya expiró antes de iniciarse`);
                    task.TimeBoxing.isActive = false;
                    task.TimeBoxing.completed = true;
                    renderAllCards();
                    scheduleAutoSave();
                }
            }
        }, 5000); // Verificar cada 5 segundos en lugar de 60

        // Guardar referencia del interval en la tarea para poder limpiarlo después
        task.TimeBoxing.checkInterval = checkInterval;
        
        console.log(`✅ Verificador programado para '${task.title}' - verificará cada 5 segundos`);
    }

    function clearTimeBoxingInterval(task) {
        if (task.TimeBoxing) {
            // Limpiar interval principal
            if (task.TimeBoxing.checkInterval) {
                clearInterval(task.TimeBoxing.checkInterval);
                delete task.TimeBoxing.checkInterval;
            }
            
            // Limpiar intervals de countdown
            if (task.TimeBoxing.intervals) {
                task.TimeBoxing.intervals.forEach(interval => clearInterval(interval));
                task.TimeBoxing.intervals = [];
            }
            
            console.log(`🧹 Limpiados todos los intervals para tarea: ${task.title}`);
        }
    }


    function startTimeBoxing(task) {
        currentTimeBoxingCard = task;
        const overlay = document.getElementById('TimeBoxing-active-overlay');
        
        document.getElementById('TimeBoxing-task-title').textContent = task.title;
        
        // Mostrar descripción limpia (sin HTML)
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = task.description || 'Sin descripción';
        const cleanDescription = tempDiv.textContent || tempDiv.innerText || 'Sin descripción';
        
        // Mostrar detalles completos de la tarjeta
        const startTime = new Date(task.TimeBoxing.startDateTime).toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
        const endTime = new Date(task.TimeBoxing.endDateTime).toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
        
        document.getElementById('TimeBoxing-task-details').innerHTML = `
            <div class="text-sm space-y-1">
                <p><strong>Descripción:</strong> ${cleanDescription}</p>
                <p><strong>Horario:</strong> ${startTime} - ${endTime}</p>
                <p><strong>Tags:</strong> ${task.tags ? task.tags.map(t => t.text).join(', ') : 'Sin etiquetas'}</p>
            </div>
        `;
        
        // Mostrar modal inmediatamente
        overlay.style.display = 'flex';
        
        // Cerrar modal después de solo 3 segundos y empezar timer
        setTimeout(() => {
            overlay.style.display = 'none';
            startTimer(task);
        }, 5000); // Reducido a 3 segundos para inicio más rápido
    }

    function startTimer(task) {
        const endTime = new Date(task.TimeBoxing.endDateTime);
        TimeBoxingEndTime = endTime;
        
        // Mostrar timer flotante
        const timerContainer = document.getElementById('timer-container');
        const timerText = document.getElementById('timer-text');
        timerContainer.classList.remove('hidden');
        
        // Timer integrado en la tarjeta
        const cardTimerDisplay = document.getElementById(`timer-display-${task.id}`);
        
        TimeBoxingInterval = setInterval(() => {
            const now = new Date();
            const timeLeft = TimeBoxingEndTime.getTime() - now.getTime();
            
            if (timeLeft <= 0) {
                finishTimeBoxing();
                return;
            }
            
            const hours = Math.floor(timeLeft / (1000 * 60 * 60));
            const minutes = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
            
            let timeDisplay;
            if (hours > 0) {
                timeDisplay = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            } else {
                timeDisplay = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }
            
            // Actualizar displays - Incluir título de la tarjeta
            timerText.innerHTML = `
                <div style="font-size: 14px; margin-bottom: 4px; opacity: 0.9;">${task.title}</div>
                <div style="font-size: 20px;">${timeDisplay}</div>
            `;
            
            if (cardTimerDisplay) {
                cardTimerDisplay.textContent = timeDisplay;
                
                // Cambiar color cuando quede poco tiempo (menos de 5 minutos)
                if (timeLeft <= 5 * 60 * 1000) {
                    cardTimerDisplay.className = 'text-center bg-red-600 text-white font-bold py-2 px-4 rounded-md my-2 animate-pulse';
                }
            }
        }, 1000);
    }

    async function finishTimeBoxing() {
        clearInterval(TimeBoxingInterval);
        document.getElementById('timer-container').classList.add('hidden');
        
        if (currentTimeBoxingCard) {
            const task = currentTimeBoxingCard;
            const cardIdToDelete = task.id;
            
            // Efecto de flash en la pantalla
            document.body.classList.add('screen-flash');
            
            setTimeout(() => {
                document.body.classList.remove('screen-flash');
                
                // Mostrar modal de finalización
                const finishedOverlay = document.getElementById('TimeBoxing-finished-overlay');
                const modalContent = finishedOverlay.querySelector('.TimeBoxing-modal');
                
                // Limpiar descripción HTML
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = task.description || 'Sin descripción';
                const cleanDescription = tempDiv.textContent || tempDiv.innerText || 'Sin descripción';
                
                modalContent.innerHTML = `
                    <div class="text-6xl mb-4">⏰</div>
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">¡Tiempo Terminado!</h2>
                    <div class="text-left bg-gray-50 p-4 rounded-lg mb-4">
                        <h3 class="font-bold text-lg text-gray-800 mb-2">${task.title}</h3>
                        <p class="text-sm text-gray-600 mb-2">${cleanDescription}</p>
                        ${task.tags && task.tags.length > 0 ? 
                            `<div class="flex flex-wrap gap-1 mb-2">
                                ${task.tags.map(tag => `<span class="px-2 py-1 bg-orange-100 text-orange-800 text-xs rounded">${tag.text}</span>`).join('')}
                            </div>` : ''
                        }
                        <p class="text-xs text-gray-500">Sesión completada: ${new Date().toLocaleString('es-ES')}</p>
                    </div>
                    <button id="TimeBoxing-finished-ok" class="px-6 py-2 bg-orange-600 text-white rounded-lg hover:bg-orange-700">
                        Entendido
                    </button>
                `;
                
                finishedOverlay.style.display = 'flex';
                
                // ELIMINAR LA TARJETA COMPLETAMENTE - NO GUARDAR
                console.log(`🗑️ Eliminando tarjeta de TimeBoxing: ${task.title}`);
                cardDataStore.delete(cardIdToDelete);
                renderAllCards();
                scheduleAutoSave(); // Esto guardará el estado sin la tarjeta
                
                currentTimeBoxingCard = null;
                
                // Re-agregar event listener al botón OK
                document.getElementById('TimeBoxing-finished-ok').addEventListener('click', () => {
                    finishedOverlay.style.display = 'none';
                });
                
            }, 1500);
        }
    }

    function createTimeBoxingCard(task) {
        const card = createCardElement(task);
        
        // Aplicar estilo especial para TimeBoxing en naranja
        card.classList.add('TimeBoxing-card');
        card.style.borderColor = '#fb923c'; // Naranja
        card.style.borderWidth = '3px';
        card.style.background = 'linear-gradient(135deg, #fff7ed, #fed7aa)';
        
        const cardBody = card.querySelector('.p-3');
        if (cardBody) {
            // Badge naranja
            const TimeBoxingBadge = document.createElement('div');
            TimeBoxingBadge.className = 'bg-orange-500 text-white px-3 py-1 rounded-full text-xs font-bold mb-2 inline-block';
            TimeBoxingBadge.textContent = '⏰ TimeBoxing ACTIVO';
            
            // Timer integrado naranja
            const timerDisplay = document.createElement('div');
            timerDisplay.id = `timer-display-${task.id}`;
            timerDisplay.className = 'text-center bg-orange-500 text-white font-bold py-2 px-4 rounded-md my-2';
            timerDisplay.textContent = '00:00';
            
            // Insertar elementos al inicio del cuerpo
            cardBody.insertBefore(timerDisplay, cardBody.firstChild);
            cardBody.insertBefore(TimeBoxingBadge, cardBody.firstChild);
        }
        
        // Deshabilitar edición
        card.style.cursor = 'not-allowed';
        const newCard = card.cloneNode(true);
        
        return newCard;
    }

    document.getElementById('TimeBoxing-finished-ok').addEventListener('click', () => {
        // --- INICIO DE CAMBIOS ---
        // Simplemente oculta el modal, la lógica de borrado ya se ejecutó
        document.getElementById('TimeBoxing-finished-overlay').style.display = 'none';
        // --- FIN DE CAMBIOS ---
    });


    // Event listeners para el nuevo modal
    userSelectorModal.querySelector('#user-selector-close-btn').addEventListener('click', hideUserSelectorModal);
    userSelectorOverlay.addEventListener('click', hideUserSelectorModal);
    

    // Modificar los listeners del chat para que ahora se listen en el modo "general"
    chatModeGeneralBtn.addEventListener('click', () => {
        switchChatMode('general');
    });


    async function fetchJSON(path, {method='GET', body=null} = {}){
        const opts = { method, headers: { 'ngrok-skip-browser-warning':'true' }, mode:'cors' };
        if (body) {
            opts.headers['Content-Type'] = 'application/json';
            opts.body = JSON.stringify(body);
        }
        const res = await fetch(`${API_BASE_URL}${path}`, opts);
        const resData = await res.json();
        if(!res.ok) throw new Error(resData.message || `HTTP ${res.status}`);
        return resData;
    }



    // Initialize TimeBoxing when card modal opens
    function initializeTimeBoxingInModal(task) {
        const section = document.querySelector('.TimeBoxing-section');
        
        // --- INICIO DE CAMBIOS ---
        // Restaurar el HTML original del formulario de TimeBoxing cada vez que se abre el modal
        section.innerHTML = `
            <div class="space-y-4">
                    <h4 class="text-base font-semibold text-gray-800 mb-4">Programación de Tarjeta</h4>
                    <div class="space-y-4">
                        <h5 class="text-md font-semibold text-gray-800 mb-3">⏰ TimeBoxing</h5>
                        <div class="TimeBoxing-section">
                            <label for="TimeBoxing-checkbox" class="flex items-center justify-between p-4 rounded-lg bg-orange-50 border border-orange-200 cursor-pointer hover:bg-orange-100 transition-all">
                                <div class="flex items-center gap-4">
                                    <div class="bg-orange-100 p-2 rounded-full">
                                        <svg class="h-6 w-6 text-orange-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                    </div>
                                    <div>
                                        <p class="font-semibold text-gray-800">Activar TimeBoxing</p>
                                        <p class="text-xs text-gray-500">Bloquea tiempo específico para esta tarea</p>
                                    </div>
                                </div>
                                <div class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="TimeBoxing-checkbox" class="sr-only peer">
                                    <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-focus:ring-2 peer-focus:ring-orange-300 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-orange-600"></div>
                                </div>
                            </label>
                            
                            <div id="TimeBoxing-config" class="hidden space-y-3 p-4 bg-gray-50 rounded-lg">
                                <div class="grid grid-cols-2 gap-3">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Fecha</label>
                                        <input type="date" id="TimeBoxing-date" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Hora Inicio</label>
                                        <input type="time" id="TimeBoxing-start" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm">
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-1">Hora Fin</label>
                                    <input type="time" id="TimeBoxing-end" class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Volver a configurar los listeners del formulario restaurado
        setupTimeBoxing();
        
        const hasActiveTimeBoxing = task.TimeBoxing && 
                                     task.TimeBoxing.isActive && 
                                     task.TimeBoxing.endDateTime && 
                                     new Date(task.TimeBoxing.endDateTime) > new Date();
        
        // Si la tarjeta específica que se está editando tiene un TimeBoxing activo,
        // entonces mostrar el mensaje de bloqueo.
        if (hasActiveTimeBoxing) {
            section.innerHTML = '<p class="text-red-600 font-bold flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" /></svg>Esta tarjeta tiene un TimeBoxing activo y no puede ser modificada.</p>';
        } else if (task.TimeBoxing) {
            // Limpiar datos de TimeBoxing expirados o completados de la tarjeta
            delete task.TimeBoxing;
        }
        // --- FIN DE CAMBIOS ---
    }


        
        cardDataStore.forEach(task => {
            if (task.TimeBoxing && task.TimeBoxing.isActive && !task.TimeBoxing.completed) {
                const startTime = new Date(task.TimeBoxing.startDateTime);
                const endTime = new Date(task.TimeBoxing.endDateTime);
                const now = new Date();
                
                // Si la sesión debería estar activa (entre tiempo de inicio y fin)
                if (startTime <= now && endTime > now) {
                    console.log(`⏰ Reanudando sesión de TimeBoxing para '${task.title}'.`);
                    // Iniciar timer directamente sin mostrar modal de inicio
                    startTimer(task);
                    currentTimeBoxingCard = task;
                } else if (startTime > now) {
                    // Si la tarea está programada para el futuro
                    console.log(`⏰ Programando TimeBoxing para '${task.title}' en ${Math.round((startTime - now) / 1000)}s.`);
                    scheduleTimeBoxing(task);
                } else if (endTime <= now) {
                    // Si ya expiró, limpiar el TimeBoxing
                    task.TimeBoxing.isActive = false;
                    task.TimeBoxing.completed = true;
                }
            }
        });

        console.log('Initializing Focux application...');
        console.log('Current user:', currentUser);

        loadUserBoards().then(() => {
            console.log('Application initialized successfully');
            
            // Cargar notificaciones y mensajes Focux
            loadPendingNotifications();
            updateNotificationsUI();
            loadFocuxMessages(); // <--- LLAMADA A LA NUEVA FUNCIÓN

            // Iniciar procesos automáticos
            moveProgrammedCards();
            setInterval(moveProgrammedCards, 60 * 1000);
            
            // Configurar guardado automático periódico
            setInterval(() => {
                if (autoSaveTimeout === null) {
                    saveBoardData();
                }
            }, 30000);

        }).catch(error => {
            console.error('Failed to initialize application:', error);
            setAutoSaveStatus('error');
            alert('Error cargando la aplicación. Por favor, recarga la página.');
        });
        
    (()=> {
        const isMobile = () => window.matchMedia("(max-width: 640px)").matches;

        /* ====== Medición dinámica de alturas ====== */
        const root = document.documentElement;
        const header = document.getElementById("main-header");
        const bottomBar = document.getElementById("mobile-bottom-bar");
        const board = document.getElementById("kanban-board");

        const setHeights = () => {
            const topH = header ? header.getBoundingClientRect().height : 0;
            const botH = bottomBar ? bottomBar.getBoundingClientRect().height : 0;
            root.style.setProperty("--topbar-h", topH + "px");
            root.style.setProperty("--bottombar-h", botH + "px");
        };
        new ResizeObserver(setHeights).observe(document.body);
        window.addEventListener("resize", setHeights);
        setHeights();

        /* ====== Reubicación de Controles en Móvil ====== */
        const topSlots = {
            board: document.getElementById("mobile-board-selector-slot"),
            viewAndStatus: document.getElementById("mobile-view-and-status-slot"),
        };
        
        const originalParents = new Map();
        
        // CORRECCIÓN: Se vuelve a mover los contenedores padres para que los dropdowns funcionen
        const MOVE_MAP = [
            // Header
            { el: () => document.getElementById("board-selector"), to: () => topSlots.board },
            { el: () => document.getElementById("view-switcher"), to: () => topSlots.viewAndStatus },
            { el: () => document.getElementById("auto-save-indicator"), to: () => topSlots.viewAndStatus },
            
            // Barra Inferior
            { el: () => document.getElementById("tag-filter-container"), to: () => bottomBar },
            { el: () => document.getElementById("board-options-btn"), to: () => bottomBar },
            { el: () => document.getElementById("notifications-container"), to: () => bottomBar },
            { el: () => document.getElementById("ai-assistant-trigger"), to: () => bottomBar},
            { el: () => document.getElementById("add-column-header-btn"), to: () => bottomBar},
            { el: () => document.getElementById("logout-btn"), to: () => bottomBar}
        ];

        function moveToMobileLayout() {
            MOVE_MAP.forEach(map => {
                const el = map.el && map.el();
                const to = map.to && map.to();
                if (!el || !to) return;
                if (!originalParents.has(el)) {
                    originalParents.set(el, { parent: el.parentElement, nextSibling: el.nextSibling });
                }
                if (to !== el.parentElement) to.appendChild(el);
            });
        }

        function restoreToDesktopLayout() {
            originalParents.forEach((pos, el) => {
                if (pos.parent && el && pos.parent !== el.parentElement) {
                    pos.parent.insertBefore(el, pos.nextSibling);
                }
            });
        }
        
        function handleLayoutChange() {
            if (isMobile()) { moveToMobileLayout(); } 
            else { restoreToDesktopLayout(); }
            setTimeout(setHeights, 50);
        }

        /* ====== Lógica para los Botones de Flecha ====== */
        const btnPrev = document.getElementById("prev-col");
        const btnNext = document.getElementById("next-col");
        function getColumns() { return Array.from(document.querySelectorAll(".kanban-column")); }
        function currentColIndex() {
            const cols = getColumns(), scrollPos = board.scrollLeft + board.clientWidth / 2;
            if (!cols.length || !board) return 0;
            let closestIndex = 0, minDistance = Infinity;
            cols.forEach((col, i) => {
                const distance = Math.abs(scrollPos - (col.offsetLeft + col.clientWidth / 2));
                if (distance < minDistance) { minDistance = distance; closestIndex = i; }
            });
            return closestIndex;
        }
        function scrollToIndex(i) {
            const cols = getColumns();
            if (!cols.length || !board) return;
            const idx = Math.max(0, Math.min(cols.length - 1, i));
            board.scrollTo({ left: cols[idx].offsetLeft, behavior: "smooth" });
        }
        if (btnPrev) btnPrev.addEventListener("click", () => scrollToIndex(currentColIndex() - 1));
        if (btnNext) btnNext.addEventListener("click", () => scrollToIndex(currentColIndex() + 1));

        window.addEventListener("resize", handleLayoutChange);
        handleLayoutChange();
    })();

}); 


</script>

<div id="column-pager" class="mobile-only" aria-label="Navegar entre columnas">
  <button id="prev-col" class="pager-btn" aria-label="Columna anterior">‹</button>
  <button id="next-col" class="pager-btn" aria-label="Siguiente columna">›</button>
</div>



<nav id="mobile-bottom-bar" class="mobile-only" aria-label="Acciones rápidas"></nav>

</body>
</html>