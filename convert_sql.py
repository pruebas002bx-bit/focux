import re

# --- Configuraci√≥n ---
INPUT_FILE = 'app.py'
OUTPUT_FILE = 'app_postgres.py'

def convert_sql_placeholders(file_content):
    """
    Reemplaza los marcadores de posici√≥n de SQLite (?) por los de PostgreSQL (%s)
    de una manera m√°s segura, enfoc√°ndose en las llamadas a execute().
    
    Args:
        file_content (str): El contenido completo del archivo Python.
        
    Returns:
        tuple: (contenido_modificado, numero_de_cambios)
    """
    # Expresi√≥n regular para encontrar las llamadas a cursor.execute()
    # Captura el contenido entre los primeros par√©ntesis de la funci√≥n.
    # re.DOTALL (o la bandera `s`) permite que '.' coincida con saltos de l√≠nea,
    # crucial para consultas multil√≠nea.
    pattern = re.compile(r"(\.execute\s*\()([^)]+)(\))", re.DOTALL)
    
    cambios = 0
    
    def replacer(match):
        nonlocal cambios
        # match.group(1) es ".execute("
        # match.group(2) es el contenido: "'SELECT * FROM ...', (params,)"
        # match.group(3) es ")"
        
        content_inside_parentheses = match.group(2)
        
        # Realiza el reemplazo solo dentro del contenido capturado
        if '?' in content_inside_parentheses:
            cambios += content_inside_parentheses.count('?')
            modified_content = content_inside_parentheses.replace('?', '%s')
            # Reconstruye la llamada a la funci√≥n
            return f"{match.group(1)}{modified_content}{match.group(3)}"
        
        # Si no hay '?', devuelve el original sin cambios
        return match.group(0)

    # Usa re.sub con la funci√≥n replacer para aplicar los cambios
    modified_code = re.sub(pattern, replacer, file_content)
    
    return modified_code, cambios

def main():
    """
    Funci√≥n principal que lee, convierte y escribe el archivo.
    """
    try:
        with open(INPUT_FILE, 'r', encoding='utf-8') as f:
            original_content = f.read()
            
        print(f"üîÑ Analizando el archivo '{INPUT_FILE}'...")
        
        converted_content, changes_count = convert_sql_placeholders(original_content)
        
        if changes_count > 0:
            with open(OUTPUT_FILE, 'w', encoding='utf-8') as f:
                f.write(converted_content)
            
            print("\n" + "="*50)
            print("‚úÖ ¬°Conversi√≥n completada exitosamente!")
            print(f"   - Se han realizado {changes_count} reemplazos de '?' por '%s'.")
            print(f"   - El archivo modificado ha sido guardado como '{OUTPUT_FILE}'.")
            print(f"   - El archivo original '{INPUT_FILE}' no ha sido modificado.")
            print("="*50)
            print("\nüëâ **Siguiente paso:** Reemplaza el contenido de tu `app.py` original con el de `app_postgres.py` y contin√∫a con los dem√°s pasos de la migraci√≥n.")
        else:
            print("\n" + "="*50)
            print("üü¢ No se encontraron marcadores de posici√≥n '?' para reemplazar.")
            print(f"   El archivo '{INPUT_FILE}' ya parece estar listo o no contiene consultas SQL con este formato.")
            print("="*50)

    except FileNotFoundError:
        print(f"\n‚ùå **Error:** No se encontr√≥ el archivo '{INPUT_FILE}'.")
        print("   Aseg√∫rate de que este script est√© en la misma carpeta que tu aplicaci√≥n Flask.")
    except Exception as e:
        print(f"\n‚ùå **Error inesperado:** Ocurri√≥ un problema durante la conversi√≥n.")
        print(f"   Detalle: {e}")

if __name__ == "__main__":
    main()